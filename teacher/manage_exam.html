<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì ìˆ˜ ê´€ë¦¬ - Westory Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Firebase -->
    <script type="module" src="../assets/js/firebase-config.js"></script>
    <link rel="stylesheet" href="../assets/css/style.css">
    <script type="module" src="../assets/js/auth-manager.js"></script>

    <style>
        .choice-btn {
            width: 32px;
            height: 32px;
            border: 1px solid #d1d5db;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: bold;
            color: #6b7280;
        }

        .choice-btn:hover {
            background-color: #f3f4f6;
        }

        .choice-btn.selected {
            background-color: #ef4444;
            color: white;
            border-color: #ef4444;
        }

        .tab-btn-base {
            padding: 14px 24px;
            font-weight: 700;
            font-size: 1rem;
            border-bottom: 3px solid transparent;
            color: #9ca3af;
            transition: all 0.2s;
            flex: 1 1 0px;
            width: 0;
            text-align: center;
        }

        .tab-btn-base:hover {
            color: #4b5563;
            background-color: #f9fafb;
        }

        .tab-btn-active {
            border-bottom-color: #2563eb;
            color: #2563eb;
            background-color: #eff6ff;
        }
    </style>
</head>

<body class="bg-gray-50 min-h-screen flex flex-col">
    <!-- Header injected by AuthManager -->

    <main class="w-full max-w-7xl mx-auto px-4 py-6 flex-1 flex flex-col">

        <div class="flex justify-between items-end mb-4 flex-shrink-0">
            <div>
                <h1 class="text-2xl font-bold text-gray-800 flex items-center gap-3">
                    ğŸ“Š ì ìˆ˜ ë° í‰ê°€ ê¸°ì¤€ ê´€ë¦¬
                    <span id="dash-year-badge"
                        class="bg-blue-600 text-white font-bold px-3 py-1 rounded-full text-xs md:text-sm shadow-md min-w-[100px] text-center ml-2 border-2 border-blue-400">
                        <i class="fas fa-spinner fa-spin"></i>
                    </span>
                </h1>
                <p class="text-sm text-gray-500 mt-1">ì„±ì  ì‚°ì¶œ ê¸°ì¤€ì„ ì„¤ì •í•˜ê³ , ì •ê¸° ì‹œí—˜ ì •ë‹µì„ ê´€ë¦¬í•˜ì„¸ìš”.</p>
            </div>
            <!-- Enhanced Semester Badge -->
            <!-- Badge Removed -->
        </div>

        <!-- Tabs -->
        <div class="flex border-b border-gray-200 mb-0 bg-white rounded-t-lg overflow-hidden flex-shrink-0 shadow-sm">
            <button onclick="app.setTab('preview')" id="btn-tab-preview" class="tab-btn-base tab-btn-active">1. ì„±ì  ì‚°ì¶œ
                ê´€ë¦¬</button>
            <button onclick="app.setTab('omr')" id="btn-tab-omr" class="tab-btn-base">2. ì •ê¸° ì‹œí—˜ ì •ë‹µ (OMR)</button>
        </div>

        <!-- Immediately apply URL tab param before page renders -->
        <script>
            (function () {
                const t = new URLSearchParams(window.location.search).get('tab');
                if (t) {
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
                    const target = document.getElementById('tab-' + t);
                    if (target) target.classList.remove('hidden');
                    document.querySelectorAll('.tab-btn-base').forEach(b => b.classList.remove('tab-btn-active'));
                    const btn = document.getElementById('btn-tab-' + t);
                    if (btn) btn.classList.add('tab-btn-active');
                }
            })();
        </script>

        <!-- Content Container -->
        <div class="bg-white border-x border-b border-gray-200 rounded-b-lg p-6 flex-1 min-h-[700px] relative">

            <!-- TAB 1: Grading Plan (Performance Assessment) -->
            <div id="tab-preview" class="tab-content h-full">
                <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 h-full">
                    <!-- Left: Form (Increased width to 5 cols) -->
                    <div class="lg:col-span-5">
                        <div class="bg-blue-50 p-6 rounded-xl border border-blue-100 sticky top-4">
                            <div class="flex justify-between items-center mb-4 border-b border-blue-200 pb-3">
                                <h3 id="formTitle" class="font-bold text-lg text-blue-900">âœï¸ í‰ê°€ ê¸°ì¤€ ë“±ë¡</h3>
                                <button onclick="app.resetPlanForm()"
                                    class="text-xs bg-white text-blue-600 border border-blue-200 px-2 py-1 rounded hover:bg-blue-100 transition"><i
                                        class="fas fa-undo mr-1"></i>ì´ˆê¸°í™”</button>
                            </div>

                            <input type="hidden" id="edit-plan-id">

                            <div class="space-y-4">
                                <div>
                                    <label class="block text-xs font-bold text-blue-800 mb-1">ëŒ€ìƒ í•™ë…„</label>
                                    <select id="plan-grade"
                                        class="w-full border border-blue-200 rounded p-2 text-sm bg-white focus:ring-2 focus:ring-blue-400 font-bold text-gray-700">
                                        <option value="1">1í•™ë…„</option>
                                        <option value="2">2í•™ë…„</option>
                                        <option value="3">3í•™ë…„</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-blue-800 mb-1">ê³¼ëª©ëª…</label>
                                    <input type="text" id="plan-subject" placeholder="ì˜ˆ: ì—­ì‚¬, ì‚¬íšŒ"
                                        class="w-full border border-blue-200 rounded p-2 text-sm focus:ring-2 focus:ring-blue-400">
                                </div>

                                <div>
                                    <div class="flex justify-between items-center mb-1">
                                        <label class="block text-xs font-bold text-blue-800">í‰ê°€ í•­ëª©</label>
                                        <span class="text-[10px] text-blue-600">* í•©ê³„ 100% í•„ìˆ˜</span>
                                    </div>
                                    <div id="criteriaList"
                                        class="space-y-2 bg-white p-2 rounded border border-blue-100"></div>
                                    <button onclick="app.addCriteriaRow()"
                                        class="w-full mt-2 border border-dashed border-blue-300 text-blue-500 text-xs py-2 rounded hover:bg-blue-50 font-bold transition">+
                                        í•­ëª© ì¶”ê°€</button>
                                </div>

                                <button onclick="app.saveGradingPlan()" id="btn-save-plan"
                                    class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 shadow-md transition transform active:scale-95 mt-4">
                                    ê¸°ì¤€ ì €ì¥í•˜ê¸°
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Right: List (Decreased width to 7 cols) -->
                    <div class="lg:col-span-7">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-gray-700 text-lg">ë“±ë¡ëœ ê¸°ì¤€ ëª©ë¡</h3>
                            <!-- Sorting Filter -->
                            <div class="flex items-center gap-2">
                                <span class="text-sm text-gray-500 font-bold">ì •ë ¬:</span>
                                <select id="planSort" onchange="app.sortPlans()"
                                    class="border border-gray-300 rounded px-2 py-1.5 text-sm bg-white font-bold text-gray-700 cursor-pointer">
                                    <option value="latest">ë“±ë¡ìˆœ (ìµœì‹ )</option>
                                    <option value="name">ê³¼ëª©ëª… (ê°€ë‚˜ë‹¤)</option>
                                    <option value="importance">ì¤‘ìš”ë„ìˆœ (êµ­ì˜ìˆ˜...)</option>
                                </select>
                            </div>
                        </div>
                        <div id="plan-list" class="space-y-4">
                            <div
                                class="text-center py-20 text-gray-400 bg-gray-50 rounded-xl border-2 border-dashed border-gray-200">
                                ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB 2: OMR Config -->
            <div id="tab-omr" class="tab-content hidden h-full relative">

                <!-- Bottom Floater: ì´ì /ì €ì¥ -->
                <div
                    class="fixed bottom-4 left-1/2 -translate-x-1/2 bg-white border border-gray-200 shadow-2xl rounded-2xl px-6 py-3 flex items-center gap-4 z-50">
                    <div class="flex items-center gap-3 text-sm font-bold">
                        <span class="text-gray-500">ì´ì </span>
                        <span id="total-score" class="text-2xl font-extrabold text-blue-600">0</span>
                        <span class="text-gray-400">ì </span>
                        <span class="mx-1 text-gray-300">|</span>
                        <span class="text-gray-500">ë¬¸í•­</span>
                        <span id="total-count" class="text-lg font-extrabold text-gray-700">0</span>
                    </div>
                    <button onclick="omrApp.saveToDB()"
                        class="bg-blue-600 hover:bg-blue-700 text-white font-bold px-5 py-2 rounded-xl text-sm transition shadow-md">
                        <i class="fas fa-save mr-1"></i>ì €ì¥
                    </button>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 pb-32">
                    <!-- Objective Section -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <div class="flex justify-between items-center mb-6 pb-2 border-b">
                            <h2 class="font-bold text-lg text-gray-700">ê°ê´€ì‹ ë¬¸í•­</h2>
                            <button onclick="omrApp.addObjective()"
                                class="text-xs bg-green-50 text-green-700 px-3 py-1.5 rounded font-bold hover:bg-green-100 border border-green-200">+
                                ë¬¸í•­ ì¶”ê°€</button>
                        </div>
                        <div id="obj-list" class="space-y-3 max-h-[600px] overflow-y-auto pr-2 custom-scroll"></div>
                    </div>

                    <!-- Subjective Section -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <div class="flex justify-between items-center mb-6 pb-2 border-b">
                            <h2 class="font-bold text-lg text-gray-700">ì„œìˆ í˜• ë¬¸í•­</h2>
                            <button onclick="omrApp.addSubjParent()"
                                class="text-xs bg-indigo-50 text-indigo-700 px-3 py-1.5 rounded font-bold hover:bg-indigo-100 border border-indigo-200">+
                                í° ë¬¸í•­ ì¶”ê°€</button>
                        </div>
                        <div id="subj-list" class="space-y-4 max-h-[600px] overflow-y-auto pr-2 custom-scroll"></div>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <!-- Bottom Status Bar -->
    <!-- Bottom Status Bar -->
    <!-- Removed as per user request -->
    <!--
    <div
        class="fixed bottom-0 left-0 w-full bg-blue-600 text-white text-xs py-1 text-center z-50 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)]">
        <i class="fas fa-calendar-alt mr-1"></i>
        <span id="current-term-badge" class="font-bold tracking-wide">ë¡œë”© ì¤‘...</span>
        <span class="opacity-80 font-normal ml-1">ê¸°ì¤€ ì„±ì  ê´€ë¦¬ ì¤‘</span>
    </div>
    -->

    <!-- Footer injected by AuthManager -->

    <script type="module">
        window.AuthManager.init('teacher');

        // --- Main App Controller ---
        window.app = {
            plans: [],
            // Subject Importance Order
            subjectOrder: ['êµ­ì–´', 'ì˜ì–´', 'ìˆ˜í•™', 'ì‚¬íšŒ', 'ì—­ì‚¬', 'ë„ë•', 'ê³¼í•™', 'ê¸°ìˆ ', 'ê°€ì •', 'ê¸°ìˆ ê°€ì •', 'ê¸°ê°€', 'ì •ë³´', 'ìŒì•…', 'ë¯¸ìˆ ', 'ì²´ìœ¡'],

            init: function () {
                this.updateSemesterBadge();
                this.loadGradingPlans();
                this.addCriteriaRow(); // Add initial row

                // Handle URL Tab Param
                const urlParams = new URLSearchParams(window.location.search);
                const tab = urlParams.get('tab');
                if (tab) this.setTab(tab);
            },

            updateSemesterBadge: function () {
                const c = window.currentConfig;
                const text = `${c.year}í•™ë…„ë„ ${c.semester}í•™ê¸°`;
                document.getElementById('current-term-badge').innerText = text;
            },

            setTab: function (tabName) {
                ['preview', 'omr'].forEach(t => {
                    const btn = document.getElementById('btn-tab-' + t);
                    const div = document.getElementById('tab-' + t);
                    if (t === tabName) {
                        btn.classList.add('tab-btn-active');
                        div.classList.remove('hidden');
                        if (t === 'omr') omrApp.init(); // Lazy load OMR
                    } else {
                        btn.classList.remove('tab-btn-active');
                        div.classList.add('hidden');
                    }
                });
            },

            // --- Grading Plan Logic ---
            loadGradingPlans: async function () {
                const listDiv = document.getElementById('plan-list');
                try {
                    const q = window.getCollection('grading_plans').orderBy('createdAt', 'desc');
                    const snap = await q.get();
                    this.plans = [];
                    snap.forEach(doc => this.plans.push({ id: doc.id, ...doc.data() }));
                    this.sortPlans(); // Initial Render through Sort
                } catch (e) {
                    listDiv.innerHTML = '<div class="text-center text-red-400">ë¡œë“œ ì‹¤íŒ¨</div>';
                }
            },

            sortPlans: function () {
                const mode = document.getElementById('planSort').value;
                if (mode === 'name') {
                    this.plans.sort((a, b) => a.subject.localeCompare(b.subject));
                } else if (mode === 'importance') {
                    this.plans.sort((a, b) => {
                        const getIdx = (subj) => {
                            // Find index based on keyword inclusion
                            const idx = this.subjectOrder.findIndex(key => subj.includes(key));
                            return idx === -1 ? 999 : idx;
                        };
                        const idxA = getIdx(a.subject);
                        const idxB = getIdx(b.subject);
                        if (idxA !== idxB) return idxA - idxB;
                        // Fallback to name if same importance
                        return a.subject.localeCompare(b.subject);
                    });
                } else {
                    // Latest (descending createdAt)
                    this.plans.sort((a, b) => {
                        const tA = a.createdAt ? a.createdAt.seconds : 0;
                        const tB = b.createdAt ? b.createdAt.seconds : 0;
                        return tB - tA;
                    });
                }
                this.renderPlans();
            },

            renderPlans: function () {
                const listDiv = document.getElementById('plan-list');
                if (this.plans.length === 0) {
                    listDiv.innerHTML = '<div class="text-center py-20 text-gray-400 bg-gray-50 rounded-xl border-2 border-dashed border-gray-200 flex flex-col items-center justify-center"><i class="fas fa-folder-open text-4xl mb-4 text-gray-300"></i><p>ë“±ë¡ëœ í‰ê°€ ê¸°ì¤€ì´ ì—†ìŠµë‹ˆë‹¤.</p></div>';
                    return;
                }
                listDiv.innerHTML = this.plans.map(p => {
                    const itemsHtml = p.items.map(i => `<span class="inline-flex items-center bg-gray-100 text-gray-600 text-xs px-3 py-1.5 rounded border border-gray-200"><span class="font-bold mr-1">${i.name}</span><span class="text-gray-300 mx-1">|</span><span class="text-blue-600 font-bold">${i.ratio}%</span></span>`).join('');
                    return `
                        <div class="bg-white p-5 rounded-xl border border-gray-200 shadow-sm hover:shadow-md hover:border-blue-300 transition group relative overflow-hidden flex items-center justify-between">
                            <div class="absolute top-0 left-0 w-1.5 h-full bg-blue-500"></div>
                            <div class="pl-4 flex-1">
                                <div class="flex items-center gap-3 mb-3">
                                    <span class="text-xs font-bold text-white bg-blue-500 px-2.5 py-1 rounded shadow-sm">${p.targetGrade || '2'}í•™ë…„</span>
                                    <h4 class="font-bold text-xl text-gray-800">${p.subject}</h4>
                                </div>
                                <div class="flex flex-wrap gap-2">${itemsHtml}</div>
                            </div>
                            <div class="flex flex-col gap-2 opacity-0 group-hover:opacity-100 transition duration-200 border-l pl-4 border-gray-100 ml-4">
                                <button onclick="app.editPlan('${p.id}')" class="text-blue-500 hover:bg-blue-50 p-2 rounded flex items-center text-xs font-bold bg-white border border-blue-100 shadow-sm"><i class="fas fa-pen mr-1"></i>ìˆ˜ì •</button>
                                <button onclick="app.deletePlan('${p.id}')" class="text-red-500 hover:bg-red-50 p-2 rounded flex items-center text-xs font-bold bg-white border border-red-100 shadow-sm"><i class="fas fa-trash mr-1"></i>ì‚­ì œ</button>
                            </div>
                        </div>
                    `;
                }).join('');
            },

            addCriteriaRow: function (data = null) {
                const div = document.createElement('div');
                div.className = 'criteria-row flex gap-1 items-center bg-gray-50 p-1 rounded mb-1';
                // Optimized Inputs: Reduced widths (w-12/w-10) and padding
                div.innerHTML = `
                    <select class="c-type border border-gray-300 rounded px-1 py-1.5 text-xs w-[60px] bg-white focus:outline-none focus:border-blue-500">
                        <option value="ì§€í•„" ${data?.type === 'ì§€í•„' ? 'selected' : ''}>ì§€í•„</option>
                        <option value="ìˆ˜í–‰" ${data?.type === 'ìˆ˜í–‰' ? 'selected' : ''}>ìˆ˜í–‰</option>
                    </select>
                    <input type="text" placeholder="í•­ëª©ëª…" class="c-name border border-gray-300 rounded px-2 py-1.5 text-xs flex-1 min-w-0 focus:outline-none focus:border-blue-500" value="${data?.name || ''}">
                    <input type="number" placeholder="ë§Œì " class="c-max border border-gray-300 rounded px-1 py-1.5 text-xs w-[45px] text-center focus:outline-none focus:border-blue-500" value="${data?.maxScore || ''}">
                    <input type="number" placeholder="%" class="c-ratio border border-gray-300 rounded px-1 py-1.5 text-xs w-[40px] text-center focus:outline-none focus:border-blue-500 font-bold text-blue-600" value="${data?.ratio || ''}">
                    <button onclick="this.parentElement.remove()" class="text-gray-300 hover:text-red-500 w-5 flex justify-center transition"><i class="fas fa-times"></i></button>
                `;
                document.getElementById('criteriaList').appendChild(div);
            },

            saveGradingPlan: async function () {
                const id = document.getElementById('edit-plan-id').value;
                const subject = document.getElementById('plan-subject').value;
                const grade = document.getElementById('plan-grade').value;

                if (!subject) { alert("ê³¼ëª©ëª…ì„ ì…ë ¥í•˜ì„¸ìš”."); return; }

                const items = [];
                let totalRatio = 0;
                document.querySelectorAll('.criteria-row').forEach(row => {
                    const type = row.querySelector('.c-type').value;
                    const name = row.querySelector('.c-name').value;
                    const maxScore = Number(row.querySelector('.c-max').value);
                    const ratio = Number(row.querySelector('.c-ratio').value);
                    if (name && maxScore && ratio) {
                        items.push({ type, name, maxScore, ratio });
                        totalRatio += ratio;
                    }
                });

                if (items.length === 0) { alert("í•­ëª©ì„ í•˜ë‚˜ ì´ìƒ ì…ë ¥í•˜ì„¸ìš”."); return; }
                if (totalRatio !== 100) { alert(`ë¹„ìœ¨ í•©ê³„ëŠ” 100%ì—¬ì•¼ í•©ë‹ˆë‹¤. (í˜„ì¬ ${totalRatio}%)`); return; }

                const data = {
                    subject,
                    targetGrade: grade,
                    items,
                    academicYear: window.currentConfig.year,
                    semester: window.currentConfig.semester,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                const col = window.getCollection('grading_plans');
                if (id) {
                    await col.doc(id).update(data);
                } else {
                    data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    await col.add(data);
                }

                alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
                this.resetPlanForm();
                this.loadGradingPlans();
            },

            editPlan: function (id) {
                const p = this.plans.find(x => x.id === id);
                if (!p) return;
                document.getElementById('edit-plan-id').value = id;
                document.getElementById('plan-subject').value = p.subject;
                document.getElementById('plan-grade').value = p.targetGrade || '2';

                const list = document.getElementById('criteriaList');
                list.innerHTML = '';
                p.items.forEach(i => this.addCriteriaRow(i));

                document.getElementById('formTitle').innerText = "ğŸ”„ í‰ê°€ ê¸°ì¤€ ìˆ˜ì •";
                document.getElementById('btn-save-plan').classList.remove('bg-blue-600');
                document.getElementById('btn-save-plan').classList.add('bg-amber-500');
                document.getElementById('btn-save-plan').innerText = "ìˆ˜ì •ì‚¬í•­ ì €ì¥";

                // Scroll to form on mobile
                if (window.innerWidth < 1024) document.getElementById('formTitle').scrollIntoView({ behavior: 'smooth' });
            },

            deletePlan: async function (id) {
                if (confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                    await window.getCollection('grading_plans').doc(id).delete();
                    this.loadGradingPlans();
                }
            },

            resetPlanForm: function () {
                document.getElementById('edit-plan-id').value = '';
                document.getElementById('plan-subject').value = '';
                document.getElementById('criteriaList').innerHTML = '';
                this.addCriteriaRow();
                document.getElementById('formTitle').innerText = "âœï¸ í‰ê°€ ê¸°ì¤€ ë“±ë¡";
                document.getElementById('btn-save-plan').classList.add('bg-blue-600');
                document.getElementById('btn-save-plan').classList.remove('bg-amber-500');
                document.getElementById('btn-save-plan').innerText = "ê¸°ì¤€ ì €ì¥í•˜ê¸°";
            }
        };

        // --- OMR Controller (Lazy Loaded) ---
        const omrApp = {
            loaded: false,
            data: { objective: [], subjective: [] },

            init: function () {
                if (this.loaded) return;
                window.getCollection("exam_config").doc("final_exam").get()
                    .then((doc) => {
                        if (doc.exists) {
                            const d = doc.data();
                            this.data.objective = d.objective || [];
                            this.data.subjective = d.subjective || [];
                        }
                        this.render();
                        this.loaded = true;
                    });
            },

            render: function () {
                this.renderObjective();
                this.renderSubjective();
                this.updateTotal();
            },

            addObjective: function () { this.data.objective.push({ score: 4, answer: 0 }); this.render(); },
            removeObjective: function (idx) { this.data.objective.splice(idx, 1); this.render(); },
            setObjAnswer: function (idx, val) { this.data.objective[idx].answer = val; this.render(); },
            updateObjScore: function (idx, val) { this.data.objective[idx].score = Number(val); this.updateTotal(); },

            renderObjective: function () {
                const list = document.getElementById('obj-list');
                list.innerHTML = this.data.objective.map((item, i) => `
                    <div class="flex items-center gap-4 bg-gray-50 p-3 rounded border border-gray-100">
                        <span class="font-bold text-gray-500 w-8 text-center">${i + 1}</span>
                        <div class="flex gap-1">
                            ${[1, 2, 3, 4, 5].map(n => `<button onclick="omrApp.setObjAnswer(${i}, ${n})" class="choice-btn ${item.answer === n ? 'selected' : ''}">${n}</button>`).join('')}
                        </div>
                        <input type="number" class="w-16 p-1 text-center border rounded text-sm font-bold text-blue-600" value="${item.score}" onchange="omrApp.updateObjScore(${i}, this.value)">
                        <span class="text-xs text-gray-400">ì </span>
                        <button onclick="omrApp.removeObjective(${i})" class="ml-auto text-gray-300 hover:text-red-500"><i class="fas fa-times"></i></button>
                    </div>
                `).join('');
            },

            addSubjParent: function () { this.data.subjective.push({ subItems: [] }); this.render(); },
            addSubjItem: function (pIdx) { this.data.subjective[pIdx].subItems.push({ score: 5, answer: "" }); this.render(); },
            removeSubjParent: function (idx) { this.data.subjective.splice(idx, 1); this.render(); },
            updateSubjField: function (pIdx, sIdx, field, val) {
                if (field === 'score') this.data.subjective[pIdx].subItems[sIdx].score = Number(val);
                else this.data.subjective[pIdx].subItems[sIdx][field] = val;
                this.updateTotal();
            },

            renderSubjective: function () {
                const list = document.getElementById('subj-list');
                list.innerHTML = this.data.subjective.map((parent, pIdx) => `
                    <div class="bg-gray-50 p-4 rounded border border-gray-200">
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-bold text-indigo-600">ì„œìˆ í˜• ${pIdx + 1}ë²ˆ</span>
                            <div class="space-x-2">
                                <button onclick="omrApp.addSubjItem(${pIdx})" class="text-xs bg-white border px-2 py-1 rounded">+ ì†Œë¬¸í•­</button>
                                <button onclick="omrApp.removeSubjParent(${pIdx})" class="text-gray-400 hover:text-red-500"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                        <div class="space-y-2">
                            ${parent.subItems.map((sub, sIdx) => `
                                <div class="pl-4 border-l-2 border-indigo-100">
                                    <div class="flex items-center gap-2 mb-1">
                                        <span class="text-xs font-bold text-gray-500">(${sIdx + 1})</span>
                                        <input type="number" class="w-14 p-1 text-center border rounded text-xs font-bold" value="${sub.score}" onchange="omrApp.updateSubjField(${pIdx}, ${sIdx}, 'score', this.value)">
                                        <span class="text-xs text-gray-400">ì </span>
                                    </div>
                                    <textarea class="w-full p-2 border rounded text-sm h-16 resize-none" placeholder="ëª¨ë²” ë‹µì•ˆ ì…ë ¥" onchange="omrApp.updateSubjField(${pIdx}, ${sIdx}, 'answer', this.value)">${sub.answer || ''}</textarea>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `).join('');
            },

            updateTotal: function () {
                let s = 0, c = 0;
                this.data.objective.forEach(i => { s += (i.score || 0); c++; });
                this.data.subjective.forEach(p => { p.subItems.forEach(i => { s += (i.score || 0); c++; }); });
                document.getElementById('total-score').innerText = s;
                document.getElementById('total-count').innerText = c;
            },

            saveToDB: function () {
                window.getCollection("exam_config").doc("final_exam").set({
                    objective: this.data.objective,
                    subjective: this.data.subjective,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                }).then(() => alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤."));
            }
        };

        document.addEventListener('auth-ready', () => {
            app.init();
            // Also try to update on event, just in case
            updateHeaderBadge();
        });

        // Start polling immediately, don't wait for event
        updateHeaderBadge();

        function updateHeaderBadge() {
            const badge = document.getElementById('dash-year-badge');
            if (!badge) return;

            const update = async () => {
                // Force fetch if missing or looks like default (2025)
                // Actually, just fetch to be safe if it's not matching 2026? 
                // No, just try to use window.currentConfig. 
                // If it's 2025, maybe we should try to re-fetch?
                // Let's explicitly fetch from DB here to confirm.
                let cfg = window.currentConfig;

                // If cfg is missing or year is 2025 (suspect default), try explicitly fetching
                if (!cfg || cfg.year === '2025') {
                    try {
                        const doc = await window.db.collection('site_settings').doc('config').get();
                        if (doc.exists) {
                            cfg = doc.data();
                            window.currentConfig = cfg; // Update global
                        }
                    } catch (e) { console.error("Force fetch failed", e); }
                }

                if (cfg && cfg.year && cfg.semester) {
                    badge.className = "bg-blue-100 text-blue-700 font-bold px-3 py-1 rounded-lg text-sm border border-blue-200 ml-2";
                    badge.innerText = `${cfg.year}í•™ë…„ë„ ${cfg.semester}í•™ê¸°`;
                    return true;
                }
                return false;
            };

            // Try immediately (and async)
            update();

            // Polling as backup
            let retries = 0;
            const interval = setInterval(() => {
                retries++;
                // We don't await here, just trigger. 
                // But update() is now async. It's fine.
                // If update() returns true (promise), we stop? 
                // No, update() doesn't return value now. 
                // Let's make it return true if successful.
                update().then(res => { if (res) clearInterval(interval); });
                if (retries > 20) clearInterval(interval);
            }, 1000);
        }
    </script>
</body>

</html>