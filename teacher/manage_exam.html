
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì ìˆ˜ ê´€ë¦¬ - Westory Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="../assets/js/firebase-config.js"></script>
    <link rel="stylesheet" href="../assets/css/style.css">
    <script src="../assets/js/auth-manager.js"></script>

    <style>
        .choice-btn { width: 32px; height: 32px; border: 1px solid #d1d5db; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; font-weight: bold; color: #6b7280; }
        .choice-btn:hover { background-color: #f3f4f6; }
        .choice-btn.selected { background-color: #ef4444; color: white; border-color: #ef4444; }
        
        /* New Styles for Score Floater */
        .score-floater {
            position: fixed;
            top: 100px;
            right: 20px;
            width: 220px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            border: 1px solid #e5e7eb;
            z-index: 40;
            padding: 1.5rem;
            text-align: center;
        }

        .tab-btn-base { padding: 12px 24px; font-weight: 700; font-size: 0.95rem; border-bottom: 3px solid transparent; color: #6b7280; transition: all 0.2s; }
        .tab-btn-base:hover { color: #374151; background-color: #f9fafb; }
        .tab-btn-active { border-bottom-color: #2563eb; color: #2563eb; }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header injected by AuthManager -->

    <main class="max-w-7xl mx-auto px-4 py-8 min-h-[800px]">
        
        <div class="flex justify-between items-center mb-6">
            <div>
                <h1 class="text-2xl font-bold text-gray-800">ğŸ“Š ì ìˆ˜ ë° í‰ê°€ ê¸°ì¤€ ê´€ë¦¬</h1>
                <p class="text-sm text-gray-500 mt-1">ì„±ì  ì‚°ì¶œ ê¸°ì¤€ì„ ì„¤ì •í•˜ê³ , ì§€í•„í‰ê°€ ì •ë‹µì„ ê´€ë¦¬í•˜ì„¸ìš”.</p>
            </div>
        </div>

        <!-- Tabs -->
        <div class="flex border-b border-gray-200 mb-6 bg-white rounded-t-lg px-2">
            <button onclick="app.setTab('preview')" id="btn-tab-preview" class="tab-btn-base tab-btn-active">1. ì„±ì  ì‚°ì¶œ ê¸°ì¤€ (ìˆ˜í–‰í‰ê°€)</button>
            <button onclick="app.setTab('omr')" id="btn-tab-omr" class="tab-btn-base">2. ì§€í•„í‰ê°€ ì •ë‹µ (OMR)</button>
        </div>

        <!-- TAB 1: Grading Plan (Performance Assessment) -->
        <div id="tab-preview" class="tab-content min-h-[600px]">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Left: Form -->
                <div class="lg:col-span-1">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 sticky top-24">
                        <div class="flex justify-between items-center mb-4">
                            <h3 id="formTitle" class="font-bold text-lg text-gray-800">âœï¸ í‰ê°€ ê¸°ì¤€ ë“±ë¡</h3>
                            <button onclick="app.resetPlanForm()" class="text-xs text-gray-400 hover:text-gray-600">ì´ˆê¸°í™”</button>
                        </div>
                        
                        <input type="hidden" id="edit-plan-id">
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-xs font-bold text-gray-500 mb-1">ëŒ€ìƒ í•™ë…„</label>
                                <select id="plan-grade" class="w-full border rounded p-2 text-sm bg-gray-50">
                                    <option value="1">1í•™ë…„</option>
                                    <option value="2">2í•™ë…„</option>
                                    <option value="3">3í•™ë…„</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 mb-1">ê³¼ëª©ëª…</label>
                                <input type="text" id="plan-subject" placeholder="ì˜ˆ: ì—­ì‚¬, ì‚¬íšŒ" class="w-full border rounded p-2 text-sm">
                            </div>

                            <div>
                                <label class="block text-xs font-bold text-gray-500 mb-2">í‰ê°€ í•­ëª© (ë§Œì  / ë°˜ì˜ë¹„ìœ¨)</label>
                                <div id="criteriaList" class="space-y-2"></div>
                                <button onclick="app.addCriteriaRow()" class="w-full mt-2 border border-dashed border-gray-300 text-gray-500 text-sm py-2 rounded hover:bg-gray-50 font-bold">+ í•­ëª© ì¶”ê°€</button>
                            </div>

                            <button onclick="app.saveGradingPlan()" id="btn-save-plan" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 shadow-md transition">
                                ê¸°ì¤€ ì €ì¥í•˜ê¸°
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Right: List -->
                <div class="lg:col-span-2">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-gray-600">ë“±ë¡ëœ ê¸°ì¤€ ëª©ë¡</h3>
                        <span id="current-term-badge" class="text-sm font-extrabold text-blue-700 bg-blue-100 px-3 py-1.5 rounded border border-blue-200">
                            <!-- JS will inject e.g., 2026í•™ë…„ë„ 1í•™ê¸° -->
                        </span>
                    </div>
                    <div id="plan-list" class="space-y-4">
                        <div class="text-center py-10 text-gray-400">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB 2: OMR Config -->
        <div id="tab-omr" class="tab-content hidden relative min-h-[600px]">
            
            <!-- Floating Score Card -->
            <div class="score-floater">
                <p class="text-xs text-gray-400 font-bold uppercase mb-1">Total Score</p>
                <p class="text-4xl font-black text-red-500 mb-2" id="total-score">0</p>
                <div class="text-xs text-gray-500 font-bold bg-gray-100 rounded py-1">ì´ ë¬¸í•­ìˆ˜: <span id="total-count">0</span></div>
                <button onclick="omrApp.saveToDB()" class="w-full mt-4 bg-gray-800 text-white text-sm font-bold py-2 rounded hover:bg-gray-900 shadow-sm">
                    <i class="fas fa-save mr-1"></i> ì €ì¥
                </button>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 pr-[240px]">
                <!-- Objective Section -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                    <div class="flex justify-between items-center mb-6 pb-2 border-b">
                        <h2 class="font-bold text-lg text-gray-700">ê°ê´€ì‹ ë¬¸í•­</h2>
                        <button onclick="omrApp.addObjective()" class="text-sm bg-green-50 text-green-700 px-3 py-1 rounded font-bold hover:bg-green-100">+ ë¬¸í•­ ì¶”ê°€</button>
                    </div>
                    <div id="obj-list" class="space-y-3 max-h-[600px] overflow-y-auto pr-2"></div>
                </div>

                <!-- Subjective Section -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                    <div class="flex justify-between items-center mb-6 pb-2 border-b">
                        <h2 class="font-bold text-lg text-gray-700">ì„œìˆ í˜• ë¬¸í•­</h2>
                        <button onclick="omrApp.addSubjParent()" class="text-sm bg-indigo-50 text-indigo-700 px-3 py-1 rounded font-bold hover:bg-indigo-100">+ í° ë¬¸í•­ ì¶”ê°€</button>
                    </div>
                    <div id="subj-list" class="space-y-4 max-h-[600px] overflow-y-auto pr-2"></div>
                </div>
            </div>
        </div>

    </main>

    <!-- Footer injected by AuthManager -->

    <script>
        window.AuthManager.init('teacher');

        // --- Main App Controller ---
        const app = {
            plans: [],

            init: function() {
                this.updateSemesterBadge();
                this.loadGradingPlans();
                this.addCriteriaRow(); // Add initial row
            },

            updateSemesterBadge: function() {
                const c = window.currentConfig;
                const text = `${c.year}í•™ë…„ë„ ${c.semester}í•™ê¸°`;
                document.getElementById('current-term-badge').innerText = text;
            },

            setTab: function(tabName) {
                ['preview', 'omr'].forEach(t => {
                    const btn = document.getElementById('btn-tab-' + t);
                    const div = document.getElementById('tab-' + t);
                    if (t === tabName) {
                        btn.classList.add('tab-btn-active');
                        div.classList.remove('hidden');
                        if(t === 'omr') omrApp.init(); // Lazy load OMR
                    } else {
                        btn.classList.remove('tab-btn-active');
                        div.classList.add('hidden');
                    }
                });
            },

            // --- Grading Plan Logic ---
            loadGradingPlans: async function() {
                const listDiv = document.getElementById('plan-list');
                try {
                    // Changed: Use dynamic collection
                    const q = window.getCollection('grading_plans').orderBy('createdAt', 'desc');
                    const snap = await q.get();
                    this.plans = [];
                    snap.forEach(doc => this.plans.push({ id: doc.id, ...doc.data() }));
                    this.renderPlans();
                } catch(e) {
                    listDiv.innerHTML = '<div class="text-center text-red-400">ë¡œë“œ ì‹¤íŒ¨</div>';
                }
            },

            renderPlans: function() {
                const listDiv = document.getElementById('plan-list');
                if(this.plans.length === 0) {
                    listDiv.innerHTML = '<div class="text-center py-10 text-gray-400 bg-white rounded border border-dashed">ë“±ë¡ëœ ê¸°ì¤€ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                    return;
                }
                listDiv.innerHTML = this.plans.map(p => {
                    const itemsHtml = p.items.map(i => `<span class="inline-block bg-gray-100 text-gray-600 text-xs px-2 py-1 rounded mr-1 mb-1">${i.name} (${i.ratio}%)</span>`).join('');
                    return `
                        <div class="bg-white p-5 rounded-lg border border-gray-200 shadow-sm hover:shadow-md transition flex justify-between items-start group">
                            <div>
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="font-bold text-lg text-gray-800">${p.subject}</span>
                                    <span class="text-xs font-bold text-white bg-blue-500 px-2 py-0.5 rounded">${p.targetGrade||'2'}í•™ë…„</span>
                                </div>
                                <div>${itemsHtml}</div>
                            </div>
                            <div class="flex gap-2 opacity-0 group-hover:opacity-100 transition">
                                <button onclick="app.editPlan('${p.id}')" class="text-blue-500 hover:bg-blue-50 p-2 rounded"><i class="fas fa-edit"></i></button>
                                <button onclick="app.deletePlan('${p.id}')" class="text-red-500 hover:bg-red-50 p-2 rounded"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                    `;
                }).join('');
            },

            addCriteriaRow: function(data = null) {
                const div = document.createElement('div');
                div.className = 'criteria-row flex gap-1 items-center'; // Reduced gap
                // Optimized Inputs: Reduced widths (w-14) and padding to fit container
                div.innerHTML = `
                    <select class="c-type border rounded px-1 py-2 text-xs w-16 bg-gray-50">
                        <option value="ì§€í•„" ${data?.type==='ì§€í•„'?'selected':''}>ì§€í•„</option>
                        <option value="ìˆ˜í–‰" ${data?.type==='ìˆ˜í–‰'?'selected':''}>ìˆ˜í–‰</option>
                    </select>
                    <input type="text" placeholder="í•­ëª©ëª…" class="c-name border rounded px-2 py-2 text-xs flex-1 min-w-0" value="${data?.name||''}">
                    <input type="number" placeholder="ë§Œì " class="c-max border rounded px-1 py-2 text-xs w-12 text-center" value="${data?.maxScore||''}">
                    <input type="number" placeholder="%" class="c-ratio border rounded px-1 py-2 text-xs w-12 text-center" value="${data?.ratio||''}">
                    <button onclick="this.parentElement.remove()" class="text-gray-300 hover:text-red-500 w-6 flex justify-center"><i class="fas fa-times"></i></button>
                `;
                document.getElementById('criteriaList').appendChild(div);
            },

            saveGradingPlan: async function() {
                const id = document.getElementById('edit-plan-id').value;
                const subject = document.getElementById('plan-subject').value;
                const grade = document.getElementById('plan-grade').value;
                
                if(!subject) { alert("ê³¼ëª©ëª…ì„ ì…ë ¥í•˜ì„¸ìš”."); return; }
                
                const items = [];
                let totalRatio = 0;
                document.querySelectorAll('.criteria-row').forEach(row => {
                    const type = row.querySelector('.c-type').value;
                    const name = row.querySelector('.c-name').value;
                    const maxScore = Number(row.querySelector('.c-max').value);
                    const ratio = Number(row.querySelector('.c-ratio').value);
                    if(name && maxScore && ratio) {
                        items.push({ type, name, maxScore, ratio });
                        totalRatio += ratio;
                    }
                });

                if(items.length === 0) { alert("í•­ëª©ì„ í•˜ë‚˜ ì´ìƒ ì…ë ¥í•˜ì„¸ìš”."); return; }
                if(totalRatio !== 100) { alert(`ë¹„ìœ¨ í•©ê³„ëŠ” 100%ì—¬ì•¼ í•©ë‹ˆë‹¤. (í˜„ì¬ ${totalRatio}%)`); return; }

                const data = {
                    subject, 
                    targetGrade: grade,
                    items,
                    academicYear: window.currentConfig.year, // explicit save
                    semester: window.currentConfig.semester,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                // Changed: Use dynamic collection
                const col = window.getCollection('grading_plans');
                if(id) {
                    await col.doc(id).update(data);
                } else {
                    data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    await col.add(data);
                }
                
                alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
                this.resetPlanForm();
                this.loadGradingPlans();
            },

            editPlan: function(id) {
                const p = this.plans.find(x => x.id === id);
                if(!p) return;
                document.getElementById('edit-plan-id').value = id;
                document.getElementById('plan-subject').value = p.subject;
                document.getElementById('plan-grade').value = p.targetGrade || '2';
                
                const list = document.getElementById('criteriaList');
                list.innerHTML = '';
                p.items.forEach(i => this.addCriteriaRow(i));
                
                document.getElementById('formTitle').innerText = "ğŸ”„ í‰ê°€ ê¸°ì¤€ ìˆ˜ì •";
                document.getElementById('btn-save-plan').classList.remove('bg-blue-600');
                document.getElementById('btn-save-plan').classList.add('bg-amber-500');
                document.getElementById('btn-save-plan').innerText = "ìˆ˜ì •ì‚¬í•­ ì €ì¥";
            },
            
            deletePlan: async function(id) {
                if(confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                    await window.getCollection('grading_plans').doc(id).delete();
                    this.loadGradingPlans();
                }
            },

            resetPlanForm: function() {
                document.getElementById('edit-plan-id').value = '';
                document.getElementById('plan-subject').value = '';
                document.getElementById('criteriaList').innerHTML = '';
                this.addCriteriaRow();
                document.getElementById('formTitle').innerText = "âœï¸ í‰ê°€ ê¸°ì¤€ ë“±ë¡";
                document.getElementById('btn-save-plan').classList.add('bg-blue-600');
                document.getElementById('btn-save-plan').classList.remove('bg-amber-500');
                document.getElementById('btn-save-plan').innerText = "ê¸°ì¤€ ì €ì¥í•˜ê¸°";
            }
        };

        // --- OMR Controller (Lazy Loaded) ---
        const omrApp = {
            loaded: false,
            data: { objective: [], subjective: [] },

            init: function() {
                if(this.loaded) return;
                window.getCollection("exam_config").doc("final_exam").get()
                    .then((doc) => {
                        if (doc.exists) {
                            const d = doc.data();
                            this.data.objective = d.objective || [];
                            this.data.subjective = d.subjective || [];
                        }
                        this.render();
                        this.loaded = true;
                    });
            },

            render: function() {
                this.renderObjective();
                this.renderSubjective();
                this.updateTotal();
            },

            addObjective: function() { this.data.objective.push({ score: 4, answer: 0 }); this.render(); },
            removeObjective: function(idx) { this.data.objective.splice(idx, 1); this.render(); },
            setObjAnswer: function(idx, val) { this.data.objective[idx].answer = val; this.render(); },
            updateObjScore: function(idx, val) { this.data.objective[idx].score = Number(val); this.updateTotal(); },

            renderObjective: function() {
                const list = document.getElementById('obj-list');
                list.innerHTML = this.data.objective.map((item, i) => `
                    <div class="flex items-center gap-4 bg-gray-50 p-3 rounded border border-gray-100">
                        <span class="font-bold text-gray-500 w-8 text-center">${i+1}</span>
                        <div class="flex gap-1">
                            ${[1,2,3,4,5].map(n => `<button onclick="omrApp.setObjAnswer(${i}, ${n})" class="choice-btn ${item.answer===n ? 'selected':''}">${n}</button>`).join('')}
                        </div>
                        <input type="number" class="w-16 p-1 text-center border rounded text-sm font-bold text-blue-600" value="${item.score}" onchange="omrApp.updateObjScore(${i}, this.value)">
                        <span class="text-xs text-gray-400">ì </span>
                        <button onclick="omrApp.removeObjective(${i})" class="ml-auto text-gray-300 hover:text-red-500"><i class="fas fa-times"></i></button>
                    </div>
                `).join('');
            },

            addSubjParent: function() { this.data.subjective.push({ subItems: [] }); this.render(); },
            addSubjItem: function(pIdx) { this.data.subjective[pIdx].subItems.push({ score: 5, answer: "" }); this.render(); },
            removeSubjParent: function(idx) { this.data.subjective.splice(idx, 1); this.render(); },
            updateSubjField: function(pIdx, sIdx, field, val) {
                if(field === 'score') this.data.subjective[pIdx].subItems[sIdx].score = Number(val);
                else this.data.subjective[pIdx].subItems[sIdx][field] = val;
                this.updateTotal();
            },

            renderSubjective: function() {
                const list = document.getElementById('subj-list');
                list.innerHTML = this.data.subjective.map((parent, pIdx) => `
                    <div class="bg-gray-50 p-4 rounded border border-gray-200">
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-bold text-indigo-600">ì„œìˆ í˜• ${pIdx+1}ë²ˆ</span>
                            <div class="space-x-2">
                                <button onclick="omrApp.addSubjItem(${pIdx})" class="text-xs bg-white border px-2 py-1 rounded">+ ì†Œë¬¸í•­</button>
                                <button onclick="omrApp.removeSubjParent(${pIdx})" class="text-gray-400 hover:text-red-500"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                        <div class="space-y-2">
                            ${parent.subItems.map((sub, sIdx) => `
                                <div class="pl-4 border-l-2 border-indigo-100">
                                    <div class="flex items-center gap-2 mb-1">
                                        <span class="text-xs font-bold text-gray-500">(${sIdx+1})</span>
                                        <input type="number" class="w-14 p-1 text-center border rounded text-xs font-bold" value="${sub.score}" onchange="omrApp.updateSubjField(${pIdx}, ${sIdx}, 'score', this.value)">
                                        <span class="text-xs text-gray-400">ì </span>
                                    </div>
                                    <textarea class="w-full p-2 border rounded text-sm h-16" placeholder="ëª¨ë²” ë‹µì•ˆ ì…ë ¥" onchange="omrApp.updateSubjField(${pIdx}, ${sIdx}, 'answer', this.value)">${sub.answer || ''}</textarea>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `).join('');
            },

            updateTotal: function() {
                let s = 0, c = 0;
                this.data.objective.forEach(i => { s += (i.score||0); c++; });
                this.data.subjective.forEach(p => { p.subItems.forEach(i => { s += (i.score||0); c++; }); });
                document.getElementById('total-score').innerText = s;
                document.getElementById('total-count').innerText = c;
            },

            saveToDB: function() {
                window.getCollection("exam_config").doc("final_exam").set({
                    objective: this.data.objective,
                    subjective: this.data.subjective,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                }).then(() => alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤."));
            }
        };

        document.addEventListener('auth-ready', () => app.init());
    </script>
</body>
</html>
