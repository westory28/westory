
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>μ‹ν— μ±„μ  μ„¤μ • - Westory Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="../assets/js/firebase-config.js"></script>
    <link rel="stylesheet" href="../assets/css/style.css">
    <script src="../assets/js/auth-manager.js"></script>

    <style>
        .choice-btn { width: 32px; height: 32px; border: 1px solid #d1d5db; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; font-weight: bold; color: #6b7280; }
        .choice-btn:hover { background-color: #f3f4f6; }
        .choice-btn.selected { background-color: #ef4444; color: white; border-color: #ef4444; }
    </style>
</head>
<body>
    <!-- Header injected by AuthManager -->

    <main class="max-w-6xl mx-auto px-4 py-8">
        
        <div class="flex justify-between items-center mb-6">
            <div>
                <h1 class="text-2xl font-bold text-gray-800">π“ μ •λ‹µ λ° μ±„μ  κΈ°μ¤€ μ„¤μ •</h1>
                <p class="text-sm text-gray-500 mt-1">ν•™μƒλ“¤μ΄ [μ‹ν— μ±„μ ] λ©”λ‰΄μ—μ„ μ‚¬μ©ν•  μ •λ‹µ λ°μ΄ν„°λ¥Ό μ„¤μ •ν•©λ‹λ‹¤.</p>
            </div>
            <button onclick="configApp.saveToDB()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-bold shadow-lg transition flex items-center">
                <i class="fas fa-save mr-2"></i> μ„¤μ • μ €μ¥ν•κΈ°
            </button>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-20">
            <!-- Objective Section -->
            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                <div class="flex justify-between items-center mb-6 pb-2 border-b">
                    <h2 class="font-bold text-lg text-gray-700">κ°κ΄€μ‹ λ¬Έν•­</h2>
                    <button onclick="configApp.addObjective()" class="text-sm bg-green-50 text-green-700 px-3 py-1 rounded font-bold hover:bg-green-100">+ λ¬Έν•­ μ¶”κ°€</button>
                </div>
                <div id="obj-list" class="space-y-3 max-h-[600px] overflow-y-auto pr-2"></div>
            </div>

            <!-- Subjective Section -->
            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                <div class="flex justify-between items-center mb-6 pb-2 border-b">
                    <h2 class="font-bold text-lg text-gray-700">μ„μ ν• λ¬Έν•­</h2>
                    <button onclick="configApp.addSubjParent()" class="text-sm bg-indigo-50 text-indigo-700 px-3 py-1 rounded font-bold hover:bg-indigo-100">+ ν° λ¬Έν•­ μ¶”κ°€</button>
                </div>
                <div id="subj-list" class="space-y-4 max-h-[600px] overflow-y-auto pr-2"></div>
            </div>
        </div>

        <div class="fixed bottom-0 left-0 w-full bg-white border-t p-4 z-40 flex justify-center items-center shadow-lg gap-8">
            <div class="text-center"><p class="text-xs text-gray-500 font-bold">μ΄ λ¬Έν•­μ</p><p class="text-xl font-bold text-gray-800" id="total-count">0</p></div>
            <div class="text-center"><p class="text-xs text-gray-500 font-bold">μ΄ λ°°μ </p><p class="text-xl font-bold text-red-600" id="total-score">0</p></div>
        </div>
    </main>

    <!-- Footer injected by AuthManager -->

    <script>
        window.AuthManager.init('teacher');

        const configApp = {
            data: { objective: [], subjective: [] },

            init: function() {
                // Changed: Use dynamic collection for exam config
                window.getCollection("exam_config").doc("final_exam").get()
                    .then((doc) => {
                        if (doc.exists) {
                            const d = doc.data();
                            this.data.objective = d.objective || [];
                            this.data.subjective = d.subjective || [];
                        }
                        this.render();
                    });
            },

            render: function() {
                this.renderObjective();
                this.renderSubjective();
                this.updateTotal();
            },

            addObjective: function() { this.data.objective.push({ score: 4, answer: 0 }); this.render(); },
            removeObjective: function(idx) { this.data.objective.splice(idx, 1); this.render(); },
            setObjAnswer: function(idx, val) { this.data.objective[idx].answer = val; this.render(); },
            updateObjScore: function(idx, val) { this.data.objective[idx].score = Number(val); this.updateTotal(); },

            renderObjective: function() {
                const list = document.getElementById('obj-list');
                list.innerHTML = this.data.objective.map((item, i) => `
                    <div class="flex items-center gap-4 bg-gray-50 p-3 rounded border border-gray-100">
                        <span class="font-bold text-gray-500 w-8 text-center">${i+1}</span>
                        <div class="flex gap-1">
                            ${[1,2,3,4,5].map(n => `<button onclick="configApp.setObjAnswer(${i}, ${n})" class="choice-btn ${item.answer===n ? 'selected':''}">${n}</button>`).join('')}
                        </div>
                        <input type="number" class="w-16 p-1 text-center border rounded text-sm font-bold text-blue-600" value="${item.score}" onchange="configApp.updateObjScore(${i}, this.value)">
                        <span class="text-xs text-gray-400">μ </span>
                        <button onclick="configApp.removeObjective(${i})" class="ml-auto text-gray-300 hover:text-red-500"><i class="fas fa-times"></i></button>
                    </div>
                `).join('');
            },

            addSubjParent: function() { this.data.subjective.push({ subItems: [] }); this.render(); },
            addSubjItem: function(pIdx) { this.data.subjective[pIdx].subItems.push({ score: 5, answer: "" }); this.render(); },
            removeSubjParent: function(idx) { this.data.subjective.splice(idx, 1); this.render(); },
            updateSubjField: function(pIdx, sIdx, field, val) {
                if(field === 'score') this.data.subjective[pIdx].subItems[sIdx].score = Number(val);
                else this.data.subjective[pIdx].subItems[sIdx][field] = val;
                this.updateTotal();
            },

            renderSubjective: function() {
                const list = document.getElementById('subj-list');
                list.innerHTML = this.data.subjective.map((parent, pIdx) => `
                    <div class="bg-gray-50 p-4 rounded border border-gray-200">
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-bold text-indigo-600">μ„μ ν• ${pIdx+1}λ²</span>
                            <div class="space-x-2">
                                <button onclick="configApp.addSubjItem(${pIdx})" class="text-xs bg-white border px-2 py-1 rounded">+ μ†λ¬Έν•­</button>
                                <button onclick="configApp.removeSubjParent(${pIdx})" class="text-gray-400 hover:text-red-500"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                        <div class="space-y-2">
                            ${parent.subItems.map((sub, sIdx) => `
                                <div class="pl-4 border-l-2 border-indigo-100">
                                    <div class="flex items-center gap-2 mb-1">
                                        <span class="text-xs font-bold text-gray-500">(${sIdx+1})</span>
                                        <input type="number" class="w-14 p-1 text-center border rounded text-xs font-bold" value="${sub.score}" onchange="configApp.updateSubjField(${pIdx}, ${sIdx}, 'score', this.value)">
                                        <span class="text-xs text-gray-400">μ </span>
                                    </div>
                                    <textarea class="w-full p-2 border rounded text-sm h-16" placeholder="λ¨λ²” λ‹µμ• μ…λ ¥" onchange="configApp.updateSubjField(${pIdx}, ${sIdx}, 'answer', this.value)">${sub.answer || ''}</textarea>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `).join('');
            },

            updateTotal: function() {
                let s = 0, c = 0;
                this.data.objective.forEach(i => { s += (i.score||0); c++; });
                this.data.subjective.forEach(p => { p.subItems.forEach(i => { s += (i.score||0); c++; }); });
                document.getElementById('total-score').innerText = s;
                document.getElementById('total-count').innerText = c;
            },

            saveToDB: function() {
                // Changed: Use dynamic collection
                window.getCollection("exam_config").doc("final_exam").set({
                    objective: this.data.objective,
                    subjective: this.data.subjective,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                }).then(() => alert("μ €μ¥λμ—μµλ‹λ‹¤."));
            }
        };

        document.addEventListener('auth-ready', () => configApp.init());
    </script>
</body>
</html>
