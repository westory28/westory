
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê´€ë¦¬ì ì„¤ì • - Westory Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Quill Editor -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

    <!-- FullCalendar -->
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="../assets/js/firebase-config.js"></script>
    <link rel="stylesheet" href="../assets/css/style.css">
    <script src="../assets/js/auth-manager.js"></script>

    <style>
        .setting-sidebar { width: 250px; background-color: white; border-right: 1px solid #e5e7eb; display: flex; flex-direction: column; }
        .sidebar-item { padding: 1rem 1.5rem; color: #4b5563; font-weight: 600; font-size: 0.95rem; cursor: pointer; transition: all 0.2s; border-left: 4px solid transparent; }
        .sidebar-item:hover { background-color: #f9fafb; color: #1f2937; }
        .sidebar-item.active { background-color: #eff6ff; color: #2563eb; border-left-color: #2563eb; }
        .sidebar-item i { width: 24px; text-align: center; margin-right: 8px; }
        .content-area { flex: 1; padding: 2rem; overflow-y: auto; background-color: #f8fafc; }
        .section-panel { background: white; border-radius: 12px; border: 1px solid #e2e8f0; padding: 2rem; box-shadow: 0 1px 2px rgba(0,0,0,0.05); display: none; }
        .section-panel.active { display: block; animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Quill Overrides */
        .ql-container { font-family: 'Noto Sans KR', sans-serif; font-size: 1rem; height: 400px; }
        .ql-editor strong { font-weight: bold; }

        /* FullCalendar Overrides */
        .fc-toolbar-title { font-size: 1.25em !important; font-weight: 700; color: #1f2937; }
        .fc-button { background-color: #2563eb !important; border-color: #2563eb !important; font-weight: 600 !important; }
        .fc-button:hover { background-color: #1d4ed8 !important; border-color: #1d4ed8 !important; }
        .fc-button-active { background-color: #1e40af !important; border-color: #1e40af !important; }
        .fc-daygrid-event { cursor: pointer; border-radius: 4px; padding: 2px 4px; font-size: 0.85rem; font-weight: 600; border: none; }
        .modal-overlay { z-index: 9999; }
    </style>
</head>
<body class="bg-gray-50 h-screen flex flex-col overflow-hidden">
    <!-- Header injected by AuthManager -->

    <main class="flex flex-1 overflow-hidden">
        <!-- Sidebar -->
        <aside class="setting-sidebar">
            <div class="p-6 border-b border-gray-100">
                <h2 class="text-xl font-extrabold text-gray-800 flex items-center">
                    <i class="fas fa-cog text-gray-400 mr-2"></i> ê´€ë¦¬ì í˜ì´ì§€
                </h2>
            </div>
            <nav class="flex-1 py-4">
                <div class="sidebar-item active" onclick="app.switchTab('basic', this)">
                    <i class="fas fa-sliders-h"></i>ê¸°ë³¸ í™˜ê²½ ì„¤ì •
                </div>
                <div class="sidebar-item" onclick="app.switchTab('privacy', this)">
                    <i class="fas fa-user-shield"></i>ê°œì¸ì •ë³´ ë™ì˜ ê´€ë¦¬
                </div>
                <div class="sidebar-item" onclick="app.switchTab('schedule', this)">
                    <i class="fas fa-calendar-alt"></i>í•™ì‚¬ ì¼ì • ê´€ë¦¬
                </div>
            </nav>
        </aside>

        <!-- Content -->
        <div class="content-area">
            
            <!-- Tab 1: Basic Config -->
            <div id="tab-basic" class="section-panel active max-w-3xl">
                <div class="border-b border-gray-100 pb-4 mb-6">
                    <h3 class="text-lg font-bold text-gray-900">ì‹œìŠ¤í…œ ê¸°ë³¸ ì„¤ì •</h3>
                    <p class="text-sm text-gray-500 mt-1">í•™ë…„ë„, í•™ê¸° ë° ë©”ë‰´ í‘œì‹œ ì—¬ë¶€ë¥¼ ì œì–´í•©ë‹ˆë‹¤.</p>
                </div>

                <div class="space-y-6">
                    <div class="grid grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">í•™ë…„ë„</label>
                            <select id="global-config-year" class="w-full border border-gray-300 rounded-lg p-3 bg-gray-50 focus:ring-2 focus:ring-blue-500 font-bold text-gray-800 outline-none">
                                <option value="2025">2025í•™ë…„ë„</option>
                                <option value="2026">2026í•™ë…„ë„</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">í•™ê¸°</label>
                            <select id="global-config-sem" class="w-full border border-gray-300 rounded-lg p-3 bg-gray-50 focus:ring-2 focus:ring-blue-500 font-bold text-gray-800 outline-none">
                                <option value="1">1í•™ê¸°</option>
                                <option value="2">2í•™ê¸°</option>
                            </select>
                        </div>
                    </div>
                    <div class="bg-amber-50 text-amber-800 text-xs p-3 rounded-lg border border-amber-200 font-bold flex items-start gap-2">
                        <i class="fas fa-exclamation-triangle mt-0.5"></i>
                        <span>í•™ë…„ë„/í•™ê¸°ë¥¼ ë³€ê²½í•˜ë©´ í•´ë‹¹ ê¸°ê°„ì˜ ë°ì´í„°ë² ì´ìŠ¤ë¡œ ì¦‰ì‹œ ì „í™˜ë©ë‹ˆë‹¤. í•™ìƒë“¤ì˜ ë°ì´í„° ì¡°íšŒ ë²”ìœ„ë„ ë³€ê²½ë©ë‹ˆë‹¤.</span>
                    </div>

                    <div class="border-t border-gray-100 pt-6">
                        <label class="block text-sm font-bold text-gray-700 mb-4">í•™ìƒ ë©”ë‰´ í‘œì‹œ ì œì–´</label>
                        <div class="space-y-3">
                            <label class="flex items-center justify-between p-4 bg-gray-50 rounded-lg border border-gray-200 cursor-pointer hover:bg-gray-100 transition">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center"><i class="fas fa-gamepad"></i></div>
                                    <span class="font-bold text-gray-700">í‰ê°€(Quiz)</span>
                                </div>
                                <input type="checkbox" id="global-toggle-quiz" class="w-5 h-5 text-blue-600 rounded focus:ring-blue-500">
                            </label>
                            <label class="flex items-center justify-between p-4 bg-gray-50 rounded-lg border border-gray-200 cursor-pointer hover:bg-gray-100 transition">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 rounded-full bg-green-100 text-green-600 flex items-center justify-center"><i class="fas fa-chart-bar"></i></div>
                                    <span class="font-bold text-gray-700">ì ìˆ˜(Score)</span>
                                </div>
                                <input type="checkbox" id="global-toggle-score" class="w-5 h-5 text-blue-600 rounded focus:ring-blue-500">
                            </label>
                            <label class="flex items-center justify-between p-4 bg-gray-50 rounded-lg border border-gray-200 cursor-pointer hover:bg-gray-100 transition">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 rounded-full bg-purple-100 text-purple-600 flex items-center justify-center"><i class="fas fa-book-reader"></i></div>
                                    <span class="font-bold text-gray-700">ìˆ˜ì—…ìë£Œ(Lesson)</span>
                                </div>
                                <input type="checkbox" id="global-toggle-lesson" class="w-5 h-5 text-blue-600 rounded focus:ring-blue-500">
                            </label>
                        </div>
                    </div>

                    <div class="pt-4 text-right">
                        <button onclick="app.saveConfig()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-xl shadow-lg transition transform active:scale-95">
                            ì„¤ì • ì €ì¥
                        </button>
                    </div>
                </div>
            </div>

            <!-- Tab 2: Privacy Policy -->
            <div id="tab-privacy" class="section-panel max-w-4xl">
                <div class="border-b border-gray-100 pb-4 mb-6">
                    <h3 class="text-lg font-bold text-gray-900">ê°œì¸ì •ë³´ í™œìš© ë™ì˜ì„œ ê´€ë¦¬</h3>
                    <p class="text-sm text-gray-500 mt-1">í•™ìƒë“¤ì´ ìµœì´ˆ ì ‘ì† ì‹œ í™•ì¸í•˜ëŠ” ë™ì˜ì„œ ë¬¸êµ¬ë¥¼ ìˆ˜ì •í•©ë‹ˆë‹¤.</p>
                </div>

                <div class="space-y-4">
                    <div class="bg-blue-50 p-4 rounded-lg text-sm text-blue-800 border border-blue-100 mb-2">
                        <i class="fas fa-edit mr-1"></i> ì—ë””í„°ë¥¼ ì‚¬ìš©í•˜ì—¬ í…ìŠ¤íŠ¸ ì •ë ¬, êµµê¸°, í¬ê¸° ë“±ì„ ììœ ë¡­ê²Œ í¸ì§‘í•˜ì„¸ìš”.
                    </div>
                    
                    <!-- Quill Editor Container -->
                    <div class="bg-white rounded-xl shadow-inner">
                        <div id="privacy-editor"></div>
                    </div>
                    
                    <div class="flex justify-between items-center pt-4">
                        <button onclick="app.resetPrivacyDefault()" class="text-gray-500 text-sm hover:text-gray-800 underline">ê¸°ë³¸ ë¬¸êµ¬ë¡œ ì´ˆê¸°í™”</button>
                        <button onclick="app.savePrivacy()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-xl shadow-lg transition transform active:scale-95">
                            ë™ì˜ì„œ ë‚´ìš© ì €ì¥
                        </button>
                    </div>
                </div>
            </div>

            <!-- Tab 3: Schedule Management -->
            <div id="tab-schedule" class="section-panel h-full flex flex-col w-full" style="max-width: 100%;">
                <div class="border-b border-gray-100 pb-4 mb-4 flex flex-wrap justify-between items-end gap-4 shrink-0">
                    <div>
                        <h3 class="text-lg font-bold text-gray-900">í•™ì‚¬ ì¼ì • ê´€ë¦¬</h3>
                        <p class="text-sm text-gray-500 mt-1">ìˆ˜í–‰í‰ê°€, ì§€í•„í‰ê°€ ë“± ì£¼ìš” í•™ì‚¬ ì¼ì •ì„ ê´€ë¦¬í•©ë‹ˆë‹¤.</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-sm font-bold text-gray-600 hidden md:inline">í•„í„°:</span>
                        <select id="view-filter" onchange="app.refetchEvents()" class="border border-gray-300 rounded px-3 py-2 text-sm font-bold focus:border-blue-500 outline-none">
                            <option value="all">ì „ì²´ ì¼ì •</option>
                            <option value="common">ê³µí†µ ì¼ì •ë§Œ</option>
                            <option value="2-1">2-1ë°˜</option><option value="2-2">2-2ë°˜</option><option value="2-3">2-3ë°˜</option>
                            <option value="2-4">2-4ë°˜</option><option value="2-5">2-5ë°˜</option><option value="2-6">2-6ë°˜</option>
                            <option value="2-7">2-7ë°˜</option><option value="2-8">2-8ë°˜</option><option value="2-9">2-9ë°˜</option>
                            <option value="2-10">2-10ë°˜</option><option value="2-11">2-11ë°˜</option><option value="2-12">2-12ë°˜</option>
                        </select>
                        <button onclick="app.openEventModal()" class="bg-blue-600 text-white px-4 py-2 rounded text-sm font-bold hover:bg-blue-700 shadow-sm ml-2 whitespace-nowrap">
                            <i class="fas fa-plus mr-1"></i> ì¼ì • ì¶”ê°€
                        </button>
                    </div>
                </div>
                <div class="flex-1 bg-white rounded-xl shadow-inner border border-gray-200 p-2 overflow-hidden relative">
                    <div id="calendar" class="h-full"></div>
                </div>
            </div>

        </div>
    </main>

    <!-- Event Modal -->
    <div id="event-modal" class="fixed inset-0 hidden flex items-center justify-center bg-black bg-opacity-50 modal-overlay backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 mx-4 relative transform transition-all scale-100">
            <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2 flex items-center">
                <i class="fas fa-edit text-blue-500 mr-2"></i><span id="modal-title">ì¼ì • ë“±ë¡</span>
            </h3>
            
            <input type="hidden" id="event-id">
            
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">ì¼ì • ì œëª©</label>
                    <input type="text" id="event-title" class="w-full border rounded p-2 text-sm font-bold focus:border-blue-500 outline-none" placeholder="ì˜ˆ: ì—­ì‚¬ ìˆ˜í–‰í‰ê°€">
                </div>
                
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">ì‹œì‘ ë‚ ì§œ</label>
                        <input type="date" id="event-start" class="w-full border rounded p-2 text-sm">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">ì¢…ë£Œ ë‚ ì§œ (ì„ íƒ)</label>
                        <input type="date" id="event-end" class="w-full border rounded p-2 text-sm">
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">ì¼ì • ì¢…ë¥˜</label>
                    <select id="event-type" class="w-full border rounded p-2 text-sm font-bold bg-white">
                        <option value="performance">âš¡ ìˆ˜í–‰í‰ê°€ (Orange)</option>
                        <option value="exam">ğŸ”¥ ì§€í•„í‰ê°€ (Red)</option>
                        <option value="diagnosis">ğŸ“ ì§„ë‹¨í‰ê°€ (Blue)</option>
                        <option value="formative">âœï¸ í˜•ì„±í‰ê°€ (Blue)</option>
                        <option value="event">ğŸ‰ í–‰ì‚¬/ê¸°íƒ€ (Green)</option>
                    </select>
                </div>

                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-2">ëŒ€ìƒ ì„ íƒ</label>
                    <div class="flex gap-4 mb-2">
                        <label class="flex items-center cursor-pointer">
                            <input type="radio" name="targetType" value="common" checked onclick="app.toggleTargetClass(false)" class="w-4 h-4 text-blue-600">
                            <span class="ml-2 text-sm font-bold">ì „ì²´ ê³µí†µ</span>
                        </label>
                        <label class="flex items-center cursor-pointer">
                            <input type="radio" name="targetType" value="class" onclick="app.toggleTargetClass(true)" class="w-4 h-4 text-blue-600">
                            <span class="ml-2 text-sm font-bold">ë°˜ ì„ íƒ</span>
                        </label>
                    </div>
                    <select id="target-class" class="w-full border rounded p-2 text-sm bg-gray-50" disabled>
                        <option value="2-1">2-1ë°˜</option><option value="2-2">2-2ë°˜</option><option value="2-3">2-3ë°˜</option>
                        <option value="2-4">2-4ë°˜</option><option value="2-5">2-5ë°˜</option><option value="2-6">2-6ë°˜</option>
                        <option value="2-7">2-7ë°˜</option><option value="2-8">2-8ë°˜</option><option value="2-9">2-9ë°˜</option>
                        <option value="2-10">2-10ë°˜</option><option value="2-11">2-11ë°˜</option><option value="2-12">2-12ë°˜</option>
                    </select>
                </div>

                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">ìƒì„¸ ë‚´ìš©</label>
                    <textarea id="event-desc" class="w-full border rounded p-2 text-sm h-20 resize-none"></textarea>
                </div>
            </div>

            <div class="flex justify-between items-center mt-6 pt-4 border-t">
                <button type="button" onclick="app.deleteEvent()" id="btn-delete" class="text-red-500 font-bold text-sm hover:text-red-700 hidden"><i class="fas fa-trash mr-1"></i>ì‚­ì œ</button>
                <div class="flex gap-2 ml-auto">
                    <button onclick="app.closeEventModal()" class="px-4 py-2 bg-gray-100 text-gray-600 rounded font-bold text-sm hover:bg-gray-200">ì·¨ì†Œ</button>
                    <button onclick="app.saveEvent()" class="px-6 py-2 bg-blue-600 text-white rounded font-bold text-sm hover:bg-blue-700 shadow-md">ì €ì¥</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer injected by AuthManager -->

    <script>
        window.AuthManager.init('teacher');

        const app = {
            quill: null,
            calendar: null,
            colorMap: {
                'exam': '#ef4444',       // Red
                'performance': '#f97316', // Orange
                'event': '#10b981',       // Green
                'diagnosis': '#3b82f6',   // Blue
                'formative': '#3b82f6'    // Blue
            },

            init: function() {
                // Initialize Tabs
                document.addEventListener('auth-ready', () => {
                    this.initQuill();
                    this.loadConfig();
                    this.loadPrivacyText();
                    
                    // Check URL params to auto-switch tab
                    const params = new URLSearchParams(window.location.search);
                    const tab = params.get('tab');
                    if(tab === 'schedule') {
                        // Find the sidebar item with schedule logic (by text or ID if available)
                        const items = document.querySelectorAll('.sidebar-item');
                        items.forEach(item => {
                            if(item.textContent.includes("í•™ì‚¬ ì¼ì •")) this.switchTab('schedule', item);
                        });
                    }
                });
            },

            initQuill: function() {
                this.quill = new Quill('#privacy-editor', {
                    theme: 'snow',
                    modules: {
                        toolbar: [
                            [{ 'size': ['small', false, 'large', 'huge'] }], // Font Size
                            ['bold', 'italic', 'underline'], // Styling
                            [{ 'align': [] }], // Alignment
                            [{ 'list': 'ordered'}, { 'list': 'bullet' }], // Lists
                            ['clean'] // Remove Formatting
                        ]
                    },
                    placeholder: 'ì—¬ê¸°ì— ë™ì˜ì„œ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”...'
                });
            },

            switchTab: function(tabName, el) {
                // Sidebar Active State
                document.querySelectorAll('.sidebar-item').forEach(item => item.classList.remove('active'));
                el.classList.add('active');

                // Panel Visibility
                document.querySelectorAll('.section-panel').forEach(panel => panel.classList.remove('active'));
                document.getElementById('tab-' + tabName).classList.add('active');

                // Schedule Specific: Init or Render Calendar
                if(tabName === 'schedule') {
                    setTimeout(() => {
                        if(this.calendar) this.calendar.render();
                        else this.initCalendar();
                    }, 50);
                }
            },

            loadConfig: function() {
                const c = window.currentConfig;
                document.getElementById('global-config-year').value = c.year || '2025';
                document.getElementById('global-config-sem').value = c.semester || '2';
                document.getElementById('global-toggle-quiz').checked = c.showQuiz !== false;
                document.getElementById('global-toggle-score').checked = c.showScore !== false;
                document.getElementById('global-toggle-lesson').checked = c.showLesson !== false;
            },

            saveConfig: async function() {
                const newConfig = {
                    year: document.getElementById('global-config-year').value,
                    semester: document.getElementById('global-config-sem').value,
                    showQuiz: document.getElementById('global-toggle-quiz').checked,
                    showScore: document.getElementById('global-toggle-score').checked,
                    showLesson: document.getElementById('global-toggle-lesson').checked
                };
                try {
                    await window.db.collection('site_settings').doc('config').set(newConfig, { merge: true });
                    alert("ê¸°ë³¸ ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. ë³€ê²½ ì‚¬í•­ì„ ì ìš©í•˜ê¸° ìœ„í•´ í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.");
                    window.location.reload();
                } catch (e) { alert("ì„¤ì • ì €ì¥ ì‹¤íŒ¨: " + e.message); }
            },

            loadPrivacyText: async function() {
                try {
                    const doc = await window.db.collection('site_settings').doc('privacy').get();
                    if(doc.exists && doc.data().text) {
                        this.quill.clipboard.dangerouslyPasteHTML(doc.data().text);
                    } else {
                        this.resetPrivacyDefault(false); // Load default to editor but don't save
                    }
                } catch(e) { console.error(e); }
            },

            savePrivacy: async function() {
                // Get HTML content from Quill
                const text = this.quill.root.innerHTML;
                
                // Basic validation (Quill empty state often contains a single <p><br></p>)
                if(!text || text === '<p><br></p>') { alert("ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }
                
                try {
                    await window.db.collection('site_settings').doc('privacy').set({
                        text: text,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    alert("ê°œì¸ì •ë³´ í™œìš© ë™ì˜ì„œ ë‚´ìš©ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
                } catch(e) { alert("ì €ì¥ ì‹¤íŒ¨: " + e.message); }
            },

            resetPrivacyDefault: function(save = true) {
                const defaultText = `
                    <p class="ql-align-center"><strong style="font-size: large;">[ê°œì¸ì •ë³´ ìˆ˜ì§‘ ë° ì´ìš© ë™ì˜ì„œ]</strong></p>
                    <p><br></p>
                    <p><strong>1. ìˆ˜ì§‘ ë° ì´ìš© ëª©ì </strong></p>
                    <ul>
                        <li>í•™ìŠµ ê¸°ë¡ ê´€ë¦¬ ë° ì„±ì  ì‚°ì¶œ</li>
                        <li>ë§ì¶¤í˜• í•™ìŠµ ì½˜í…ì¸  ì œê³µ</li>
                        <li>êµì‚¬ì˜ í•™ìƒ ì§€ë„ ë° ìƒë‹´ ìë£Œ í™œìš©</li>
                    </ul>
                    <p><br></p>
                    <p><strong>2. ìˆ˜ì§‘ í•­ëª©</strong></p>
                    <p>ì´ë¦„, ì´ë©”ì¼, í•™ë…„, ë°˜, ë²ˆí˜¸, í€´ì¦ˆ ì‘ì‹œ ë‚´ì—­ ë° í•™ìŠµ í™œë™ ë°ì´í„°</p>
                    <p><br></p>
                    <p><strong>3. ë³´ìœ  ë° ì´ìš© ê¸°ê°„</strong></p>
                    <p>íšŒì› íƒˆí‡´ ì‹œ ë˜ëŠ” ì¡¸ì—… ì‹œê¹Œì§€ (ì¡¸ì—… í›„ ì§€ì²´ ì—†ì´ íŒŒê¸°)</p>
                `;
                
                this.quill.clipboard.dangerouslyPasteHTML(defaultText);
                
                if(save && confirm("ê¸°ë³¸ ë¬¸êµ¬ë¡œ ë˜ëŒë¦¬ê³  ë°”ë¡œ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                    this.savePrivacy();
                }
            },

            // --- Calendar Logic ---
            initCalendar: function() {
                const calendarEl = document.getElementById('calendar');
                this.calendar = new FullCalendar.Calendar(calendarEl, {
                    initialView: 'dayGridMonth',
                    locale: 'ko',
                    headerToolbar: {
                        left: 'prev,next today',
                        center: 'title',
                        right: 'dayGridMonth,listMonth'
                    },
                    events: this.fetchEvents.bind(this),
                    dateClick: (info) => this.openEventModal(null, info.dateStr),
                    eventClick: (info) => this.openEventModal(info.event),
                    height: '100%',
                    displayEventTime: false
                });
                this.calendar.render();
            },

            fetchEvents: async function(info, successCallback, failureCallback) {
                try {
                    const snapshot = await window.db.collection('calendar_events')
                        .where('start', '>=', info.startStr)
                        .where('start', '<', info.endStr)
                        .get();
                    
                    const events = [];
                    const filter = document.getElementById('view-filter').value;

                    snapshot.forEach(doc => {
                        const d = doc.data();
                        // Client-side filtering
                        if (filter !== 'all') {
                            if (filter === 'common') {
                                if (d.targetType !== 'common') return;
                            } else {
                                if (d.targetType === 'class' && d.targetClass !== filter) return;
                            }
                        }

                        events.push({
                            id: doc.id,
                            title: d.title,
                            start: d.start,
                            end: d.end || d.start,
                            backgroundColor: this.colorMap[d.eventType] || '#6b7280',
                            borderColor: this.colorMap[d.eventType] || '#6b7280',
                            extendedProps: d
                        });
                    });
                    successCallback(events);
                } catch(e) { console.error(e); failureCallback(e); }
            },

            refetchEvents: function() {
                if(this.calendar) this.calendar.refetchEvents();
            },

            // --- Event Modal Logic ---
            openEventModal: function(eventObj = null, dateStr = null) {
                document.getElementById('event-modal').classList.remove('hidden');
                document.getElementById('event-modal').classList.add('flex');
                
                if (eventObj) {
                    const p = eventObj.extendedProps;
                    document.getElementById('modal-title').innerText = "ì¼ì • ìˆ˜ì •";
                    document.getElementById('event-id').value = eventObj.id;
                    document.getElementById('event-title').value = p.title;
                    document.getElementById('event-start').value = p.start;
                    document.getElementById('event-end').value = p.end || '';
                    document.getElementById('event-type').value = p.eventType;
                    document.getElementById('event-desc').value = p.description || '';
                    
                    if (p.targetType === 'class') {
                        document.querySelector('input[name="targetType"][value="class"]').checked = true;
                        this.toggleTargetClass(true);
                        document.getElementById('target-class').value = p.targetClass;
                    } else {
                        document.querySelector('input[name="targetType"][value="common"]').checked = true;
                        this.toggleTargetClass(false);
                    }
                    document.getElementById('btn-delete').classList.remove('hidden');
                } else {
                    document.getElementById('modal-title').innerText = "ì¼ì • ë“±ë¡";
                    document.getElementById('event-id').value = '';
                    document.getElementById('event-title').value = '';
                    document.getElementById('event-start').value = dateStr || new Date().toISOString().split('T')[0];
                    document.getElementById('event-end').value = '';
                    document.getElementById('event-type').value = 'performance';
                    document.getElementById('event-desc').value = '';
                    document.querySelector('input[name="targetType"][value="common"]').checked = true;
                    this.toggleTargetClass(false);
                    document.getElementById('btn-delete').classList.add('hidden');
                }
            },

            closeEventModal: function() {
                document.getElementById('event-modal').classList.add('hidden');
                document.getElementById('event-modal').classList.remove('flex');
            },

            toggleTargetClass: function(enable) {
                const sel = document.getElementById('target-class');
                sel.disabled = !enable;
                if(enable) sel.classList.remove('bg-gray-50');
                else sel.classList.add('bg-gray-50');
            },

            saveEvent: async function() {
                const id = document.getElementById('event-id').value;
                const title = document.getElementById('event-title').value;
                const start = document.getElementById('event-start').value;
                if(!title || !start) { alert("ì œëª©ê³¼ ì‹œì‘ ë‚ ì§œëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤."); return; }

                const data = {
                    title: title,
                    start: start,
                    end: document.getElementById('event-end').value || null,
                    eventType: document.getElementById('event-type').value,
                    targetType: document.querySelector('input[name="targetType"]:checked').value,
                    targetClass: document.querySelector('input[name="targetType"]:checked').value === 'class' ? document.getElementById('target-class').value : null,
                    description: document.getElementById('event-desc').value,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                try {
                    if (id) {
                        await window.db.collection('calendar_events').doc(id).update(data);
                    } else {
                        data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                        await window.db.collection('calendar_events').add(data);
                    }
                    this.closeEventModal();
                    this.refetchEvents();
                } catch(e) { alert("ì €ì¥ ì‹¤íŒ¨: " + e.message); }
            },

            deleteEvent: async function() {
                const id = document.getElementById('event-id').value;
                if(!id) return;
                if(!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
                
                try {
                    await window.db.collection('calendar_events').doc(id).delete();
                    this.closeEventModal();
                    this.refetchEvents();
                } catch(e) { alert("ì‚­ì œ ì‹¤íŒ¨: " + e.message); }
            }
        };

        app.init();
    </script>
</body>
</html>
