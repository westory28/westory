
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í€´ì¦ˆ ê´€ë¦¬ - Westory Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="../assets/js/firebase-config.js"></script>
    <link rel="stylesheet" href="../assets/css/style.css">
    <script src="../assets/js/auth-manager.js"></script>

    <style>
        /* Table sort icon style */
        .sort-icon { margin-left: 4px; font-size: 0.8em; color: #9ca3af; }
        .sort-active { color: #2563eb; }
        .tab-btn-base { padding: 12px 24px; font-weight: 700; font-size: 0.95rem; border-bottom: 3px solid transparent; color: #6b7280; transition: all 0.2s; }
        .tab-btn-base:hover { color: #374151; background-color: #f9fafb; }
        .tab-btn-active { border-bottom-color: #2563eb; color: #2563eb; }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header injected by AuthManager -->

    <main class="w-full px-6 py-8">
        
        <!-- Improved Tabs -->
        <div class="flex border-b border-gray-200 mb-6 bg-white rounded-t-lg px-2">
            <button onclick="app.setTab('log')" id="btn-tab-log" class="tab-btn-base tab-btn-active">ğŸ“Š ì œì¶œ í˜„í™©</button>
            <button onclick="app.setTab('bank')" id="btn-tab-bank" class="tab-btn-base">ğŸ—„ï¸ ë¬¸ì œ ì€í–‰</button>
            <button onclick="app.setTab('add')" id="btn-tab-add" class="tab-btn-base">âœï¸ ë¬¸ì œ ë“±ë¡</button>
        </div>

        <!-- 1. Submission Status Tab -->
        <div id="tab-log" class="tab-content">
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                    <h2 class="text-xl font-bold text-gray-800">ì œì¶œ í˜„í™© <span id="log-count" class="text-sm font-normal text-gray-500"></span></h2>
                    <div class="flex gap-2">
                        <select id="select-class-trigger" onchange="app.loadByClass(this.value)" class="border rounded px-3 py-2 text-sm font-bold bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">ë°˜ ì„ íƒ</option>
                            <option value="all">ì „ì²´ (ìµœê·¼ 50ê°œ)</option>
                            <option value="1">1ë°˜</option><option value="2">2ë°˜</option><option value="3">3ë°˜</option>
                            <option value="4">4ë°˜</option><option value="5">5ë°˜</option><option value="6">6ë°˜</option>
                            <option value="7">7ë°˜</option><option value="8">8ë°˜</option><option value="9">9ë°˜</option>
                        </select>
                        <button onclick="app.loadByClass(document.getElementById('select-class-trigger').value)" class="bg-gray-100 p-2 rounded hover:bg-gray-200 text-gray-600" title="ìƒˆë¡œê³ ì¹¨"><i class="fas fa-sync-alt"></i></button>
                        <button onclick="app.deleteSelectedLogs()" class="bg-white border border-red-200 text-red-600 px-3 py-2 rounded text-sm font-bold hover:bg-red-50 transition">ì„ íƒ ì‚­ì œ</button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left whitespace-nowrap">
                        <thead class="bg-gray-50 text-gray-600 font-bold border-b">
                            <tr>
                                <th class="p-4 w-10"><input type="checkbox" onchange="document.querySelectorAll('.log-checkbox').forEach(cb=>cb.checked=this.checked)"></th>
                                <th class="p-4">ì‹œê°„</th>
                                <th class="p-4">í•™ìƒ</th>
                                <th class="p-4">ì ìˆ˜</th>
                                <th class="p-4">ìƒíƒœ</th>
                                <th class="p-4 text-center">ê´€ë¦¬</th>
                            </tr>
                        </thead>
                        <tbody id="log-body" class="divide-y divide-gray-100">
                            <tr><td colspan="6" class="p-8 text-center text-gray-400">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ë ¤ë©´ ë°˜ì„ ì„ íƒí•˜ì„¸ìš”.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 2. Question Bank Tab -->
        <div id="tab-bank" class="tab-content hidden">
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-gray-800">ë¬¸ì œ ì€í–‰ <span id="total-q-count" class="text-sm font-normal text-gray-500"></span></h2>
                    <div class="flex gap-2">
                        <select id="bank-filter-unit" onchange="app.renderBank()" class="border rounded px-3 py-2 text-sm bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="all">ì „ì²´ ë‹¨ì›</option>
                            <option value="I.">I. ê³ ëŒ€</option>
                            <option value="II.">II. ì¢…êµ</option>
                            <option value="III.">III. êµë¥˜</option>
                            <option value="IV.">IV. ì œêµ­ì£¼ì˜</option>
                            <option value="V.">V. ì„¸ê³„ëŒ€ì „</option>
                        </select>
                        <button onclick="app.deleteSelectedQuestions()" class="bg-white border border-red-200 text-red-600 px-3 py-2 rounded text-sm font-bold hover:bg-red-50 transition">ì„ íƒ ì‚­ì œ</button>
                    </div>
                </div>
                <div class="overflow-x-auto max-h-[700px]">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-gray-50 text-gray-600 font-bold sticky top-0 shadow-sm z-10">
                            <tr>
                                <th class="p-3 bg-gray-50 w-10"><input type="checkbox" onchange="document.querySelectorAll('.q-checkbox').forEach(cb=>cb.checked=this.checked)"></th>
                                <th class="p-3 bg-gray-50 w-20 cursor-pointer hover:bg-gray-100" onclick="app.sortBank('id')">ID <i id="sort-icon-id" class="fas fa-sort sort-icon"></i></th>
                                <th class="p-3 bg-gray-50 cursor-pointer hover:bg-gray-100" onclick="app.sortBank('unit')">ë‹¨ì› <i id="sort-icon-unit" class="fas fa-sort sort-icon"></i></th>
                                <th class="p-3 bg-gray-50 cursor-pointer hover:bg-gray-100" onclick="app.sortBank('question')">ë¬¸ì œ ë‚´ìš© <i id="sort-icon-question" class="fas fa-sort sort-icon"></i></th>
                                <th class="p-3 bg-gray-50 w-24 cursor-pointer hover:bg-gray-100" onclick="app.sortBank('type')">ìœ í˜• <i id="sort-icon-type" class="fas fa-sort sort-icon"></i></th>
                                <th class="p-3 bg-gray-50 w-20 text-center">ì •ë‹µ</th>
                                <th class="p-3 bg-gray-50 w-24 text-center">ì •ë‹µë¥ </th>
                            </tr>
                        </thead>
                        <tbody id="bank-body" class="divide-y divide-gray-100 bg-white"></tbody>
                    </table>
                </div>
                <div class="mt-4 text-xs text-gray-400 text-right">* ë¬¸ì œë¥¼ í´ë¦­í•˜ë©´ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
            </div>
        </div>

        <!-- 3. Add Question Tab -->
        <div id="tab-add" class="tab-content hidden">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <!-- Manual Add Form -->
                <div class="md:col-span-2 bg-white p-6 rounded-xl shadow-sm border border-gray-200 relative">
                    <input type="hidden" id="edit-q-id"> <!-- Hidden ID for Edit Mode -->
                    <div class="flex justify-between items-center mb-6 border-b pb-4">
                        <h3 class="font-bold text-lg text-gray-800" id="form-title">ğŸ“ ì§ì ‘ ë§Œë“¤ê¸°</h3>
                        <button onclick="app.clearForm()" class="text-xs text-gray-400 hover:text-gray-600"><i class="fas fa-undo mr-1"></i>ì´ˆê¸°í™”</button>
                    </div>
                    
                    <div class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-gray-500 mb-1">ë‹¨ì›</label>
                                <select id="new-q-unit" class="w-full p-3 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                                    <option>I. ë¬¸ëª…ì˜ ë°œìƒ</option>
                                    <option>II. ì¢…êµì™€ ë¬¸í™”</option>
                                    <option>III. ì§€ì—­ ì„¸ê³„ì˜ êµë¥˜</option>
                                    <option>IV. ì œêµ­ì£¼ì˜ ì¹¨ëµ</option>
                                    <option>V. ì„¸ê³„ ëŒ€ì „</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 mb-1">ìœ í˜•</label>
                                <select id="new-q-type" class="w-full p-3 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                                    <option value="choice">ê°ê´€ì‹</option>
                                    <option value="ox">O/X</option>
                                    <option value="word">ë‹¨ë‹µí˜•</option>
                                    <option value="order">ìˆœì„œë‚˜ì—´</option>
                                </select>
                            </div>
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">ë¬¸ì œ ë‚´ìš©</label>
                            <textarea id="new-q-text" class="w-full p-3 border rounded-lg text-sm h-32 focus:ring-2 focus:ring-blue-500 outline-none resize-none" placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">ë³´ê¸° (ì½¤ë§ˆ , ë¡œ êµ¬ë¶„ / ê°ê´€ì‹Â·ìˆœì„œë‚˜ì—´ ì „ìš©)</label>
                            <input type="text" id="new-q-options" class="w-full p-3 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none" placeholder="ì˜ˆ: ê¸°ì›ì „ 8000ë…„, ê¸°ì›ì „ 2333ë…„, ...">
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-gray-500 mb-1">ì •ë‹µ</label>
                                <input type="text" id="new-q-answer" class="w-full p-3 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none font-bold text-blue-600" placeholder="ì •ë‹µ ì…ë ¥">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 mb-1">í•´ì„¤ (ì„ íƒ)</label>
                                <input type="text" id="new-q-exp" class="w-full p-3 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none" placeholder="í•´ì„¤ ì…ë ¥">
                            </div>
                        </div>

                        <button onclick="app.saveCustomQuestion()" id="btn-save-q" class="w-full bg-blue-600 text-white font-bold py-4 rounded-lg hover:bg-blue-700 transition shadow-lg mt-4">
                            ë“±ë¡í•˜ê¸°
                        </button>
                    </div>
                </div>
                
                <!-- Excel Upload -->
                <div class="bg-green-50 p-6 rounded-xl border border-green-200 h-fit">
                    <h3 class="font-bold text-lg mb-4 text-green-800 border-b border-green-200 pb-2">ğŸ“— ì—‘ì…€ ëŒ€ëŸ‰ ì—…ë¡œë“œ</h3>
                    <div class="mb-4 text-xs text-green-700 leading-relaxed">
                        <p class="mb-2"><strong>[í•„ìˆ˜ ì»¬ëŸ¼]</strong><br>unit, type, question, options, answer, explanation</p>
                        <p>ì—‘ì…€ íŒŒì¼(.xlsx)ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ ì„ íƒí•˜ì—¬ í•œ ë²ˆì— ë“±ë¡í•˜ì„¸ìš”.</p>
                    </div>
                    <input type="file" id="excel-file" accept=".xlsx" class="block w-full text-sm text-slate-500 mb-6 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-100 file:text-green-700 hover:file:bg-green-200 cursor-pointer"/>
                    <button onclick="app.uploadExcel()" class="w-full bg-green-600 text-white font-bold py-3 rounded-lg hover:bg-green-700 transition shadow-md">
                        ì—…ë¡œë“œ ì‹œì‘
                    </button>
                </div>
            </div>
        </div>

    </main>

    <!-- Footer injected by AuthManager -->

    <script>
        window.AuthManager.init('teacher');

        const app = {
            state: { questions: [], logs: [], sortField: 'id', sortOrder: 'asc' },

            init: function() {
                this.loadQuestions();
            },

            setTab: function(tabName) {
                // Update Tab Styles
                ['log', 'bank', 'add'].forEach(t => {
                    const btn = document.getElementById('btn-tab-' + t);
                    const div = document.getElementById('tab-' + t);
                    
                    if (t === tabName) {
                        btn.classList.add('tab-btn-active');
                        div.classList.remove('hidden');
                    } else {
                        btn.classList.remove('tab-btn-active');
                        div.classList.add('hidden');
                    }
                });

                // Clear form if switching to 'add' without edit intent (simple heuristic)
                if (tabName === 'add' && !document.getElementById('edit-q-id').value) {
                    this.clearForm();
                }
            },

            loadByClass: function(cls) {
                if(!cls) return;
                const tbody = document.getElementById('log-body');
                tbody.innerHTML = '<tr><td colspan="6" class="p-8 text-center"><div class="loader-spinner mx-auto mb-2"></div>ë¡œë”© ì¤‘...</td></tr>';

                let q = window.db.collection('quiz_results').orderBy('timestamp', 'desc');
                if (cls !== 'all') q = q.where('class', '==', parseInt(cls) || cls);
                else q = q.limit(50);

                q.get().then(snap => {
                    let html = '';
                    snap.forEach(doc => {
                        const d = doc.data();
                        html += `
                        <tr class="hover:bg-blue-50 transition border-b border-gray-100 last:border-0">
                            <td class="p-4"><input type="checkbox" class="log-checkbox w-4 h-4" value="${doc.id}"></td>
                            <td class="p-4 text-xs text-gray-500 font-mono">${d.timeString}</td>
                            <td class="p-4 font-bold text-gray-700">${d.class}ë°˜ ${d.number}ë²ˆ ${d.name}</td>
                            <td class="p-4 font-bold text-blue-600">${d.score}ì </td>
                            <td class="p-4 text-xs"><span class="px-2 py-1 rounded ${d.status==='ì™„ë£Œ'?'bg-green-100 text-green-700':'bg-red-100 text-red-700'}">${d.status}</span></td>
                            <td class="p-4 text-center"><button onclick="app.deleteLog('${doc.id}')" class="text-gray-300 hover:text-red-500 transition"><i class="fas fa-trash"></i></button></td>
                        </tr>`;
                    });
                    tbody.innerHTML = html || '<tr><td colspan="6" class="p-8 text-center text-gray-400">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                    document.getElementById('log-count').innerText = `(${snap.size}ê±´)`;
                });
            },

            loadQuestions: function() {
                window.db.collection('quiz_questions').get().then(snap => {
                    this.state.questions = [];
                    snap.forEach(doc => this.state.questions.push({ ...doc.data(), id: parseInt(doc.id) }));
                    this.renderBank();
                });
            },

            sortBank: function(field) {
                if (this.state.sortField === field) {
                    this.state.sortOrder = this.state.sortOrder === 'asc' ? 'desc' : 'asc';
                } else {
                    this.state.sortField = field;
                    this.state.sortOrder = 'asc';
                }
                this.renderBank();
            },

            renderBank: function() {
                // Filter
                const filter = document.getElementById('bank-filter-unit').value;
                let list = (filter === 'all') ? this.state.questions : this.state.questions.filter(q => (q.unit||"").includes(filter));
                
                // Sort
                const field = this.state.sortField;
                const order = this.state.sortOrder === 'asc' ? 1 : -1;
                list.sort((a, b) => {
                    let va = a[field], vb = b[field];
                    if (typeof va === 'string') va = va.toLowerCase();
                    if (typeof vb === 'string') vb = vb.toLowerCase();
                    if (va < vb) return -1 * order;
                    if (va > vb) return 1 * order;
                    return 0;
                });

                document.getElementById('total-q-count').innerText = `(${list.length}ë¬¸í•­)`;
                
                // Update Icons
                document.querySelectorAll('.sort-icon').forEach(el => { el.className = 'fas fa-sort sort-icon'; });
                const icon = document.getElementById('sort-icon-' + field);
                if(icon) icon.className = `fas fa-sort-${this.state.sortOrder === 'asc' ? 'up' : 'down'} sort-icon sort-active`;

                // Render Table
                document.getElementById('bank-body').innerHTML = list.map(q => `
                    <tr class="hover:bg-blue-50 border-b border-gray-100 last:border-0 cursor-pointer group" onclick="app.editQuestion(${q.id})">
                        <td class="p-3" onclick="event.stopPropagation()"><input type="checkbox" class="q-checkbox w-4 h-4" value="${q.id}"></td>
                        <td class="p-3 text-xs font-bold text-gray-500 font-mono group-hover:text-blue-600">${q.id}</td>
                        <td class="p-3 text-xs text-gray-500">${q.unit || '-'}</td>
                        <td class="p-3 text-sm font-medium text-gray-800 truncate max-w-xs group-hover:text-blue-700">${q.question}</td>
                        <td class="p-3 text-xs"><span class="bg-gray-100 text-gray-600 px-2 py-1 rounded border">${q.type}</span></td>
                        <td class="p-3 text-xs font-bold text-center text-blue-600">${q.answer}</td>
                        <td class="p-3 text-xs text-gray-500 text-center">${q.stat_total ? Math.round((q.stat_correct/q.stat_total)*100)+'%' : '-'}</td>
                    </tr>
                `).join('');
            },

            editQuestion: function(id) {
                const q = this.state.questions.find(item => item.id === id);
                if (!q) return;

                document.getElementById('edit-q-id').value = q.id;
                document.getElementById('new-q-unit').value = q.unit;
                document.getElementById('new-q-type').value = q.type;
                document.getElementById('new-q-text').value = q.question;
                document.getElementById('new-q-options').value = (q.options || []).join(', ');
                document.getElementById('new-q-answer').value = q.answer;
                document.getElementById('new-q-exp').value = q.explanation || '';
                
                document.getElementById('form-title').innerHTML = `âœï¸ ë¬¸ì œ ìˆ˜ì • (ID: ${q.id})`;
                document.getElementById('btn-save-q').innerText = "ìˆ˜ì •ì‚¬í•­ ì €ì¥";
                document.getElementById('btn-save-q').classList.remove('bg-blue-600');
                document.getElementById('btn-save-q').classList.add('bg-indigo-600');
                
                this.setTab('add');
            },

            clearForm: function() {
                document.getElementById('edit-q-id').value = '';
                document.getElementById('form-title').innerHTML = 'ğŸ“ ì§ì ‘ ë§Œë“¤ê¸°';
                document.getElementById('new-q-text').value = '';
                document.getElementById('new-q-options').value = '';
                document.getElementById('new-q-answer').value = '';
                document.getElementById('new-q-exp').value = '';
                document.getElementById('btn-save-q').innerText = "ë“±ë¡í•˜ê¸°";
                document.getElementById('btn-save-q').classList.add('bg-blue-600');
                document.getElementById('btn-save-q').classList.remove('bg-indigo-600');
            },

            saveCustomQuestion: function() {
                const editId = document.getElementById('edit-q-id').value;
                const isEdit = !!editId;
                
                // Calculate ID: if edit use existing, else max + 1
                let id = isEdit ? parseInt(editId) : 1;
                if (!isEdit && this.state.questions.length > 0) {
                    id = Math.max(...this.state.questions.map(q=>q.id)) + 1;
                }
                
                const data = {
                    id: id,
                    unit: document.getElementById('new-q-unit').value,
                    type: document.getElementById('new-q-type').value,
                    question: document.getElementById('new-q-text').value,
                    options: document.getElementById('new-q-options').value.split(',').map(s=>s.trim()).filter(s=>s),
                    answer: document.getElementById('new-q-answer').value,
                    explanation: document.getElementById('new-q-exp').value
                };

                window.db.collection('quiz_questions').doc(String(id)).set(data).then(() => {
                    alert(isEdit ? 'ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    this.clearForm();
                    this.loadQuestions();
                    if(isEdit) this.setTab('bank'); // Return to bank after edit
                }).catch(err => alert("ì €ì¥ ì‹¤íŒ¨: " + err.message));
            },

            deleteSelectedLogs: function() {
                const checked = document.querySelectorAll('.log-checkbox:checked');
                if(!checked.length) return;
                if(!confirm(`${checked.length}ê°œì˜ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
                
                const batch = window.db.batch();
                checked.forEach(cb => batch.delete(window.db.collection('quiz_results').doc(cb.value)));
                
                batch.commit().then(() => {
                    this.loadByClass(document.getElementById('select-class-trigger').value);
                });
            },
            
            deleteLog: function(id) {
                if(confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                    window.db.collection('quiz_results').doc(id).delete().then(() => {
                        this.loadByClass(document.getElementById('select-class-trigger').value);
                    });
                }
            },

            deleteSelectedQuestions: function() {
                const checked = document.querySelectorAll('.q-checkbox:checked');
                if(!checked.length) return;
                if(!confirm(`ì„ íƒí•œ ${checked.length}ê°œì˜ ë¬¸ì œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
                
                const batch = window.db.batch();
                checked.forEach(cb => batch.delete(window.db.collection('quiz_questions').doc(cb.value)));
                
                batch.commit().then(() => this.loadQuestions());
            }
        };

        document.addEventListener('auth-ready', () => app.init());
    </script>
</body>
</html>
