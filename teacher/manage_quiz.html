<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í€´ì¦ˆ ê´€ë¦¬ - Westory Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="../assets/js/firebase-config.js"></script>
    <link rel="stylesheet" href="../assets/css/style.css">
    <script src="../assets/js/auth-manager.js"></script>

    <style>
        .tab-btn { @apply px-6 py-2 rounded-full text-sm font-bold transition cursor-pointer; }
        .tab-btn.active { @apply bg-blue-600 text-white shadow-md; }
        .tab-btn.inactive { @apply bg-white text-gray-500 hover:bg-gray-100; }
    </style>
</head>
<body>
    <!-- Header injected by AuthManager -->

    <main class="max-w-7xl mx-auto px-4 py-8">
        
        <!-- Tabs -->
        <div class="flex justify-center mb-8 gap-2">
            <button onclick="app.setTab('log')" id="btn-tab-log" class="tab-btn active">ğŸ“Š ì‹¤ì‹œê°„ ê¸°ë¡</button>
            <button onclick="app.setTab('bank')" id="btn-tab-bank" class="tab-btn inactive">ğŸ—„ï¸ ë¬¸ì œ ì€í–‰</button>
            <button onclick="app.setTab('add')" id="btn-tab-add" class="tab-btn inactive">âœï¸ ë¬¸ì œ ë“±ë¡</button>
        </div>

        <!-- 1. Realtime Log Tab -->
        <div id="tab-log" class="tab-content">
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                    <h2 class="text-xl font-bold text-gray-800">ì œì¶œ í˜„í™© <span id="log-count" class="text-sm font-normal text-gray-500"></span></h2>
                    <div class="flex gap-2">
                        <select id="select-class-trigger" onchange="app.loadByClass(this.value)" class="border rounded px-3 py-2 text-sm font-bold bg-gray-50">
                            <option value="">ë°˜ ì„ íƒ</option>
                            <option value="all">ì „ì²´ (ìµœê·¼ 50ê°œ)</option>
                            <option value="1">1ë°˜</option><option value="2">2ë°˜</option><option value="3">3ë°˜</option>
                            <option value="4">4ë°˜</option><option value="5">5ë°˜</option><option value="6">6ë°˜</option>
                            <option value="7">7ë°˜</option><option value="8">8ë°˜</option><option value="9">9ë°˜</option>
                        </select>
                        <button onclick="app.loadByClass(document.getElementById('select-class-trigger').value)" class="bg-gray-100 p-2 rounded hover:bg-gray-200"><i class="fas fa-sync-alt"></i></button>
                        <button onclick="app.deleteSelectedLogs()" class="bg-red-50 text-red-600 px-3 py-2 rounded text-sm font-bold hover:bg-red-100">ì„ íƒ ì‚­ì œ</button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-gray-50 text-gray-600 font-bold border-b">
                            <tr>
                                <th class="p-4 w-10"><input type="checkbox" onchange="document.querySelectorAll('.log-checkbox').forEach(cb=>cb.checked=this.checked)"></th>
                                <th class="p-4">ì‹œê°„</th>
                                <th class="p-4">í•™ìƒ</th>
                                <th class="p-4">ì ìˆ˜</th>
                                <th class="p-4">ìƒíƒœ</th>
                                <th class="p-4 text-center">ì‚­ì œ</th>
                            </tr>
                        </thead>
                        <tbody id="log-body" class="divide-y">
                            <tr><td colspan="6" class="p-8 text-center text-gray-400">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ë ¤ë©´ ë°˜ì„ ì„ íƒí•˜ì„¸ìš”.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 2. Question Bank Tab -->
        <div id="tab-bank" class="tab-content hidden">
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-gray-800">ë“±ë¡ëœ ë¬¸ì œ <span id="total-q-count" class="text-sm font-normal text-gray-500"></span></h2>
                    <div class="flex gap-2">
                        <select id="bank-filter-unit" onchange="app.renderBank()" class="border rounded px-2 py-1 text-sm"><option value="all">ì „ì²´ ë‹¨ì›</option><option value="I.">I. ê³ ëŒ€</option><option value="II.">II. ì¢…êµ</option><option value="III.">III. êµë¥˜</option><option value="IV.">IV. ì œêµ­ì£¼ì˜</option><option value="V.">V. ì„¸ê³„ëŒ€ì „</option></select>
                        <button onclick="app.deleteSelectedQuestions()" class="bg-red-50 text-red-600 px-3 py-1 rounded text-sm font-bold border border-red-200">ì‚­ì œ</button>
                    </div>
                </div>
                <div class="overflow-x-auto max-h-[600px]">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-gray-50 text-gray-600 font-bold sticky top-0">
                            <tr>
                                <th class="p-3 w-10"><input type="checkbox" onchange="document.querySelectorAll('.q-checkbox').forEach(cb=>cb.checked=this.checked)"></th>
                                <th class="p-3 w-12">ID</th>
                                <th class="p-3">ë¬¸ì œ ë‚´ìš©</th>
                                <th class="p-3 w-20">ìœ í˜•</th>
                                <th class="p-3 w-20">ì •ë‹µ</th>
                                <th class="p-3 w-20">ì •ë‹µë¥ </th>
                            </tr>
                        </thead>
                        <tbody id="bank-body" class="divide-y"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 3. Add Question Tab -->
        <div id="tab-add" class="tab-content hidden">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Manual Add -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                    <h3 class="font-bold text-lg mb-4 text-gray-800">ğŸ“ ì§ì ‘ ë§Œë“¤ê¸°</h3>
                    <div class="space-y-3">
                        <select id="new-q-unit" class="w-full p-2 border rounded text-sm"><option>I. ë¬¸ëª…ì˜ ë°œìƒ</option><option>IV. ì œêµ­ì£¼ì˜ ì¹¨ëµ</option><option>V. ì„¸ê³„ ëŒ€ì „</option></select>
                        <select id="new-q-type" class="w-full p-2 border rounded text-sm"><option value="choice">ê°ê´€ì‹</option><option value="ox">O/X</option><option value="word">ë‹¨ë‹µí˜•</option></select>
                        <textarea id="new-q-text" class="w-full p-2 border rounded text-sm h-24" placeholder="ë¬¸ì œ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                        <input type="text" id="new-q-options" class="w-full p-2 border rounded text-sm" placeholder="ë³´ê¸° (ì½¤ë§ˆë¡œ êµ¬ë¶„, ê°ê´€ì‹ë§Œ)">
                        <input type="text" id="new-q-answer" class="w-full p-2 border rounded text-sm" placeholder="ì •ë‹µ">
                        <input type="text" id="new-q-exp" class="w-full p-2 border rounded text-sm" placeholder="í•´ì„¤">
                        <button onclick="app.addCustomQuestion()" class="w-full bg-blue-600 text-white font-bold py-3 rounded hover:bg-blue-700">ë“±ë¡í•˜ê¸°</button>
                    </div>
                </div>
                
                <!-- Excel Upload -->
                <div class="bg-green-50 p-6 rounded-xl border border-green-200">
                    <h3 class="font-bold text-lg mb-4 text-green-800">ğŸ“— ì—‘ì…€ ì—…ë¡œë“œ</h3>
                    <input type="file" id="excel-file" accept=".xlsx" class="block w-full text-sm text-slate-500 mb-6 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-100 file:text-green-700 hover:file:bg-green-200"/>
                    <button onclick="app.uploadExcel()" class="w-full bg-green-600 text-white font-bold py-3 rounded hover:bg-green-700">ì—…ë¡œë“œ ì‹œì‘</button>
                </div>
            </div>
        </div>

    </main>

    <script>
        window.AuthManager.init('teacher');

        const app = {
            state: { questions: [], logs: [] },

            init: function() {
                this.loadQuestions();
            },

            setTab: function(tabName) {
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.classList.remove('active');
                    btn.classList.add('inactive');
                });
                document.getElementById('btn-tab-' + tabName).classList.add('active');
                document.getElementById('btn-tab-' + tabName).classList.remove('inactive');

                document.querySelectorAll('.tab-content').forEach(div => div.classList.add('hidden'));
                document.getElementById('tab-' + tabName).classList.remove('hidden');
            },

            loadByClass: function(cls) {
                if(!cls) return;
                let q = window.db.collection('quiz_results').orderBy('timestamp', 'desc');
                if (cls !== 'all') q = q.where('class', '==', parseInt(cls) || cls); // Try both number and string
                else q = q.limit(50);

                q.get().then(snap => {
                    let html = '';
                    snap.forEach(doc => {
                        const d = doc.data();
                        html += `<tr class="hover:bg-gray-50"><td class="p-4"><input type="checkbox" class="log-checkbox" value="${doc.id}"></td><td class="p-4 text-xs text-gray-500">${d.timeString}</td><td class="p-4 font-bold text-gray-700">${d.class}ë°˜ ${d.number}ë²ˆ ${d.name}</td><td class="p-4 font-bold text-blue-600">${d.score}ì </td><td class="p-4 text-xs">${d.status}</td><td class="p-4 text-center"><button onclick="app.deleteLog('${doc.id}')" class="text-red-400 hover:text-red-600"><i class="fas fa-trash"></i></button></td></tr>`;
                    });
                    document.getElementById('log-body').innerHTML = html || '<tr><td colspan="6" class="p-8 text-center">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                    document.getElementById('log-count').innerText = `(${snap.size}ê±´)`;
                });
            },

            loadQuestions: function() {
                window.db.collection('quiz_questions').get().then(snap => {
                    this.state.questions = [];
                    snap.forEach(doc => this.state.questions.push({ ...doc.data(), id: parseInt(doc.id) }));
                    this.state.questions.sort((a,b) => a.id - b.id);
                    this.renderBank();
                });
            },

            renderBank: function() {
                const filter = document.getElementById('bank-filter-unit').value;
                const list = (filter === 'all') ? this.state.questions : this.state.questions.filter(q => (q.unit||"").includes(filter));
                document.getElementById('total-q-count').innerText = `(${list.length}ë¬¸í•­)`;
                
                document.getElementById('bank-body').innerHTML = list.map(q => `
                    <tr class="hover:bg-gray-50 border-b">
                        <td class="p-3"><input type="checkbox" class="q-checkbox" value="${q.id}"></td>
                        <td class="p-3 text-xs font-bold text-gray-500">${q.id}</td>
                        <td class="p-3 text-sm font-bold text-gray-800">${q.question}</td>
                        <td class="p-3 text-xs text-gray-500 bg-gray-100 rounded text-center">${q.type}</td>
                        <td class="p-3 text-xs font-bold text-blue-600">${q.answer}</td>
                        <td class="p-3 text-xs text-gray-500 text-center">${q.stat_total ? Math.round((q.stat_correct/q.stat_total)*100)+'%' : '-'}</td>
                    </tr>
                `).join('');
            },

            addCustomQuestion: function() {
                // Logic adapted from previous `addCustomQuestion`
                const id = this.state.questions.length > 0 ? Math.max(...this.state.questions.map(q=>q.id)) + 1 : 1;
                const data = {
                    id: id,
                    unit: document.getElementById('new-q-unit').value,
                    type: document.getElementById('new-q-type').value,
                    question: document.getElementById('new-q-text').value,
                    options: document.getElementById('new-q-options').value.split(','),
                    answer: document.getElementById('new-q-answer').value,
                    explanation: document.getElementById('new-q-exp').value
                };
                window.db.collection('quiz_questions').doc(String(id)).set(data).then(() => {
                    alert('ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    this.loadQuestions();
                });
            },

            deleteSelectedLogs: function() {
                const checked = document.querySelectorAll('.log-checkbox:checked');
                if(!checked.length) return;
                if(!confirm(`${checked.length}ê°œì˜ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
                const batch = window.db.batch();
                checked.forEach(cb => batch.delete(window.db.collection('quiz_results').doc(cb.value)));
                batch.commit().then(() => this.loadByClass(document.getElementById('select-class-trigger').value));
            },

            deleteSelectedQuestions: function() {
                const checked = document.querySelectorAll('.q-checkbox:checked');
                if(!checked.length) return;
                if(!confirm("ì„ íƒí•œ ë¬¸ì œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
                const batch = window.db.batch();
                checked.forEach(cb => batch.delete(window.db.collection('quiz_questions').doc(cb.value)));
                batch.commit().then(() => this.loadQuestions());
            }
        };

        // Initialize when Auth is ready
        document.addEventListener('auth-ready', () => app.init());
    </script>
</body>
</html>