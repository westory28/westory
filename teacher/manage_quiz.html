
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í€´ì¦ˆ ê´€ë¦¬ - Westory Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="../assets/js/firebase-config.js"></script>
    <link rel="stylesheet" href="../assets/css/style.css">
    <script src="../assets/js/auth-manager.js"></script>

    <style>
        .sort-icon { margin-left: 4px; font-size: 0.8em; color: #9ca3af; }
        .sort-active { color: #2563eb; }
        .tab-btn-base { padding: 12px 24px; font-weight: 700; font-size: 0.95rem; border-bottom: 3px solid transparent; color: #6b7280; transition: all 0.2s; }
        .tab-btn-base:hover { color: #374151; background-color: #f9fafb; }
        .tab-btn-active { border-bottom-color: #2563eb; color: #2563eb; }
        
        /* Tree Styles */
        .tree-node { position: relative; }
        .tree-node.level-0 { margin-bottom: 4px; }
        .tree-node:not(.level-0) { margin-left: 20px; border-left: 1px dashed #e5e7eb; }
        .tree-item { display: flex; align-items: center; padding: 8px 12px; border-radius: 6px; cursor: pointer; transition: all 0.2s; margin-bottom: 2px; }
        .tree-item:hover { background-color: #f3f4f6; }
        .tree-item.active { background-color: #eff6ff; color: #2563eb; font-weight: bold; }
        .tree-item.exam-prep { background-color: #fffbeb; color: #b45309; border: 1px solid #fcd34d; font-weight: bold; margin-bottom: 12px; }
        .tree-item.exam-prep.active { background-color: #f59e0b; color: white; border-color: #d97706; }

        /* Toggle Switch */
        .toggle-checkbox:checked { right: 0; border-color: #68D391; }
        .toggle-checkbox:checked + .toggle-label { background-color: #68D391; }
        .toggle-checkbox { right: 0; z-index: 1; border-color: #ccc; transition: all 0.3s; }
        .toggle-label { width: 40px; height: 20px; border-radius: 9999px; transition: background-color 0.3s; background-color: #ccc; }
        .toggle-dot { top: 2px; left: 2px; width: 16px; height: 16px; border-radius: 100%; transition: all 0.3s; background-color: white; position: absolute; }
        .toggle-checkbox:checked + .toggle-label .toggle-dot { transform: translateX(100%); }

        /* Table Sort Header */
        th.sortable { cursor: pointer; user-select: none; transition: background 0.2s; }
        th.sortable:hover { background-color: #e5e7eb; }

        /* Preview Styles */
        .preview-choice { padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; margin-bottom: 8px; cursor: pointer; transition: all 0.2s; }
        .preview-choice:hover { background-color: #f9fafb; }
        .preview-choice.correct { border-color: #22c55e; background-color: #f0fdf4; color: #15803d; font-weight: bold; }
        .preview-choice.wrong { border-color: #ef4444; background-color: #fef2f2; color: #b91c1c; }
        .preview-img { max-height: 200px; max-width: 100%; border-radius: 8px; border: 1px solid #eee; margin: 10px auto; display: block; }
    </style>
</head>
<body class="bg-gray-50 h-screen flex flex-col">
    <!-- Header injected by AuthManager -->

    <main class="flex-1 w-full max-w-7xl mx-auto px-6 py-6 h-full overflow-hidden flex flex-col">
        <!-- Tabs -->
        <div class="flex border-b border-gray-200 mb-4 bg-white rounded-t-lg px-2 shrink-0">
            <button onclick="app.setTab('manage')" id="btn-tab-manage" class="tab-btn-base tab-btn-active">ë¬¸ì œ ë“±ë¡</button>
            <button onclick="app.setTab('log')" id="btn-tab-log" class="tab-btn-base">ğŸ“Š ì œì¶œ í˜„í™©</button>
            <button onclick="app.setTab('bank')" id="btn-tab-bank" class="tab-btn-base">ğŸ—„ï¸ ì „ì²´ ë¬¸ì œ ì€í–‰</button>
        </div>

        <!-- TAB 1: Assessment Management (Tree + Editor) -->
        <div id="tab-manage" class="tab-content h-full flex gap-6 overflow-hidden pb-2">
            <!-- Left: Unit Tree -->
            <div class="w-1/3 bg-white rounded-xl shadow-sm border border-gray-200 flex flex-col overflow-hidden">
                <div class="p-4 border-b bg-gray-50 font-bold text-gray-700">
                    ğŸ“š ë‹¨ì› ë° í‰ê°€ ì„ íƒ
                </div>
                <div class="flex-1 overflow-y-auto p-4" id="tree-container"></div>
            </div>

            <!-- Right: Assessment Editor -->
            <div class="w-2/3 bg-white rounded-xl shadow-sm border border-gray-200 flex flex-col relative overflow-hidden" id="editor-panel">
                <!-- Empty State -->
                <div id="empty-state" class="absolute inset-0 flex flex-col items-center justify-center text-gray-400 bg-white z-20">
                    <i class="fas fa-mouse-pointer text-4xl mb-4"></i>
                    <p class="text-lg text-center">ì™¼ìª½ ëª©ë¡ì—ì„œ <strong>ì§€í•„í‰ê°€ ëŒ€ë¹„</strong> ë˜ëŠ”<br><strong>ì¤‘ë‹¨ì›</strong>ì„ ì„ íƒí•˜ì—¬ ë¬¸ì œë¥¼ ê´€ë¦¬í•˜ì„¸ìš”.</p>
                </div>

                <!-- Editor Header -->
                <div class="p-4 border-b bg-gray-50 flex justify-between items-center shrink-0">
                    <div>
                        <div class="text-xs text-gray-500 font-bold mb-1" id="selected-path"></div>
                        <h2 class="text-xl font-bold text-gray-800" id="selected-title">-</h2>
                    </div>
                    <div class="flex items-center gap-3">
                        <label class="flex items-center cursor-pointer relative">
                            <input type="checkbox" id="toggle-active" class="sr-only toggle-checkbox" onchange="app.toggleActivation()">
                            <div class="toggle-label bg-gray-300 rounded-full w-10 h-6 relative">
                                <div class="toggle-dot bg-white w-5 h-5 rounded-full absolute top-0.5 left-0.5 shadow-sm"></div>
                            </div>
                            <span class="ml-2 text-sm font-bold text-gray-600" id="toggle-text">í•™ìƒ ë¹„ê³µê°œ</span>
                        </label>
                    </div>
                </div>

                <!-- Sub Tabs (Diagnostic / Formative) -->
                <div class="flex border-b border-gray-200 px-4 pt-2 bg-white shrink-0" id="sub-tabs">
                    <button onclick="app.setSubTab('diagnostic')" id="sub-btn-diagnostic" class="py-2 px-4 font-bold text-sm border-b-2 border-blue-500 text-blue-600">ì§„ë‹¨í‰ê°€</button>
                    <button onclick="app.setSubTab('formative')" id="sub-btn-formative" class="py-2 px-4 font-bold text-sm border-b-2 border-transparent text-gray-400 hover:text-gray-600">í˜•ì„±í‰ê°€</button>
                </div>

                <!-- Questions List -->
                <div class="flex-1 overflow-y-auto p-6 bg-gray-50 space-y-4">
                    <div id="q-list" class="space-y-3"></div>
                    
                    <!-- Add Form Area -->
                    <div class="mt-8 bg-white p-5 rounded-xl border-2 border-dashed border-gray-300">
                        <h3 class="font-bold text-gray-700 mb-4 flex items-center"><i class="fas fa-plus-circle text-blue-500 mr-2"></i> ìƒˆ ë¬¸ì œ ì¶”ê°€</h3>
                        <div class="space-y-3">
                            <div class="grid grid-cols-2 gap-3">
                                <select id="new-q-type" class="border p-2 rounded text-sm bg-gray-50">
                                    <option value="choice">ê°ê´€ì‹</option>
                                    <option value="ox">O/X</option>
                                    <option value="word">ë‹¨ë‹µí˜•</option>
                                    <option value="order">ìˆœì„œë‚˜ì—´</option>
                                </select>
                                <select id="new-q-subunit" class="border p-2 rounded text-sm bg-gray-50">
                                    <option value="">ì†Œë‹¨ì› (ì „ì²´)</option>
                                </select>
                            </div>
                            <input type="text" id="new-q-text" placeholder="ë¬¸ì œ ë‚´ìš© ì…ë ¥" class="w-full border p-2 rounded text-sm">
                            <!-- Image Input -->
                            <div class="flex items-center gap-2">
                                <label class="flex items-center gap-2 text-xs font-bold text-gray-500 cursor-pointer hover:text-blue-600">
                                    <i class="fas fa-image text-lg"></i> ì´ë¯¸ì§€ ì²¨ë¶€
                                    <input type="file" id="new-q-image" class="hidden" accept="image/*" onchange="app.handleImageSelect(this, 'new-q-preview')">
                                </label>
                                <span id="new-q-preview-name" class="text-xs text-gray-400 truncate max-w-[200px]"></span>
                            </div>
                            <img id="new-q-preview" class="hidden h-20 rounded border border-gray-200 object-contain">

                            <input type="text" id="new-q-options" placeholder="ë³´ê¸° (ì½¤ë§ˆë¡œ êµ¬ë¶„, ê°ê´€ì‹/ìˆœì„œìš©)" class="w-full border p-2 rounded text-sm">
                            <input type="text" id="new-q-answer" placeholder="ì •ë‹µ" class="w-full border p-2 rounded text-sm font-bold text-blue-600">
                            <textarea id="new-q-exp" placeholder="í•´ì„¤ (ì„ íƒ)" class="w-full border p-2 rounded text-sm h-16 resize-none"></textarea>
                            <button onclick="app.addQuestion()" class="w-full bg-blue-600 text-white font-bold py-2 rounded hover:bg-blue-700 transition">ë“±ë¡</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB 2: Logs -->
        <div id="tab-log" class="tab-content hidden h-full overflow-y-auto">
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-gray-800">ì œì¶œ í˜„í™© <span id="log-count" class="text-sm font-normal text-gray-500"></span></h2>
                    <div class="flex gap-2">
                        <select id="select-class-trigger" onchange="app.loadByClass(this.value)" class="border rounded px-3 py-2 text-sm font-bold">
                            <option value="">ë°˜ ì„ íƒ</option>
                            <option value="all">ì „ì²´ (ìµœê·¼ 50ê°œ)</option>
                            <option value="1">1ë°˜</option><option value="2">2ë°˜</option><option value="3">3ë°˜</option><option value="4">4ë°˜</option><option value="5">5ë°˜</option><option value="6">6ë°˜</option><option value="7">7ë°˜</option><option value="8">8ë°˜</option><option value="9">9ë°˜</option><option value="10">10ë°˜</option>
                        </select>
                        <button onclick="app.loadByClass(document.getElementById('select-class-trigger').value)" class="bg-gray-100 p-2 rounded"><i class="fas fa-sync-alt"></i></button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left whitespace-nowrap">
                        <thead class="bg-gray-50 text-gray-600 font-bold border-b">
                            <tr><th class="p-4">ì‹œê°„</th><th class="p-4">í•™ìƒ</th><th class="p-4">ì ìˆ˜</th><th class="p-4">ìƒíƒœ</th><th class="p-4">ê´€ë¦¬</th></tr>
                        </thead>
                        <tbody id="log-body" class="divide-y divide-gray-100"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- TAB 3: Question Bank -->
        <div id="tab-bank" class="tab-content hidden h-full overflow-hidden flex flex-col">
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 flex flex-col h-full overflow-hidden">
                 <div class="p-4 border-b bg-gray-50 flex flex-wrap gap-3 items-center shrink-0">
                    <div class="flex items-center gap-2">
                        <i class="fas fa-filter text-gray-400"></i>
                        <select id="filter-big" onchange="app.filterBank('big')" class="border rounded px-2 py-1.5 text-sm w-32 font-bold text-gray-700"><option value="">ëŒ€ë‹¨ì› ì „ì²´</option></select>
                        <i class="fas fa-chevron-right text-gray-300 text-xs"></i>
                        <select id="filter-mid" onchange="app.filterBank('mid')" class="border rounded px-2 py-1.5 text-sm w-32 text-gray-700"><option value="">ì¤‘ë‹¨ì› ì „ì²´</option></select>
                        <i class="fas fa-chevron-right text-gray-300 text-xs"></i>
                        <select id="filter-small" onchange="app.filterBank('small')" class="border rounded px-2 py-1.5 text-sm w-32 text-gray-700"><option value="">ì†Œë‹¨ì› ì „ì²´</option></select>
                    </div>
                    <div class="h-6 w-px bg-gray-300 mx-2"></div>
                    <select id="filter-type" onchange="app.filterBank('type')" class="border rounded px-2 py-1.5 text-sm w-24 text-gray-700"><option value="">ìœ í˜• ì „ì²´</option><option value="choice">ê°ê´€ì‹</option><option value="ox">O/X</option><option value="word">ë‹¨ë‹µí˜•</option><option value="order">ìˆœì„œ</option></select>
                    <div class="ml-auto text-xs text-gray-500">ì´ <span id="bank-total-count" class="font-bold text-blue-600">0</span>ë¬¸ì œ</div>
                 </div>
                 <div class="flex-1 overflow-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-white font-bold text-gray-700 sticky top-0 shadow-sm z-10">
                            <tr>
                                <th class="p-3 w-16 text-center sortable" onclick="app.sortBank('id')">ID <i class="fas fa-sort sort-icon"></i></th>
                                <th class="p-3 w-20 text-center sortable" onclick="app.sortBank('category')">ë¶„ë¥˜ <i class="fas fa-sort sort-icon"></i></th>
                                <th class="p-3 w-40 sortable" onclick="app.sortBank('unit')">ë‹¨ì› ì •ë³´ <i class="fas fa-sort sort-icon"></i></th>
                                <th class="p-3 w-20 text-center sortable" onclick="app.sortBank('type')">ìœ í˜• <i class="fas fa-sort sort-icon"></i></th>
                                <th class="p-3">ë¬¸ì œ</th>
                                <th class="p-3 w-32">ì •ë‹µ</th>
                                <th class="p-3 w-24 text-center sortable" onclick="app.sortBank('rate')">ì •ë‹µë¥  <i class="fas fa-sort sort-icon"></i></th>
                                <th class="p-3 w-16 text-center">ê´€ë¦¬</th>
                            </tr>
                        </thead>
                        <tbody id="bank-body" class="divide-y divide-gray-100 bg-white"></tbody>
                    </table>
                 </div>
            </div>
        </div>

    </main>

    <!-- Edit Modal -->
    <div id="edit-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center">
        <div class="absolute inset-0 bg-black bg-opacity-50 backdrop-blur-sm" onclick="app.closeEditModal()"></div>
        <div class="bg-white rounded-xl shadow-2xl z-10 w-full max-w-2xl p-6 mx-4 relative flex flex-col max-h-[90vh]">
            <div class="flex justify-between items-center mb-4 border-b pb-3">
                <h3 class="font-bold text-lg text-gray-800"><i class="fas fa-edit text-blue-500 mr-2"></i>ë¬¸ì œ ìˆ˜ì •</h3>
                <button onclick="app.closeEditModal()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
            </div>
            <div class="overflow-y-auto flex-1 space-y-4 pr-2">
                <input type="hidden" id="edit-id">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">ë¶„ë¥˜</label>
                        <select id="edit-category" class="w-full border p-2 rounded text-sm bg-gray-50 font-bold">
                            <option value="diagnostic">ì§„ë‹¨í‰ê°€</option>
                            <option value="formative">í˜•ì„±í‰ê°€</option>
                            <option value="exam_prep">ì§€í•„í‰ê°€ ëŒ€ë¹„</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">ìœ í˜•</label>
                        <select id="edit-type" class="w-full border p-2 rounded text-sm bg-gray-50">
                            <option value="choice">ê°ê´€ì‹</option>
                            <option value="ox">O/X</option>
                            <option value="word">ë‹¨ë‹µí˜•</option>
                            <option value="order">ìˆœì„œë‚˜ì—´</option>
                        </select>
                    </div>
                </div>
                <div class="bg-gray-50 p-3 rounded border border-gray-200">
                    <label class="block text-xs font-bold text-gray-500 mb-2">ë‹¨ì› ì´ë™</label>
                    <div class="grid grid-cols-2 gap-2">
                        <select id="edit-unit" onchange="app.updateEditSubUnits()" class="w-full border p-2 rounded text-sm"></select>
                        <select id="edit-subunit" class="w-full border p-2 rounded text-sm"></select>
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">ë¬¸ì œ ë‚´ìš©</label>
                    <input type="text" id="edit-question" class="w-full border p-2 rounded text-sm font-bold">
                </div>
                <!-- Image Input in Edit -->
                <div>
                    <div class="flex items-center gap-2 mb-2">
                        <label class="flex items-center gap-2 text-xs font-bold text-gray-500 cursor-pointer hover:text-blue-600 bg-gray-100 px-3 py-1 rounded">
                            <i class="fas fa-image"></i> ì´ë¯¸ì§€ ë³€ê²½
                            <input type="file" id="edit-image" class="hidden" accept="image/*" onchange="app.handleImageSelect(this, 'edit-preview')">
                        </label>
                        <button onclick="app.removeEditImage()" class="text-xs text-red-500 hover:text-red-700 font-bold px-2">ì‚­ì œ</button>
                    </div>
                    <img id="edit-preview" class="hidden h-24 rounded border border-gray-200 object-contain bg-white p-1">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">ë³´ê¸° (ì½¤ë§ˆ êµ¬ë¶„)</label>
                    <input type="text" id="edit-options" class="w-full border p-2 rounded text-sm">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">ì •ë‹µ</label>
                    <input type="text" id="edit-answer" class="w-full border p-2 rounded text-sm font-bold text-blue-600 bg-blue-50">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">í•´ì„¤</label>
                    <textarea id="edit-explanation" class="w-full border p-2 rounded text-sm h-20 resize-none"></textarea>
                </div>
            </div>
            <div class="mt-6 pt-4 border-t flex justify-end gap-3">
                <button onclick="app.closeEditModal()" class="px-4 py-2 bg-white border border-gray-300 rounded text-gray-700 font-bold hover:bg-gray-50">ì·¨ì†Œ</button>
                <button onclick="app.saveEditQuestion()" class="px-6 py-2 bg-blue-600 text-white rounded font-bold hover:bg-blue-700 shadow-md">ìˆ˜ì • ì €ì¥</button>
            </div>
        </div>
    </div>

    <!-- Preview Modal -->
    <div id="preview-modal" class="fixed inset-0 z-[60] hidden flex items-center justify-center">
        <div class="absolute inset-0 bg-black bg-opacity-70 backdrop-blur-sm" onclick="document.getElementById('preview-modal').classList.add('hidden')"></div>
        <div class="bg-white rounded-xl shadow-2xl z-10 w-full max-w-md p-6 relative mx-4">
            <div class="flex justify-between items-center mb-4">
                <span class="text-xs font-bold bg-blue-100 text-blue-700 px-2 py-1 rounded">í•™ìƒ í™”ë©´ ë¯¸ë¦¬ë³´ê¸°</span>
                <button onclick="document.getElementById('preview-modal').classList.add('hidden')" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-lg"></i></button>
            </div>
            <div id="preview-content"></div>
        </div>
    </div>

    <!-- Footer injected by AuthManager -->

    <script>
        window.AuthManager.init('teacher');

        const app = {
            treeData: [],
            questions: [],
            selectedNode: null,
            selectedCategory: 'diagnostic', 
            assessmentConfig: {},
            filters: { big: '', mid: '', small: '', type: '' },
            sort: { key: 'id', order: 'desc' },
            tempImage: null, // Stores Base64 for new/edit image

            init: function() {
                this.loadTree();
                this.loadQuestions();
                this.loadConfig();
            },

            // ... (Tab Switching, Tree Loading, Config Loading same as before) ...
            setTab: function(tab) {
                document.querySelectorAll('.tab-btn-base').forEach(b => b.classList.remove('tab-btn-active'));
                document.getElementById('btn-tab-'+tab).classList.add('tab-btn-active');
                document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
                document.getElementById('tab-'+tab).classList.remove('hidden');
                if(tab === 'bank') this.renderBank();
            },
            setSubTab: function(cat) {
                this.selectedCategory = cat;
                document.getElementById('sub-btn-diagnostic').className = cat==='diagnostic' ? "py-2 px-4 font-bold text-sm border-b-2 border-blue-500 text-blue-600" : "py-2 px-4 font-bold text-sm border-b-2 border-transparent text-gray-400 hover:text-gray-600";
                document.getElementById('sub-btn-formative').className = cat==='formative' ? "py-2 px-4 font-bold text-sm border-b-2 border-blue-500 text-blue-600" : "py-2 px-4 font-bold text-sm border-b-2 border-transparent text-gray-400 hover:text-gray-600";
                this.renderQuestions();
                this.updateToggleState();
            },
            loadTree: async function() {
                try {
                    const doc = await window.getCollection('curriculum').doc('tree').get();
                    this.treeData = (doc.exists && doc.data().tree) ? doc.data().tree : [];
                    this.renderTree();
                    this.populateFilters();
                } catch(e) { console.error(e); }
            },
            loadQuestions: async function() {
                const snap = await window.getCollection('quiz_questions').get();
                this.questions = [];
                snap.forEach(doc => this.questions.push({id: parseInt(doc.id), ...doc.data()}));
                if(document.getElementById('tab-bank').classList.contains('hidden') === false) this.renderBank();
            },
            loadConfig: async function() {
                const doc = await window.getCollection('assessment_config').doc('status').get();
                this.assessmentConfig = (doc.exists) ? doc.data() : {};
            },

            // --- Render Tree & Editor ---
            renderTree: function() {
                const container = document.getElementById('tree-container');
                container.innerHTML = '';
                const examNode = document.createElement('div');
                examNode.className = 'tree-item exam-prep';
                examNode.innerHTML = '<i class="fas fa-file-contract mr-2"></i>ì§€í•„í‰ê°€ ëŒ€ë¹„ ì‹¤ì „';
                examNode.onclick = () => this.selectExamPrep(examNode);
                container.appendChild(examNode);
                this.treeData.forEach(big => {
                    const bigEl = document.createElement('div');
                    bigEl.className = 'tree-node level-0';
                    bigEl.innerHTML = `<div class="font-bold text-gray-800 py-1 select-none">${big.title}</div>`;
                    if(big.children) {
                        big.children.forEach(mid => {
                            const midEl = document.createElement('div');
                            midEl.className = 'tree-node level-1';
                            const item = document.createElement('div');
                            item.className = 'tree-item';
                            item.innerHTML = `<i class="fas fa-folder text-yellow-400 mr-2"></i>${mid.title}`;
                            item.onclick = () => this.selectNode(mid, big.title, item);
                            midEl.appendChild(item);
                            bigEl.appendChild(midEl);
                        });
                    }
                    container.appendChild(bigEl);
                });
            },
            selectExamPrep: function(el) {
                this.resetSelection();
                el.classList.add('active');
                this.selectedNode = { id: 'exam_prep', title: 'ì§€í•„í‰ê°€ ëŒ€ë¹„ ì‹¤ì „', type: 'special' };
                this.renderEditor();
            },
            selectNode: function(node, parentTitle, el) {
                this.resetSelection();
                el.classList.add('active');
                this.selectedNode = { ...node, parentTitle };
                this.renderEditor();
            },
            resetSelection: function() {
                document.querySelectorAll('.tree-item').forEach(e => e.classList.remove('active'));
                document.getElementById('empty-state').classList.add('hidden');
            },
            renderEditor: function() {
                const node = this.selectedNode;
                document.getElementById('selected-title').innerText = node.title;
                document.getElementById('selected-path').innerText = node.type === 'special' ? 'íŠ¹ë³„ í•™ìŠµ' : `${node.parentTitle} > ${node.title}`;
                const subTabs = document.getElementById('sub-tabs');
                if (node.id === 'exam_prep') {
                    subTabs.classList.add('hidden');
                    this.selectedCategory = 'exam_prep';
                } else {
                    subTabs.classList.remove('hidden');
                    this.setSubTab('diagnostic'); 
                }
                const subSel = document.getElementById('new-q-subunit');
                subSel.innerHTML = '<option value="">ì†Œë‹¨ì› (ì „ì²´)</option>';
                if(node.children) {
                    node.children.forEach(small => {
                        const opt = document.createElement('option');
                        opt.value = small.id;
                        opt.innerText = small.title;
                        subSel.appendChild(opt);
                    });
                }
                this.renderQuestions();
                this.updateToggleState();
            },

            // --- Image Handling ---
            handleImageSelect: function(input, previewId) {
                const file = input.files[0];
                if(file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        this.tempImage = e.target.result;
                        const prev = document.getElementById(previewId);
                        prev.src = this.tempImage;
                        prev.classList.remove('hidden');
                        if(previewId === 'new-q-preview') document.getElementById('new-q-preview-name').innerText = file.name;
                    };
                    reader.readAsDataURL(file);
                }
            },
            removeEditImage: function() {
                this.tempImage = null;
                document.getElementById('edit-preview').src = '';
                document.getElementById('edit-preview').classList.add('hidden');
            },

            // --- Question Operations ---
            renderQuestions: function() {
                const list = document.getElementById('q-list');
                const filtered = this.questions.filter(q => q.unitId === this.selectedNode.id && q.category === this.selectedCategory);
                if(filtered.length === 0) {
                    list.innerHTML = '<div class="text-center py-10 text-gray-400 border-2 border-dashed border-gray-200 rounded-lg">ë“±ë¡ëœ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                } else {
                    list.innerHTML = filtered.map((q, idx) => `
                        <div class="bg-white p-4 rounded-lg border border-gray-200 hover:border-blue-300 transition relative group">
                            <div class="flex justify-between items-start mb-2">
                                <span class="bg-gray-100 text-gray-600 text-xs font-bold px-2 py-1 rounded">Q${idx+1} | ${q.type}</span>
                                <div class="flex gap-2">
                                    <button onclick="app.previewQuestion(${q.id})" class="text-gray-400 hover:text-green-600 text-xs border border-gray-200 px-2 py-1 rounded hover:bg-green-50 transition"><i class="fas fa-play mr-1"></i>ë¯¸ë¦¬ë³´ê¸°</button>
                                    <button onclick="app.openEditModal(${q.id})" class="text-blue-400 hover:text-blue-600"><i class="fas fa-edit"></i></button>
                                    <button onclick="app.deleteQuestion('${q.id}')" class="text-gray-300 hover:text-red-500"><i class="fas fa-trash"></i></button>
                                </div>
                            </div>
                            <div class="flex gap-4">
                                ${q.image ? `<img src="${q.image}" class="w-16 h-16 object-cover rounded border border-gray-100">` : ''}
                                <div>
                                    <p class="font-bold text-gray-800 mb-2">${q.question}</p>
                                    <div class="text-sm text-gray-500">
                                        <span class="text-blue-600 font-bold mr-2">ì •ë‹µ: ${q.answer}</span>
                                        ${q.options ? `<span class="text-xs text-gray-400">(${q.options.join(', ')})</span>` : ''}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('');
                }
            },

            addQuestion: async function() {
                if(!this.selectedNode) return;
                const text = document.getElementById('new-q-text').value;
                const ans = document.getElementById('new-q-answer').value;
                if(!text || !ans) { alert("ë¬¸ì œì™€ ì •ë‹µì€ í•„ìˆ˜ì…ë‹ˆë‹¤."); return; }

                const newId = Date.now();
                const qData = {
                    id: newId,
                    unitId: this.selectedNode.id,
                    category: this.selectedCategory,
                    subUnitId: document.getElementById('new-q-subunit').value || null,
                    type: document.getElementById('new-q-type').value,
                    question: text,
                    image: this.tempImage || null,
                    answer: ans,
                    options: document.getElementById('new-q-options').value ? document.getElementById('new-q-options').value.split(',').map(s=>s.trim()) : [],
                    explanation: document.getElementById('new-q-exp').value,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                await window.getCollection('quiz_questions').doc(String(newId)).set(qData);
                
                // Reset
                document.getElementById('new-q-text').value = '';
                document.getElementById('new-q-options').value = '';
                document.getElementById('new-q-answer').value = '';
                document.getElementById('new-q-exp').value = '';
                document.getElementById('new-q-image').value = '';
                document.getElementById('new-q-preview').classList.add('hidden');
                document.getElementById('new-q-preview-name').innerText = '';
                this.tempImage = null;
                
                this.questions.push(qData);
                this.renderQuestions();
                if(!document.getElementById('tab-bank').classList.contains('hidden')) this.renderBank();
            },

            deleteQuestion: async function(id) {
                if(!confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
                await window.getCollection('quiz_questions').doc(String(id)).delete();
                this.questions = this.questions.filter(q => String(q.id) !== String(id));
                this.renderQuestions();
                if(!document.getElementById('tab-bank').classList.contains('hidden')) this.renderBank();
            },

            // --- Preview Logic ---
            previewQuestion: function(id) {
                const q = this.questions.find(x => x.id === id);
                if(!q) return;
                
                const container = document.getElementById('preview-content');
                let html = `
                    <div class="mb-4">
                        <span class="text-xs bg-gray-100 px-2 py-1 rounded text-gray-500">${q.type}</span>
                        ${q.image ? `<img src="${q.image}" class="preview-img">` : ''}
                        <h4 class="font-bold text-lg mt-2 text-gray-800">${q.question}</h4>
                    </div>
                `;

                if(q.type === 'choice') {
                    html += `<div class="space-y-2">
                        ${(q.options||[]).map(opt => `
                            <div class="preview-choice" onclick="app.simulateAnswer(this, '${opt}', '${q.answer}')">${opt}</div>
                        `).join('')}
                    </div>`;
                } else if(q.type === 'ox') {
                    html += `<div class="flex gap-2">
                        <button class="flex-1 py-4 border-2 rounded-lg font-bold text-xl hover:bg-blue-50 border-blue-200 text-blue-600" onclick="app.simulateAnswer(this, 'O', '${q.answer}')">O</button>
                        <button class="flex-1 py-4 border-2 rounded-lg font-bold text-xl hover:bg-red-50 border-red-200 text-red-600" onclick="app.simulateAnswer(this, 'X', '${q.answer}')">X</button>
                    </div>`;
                } else {
                    html += `<div class="flex gap-2">
                        <input type="text" class="border p-2 rounded w-full" placeholder="ì •ë‹µ ì…ë ¥">
                        <button class="bg-blue-600 text-white px-4 rounded" onclick="alert('ì£¼ê´€ì‹ì€ ìë™ ì±„ì ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤ (ì˜ˆì‹œ). ì •ë‹µ: ${q.answer}')">í™•ì¸</button>
                    </div>`;
                }

                container.innerHTML = html;
                document.getElementById('preview-modal').classList.remove('hidden');
                document.getElementById('preview-modal').classList.add('flex');
            },

            simulateAnswer: function(el, selected, correct) {
                // Reset siblings
                if(el.parentNode) {
                    Array.from(el.parentNode.children).forEach(child => {
                        child.classList.remove('correct', 'wrong', 'border-blue-200', 'border-red-200', 'bg-blue-50', 'bg-red-50');
                        child.style.opacity = '0.5';
                    });
                }
                el.style.opacity = '1';
                
                if(String(selected) === String(correct)) {
                    el.classList.add('correct');
                    // Confetti or simple animation could go here
                } else {
                    el.classList.add('wrong');
                    // Highlight correct one?
                }
            },

            // --- Edit Modal ---
            openEditModal: function(id) {
                const q = this.questions.find(x => x.id === id);
                if(!q) return;
                document.getElementById('edit-id').value = id;
                document.getElementById('edit-category').value = q.category;
                document.getElementById('edit-type').value = q.type;
                document.getElementById('edit-question').value = q.question;
                document.getElementById('edit-options').value = (q.options || []).join(', ');
                document.getElementById('edit-answer').value = q.answer;
                document.getElementById('edit-explanation').value = q.explanation || '';
                
                // Image handling
                const prev = document.getElementById('edit-preview');
                if(q.image) {
                    prev.src = q.image;
                    prev.classList.remove('hidden');
                    this.tempImage = q.image; // Keep existing unless changed
                } else {
                    prev.classList.add('hidden');
                    this.tempImage = null;
                }

                // Populate Selectors (same as before)
                const unitSel = document.getElementById('edit-unit');
                unitSel.innerHTML = '<option value="">(ì„ íƒ ì•ˆí•¨ - ì§€í•„í‰ê°€)</option>';
                this.treeData.forEach(big => {
                     if(big.children) {
                         big.children.forEach(mid => {
                             const opt = document.createElement('option');
                             opt.value = mid.id;
                             opt.innerText = `${big.title} > ${mid.title}`;
                             unitSel.appendChild(opt);
                         });
                     }
                });
                unitSel.value = q.unitId || '';
                this.updateEditSubUnits(q.subUnitId);

                document.getElementById('edit-modal').classList.remove('hidden');
                document.getElementById('edit-modal').classList.add('flex');
            },
            updateEditSubUnits: function(defaultVal = '') {
                const midId = document.getElementById('edit-unit').value;
                const subSel = document.getElementById('edit-subunit');
                subSel.innerHTML = '<option value="">(ì†Œë‹¨ì› ì—†ìŒ)</option>';
                if(midId) {
                    let midNode = null;
                    this.treeData.forEach(big => { if(big.children) { const found = big.children.find(m => m.id === midId); if(found) midNode = found; } });
                    if(midNode && midNode.children) {
                        midNode.children.forEach(small => { const opt = document.createElement('option'); opt.value = small.id; opt.innerText = small.title; subSel.appendChild(opt); });
                    }
                }
                if(defaultVal) subSel.value = defaultVal;
            },
            saveEditQuestion: async function() {
                const id = document.getElementById('edit-id').value;
                const data = {
                    category: document.getElementById('edit-category').value,
                    type: document.getElementById('edit-type').value,
                    unitId: document.getElementById('edit-unit').value || 'exam_prep',
                    subUnitId: document.getElementById('edit-subunit').value || null,
                    question: document.getElementById('edit-question').value,
                    image: this.tempImage || null, // Updated image or existing or null
                    options: document.getElementById('edit-options').value.split(',').map(s=>s.trim()),
                    answer: document.getElementById('edit-answer').value,
                    explanation: document.getElementById('edit-explanation').value,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                await window.getCollection('quiz_questions').doc(String(id)).update(data);
                
                const idx = this.questions.findIndex(q => String(q.id) === String(id));
                if(idx > -1) this.questions[idx] = { ...this.questions[idx], ...data };
                
                this.closeEditModal();
                if(!document.getElementById('tab-bank').classList.contains('hidden')) this.renderBank(); else this.renderQuestions();
            },
            closeEditModal: function() {
                document.getElementById('edit-modal').classList.add('hidden');
                document.getElementById('edit-modal').classList.remove('flex');
                this.tempImage = null;
                document.getElementById('edit-image').value = '';
            },

            // --- Toggle/Bank/Sort/Filter (Same as existing) ---
            updateToggleState: function() {
                const key = `${this.selectedNode.id}_${this.selectedCategory}`;
                const isActive = this.assessmentConfig[key] === true;
                document.getElementById('toggle-active').checked = isActive;
                const text = document.getElementById('toggle-text');
                text.innerText = isActive ? 'í•™ìƒ ê³µê°œ ì¤‘' : 'í•™ìƒ ë¹„ê³µê°œ';
                text.className = isActive ? 'ml-2 text-sm font-bold text-green-600' : 'ml-2 text-sm font-bold text-gray-400';
            },
            toggleActivation: async function() {
                if(!this.selectedNode) return;
                const key = `${this.selectedNode.id}_${this.selectedCategory}`;
                const newState = document.getElementById('toggle-active').checked;
                this.assessmentConfig[key] = newState;
                this.updateToggleState();
                await window.getCollection('assessment_config').doc('status').set({[key]: newState}, { merge: true });
            },
            populateFilters: function() {
                const bigSel = document.getElementById('filter-big');
                bigSel.innerHTML = '<option value="">ëŒ€ë‹¨ì› ì „ì²´</option>';
                this.treeData.forEach(big => { const opt = document.createElement('option'); opt.value = big.id; opt.innerText = big.title; bigSel.appendChild(opt); });
            },
            filterBank: function(level) {
                if(level === 'big') {
                    const bigId = document.getElementById('filter-big').value;
                    const midSel = document.getElementById('filter-mid');
                    midSel.innerHTML = '<option value="">ì¤‘ë‹¨ì› ì „ì²´</option>';
                    this.filters.big = bigId; this.filters.mid = ''; this.filters.small = '';
                    if(bigId) { const big = this.treeData.find(b => b.id === bigId); if(big && big.children) big.children.forEach(mid => { const opt = document.createElement('option'); opt.value = mid.id; opt.innerText = mid.title; midSel.appendChild(opt); }); }
                } else if(level === 'mid') { this.filters.mid = document.getElementById('filter-mid').value; }
                else if(level === 'type') { this.filters.type = document.getElementById('filter-type').value; }
                this.renderBank();
            },
            sortBank: function(key) {
                if(this.sort.key === key) this.sort.order = this.sort.order === 'asc' ? 'desc' : 'asc';
                else { this.sort.key = key; this.sort.order = 'asc'; }
                this.renderBank();
            },
            renderBank: function() {
                const tbody = document.getElementById('bank-body');
                let filtered = this.questions.filter(q => {
                    if(this.filters.type && q.type !== this.filters.type) return false;
                    if(this.filters.mid && q.unitId !== this.filters.mid) return false;
                    if(this.filters.big) { const big = this.treeData.find(b => b.id === this.filters.big); if(!big || !big.children || !big.children.find(m => m.id === q.unitId)) return false; }
                    return true;
                });
                filtered.sort((a, b) => {
                    let valA = a[this.sort.key]; let valB = b[this.sort.key];
                    if(this.sort.key === 'unit') { valA = a.unitId; valB = b.unitId; }
                    if(valA < valB) return this.sort.order === 'asc' ? -1 : 1;
                    if(valA > valB) return this.sort.order === 'asc' ? 1 : -1;
                    return 0;
                });
                document.getElementById('bank-total-count').innerText = filtered.length;
                tbody.innerHTML = filtered.map(q => `
                    <tr class="border-b border-gray-50 last:border-0 hover:bg-gray-50 group cursor-pointer" onclick="app.openEditModal(${q.id})">
                        <td class="p-3 text-xs text-gray-500 text-center">${q.id}</td>
                        <td class="p-3 text-center"><span class="bg-gray-100 text-xs px-2 py-1 rounded text-gray-600">${q.category==='diagnostic'?'ì§„ë‹¨':(q.category==='formative'?'í˜•ì„±':'ì§€í•„')}</span></td>
                        <td class="p-3 text-xs text-gray-500 truncate max-w-[100px]">${q.unitId}</td>
                        <td class="p-3 text-center"><span class="border border-gray-200 text-xs px-2 py-1 rounded text-gray-500">${q.type}</span></td>
                        <td class="p-3 font-bold text-gray-700 max-w-xs break-keep group-hover:text-blue-600 flex items-center gap-2">
                            ${q.image ? '<i class="fas fa-image text-gray-400"></i>' : ''} ${q.question}
                        </td>
                        <td class="p-3 text-blue-600 font-bold truncate max-w-[100px]">${q.answer}</td>
                        <td class="p-3 text-center text-gray-500 font-mono">-</td>
                        <td class="p-3 text-center" onclick="event.stopPropagation()">
                            <button onclick="app.previewQuestion(${q.id})" class="text-green-500 hover:text-green-700 mr-2"><i class="fas fa-play"></i></button>
                            <button onclick="app.deleteQuestion('${q.id}')" class="text-gray-300 hover:text-red-500"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `).join('');
            },
            
            loadByClass: function(cls) {
                // (Existing Log Logic)
                const tbody = document.getElementById('log-body');
                if(!cls) return;
                tbody.innerHTML = '<tr><td colspan="5" class="p-8 text-center">ë¡œë”© ì¤‘...</td></tr>';
                let q = window.getCollection('quiz_results').orderBy('timestamp', 'desc');
                if (cls !== 'all') q = q.where('class', '==', parseInt(cls)); else q = q.limit(50);
                q.get().then(snap => {
                    let html = '';
                    snap.forEach(doc => { const d = doc.data(); html += `<tr class="border-b hover:bg-blue-50"><td class="p-4 text-xs font-mono text-gray-500">${d.timeString||'-'}</td><td class="p-4 font-bold text-gray-700">${d.class}ë°˜ ${d.number}ë²ˆ ${d.name}</td><td class="p-4 font-bold text-blue-600">${d.score}ì </td><td class="p-4 text-xs">${d.status}</td><td class="p-4"><button onclick="app.deleteLog('${doc.id}')" class="text-gray-300 hover:text-red-500"><i class="fas fa-trash"></i></button></td></tr>`; });
                    tbody.innerHTML = html || '<tr><td colspan="5" class="p-8 text-center text-gray-400">ë°ì´í„° ì—†ìŒ</td></tr>';
                    document.getElementById('log-count').innerText = `(${snap.size}ê±´)`;
                });
            },
            deleteLog: function(id) { if(confirm("ê¸°ë¡ ì‚­ì œ?")) window.getCollection('quiz_results').doc(id).delete().then(() => this.loadByClass(document.getElementById('select-class-trigger').value)); }
        };

        document.addEventListener('auth-ready', () => app.init());
    </script>
</body>
</html>
