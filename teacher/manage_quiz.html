<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í€´ì¦ˆ ê´€ë¦¬ - Westory Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Firebase -->
    <script type="module" src="../assets/js/firebase-config.js"></script>
    <link rel="stylesheet" href="../assets/css/style.css">
    <script type="module" src="../assets/js/auth-manager.js"></script>
    <style>
        .sort-icon {
            margin-left: 4px;
            font-size: 0.8em;
            color: #9ca3af;
        }

        .sort-active {
            color: #2563eb;
        }

        .tab-btn-base {
            padding: 12px 24px;
            font-weight: 700;
            font-size: 0.95rem;
            border-bottom: 3px solid transparent;
            color: #6b7280;
            transition: all 0.2s;
        }

        .tab-btn-base:hover {
            color: #374151;
            background-color: #f9fafb;
        }

        .tab-btn-active {
            border-bottom-color: #2563eb;
            color: #2563eb;
        }

        .tree-node {
            position: relative;
        }

        .tree-node.level-0 {
            margin-bottom: 4px;
        }

        .tree-node:not(.level-0) {
            margin-left: 20px;
            border-left: 1px dashed #e5e7eb;
        }

        .tree-item {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 2px;
            white-space: normal;
            /* Allow wrapping */
            word-break: break-all;
            /* Break long words if needed */
        }

        .tree-item:hover {
            background-color: #f3f4f6;
        }

        .tree-item.active {
            background-color: #eff6ff;
            color: #2563eb;
            font-weight: bold;
        }

        .tree-item.exam-prep {
            background-color: #fffbeb;
            color: #b45309;
            border: 1px solid #fcd34d;
            font-weight: bold;
            margin-bottom: 12px;
        }

        .tree-item.exam-prep.active {
            background-color: #f59e0b;
            color: white;
            border-color: #d97706;
        }

        .toggle-checkbox:checked {
            right: 0;
            border-color: #68D391;
        }

        .toggle-checkbox:checked+.toggle-label {
            background-color: #68D391;
        }

        .toggle-checkbox {
            right: 0;
            z-index: 1;
            border-color: #ccc;
            transition: all 0.3s;
        }

        .toggle-label {
            width: 40px;
            height: 20px;
            border-radius: 9999px;
            transition: background-color 0.3s;
            background-color: #ccc;
        }

        .toggle-dot {
            top: 2px;
            left: 2px;
            width: 16px;
            height: 16px;
            border-radius: 100%;
            transition: all 0.3s;
            background-color: white;
            position: absolute;
        }

        .toggle-checkbox:checked+.toggle-label .toggle-dot {
            transform: translateX(100%);
        }

        th.sortable {
            cursor: pointer;
            user-select: none;
            transition: background 0.2s;
        }

        th.sortable:hover {
            background-color: #e5e7eb;
        }

        .preview-choice {
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .preview-choice:hover {
            background-color: #f9fafb;
        }

        .preview-choice.correct {
            border-color: #22c55e;
            background-color: #f0fdf4;
            color: #15803d;
            font-weight: bold;
        }

        .preview-choice.wrong {
            border-color: #ef4444;
            background-color: #fef2f2;
            color: #b91c1c;
        }

        .preview-img {
            max-height: 200px;
            max-width: 100%;
            border-radius: 8px;
            border: 1px solid #eee;
            margin: 10px auto;
            display: block;
        }

        @media (max-width: 1024px) {
            #sidebar-panel {
                position: fixed;
                top: 0;
                right: 0;
                /* Changed from left: 0 */
                left: auto;
                height: 100%;
                z-index: 50;
                width: 280px;
                /* Slightly wider for better readability */
                transform: translateX(100%);
                /* Start off-screen right */
                transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                box-shadow: -4px 0 15px rgba(0, 0, 0, 0.1);
            }

            #sidebar-panel.open {
                transform: translateX(0);
            }

            .sidebar-overlay {
                position: fixed;
                inset: 0;
                background: rgba(0, 0, 0, 0.5);
                backdrop-filter: blur(2px);
                z-index: 40;
                display: none;
            }

            .sidebar-overlay.active {
                display: block;
            }
        }

        .fab-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: #2563eb;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            z-index: 45;
            transition: transform 0.2s;
        }

        .fab-btn:active {
            transform: scale(0.95);
        }
    </style>
</head>

<body class="bg-gray-50 min-h-screen flex flex-col">
    <!-- Header injected by AuthManager -->
    <main class="flex-1 w-full max-w-7xl mx-auto px-4 lg:px-6 py-6 h-full flex flex-col">
        <!-- Tabs -->
        <div class="flex border-b border-gray-200 mb-4 bg-white rounded-t-lg px-2 shrink-0 overflow-x-auto">
            <button onclick="app.setTab('manage')" id="btn-tab-manage"
                class="tab-btn-base tab-btn-active whitespace-nowrap">ë¬¸ì œ ë“±ë¡</button>
            <button onclick="app.setTab('log')" id="btn-tab-log" class="tab-btn-base whitespace-nowrap">ğŸ“Š ì œì¶œ
                í˜„í™©</button>
            <button onclick="app.setTab('bank')" id="btn-tab-bank" class="tab-btn-base whitespace-nowrap">ğŸ—„ï¸ ë¬¸ì œ
                ì€í–‰</button>
        </div>

        <!-- Immediately apply URL tab param before page renders -->
        <script>
            (function () {
                const t = new URLSearchParams(window.location.search).get('tab');
                if (t) {
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
                    const target = document.getElementById('tab-' + t);
                    if (target) target.classList.remove('hidden');
                    document.querySelectorAll('.tab-btn-base').forEach(b => b.classList.remove('tab-btn-active'));
                    const btn = document.getElementById('btn-tab-' + t);
                    if (btn) btn.classList.add('tab-btn-active');
                }
            })();
        </script>

        <!-- TAB 1: Assessment Management (Tree + Editor) -->
        <div id="tab-manage"
            class="tab-content h-full flex flex-col lg:flex-row gap-6 lg:overflow-hidden pb-2 relative">
            <!-- Mobile Overlay -->
            <div id="sidebar-overlay" class="sidebar-overlay" onclick="app.toggleSidebar(false)"></div>

            <!-- Left: Unit Tree (Sidebar) -->
            <div id="sidebar-panel"
                class="w-full lg:w-1/3 bg-white rounded-xl shadow-sm border border-gray-200 flex flex-col lg:overflow-hidden min-h-[300px] lg:min-h-0 lg:static fixed h-full top-0 right-0 z-50">
                <div class="p-4 border-b bg-gray-50 font-bold text-gray-700 flex justify-between items-center">
                    <span>ğŸ“š ë‹¨ì› ë° í‰ê°€ ì„ íƒ</span>
                    <button class="lg:hidden text-gray-500 hover:text-gray-700" onclick="app.toggleSidebar(false)">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="flex-1 overflow-y-auto p-4" id="tree-container"></div>
            </div>

            <!-- Mobile FAB to Open Sidebar -->
            <button class="fab-btn lg:hidden" onclick="app.toggleSidebar(true)"><i
                    class="fas fa-list-ul text-xl"></i></button>

            <!-- Right: Assessment Editor -->
            <div class="w-full lg:w-2/3 bg-white rounded-xl shadow-sm border border-gray-200 flex flex-col relative lg:overflow-hidden min-h-[600px] lg:min-h-0"
                id="editor-panel">
                <!-- Empty State -->
                <div id="empty-state"
                    class="absolute inset-0 flex flex-col items-center justify-center text-gray-400 bg-white z-20">
                    <i class="fas fa-mouse-pointer text-4xl mb-4"></i>
                    <p class="text-lg text-center">ëª©ì°¨ì—ì„œ <strong>ì •ê¸° ì‹œí—˜ ëŒ€ë¹„</strong>ë˜ëŠ”<br><strong>ì¤‘ë‹¨ì›</strong>ì„ ì„ íƒí•˜ì—¬ ë¬¸ì œë¥¼
                        ê´€ë¦¬í•˜ì„¸ìš”.</p>
                </div>

                <!-- Editor Header -->
                <div class="p-4 border-b bg-gray-50 flex flex-wrap justify-between items-center shrink-0 gap-2">
                    <div>
                        <div class="text-xs text-gray-500 font-bold mb-1" id="selected-path"></div>
                        <div class="flex items-center gap-2">
                            <h2 class="text-xl font-bold text-gray-800" id="selected-title">-
                            </h2>
                            <!-- Settings Button -->
                            <button onclick="app.openSettingsModal()"
                                class="text-gray-400 hover:text-blue-600 transition p-1" title="í‰ê°€ ì„¤ì • (ì‹œê°„, ì¬ì‘ì‹œ ë“±)">
                                <i class="fas fa-cog"></i>
                            </button>
                        </div>
                    </div>
                    <!-- Toggle -->
                    <div class="flex items-center gap-3">
                        <label class="flex items-center cursor-pointer relative">
                            <input type="checkbox" id="toggle-active" class="sr-only toggle-checkbox"
                                onchange="app.saveSettings()">
                            <div class="toggle-label bg-gray-300 rounded-full w-10 h-6 relative">
                                <div
                                    class="toggle-dot bg-white w-5 h-5 rounded-full absolute top-0.5 left-0.5 shadow-sm">
                                </div>
                            </div>
                            <span class="ml-2 text-sm font-bold text-gray-600" id="toggle-text">í•™ìƒ ë¹„ê³µê°œ</span>
                        </label>
                    </div>
                </div>

                <!-- 1. Normal Mode: Sub Tabs -->
                <div class="bg-white shrink-0 flex border-b border-gray-200 px-4 pt-2" id="sub-tabs">
                    <button onclick="app.setSubTab('diagnostic')" id="sub-btn-diagnostic"
                        class="py-2 px-4 font-bold text-sm border-b-2 border-blue-500 text-blue-600">ì§„ë‹¨í‰ê°€</button>
                    <button onclick="app.setSubTab('formative')" id="sub-btn-formative"
                        class="py-2 px-4 font-bold text-sm border-b-2 border-transparent text-gray-400 hover:text-gray-600">í˜•ì„±í‰ê°€</button>
                </div>

                <!-- 2. Exam Prep Mode: Cascading Filters -->
                <div class="bg-blue-50 shrink-0 border-b border-blue-100 px-4 py-3 hidden" id="ep-filter-container">
                    <div class="flex flex-wrap items-center gap-2 text-sm">
                        <i class="fas fa-filter text-blue-500"></i><span class="font-bold text-blue-800 mr-1">ë‹¨ì›
                            í•„í„°:</span>
                        <select id="ep-filter-big" onchange="app.updateEpSelects('filter', 'big')"
                            class="border border-blue-200 rounded px-2 py-1 text-xs w-28 bg-white focus:outline-none focus:border-blue-500">
                            <option value="">ëŒ€ë‹¨ì› ì „ì²´</option>
                        </select>
                        <i class="fas fa-chevron-right text-blue-300 text-xs"></i>
                        <select id="ep-filter-mid" onchange="app.updateEpSelects('filter', 'mid')"
                            class="border border-blue-200 rounded px-2 py-1 text-xs w-28 bg-white focus:outline-none focus:border-blue-500">
                            <option value="">ì¤‘ë‹¨ì› ì „ì²´</option>
                        </select>
                        <i class="fas fa-chevron-right text-blue-300 text-xs"></i>
                        <select id="ep-filter-small" onchange="app.updateEpSelects('filter', 'small')"
                            class="border border-blue-200 rounded px-2 py-1 text-xs w-28 bg-white focus:outline-none focus:border-blue-500">
                            <option value="">ì†Œë‹¨ì› ì „ì²´</option>
                        </select>
                        <button onclick="app.resetEpFilters()"
                            class="ml-auto text-xs text-blue-400 hover:text-blue-600"><i
                                class="fas fa-sync-alt"></i></button>
                    </div>
                </div>

                <!-- Questions List -->
                <div class="flex-1 overflow-y-auto p-6 bg-gray-50 space-y-4">
                    <div id="q-list" class="space-y-3"></div>

                    <!-- Add Form Area -->
                    <div class="mt-8 bg-white p-5 rounded-xl border-2 border-dashed border-gray-300 relative">
                        <h3 class="font-bold text-gray-700 mb-4 flex items-center"><i
                                class="fas fa-plus-circle text-blue-500 mr-2"></i>ìƒˆ ë¬¸ì œ ì¶”ê°€</h3>
                        <div class="space-y-3">
                            <div class="grid grid-cols-2 gap-3">
                                <select id="new-q-type" class="border p-2 rounded text-sm bg-gray-50">
                                    <option value="choice">ê°ê´€ì‹</option>
                                    <option value="ox">O/X</option>
                                    <option value="word">ë‹¨ë‹µí˜•</option>
                                    <option value="order">ìˆœì„œë‚˜ì—´</option>
                                </select>
                                <!-- Normal Mode: Single Subunit Select -->
                                <select id="new-q-subunit" class="border p-2 rounded text-sm bg-gray-50">
                                    <option value="">ì†Œë‹¨ì› (ì „ì²´)</option>
                                </select>
                            </div>

                            <!-- Exam Prep Mode: Cascading Selects for Assignment -->
                            <div id="ep-add-container" class="hidden bg-blue-50 p-2 rounded border border-blue-100">
                                <div class="text-xs font-bold text-blue-600 mb-1 flex items-center"><i
                                        class="fas fa-tag mr-1"></i>ë¬¸ì œ ì¶œì²˜ ë‹¨ì› ì§€ì •</div>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
                                    <select id="ep-add-big" onchange="app.updateEpSelects('add', 'big')"
                                        class="border border-blue-200 rounded p-1.5 text-xs bg-white">
                                        <option value="">ëŒ€ë‹¨ì› ì„ íƒ</option>
                                    </select>
                                    <select id="ep-add-mid" onchange="app.updateEpSelects('add', 'mid')"
                                        class="border border-blue-200 rounded p-1.5 text-xs bg-white">
                                        <option value="">ì¤‘ë‹¨ì› ì„ íƒ</option>
                                    </select>
                                    <select id="ep-add-small"
                                        class="border border-blue-200 rounded p-1.5 text-xs bg-white">
                                        <option value="">ì†Œë‹¨ì› ì„ íƒ</option>
                                    </select>
                                </div>
                            </div>

                            <input type="text" id="new-q-text" placeholder="ë¬¸ì œ ë‚´ìš© ì…ë ¥"
                                class="w-full border p-2 rounded text-sm">
                            <div class="flex items-center gap-2">
                                <label
                                    class="flex items-center gap-2 text-xs font-bold text-gray-500 cursor-pointer hover:text-blue-600">
                                    <i class="fas fa-image text-lg"></i>ì´ë¯¸ì§€ ì²¨ë¶€
                                    <input type="file" id="new-q-image" class="hidden" accept="image/*"
                                        onchange="app.handleImageSelect(this, 'new-q-preview')">
                                </label>
                                <span id="new-q-preview-name"
                                    class="text-xs text-gray-400 truncate max-w-[200px]"></span>
                            </div>
                            <img id="new-q-preview" class="hidden h-20 rounded border border-gray-200 object-contain">
                            <input type="text" id="new-q-options" placeholder="ë³´ê¸° (ì½¤ë§ˆë¡œ êµ¬ë¶„, ê°ê´€ì‹/ìˆœì„œìš©)"
                                class="w-full border p-2 rounded text-sm">
                            <input type="text" id="new-q-answer" placeholder="ì •ë‹µ"
                                class="w-full border p-2 rounded text-sm font-bold text-blue-600">
                            <textarea id="new-q-exp" placeholder="í•´ì„¤ (ì„ íƒ)"
                                class="w-full border p-2 rounded text-sm h-16 resize-none"></textarea>
                            <div class="grid grid-cols-2 gap-2 mt-2">
                                <button onclick="app.previewNewQuestion()"
                                    class="bg-white border border-gray-300 text-gray-700 font-bold py-2 rounded hover:bg-gray-50 transition"><i
                                        class="fas fa-eye mr-2"></i>ë¯¸ë¦¬ë³´ê¸° </button>
                                <button onclick="app.addQuestion()"
                                    class="bg-blue-600 text-white font-bold py-2 rounded hover:bg-blue-700 transition">ë“±ë¡
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB 2 & 3 -->
        <div id="tab-log" class="tab-content hidden h-full overflow-y-auto">
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-gray-800">ì œì¶œ í˜„í™© <span id="log-count"
                            class="text-sm font-normal text-gray-500"></span></h2>
                    <div class="flex gap-2">
                        <select id="select-class-trigger" onchange="app.loadByClass(this.value)"
                            class="border rounded px-3 py-2 text-sm font-bold">
                            <option value="">ë°˜ ì„ íƒ</option>
                            <option value="all">ì „ì²´ (ìµœê·¼ 50ê°œ)</option>
                            <option value="1">1ë°˜</option>
                            <option value="2">2ë°˜</option>
                            <option value="3">3ë°˜</option>
                            <option value="4">4ë°˜</option>
                            <option value="5">5ë°˜</option>
                            <option value="6">6ë°˜</option>
                            <option value="7">7ë°˜</option>
                            <option value="8">8ë°˜</option>
                            <option value="9">9ë°˜</option>
                            <option value="10">10ë°˜</option>
                        </select>
                        <button onclick="app.loadByClass(document.getElementById('select-class-trigger').value)"
                            class="bg-gray-100 p-2 rounded"><i class="fas fa-sync-alt"></i></button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left whitespace-nowrap">
                        <thead class="bg-gray-50 text-gray-600 font-bold border-b">
                            <tr>
                                <th class="p-4 w-32 cursor-pointer hover:bg-gray-100"
                                    onclick="app.sortLog('timestamp')">ì‹œê°„ <i class="fas fa-sort sort-icon"></i></th>
                                <th class="p-4 w-16 cursor-pointer hover:bg-gray-100" onclick="app.sortLog('class')">ë°˜
                                    <i class="fas fa-sort sort-icon"></i>
                                </th>
                                <th class="p-4 w-16 cursor-pointer hover:bg-gray-100" onclick="app.sortLog('number')">ë²ˆí˜¸
                                    <i class="fas fa-sort sort-icon"></i>
                                </th>
                                <th class="p-4 w-32 cursor-pointer hover:bg-gray-100"
                                    onclick="app.sortLog('studentName')">í•™ìƒ <i class="fas fa-sort sort-icon"></i></th>
                                <th class="p-4 w-24 cursor-pointer hover:bg-gray-100" onclick="app.sortLog('score')">ì ìˆ˜
                                    <i class="fas fa-sort sort-icon"></i>
                                </th>
                                <th class="p-4 w-24 cursor-pointer hover:bg-gray-100" onclick="app.sortLog('status')">ìƒíƒœ
                                    <i class="fas fa-sort sort-icon"></i>
                                </th>
                                <th class="p-4 w-20">ê´€ë¦¬</th>
                            </tr>
                        </thead>
                        <tbody id="log-body" class="divide-y divide-gray-100"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="tab-bank" class="tab-content hidden h-full overflow-hidden flex flex-col">
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 flex flex-col h-full overflow-hidden">
                <div class="p-4 border-b bg-gray-50 flex flex-wrap gap-3 items-center shrink-0">
                    <!-- Group 1: Unit hierarchy -->
                    <div class="flex flex-wrap items-center gap-2">
                        <i class="fas fa-filter text-gray-400"></i>
                        <select id="filter-big" onchange="app.filterBank('big')"
                            class="minimal-select text-sm w-28 text-gray-700">
                            <option value="">ëŒ€ë‹¨ì› ì „ì²´</option>
                        </select>
                        <i class="fas fa-chevron-right text-gray-300 text-xs"></i>
                        <select id="filter-mid" onchange="app.filterBank('mid')"
                            class="minimal-select text-sm w-28 text-gray-700">
                            <option value="">ì¤‘ë‹¨ì› ì „ì²´</option>
                        </select>
                        <i class="fas fa-chevron-right text-gray-300 text-xs"></i>
                        <select id="filter-small" onchange="app.filterBank('small')"
                            class="minimal-select text-sm w-28 text-gray-700">
                            <option value="">ì†Œë‹¨ì› ì „ì²´</option>
                        </select>
                    </div>

                    <!-- Divider -->
                    <div class="w-px bg-gray-300 self-stretch mx-2" style="min-height:24px;"></div>

                    <!-- Group 2: Type -->
                    <select id="filter-type" onchange="app.filterBank('type')"
                        class="minimal-select text-sm w-24 text-gray-700">
                        <option value="">ìœ í˜• ì „ì²´</option>
                        <option value="choice">ê°ê´€ì‹</option>
                        <option value="ox">O/X</option>
                        <option value="word">ë‹¨ë‹µí˜•</option>
                        <option value="order">ìˆœì„œ</option>
                    </select>

                    <!-- Divider -->
                    <div class="w-px bg-gray-300 self-stretch mx-2" style="min-height:24px;"></div>

                    <!-- Group 3: Eval type -->
                    <select id="filter-eval-type" onchange="app.filterBank('evalType')"
                        class="minimal-select text-sm w-24 text-gray-700">
                        <option value="">í‰ê°€ êµ¬ë¶„</option>
                        <option value="diagnosis">ì§„ë‹¨í‰ê°€</option>
                        <option value="formative">í˜•ì„±í‰ê°€</option>
                        <option value="exam">ì •ê¸°ì‹œí—˜</option>
                    </select>

                    <div class="ml-auto text-xs text-gray-500">ì´ <span id="bank-total-count"
                            class="font-bold text-blue-600">0</span>ë¬¸ì œ</div>
                </div>
                <div class="flex-1 overflow-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-white font-bold text-gray-700 sticky top-0 shadow-sm z-10">
                            <tr>
                                <th class="p-3 w-16 text-center sortable" onclick="app.sortBank('id')">ID <i
                                        class="fas fa-sort sort-icon"></i></th>
                                <th class="p-3 w-20 text-center sortable" onclick="app.sortBank('category')">ë¶„ë¥˜ <i
                                        class="fas fa-sort sort-icon"></i></th>
                                <th class="p-3 w-40 sortable" onclick="app.sortBank('unit')">ë‹¨ì› ì •ë³´ <i
                                        class="fas fa-sort sort-icon"></i></th>
                                <th class="p-3 w-20 text-center sortable" onclick="app.sortBank('type')">ìœ í˜• <i
                                        class="fas fa-sort sort-icon"></i></th>
                                <th class="p-3">ë¬¸ì œ</th>
                                <th class="p-3 w-32">ì •ë‹µ</th>
                                <th class="p-3 w-24 text-center sortable" onclick="app.sortBank('rate')">ì •ë‹µë¥  <i
                                        class="fas fa-sort sort-icon"></i></th>
                                <th class="p-3 w-16 text-center">ê´€ë¦¬</th>
                            </tr>
                        </thead>
                        <tbody id="bank-body" class="divide-y divide-gray-100 bg-white"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center">
        <div class="absolute inset-0 bg-black bg-opacity-50 backdrop-blur-sm" onclick="app.closeSettingsModal()"></div>
        <div class="bg-white rounded-xl shadow-2xl z-10 w-96 p-6 mx-4 relative transform transition-all">
            <h3 class="font-bold text-lg text-gray-800 mb-4 border-b pb-2 flex items-center gap-2"><i
                    class="fas fa-sliders-h text-blue-500"></i>í‰ê°€ ìƒì„¸ ì„¤ì • </h3>
            <div class="space-y-5">
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">í•œ ë²ˆì— ì¶œì œí•  ë¬¸í•­ ìˆ˜</label>
                    <div class="flex items-center gap-2">
                        <input type="number" id="setting-count"
                            class="flex-1 border rounded p-2 text-center font-bold text-blue-600 text-lg"
                            placeholder="10"><span class="text-sm font-bold text-gray-600">ê°œ</span>
                    </div>
                    <p class="text-[10px] text-gray-400 mt-1 leading-tight">* ë¬¸ì œ ì€í–‰ì—ì„œ ëœë¤ìœ¼ë¡œ ì¶”ì¶œë©ë‹ˆë‹¤.<br>* ë¯¸í’€ì´ ë¬¸í•­ì„ ìš°ì„  ì¶œì œí•˜ë©°,
                        <br> * ì •ê¸° ì‹œí—˜ ëŒ€ë¹„ëŠ” ë‹¨ì›ë³„ ê· í˜• ì¶œì œ ë¡œì§ì´ ì ìš©ë©ë‹ˆë‹¤.
                    </p>
                </div>
                <div><label class="block text-xs font-bold text-gray-500 mb-1">ì œí•œ ì‹œê°„ (ì´ˆ)</label><input type="number"
                        id="setting-time" class="w-full border rounded p-2 text-center font-bold text-lg"></div>
                <div><label
                        class="flex items-center justify-between cursor-pointer p-3 bg-gray-50 rounded-lg border border-gray-200"><span
                            class="text-sm font-bold text-gray-600">ì¬ì‘ì‹œ í—ˆìš©</span><input type="checkbox"
                            id="setting-retake" class="w-5 h-5 text-blue-600 rounded"
                            onchange="app.toggleCooldownInput()"></label></div>
                <div id="cooldown-area"><label class="block text-xs font-bold text-gray-500 mb-1">ì¬ì‘ì‹œ ëŒ€ê¸° ì‹œê°„
                        (ë¶„)</label><input type="number" id="setting-cooldown"
                        class="w-full border rounded p-2 text-center font-bold text-lg"></div>
            </div>
            <div class="mt-8 flex justify-end"><button onclick="app.saveSettings(true)"
                    class="bg-blue-600 text-white px-4 py-3 rounded-xl font-bold hover:bg-blue-700 w-full shadow-lg transition transform active:scale-95">ì„¤ì •
                    ì €ì¥í•˜ê¸°</button></div>
        </div>
    </div>

    <!-- Preview Modal -->
    <div id="preview-modal" class="fixed inset-0 z-[60] hidden flex items-center justify-center">
        <div class="absolute inset-0 bg-black bg-opacity-70 backdrop-blur-sm"
            onclick="document.getElementById('preview-modal').classList.add('hidden')"></div>
        <div class="bg-white rounded-xl shadow-2xl z-10 w-full max-w-md p-6 relative mx-4">
            <div class="flex justify-between items-center mb-4"><span
                    class="text-xs font-bold bg-blue-100 text-blue-700 px-2 py-1 rounded">ë¯¸ë¦¬ë³´ê¸°</span><button
                    onclick="document.getElementById('preview-modal').classList.add('hidden')"
                    class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-lg"></i></button></div>
            <div id="preview-content"></div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="edit-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center">
        <div class="absolute inset-0 bg-black bg-opacity-50 backdrop-blur-sm" onclick="app.closeEditModal()"></div>
        <div class="bg-white rounded-xl shadow-2xl z-10 w-full max-w-2xl p-6 mx-4 relative flex flex-col max-h-[90vh]">
            <div class="flex justify-between items-center mb-4 border-b pb-3">
                <h3 class="font-bold text-lg text-gray-800"><i class="fas fa-edit text-blue-500 mr-2"></i>ë¬¸ì œ ìˆ˜ì •</h3>
                <button onclick="app.closeEditModal()" class="text-gray-400 hover:text-gray-600"><i
                        class="fas fa-times"></i></button>
            </div>
            <div class="overflow-y-auto flex-1 space-y-4 pr-2">
                <input type="hidden" id="edit-id">
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-xs font-bold text-gray-500 mb-1">ë¶„ë¥˜</label><select id="edit-category"
                            class="w-full border p-2 rounded text-sm bg-gray-50 font-bold">
                            <option value="diagnostic">ì§„ë‹¨í‰ê°€</option>
                            <option value="formative">í˜•ì„±í‰ê°€</option>
                            <option value="exam_prep">ì •ê¸° ì‹œí—˜ ëŒ€ë¹„</option>
                        </select></div>
                    <div><label class="block text-xs font-bold text-gray-500 mb-1">ìœ í˜•</label><select id="edit-type"
                            class="w-full border p-2 rounded text-sm bg-gray-50">
                            <option value="choice">ê°ê´€ì‹</option>
                            <option value="ox">O/X</option>
                            <option value="word">ë‹¨ë‹µí˜•</option>
                            <option value="order">ìˆœì„œë‚˜ì—´</option>
                        </select></div>
                </div>
                <div class="bg-gray-50 p-3 rounded border border-gray-200">
                    <label class="block text-xs font-bold text-gray-500 mb-2">ë‹¨ì› ì´ë™</label>
                    <div class="grid grid-cols-2 gap-2"><select id="edit-unit" onchange="app.updateEditSubUnits()"
                            class="w-full border p-2 rounded text-sm"></select><select id="edit-subunit"
                            class="w-full border p-2 rounded text-sm"></select></div>
                </div>
                <div><label class="block text-xs font-bold text-gray-500 mb-1">ë¬¸ì œ ë‚´ìš©</label><input type="text"
                        id="edit-question" class="w-full border p-2 rounded text-sm font-bold"></div>
                <div>
                    <div class="flex items-center gap-2 mb-2">
                        <label
                            class="flex items-center gap-2 text-xs font-bold text-gray-500 cursor-pointer hover:text-blue-600 bg-gray-100 px-3 py-1 rounded"><i
                                class="fas fa-image"></i>ì´ë¯¸ì§€ ë³€ê²½<input type="file" id="edit-image" class="hidden"
                                accept="image/*" onchange="app.handleImageSelect(this, 'edit-preview')"></label>
                        <button onclick="app.removeEditImage()"
                            class="text-xs text-red-500 hover:text-red-700 font-bold px-2">ì‚­ì œ</button>
                    </div>
                    <img id="edit-preview"
                        class="hidden h-24 rounded border border-gray-200 object-contain bg-white p-1">
                </div>
                <div><label class="block text-xs font-bold text-gray-500 mb-1">ë³´ê¸° (ì½¤ë§ˆ êµ¬ë¶„)</label><input type="text"
                        id="edit-options" class="w-full border p-2 rounded text-sm"></div>
                <div><label class="block text-xs font-bold text-gray-500 mb-1">ì •ë‹µ</label><input type="text"
                        id="edit-answer" class="w-full border p-2 rounded text-sm font-bold text-blue-600 bg-blue-50">
                </div>
                <div><label class="block text-xs font-bold text-gray-500 mb-1">í•´ì„¤</label><textarea id="edit-explanation"
                        class="w-full border p-2 rounded text-sm h-20 resize-none"></textarea></div>
            </div>
            <div class="mt-6 pt-4 border-t flex justify-end gap-3">
                <button onclick="app.closeEditModal()"
                    class="px-4 py-2 bg-white border border-gray-300 rounded text-gray-700 font-bold hover:bg-gray-50">ì·¨ì†Œ</button>
                <button onclick="app.saveEditQuestion()"
                    class="px-6 py-2 bg-blue-600 text-white rounded font-bold hover:bg-blue-700 shadow-md">ìˆ˜ì •
                    ì €ì¥</button>
            </div>
        </div>
    </div>

    <!-- Footer injected by AuthManager -->

    <script type="module">
        window.AuthManager.init('teacher');

        window.app = {
            treeData: [],
            questions: [],
            selectedNode: null,
            selectedCategory: 'diagnostic',
            assessmentSettings: {},
            examPrepFilters: { big: '', mid: '', small: '' },
            tempImage: null,

            init: function () {
                this.loadTree();
                this.loadQuestions();
                this.loadSettings();

                // Handle URL Tab Param
                const urlParams = new URLSearchParams(window.location.search);
                const tab = urlParams.get('tab');
                if (tab) this.setTab(tab);
            },

            toggleSidebar: function (show) {
                const panel = document.getElementById('sidebar-panel');
                const overlay = document.getElementById('sidebar-overlay');
                if (show) {
                    panel.classList.add('open');
                    overlay.classList.add('active');
                } else {
                    panel.classList.remove('open');
                    overlay.classList.remove('active');
                }
            },

            setTab: function (tab) {
                document.querySelectorAll('.tab-btn-base').forEach(b => b.classList.remove('tab-btn-active'));
                document.getElementById('btn-tab-' + tab).classList.add('tab-btn-active');
                document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
                document.getElementById('tab-' + tab).classList.remove('hidden');
            },

            setSubTab: function (cat) {
                this.selectedCategory = cat;
                document.getElementById('sub-btn-diagnostic').className = cat === 'diagnostic' ? "py-2 px-4 font-bold text-sm border-b-2 border-blue-500 text-blue-600" : "py-2 px-4 font-bold text-sm border-b-2 border-transparent text-gray-400 hover:text-gray-600";
                document.getElementById('sub-btn-formative').className = cat === 'formative' ? "py-2 px-4 font-bold text-sm border-b-2 border-blue-500 text-blue-600" : "py-2 px-4 font-bold text-sm border-b-2 border-transparent text-gray-400 hover:text-gray-600";
                this.renderQuestions();
                this.updateSettingsUI();
            },

            loadTree: async function () {
                try {
                    const doc = await window.getCollection('curriculum').doc('tree').get();
                    this.treeData = (doc.exists && doc.data().tree) ? doc.data().tree : [];
                    this.renderTree();
                    this.initBankFilters();
                } catch (e) { }
            },

            loadQuestions: async function () {
                const snap = await window.getCollection('quiz_questions').get();
                this.questions = [];
                snap.forEach(doc => this.questions.push({ id: parseInt(doc.id), ...doc.data() }));
            },

            loadSettings: async function () {
                const doc = await window.getCollection('assessment_config').doc('settings').get();
                this.assessmentSettings = (doc.exists) ? doc.data() : {};
            },

            renderTree: function () {
                const container = document.getElementById('tree-container');
                container.innerHTML = '';

                const examNode = document.createElement('div');
                examNode.className = 'tree-item exam-prep';
                examNode.innerHTML = '<i class="fas fa-file-contract mr-2"></i>ì •ê¸° ì‹œí—˜ ëŒ€ë¹„ ì‹¤ì „';
                examNode.onclick = () => this.selectExamPrep(examNode);
                container.appendChild(examNode);

                this.treeData.forEach(big => {
                    const bigEl = document.createElement('div');
                    bigEl.className = 'tree-node level-0';
                    bigEl.innerHTML = `<div class="font-bold text-gray-800 py-1 select-none">${big.title}</div>`;

                    if (big.children) {
                        big.children.forEach(mid => {
                            const midEl = document.createElement('div');
                            midEl.className = 'tree-node level-1';
                            const item = document.createElement('div');
                            item.className = 'tree-item';
                            item.innerHTML = `<i class="fas fa-folder text-yellow-400 mr-2"></i>${mid.title}`;
                            item.onclick = () => this.selectNode(mid, big.title, item);
                            midEl.appendChild(item);
                            bigEl.appendChild(midEl);
                        });
                    }
                    container.appendChild(bigEl);
                });
            },

            selectExamPrep: function (el) {
                this.resetSelection();
                el.classList.add('active');
                this.selectedNode = { id: 'exam_prep', title: 'ì •ê¸° ì‹œí—˜ ëŒ€ë¹„ ì‹¤ì „', type: 'special' };
                this.renderEditor();
                this.toggleSidebar(false);
                if (window.innerWidth < 1024) document.getElementById('editor-panel').scrollIntoView({ behavior: 'smooth' });
            },

            selectNode: function (node, parentTitle, el) {
                this.resetSelection();
                el.classList.add('active');
                this.selectedNode = { ...node, parentTitle };
                this.renderEditor();
                this.toggleSidebar(false);
                if (window.innerWidth < 1024) document.getElementById('editor-panel').scrollIntoView({ behavior: 'smooth' });
            },

            resetSelection: function () {
                document.querySelectorAll('.tree-item').forEach(e => e.classList.remove('active'));
                document.getElementById('empty-state').classList.add('hidden');
            },

            renderEditor: function () {
                const node = this.selectedNode;
                document.getElementById('selected-title').innerText = node.title;
                document.getElementById('selected-path').innerText = node.type === 'special' ? 'íŠ¹ë³„ í•™ìŠµ' : `${node.parentTitle} > ${node.title}`;

                const subTabs = document.getElementById('sub-tabs');
                const epFilters = document.getElementById('ep-filter-container');
                const epAddContainer = document.getElementById('ep-add-container');
                const normalSubUnitSelect = document.getElementById('new-q-subunit');

                if (node.id === 'exam_prep') {
                    subTabs.classList.add('hidden');
                    epFilters.classList.remove('hidden');
                    epAddContainer.classList.remove('hidden');
                    normalSubUnitSelect.classList.add('hidden');
                    this.selectedCategory = 'exam_prep';
                    this.updateEpSelects('filter', 'init');
                    this.updateEpSelects('add', 'init');
                } else {
                    subTabs.classList.remove('hidden');
                    epFilters.classList.add('hidden');
                    epAddContainer.classList.add('hidden');
                    normalSubUnitSelect.classList.remove('hidden');
                    this.setSubTab('diagnostic');
                    normalSubUnitSelect.innerHTML = '<option value="">ì†Œë‹¨ì› (ì „ì²´)</option>';
                    if (node.children) {
                        node.children.forEach(small => {
                            const opt = document.createElement('option');
                            opt.value = small.id;
                            opt.innerText = small.title;
                            normalSubUnitSelect.appendChild(opt);
                        });
                    }
                }
                this.renderQuestions();
                this.updateSettingsUI();
            },

            updateEpSelects: function (prefix, level) {
                const idBig = prefix === 'filter' ? 'ep-filter-big' : 'ep-add-big';
                const idMid = prefix === 'filter' ? 'ep-filter-mid' : 'ep-add-mid';
                const idSmall = prefix === 'filter' ? 'ep-filter-small' : 'ep-add-small';
                const elBig = document.getElementById(idBig);
                const elMid = document.getElementById(idMid);
                const elSmall = document.getElementById(idSmall);

                if (level === 'init') {
                    elBig.innerHTML = `<option value="">${prefix === 'filter' ? 'ëŒ€ë‹¨ì› ì „ì²´' : 'ëŒ€ë‹¨ì› ì„ íƒ'}</option>`;
                    this.treeData.forEach(big => {
                        const opt = document.createElement('option');
                        opt.value = big.id; opt.innerText = big.title;
                        elBig.appendChild(opt);
                    });
                    elMid.innerHTML = `<option value="">${prefix === 'filter' ? 'ì¤‘ë‹¨ì› ì „ì²´' : 'ì¤‘ë‹¨ì› ì„ íƒ'}</option>`;
                    elSmall.innerHTML = `<option value="">${prefix === 'filter' ? 'ì†Œë‹¨ì› ì „ì²´' : 'ì†Œë‹¨ì› ì„ íƒ'}</option>`;
                } else if (level === 'big') {
                    elMid.innerHTML = `<option value="">${prefix === 'filter' ? 'ì¤‘ë‹¨ì› ì „ì²´' : 'ì¤‘ë‹¨ì› ì„ íƒ'}</option>`;
                    elSmall.innerHTML = `<option value="">${prefix === 'filter' ? 'ì†Œë‹¨ì› ì „ì²´' : 'ì†Œë‹¨ì› ì„ íƒ'}</option>`;
                    const bigNode = this.treeData.find(b => b.id === elBig.value);
                    if (bigNode && bigNode.children) {
                        bigNode.children.forEach(mid => {
                            const opt = document.createElement('option');
                            opt.value = mid.id; opt.innerText = mid.title;
                            elMid.appendChild(opt);
                        });
                    }
                } else if (level === 'mid') {
                    elSmall.innerHTML = `<option value="">${prefix === 'filter' ? 'ì†Œë‹¨ì› ì „ì²´' : 'ì†Œë‹¨ì› ì„ íƒ'}</option>`;
                    const bigNode = this.treeData.find(b => b.id === elBig.value);
                    if (bigNode && bigNode.children) {
                        const midNode = bigNode.children.find(m => m.id === elMid.value);
                        if (midNode && midNode.children) {
                            midNode.children.forEach(small => {
                                const opt = document.createElement('option');
                                opt.value = small.id; opt.innerText = small.title;
                                elSmall.appendChild(opt);
                            });
                        }
                    }
                }

                if (prefix === 'filter') {
                    this.examPrepFilters = { big: elBig.value, mid: elMid.value, small: elSmall.value };
                    this.renderQuestions();
                }
            },

            resetEpFilters: function () {
                this.updateEpSelects('filter', 'init');
                this.examPrepFilters = { big: '', mid: '', small: '' };
                this.renderQuestions();
            },

            openSettingsModal: function () {
                if (!this.selectedNode) return;
                document.getElementById('settings-modal').classList.remove('hidden');
                document.getElementById('settings-modal').classList.add('flex');
                this.updateSettingsUI();
            },

            closeSettingsModal: function () {
                document.getElementById('settings-modal').classList.add('hidden');
                document.getElementById('settings-modal').classList.remove('flex');
            },

            updateSettingsUI: function () {
                if (!this.selectedNode) return;
                const key = `${this.selectedNode.id}_${this.selectedCategory}`;
                const config = this.assessmentSettings[key] || {};

                const isActive = config.active === true;
                document.getElementById('toggle-active').checked = isActive;
                const text = document.getElementById('toggle-text');
                text.innerText = isActive ? 'í•™ìƒ ê³µê°œ ì¤‘' : 'í•™ìƒ ë¹„ê³µê°œ';
                text.className = isActive ? 'ml-2 text-sm font-bold text-green-600' : 'ml-2 text-sm font-bold text-gray-400';

                document.getElementById('setting-count').value = config.questionCount || 10;
                document.getElementById('setting-time').value = config.timeLimit || 60;
                document.getElementById('setting-retake').checked = config.allowRetake !== false;
                document.getElementById('setting-cooldown').value = config.cooldown || 0;
                this.toggleCooldownInput();
            },

            toggleCooldownInput: function () {
                const allow = document.getElementById('setting-retake').checked;
                const area = document.getElementById('cooldown-area');
                area.style.opacity = allow ? '1' : '0.5';
                document.getElementById('setting-cooldown').disabled = !allow;
            },

            saveSettings: async function (isModal = false) {
                if (!this.selectedNode) return;
                const key = `${this.selectedNode.id}_${this.selectedCategory}`;

                const newData = {
                    active: document.getElementById('toggle-active').checked,
                    questionCount: parseInt(document.getElementById('setting-count').value) || 10,
                    timeLimit: parseInt(document.getElementById('setting-time').value) || 60,
                    allowRetake: document.getElementById('setting-retake').checked,
                    cooldown: parseInt(document.getElementById('setting-cooldown').value) || 0
                };

                this.assessmentSettings[key] = newData;
                this.updateSettingsUI();

                await window.getCollection('assessment_config').doc('settings').set({ [key]: newData }, { merge: true });

                if (isModal) {
                    this.closeSettingsModal();
                    alert("ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
                }
            },

            previewNewQuestion: function () {
                const type = document.getElementById('new-q-type').value;
                const text = document.getElementById('new-q-text').value;
                const options = document.getElementById('new-q-options').value;
                const ans = document.getElementById('new-q-answer').value;

                if (!text) {
                    alert("ë¬¸ì œ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                    return;
                }

                const mockQ = {
                    id: 'temp', type: type, question: text, answer: ans,
                    options: options ? options.split(',').map(s => s.trim()) : [],
                    image: this.tempImage
                };
                this.showPreviewModal(mockQ);
            },

            showPreviewModal: function (q) {
                const container = document.getElementById('preview-content');
                let html = `<div class="mb-4"><span class="text-xs bg-gray-100 px-2 py-1 rounded text-gray-500">${q.type}</span>
                    ${q.image ? `<img src="${q.image}" class="preview-img">` : ''}
                    <h4 class="font-bold text-lg mt-2 text-gray-800">${q.question}</h4></div>`;

                if (q.type === 'choice') {
                    html += `<div class="space-y-2">${(q.options || []).map(opt =>
                        `<div class="preview-choice" onclick="app.simulateAnswer(this, '${opt}', '${q.answer}')">${opt}</div>`
                    ).join('')}</div>`;
                } else if (q.type === 'ox') {
                    html += `<div class="flex gap-2"><button class="flex-1 py-4 border-2 rounded-lg font-bold text-xl hover:bg-blue-50 border-blue-200 text-blue-600" onclick="app.simulateAnswer(this, 'O', '${q.answer}')">O</button><button class="flex-1 py-4 border-2 rounded-lg font-bold text-xl hover:bg-red-50 border-red-200 text-red-600" onclick="app.simulateAnswer(this, 'X', '${q.answer}')">X</button></div>`;
                } else {
                    html += `<div class="flex gap-2"><input type="text" class="border p-2 rounded w-full" placeholder="ì •ë‹µ ì…ë ¥"><button class="bg-blue-600 text-white px-4 rounded" onclick="alert('ì˜ˆì‹œ ì •ë‹µ: ${q.answer}')">í™•ì¸</button></div>`;
                }

                container.innerHTML = html;
                document.getElementById('preview-modal').classList.remove('hidden');
                document.getElementById('preview-modal').classList.add('flex');
            },

            simulateAnswer: function (el, selected, correct) {
                if (el.parentNode) Array.from(el.parentNode.children).forEach(child => {
                    child.classList.remove('correct', 'wrong');
                    child.style.opacity = '0.5';
                });
                el.style.opacity = '1';
                if (String(selected) === String(correct)) el.classList.add('correct');
                else el.classList.add('wrong');
            },

            previewQuestion: function (id) {
                const q = this.questions.find(x => x.id === id);
                if (q) this.showPreviewModal(q);
            },

            handleImageSelect: function (input, previewId) {
                const file = input.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        this.tempImage = e.target.result;
                        const prev = document.getElementById(previewId);
                        prev.src = this.tempImage;
                        prev.classList.remove('hidden');
                        if (previewId === 'new-q-preview') document.getElementById('new-q-preview-name').innerText = file.name;
                    };
                    reader.readAsDataURL(file);
                }
            },

            addQuestion: async function () {
                if (!this.selectedNode) return;
                const text = document.getElementById('new-q-text').value;
                const ans = document.getElementById('new-q-answer').value;

                if (!text || !ans) {
                    alert("ë¬¸ì œì™€ ì •ë‹µì€ í•„ìˆ˜ì…ë‹ˆë‹¤.");
                    return;
                }

                const newId = Date.now();
                let subUnitId = null;
                let refUnitIds = {};

                if (this.selectedNode.id === 'exam_prep') {
                    refUnitIds = {
                        refBig: document.getElementById('ep-add-big').value,
                        refMid: document.getElementById('ep-add-mid').value,
                        refSmall: document.getElementById('ep-add-small').value
                    };
                    subUnitId = refUnitIds.refSmall || refUnitIds.refMid || refUnitIds.refBig || null;
                } else {
                    subUnitId = document.getElementById('new-q-subunit').value || null;
                }

                const qData = {
                    id: newId,
                    unitId: this.selectedNode.id,
                    category: this.selectedCategory,
                    subUnitId: subUnitId,
                    ...refUnitIds,
                    type: document.getElementById('new-q-type').value,
                    question: text,
                    image: this.tempImage || null,
                    answer: ans,
                    options: document.getElementById('new-q-options').value ? document.getElementById('new-q-options').value.split(',').map(s => s.trim()) : [],
                    explanation: document.getElementById('new-q-exp').value,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                await window.getCollection('quiz_questions').doc(String(newId)).set(qData);
                this.resetForm();
                this.questions.push(qData);
                this.renderQuestions();
            },

            resetForm: function () {
                document.getElementById('new-q-text').value = '';
                document.getElementById('new-q-options').value = '';
                document.getElementById('new-q-answer').value = '';
                document.getElementById('new-q-exp').value = '';
                document.getElementById('new-q-image').value = '';
                document.getElementById('new-q-preview').classList.add('hidden');
                document.getElementById('new-q-preview-name').innerText = '';
                this.tempImage = null;
            },

            deleteQuestion: async function (id) {
                if (confirm("ì‚­ì œ?")) {
                    await window.getCollection('quiz_questions').doc(String(id)).delete();
                    this.questions = this.questions.filter(q => String(q.id) !== String(id));
                    this.renderQuestions();
                }
            },

            renderQuestions: function () {
                const list = document.getElementById('q-list');
                let filtered = this.questions.filter(q => q.unitId === this.selectedNode.id && q.category === this.selectedCategory);

                if (this.selectedNode.id === 'exam_prep') {
                    if (this.examPrepFilters.big) filtered = filtered.filter(q => q.refBig === this.examPrepFilters.big);
                    if (this.examPrepFilters.mid) filtered = filtered.filter(q => q.refMid === this.examPrepFilters.mid);
                    if (this.examPrepFilters.small) filtered = filtered.filter(q => q.refSmall === this.examPrepFilters.small);
                }

                if (filtered.length === 0) {
                    list.innerHTML = '<div class="text-center py-10 text-gray-400 border-2 border-dashed border-gray-200 rounded-lg">ë“±ë¡ëœ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                } else {
                    list.innerHTML = filtered.map((q, idx) => `
                        <div class="bg-white p-4 rounded-lg border border-gray-200 hover:border-blue-300 transition relative group shadow-sm">
                            <div class="flex justify-between items-start mb-2">
                                <span class="bg-gray-100 text-gray-600 text-[10px] font-bold px-2 py-1 rounded">Q${idx + 1} | ${q.type}</span>
                                <div class="flex gap-2">
                                    <button onclick="app.previewQuestion(${q.id})" class="text-gray-400 hover:text-green-600 text-xs border border-gray-200 px-2 py-1 rounded hover:bg-green-50 transition"><i class="fas fa-play mr-1"></i>ë¯¸ë¦¬ë³´ê¸°</button>
                                    <button onclick="app.deleteQuestion('${q.id}')" class="text-gray-300 hover:text-red-500"><i class="fas fa-trash"></i></button>
                                </div>
                            </div>
                            <div class="flex gap-4">
                                ${q.image ? `<img src="${q.image}" class="w-16 h-16 object-cover rounded border border-gray-100">` : ''}
                                <div>
                                    <p class="font-bold text-gray-800 mb-2 text-sm">${q.question}</p>
                                    <div class="text-xs text-gray-500">
                                        <span class="text-blue-600 font-bold mr-2">ì •ë‹µ: ${q.answer}</span>
                                        ${q.options ? `<span class="text-xs text-gray-400">(${q.options.join(', ')})</span>` : ''}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('');
                }
            },

            loadByClass: async function (classNum) {
                const list = document.getElementById('log-body');
                const count = document.getElementById('log-count');
                list.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-gray-400">ë¡œë”© ì¤‘...</td></tr>';

                try {
                    let q = window.getCollection('quiz_submissions').orderBy('timestamp', 'desc');
                    if (classNum !== 'all' && classNum != "") {
                        // Note: Requires composite index if filtering by class and ordering by timestamp
                        // For now, client-side filter might be safer if index missing, 
                        // but let's try direct query. If it fails, we might need to filter client-side.
                        // Assuming composite index exists or we process client-side.
                        // Let's use client-side filtering for safety on "class" field if not indexed
                    }

                    const snap = await q.limit(50).get();
                    this.logs = [];
                    snap.forEach(doc => {
                        const d = doc.data();
                        // Filter by class if needed (doing it client-side to avoid index issues for now)
                        if (classNum && classNum !== 'all' && d.gradeClass && !d.gradeClass.endsWith(`${classNum}ë°˜`)) return;

                        // Parse gradeClass string (e.g. "3í•™ë…„ 2ë°˜ 15ë²ˆ")
                        // If format is "Xí•™ë…„ Yë°˜ Zë²ˆ", we extract Z.
                        // If not, try to look for 'number' in data, or default to '-'
                        let stdNum = '-';
                        if (d.gradeClass) {
                            const parts = d.gradeClass.split(' ');
                            if (parts.length >= 3) {
                                stdNum = parseInt(parts[2].replace('ë²ˆ', '')) || 0;
                            }
                        } else if (d.number) {
                            stdNum = d.number;
                        }

                        this.logs.push({
                            id: doc.id,
                            ...d,
                            // Extract class from gradeClass string (e.g. "3í•™ë…„ 2ë°˜") or user info
                            classOnly: d.gradeClass ? d.gradeClass.split(' ')[1] : '-',
                            studentNumber: stdNum
                        });
                    });

                    count.innerText = `(${this.logs.length}ê±´)`;
                    this.renderLog();
                } catch (e) {
                    console.error(e);
                    list.innerHTML = '<tr><td colspan="7" class="p-4 text-center text-red-500">ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨</td></tr>';
                }
            },

            renderLog: function () {
                const list = document.getElementById('log-body');
                if (this.logs.length === 0) {
                    list.innerHTML = '<tr><td colspan="7" class="p-4 text-center text-gray-400">ì œì¶œ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                    return;
                }
                list.innerHTML = this.logs.map(log => {
                    const date = log.timestamp ? new Date(log.timestamp.seconds * 1000).toLocaleString() : '-';
                    const scoreColor = log.score >= 80 ? 'text-green-600' : (log.score >= 60 ? 'text-blue-600' : 'text-red-600');
                    return `
                        <tr class="hover:bg-gray-50 transition">
                            <td class="p-4 text-gray-500">${date}</td>
                            <td class="p-4 font-bold text-gray-600">${log.classOnly}</td>
                            <td class="p-4 font-bold text-gray-600">${log.studentNumber !== '-' ? log.studentNumber + 'ë²ˆ' : '-'}</td>
                            <td class="p-4">
                                <div class="font-bold text-gray-800">${log.studentName || 'ì´ë¦„ ì—†ìŒ'}</div>
                                <div class="text-xs text-gray-400 truncate max-w-[150px]">${log.email || '-'}</div>
                            </td>
                            <td class="p-4 font-bold ${scoreColor}">${log.score}ì </td>
                            <td class="p-4"><span class="bg-gray-100 text-gray-600 px-2 py-1 rounded text-xs font-bold">ì œì¶œì™„ë£Œ</span></td>
                            <td class="p-4">
                                <button onclick="app.viewLogDetail('${log.id}')" class="text-blue-500 hover:text-blue-700 bg-blue-50 hover:bg-blue-100 px-3 py-1 rounded text-xs font-bold transition">ìƒì„¸</button>
                            </td>
                        </tr>
                    `;
                }).join('');
            },

            logSortField: 'timestamp',
            logSortAsc: false,

            sortLog: function (field) {
                if (this.logSortField === field) {
                    this.logSortAsc = !this.logSortAsc; // Toggle
                } else {
                    this.logSortField = field;
                    this.logSortAsc = true; // Default to asc for new field
                    // exception: timestamp default desc? user asked for filter function.
                    // Let's stick to toggle.
                    if (field === 'timestamp') this.logSortAsc = false;
                }

                // Update Icon UI
                document.querySelectorAll('#tab-log .sort-icon').forEach(i => i.className = 'fas fa-sort sort-icon');
                // We can't easily target specific header icon without ID, but let's assume simple re-render or global reset
                // Ideally add 'text-blue-500' to active sort

                this.logs.sort((a, b) => {
                    let valA = a[field];
                    let valB = b[field];

                    // Handle specific fields
                    if (field === 'class') valA = a.classOnly;
                    if (field === 'class') valB = b.classOnly;

                    if (field === 'number') valA = parseInt(a.studentNumber) || 0;
                    if (field === 'number') valB = parseInt(b.studentNumber) || 0;

                    if (valA < valB) return this.logSortAsc ? -1 : 1;
                    if (valA > valB) return this.logSortAsc ? 1 : -1;
                    return 0;
                });
                this.renderLog();
            },
            bankFilters: { big: '', mid: '', small: '', type: '', evalType: '' },
            bankSortField: 'id',
            bankSortAsc: true,

            initBankFilters: function () {
                const bigEl = document.getElementById('filter-big');
                if (!bigEl) return;
                bigEl.innerHTML = '<option value="">ëŒ€ë‹¨ì› ì „ì²´</option>';
                this.treeData.forEach(big => {
                    const opt = document.createElement('option');
                    opt.value = big.id; opt.innerText = big.title;
                    bigEl.appendChild(opt);
                });
                this.renderBank();
            },

            filterBank: function (level) {
                const bigEl = document.getElementById('filter-big');
                const midEl = document.getElementById('filter-mid');
                const smallEl = document.getElementById('filter-small');
                const typeEl = document.getElementById('filter-type');
                const evalTypeEl = document.getElementById('filter-eval-type');

                // Update Dropdowns
                if (level === 'big') {
                    midEl.innerHTML = '<option value="">ì¤‘ë‹¨ì› ì „ì²´</option>';
                    smallEl.innerHTML = '<option value="">ì†Œë‹¨ì› ì „ì²´</option>';
                    const bigNode = this.treeData.find(b => b.id === bigEl.value);
                    if (bigNode && bigNode.children) {
                        bigNode.children.forEach(mid => {
                            const opt = document.createElement('option');
                            opt.value = mid.id; opt.innerText = mid.title;
                            midEl.appendChild(opt);
                        });
                    }
                } else if (level === 'mid') {
                    smallEl.innerHTML = '<option value="">ì†Œë‹¨ì› ì „ì²´</option>';
                    const bigNode = this.treeData.find(b => b.id === bigEl.value);
                    if (bigNode && bigNode.children) {
                        const midNode = bigNode.children.find(m => m.id === midEl.value);
                        if (midNode && midNode.children) {
                            midNode.children.forEach(small => {
                                const opt = document.createElement('option');
                                opt.value = small.id; opt.innerText = small.title;
                                smallEl.appendChild(opt);
                            });
                        }
                    }
                }

                // Update current filter state
                this.bankFilters = {
                    big: bigEl.value,
                    mid: midEl.value,
                    small: smallEl.value,
                    type: typeEl.value,
                    evalType: evalTypeEl.value
                };

                this.renderBank();
            },

            sortBank: function (field) {
                if (this.bankSortField === field) this.bankSortAsc = !this.bankSortAsc;
                else { this.bankSortField = field; this.bankSortAsc = true; }
                this.renderBank();
            },

            renderBank: function () {
                let filtered = this.questions.filter(q => {
                    // Big/Mid/Small Filter
                    if (this.bankFilters.big) {
                        const bigNode = this.treeData.find(b => b.id === this.bankFilters.big);
                        if (!bigNode) return false;
                        const midIds = bigNode.children ? bigNode.children.map(m => m.id) : [];

                        if (q.category === 'exam_prep') {
                            if (q.refBig !== this.bankFilters.big) return false;
                        } else {
                            // Approximation: check if unitId is in midIds
                            if (!midIds.includes(q.unitId)) return false;
                        }
                    }

                    if (this.bankFilters.mid) {
                        if (q.category === 'exam_prep') {
                            if (q.refMid !== this.bankFilters.mid) return false;
                        } else {
                            if (q.unitId !== this.bankFilters.mid) return false;
                        }
                    }

                    if (this.bankFilters.small) {
                        if (q.category === 'exam_prep') {
                            if (q.refSmall !== this.bankFilters.small) return false;
                        } else {
                            if (q.subUnitId !== this.bankFilters.small) return false;
                        }
                    }

                    if (this.bankFilters.type && q.type !== this.bankFilters.type) return false;

                    if (this.bankFilters.evalType) {
                        const map = { 'diagnosis': 'diagnostic', 'formative': 'formative', 'exam': 'exam_prep' };
                        if (q.category !== map[this.bankFilters.evalType]) return false;
                    }

                    return true;
                });

                // Sort
                filtered.sort((a, b) => {
                    let va = a[this.bankSortField], vb = b[this.bankSortField];
                    if (this.bankSortField === 'rate') { va = 0; vb = 0; }
                    if (va < vb) return this.bankSortAsc ? -1 : 1;
                    if (va > vb) return this.bankSortAsc ? 1 : -1;
                    return 0;
                });

                const countEl = document.getElementById('bank-total-count');
                if (countEl) countEl.innerText = filtered.length;

                const tbody = document.getElementById('bank-body');
                if (!tbody) return;

                if (filtered.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" class="p-8 text-center text-gray-400">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                    return;
                }

                tbody.innerHTML = filtered.map(q => `
                    <tr class="hover:bg-blue-50 transition group">
                        <td class="p-3 text-center text-gray-500 text-xs">${q.id}</td>
                        <td class="p-3 text-center"><span class="px-2 py-1 rounded text-xs font-bold ${q.category === 'diagnostic' ? 'bg-green-100 text-green-700' : (q.category === 'formative' ? 'bg-yellow-100 text-yellow-700' : 'bg-purple-100 text-purple-700')}">${q.category === 'diagnostic' ? 'ì§„ë‹¨' : (q.category === 'formative' ? 'í˜•ì„±' : 'ì‹¤ì „')}</span></td>
                        <td class="p-3 text-xs text-gray-500 show-tooltip" title="${q.unitId}">${q.unitId || '-'}</td>
                        <td class="p-3 text-center text-xs font-bold text-gray-600">${q.type}</td>
                        <td class="p-3">
                            <div class="flex items-start gap-2">
                                ${q.image ? '<i class="fas fa-image text-blue-500"></i>' : ''}
                                <span class="font-bold text-gray-800 line-clamp-2 hover:line-clamp-none cursor-pointer" onclick="app.previewQuestion(${q.id})">${q.question}</span>
                            </div>
                        </td>
                        <td class="p-3 text-sm font-bold text-blue-600 truncate max-w-[100px]">${q.answer}</td>
                        <td class="p-3 text-center text-xs text-gray-400">-</td>
                        <td class="p-3 text-center">
                            <button onclick="alert('ìˆ˜ì • ê¸°ëŠ¥ì€ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.')" class="text-blue-500 hover:text-blue-700 mr-2"><i class="fas fa-edit"></i></button>
                            <button onclick="app.deleteQuestion('${q.id}')" class="text-red-400 hover:text-red-600"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `).join('');
            }
        };

        window.app = app;
        document.addEventListener('auth-ready', () => app.init());
    </script>
</body>

</html>