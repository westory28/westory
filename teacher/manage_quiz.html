
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í€´ì¦ˆ ê´€ë¦¬ - Westory Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="../assets/js/firebase-config.js"></script>
    <link rel="stylesheet" href="../assets/css/style.css">
    <script src="../assets/js/auth-manager.js"></script>

    <style>
        .sort-icon { margin-left: 4px; font-size: 0.8em; color: #9ca3af; }
        .sort-active { color: #2563eb; }
        .tab-btn-base { padding: 12px 24px; font-weight: 700; font-size: 0.95rem; border-bottom: 3px solid transparent; color: #6b7280; transition: all 0.2s; }
        .tab-btn-base:hover { color: #374151; background-color: #f9fafb; }
        .tab-btn-active { border-bottom-color: #2563eb; color: #2563eb; }
        
        /* Tree Styles */
        .tree-node { position: relative; }
        .tree-node.level-0 { margin-bottom: 4px; }
        .tree-node:not(.level-0) { margin-left: 20px; border-left: 1px dashed #e5e7eb; }
        .tree-item { display: flex; align-items: center; padding: 8px 12px; border-radius: 6px; cursor: pointer; transition: all 0.2s; margin-bottom: 2px; }
        .tree-item:hover { background-color: #f3f4f6; }
        .tree-item.active { background-color: #eff6ff; color: #2563eb; font-weight: bold; }
        .tree-item.exam-prep { background-color: #fffbeb; color: #b45309; border: 1px solid #fcd34d; font-weight: bold; margin-bottom: 12px; }
        .tree-item.exam-prep.active { background-color: #f59e0b; color: white; border-color: #d97706; }

        /* Toggle Switch */
        .toggle-checkbox:checked { right: 0; border-color: #68D391; }
        .toggle-checkbox:checked + .toggle-label { background-color: #68D391; }
        .toggle-checkbox { right: 0; z-index: 1; border-color: #ccc; transition: all 0.3s; }
        .toggle-label { width: 40px; height: 20px; border-radius: 9999px; transition: background-color 0.3s; background-color: #ccc; }
        .toggle-dot { top: 2px; left: 2px; width: 16px; height: 16px; border-radius: 100%; transition: all 0.3s; background-color: white; position: absolute; }
        .toggle-checkbox:checked + .toggle-label .toggle-dot { transform: translateX(100%); }

        /* Table Sort Header */
        th.sortable { cursor: pointer; user-select: none; transition: background 0.2s; }
        th.sortable:hover { background-color: #e5e7eb; }
    </style>
</head>
<body class="bg-gray-50 h-screen flex flex-col">
    <!-- Header injected by AuthManager -->

    <main class="flex-1 w-full max-w-7xl mx-auto px-6 py-6 h-full overflow-hidden flex flex-col">
        <!-- Tabs -->
        <div class="flex border-b border-gray-200 mb-4 bg-white rounded-t-lg px-2 shrink-0">
            <!-- Changed Label -->
            <button onclick="app.setTab('manage')" id="btn-tab-manage" class="tab-btn-base tab-btn-active">ë¬¸ì œ ë“±ë¡</button>
            <button onclick="app.setTab('log')" id="btn-tab-log" class="tab-btn-base">ğŸ“Š ì œì¶œ í˜„í™©</button>
            <button onclick="app.setTab('bank')" id="btn-tab-bank" class="tab-btn-base">ğŸ—„ï¸ ì „ì²´ ë¬¸ì œ ì€í–‰</button>
        </div>

        <!-- TAB 1: Assessment Management (Tree + Editor) -->
        <div id="tab-manage" class="tab-content h-full flex gap-6 overflow-hidden pb-2">
            <!-- Left: Unit Tree -->
            <div class="w-1/3 bg-white rounded-xl shadow-sm border border-gray-200 flex flex-col overflow-hidden">
                <div class="p-4 border-b bg-gray-50 font-bold text-gray-700">
                    ğŸ“š ë‹¨ì› ë° í‰ê°€ ì„ íƒ
                </div>
                <div class="flex-1 overflow-y-auto p-4" id="tree-container">
                    <!-- Tree rendered here -->
                </div>
            </div>

            <!-- Right: Assessment Editor -->
            <div class="w-2/3 bg-white rounded-xl shadow-sm border border-gray-200 flex flex-col relative overflow-hidden" id="editor-panel">
                <!-- Empty State -->
                <div id="empty-state" class="absolute inset-0 flex flex-col items-center justify-center text-gray-400 bg-white z-20">
                    <i class="fas fa-mouse-pointer text-4xl mb-4"></i>
                    <p class="text-lg text-center">ì™¼ìª½ ëª©ë¡ì—ì„œ <strong>ì§€í•„í‰ê°€ ëŒ€ë¹„</strong> ë˜ëŠ”<br><strong>ì¤‘ë‹¨ì›</strong>ì„ ì„ íƒí•˜ì—¬ ë¬¸ì œë¥¼ ê´€ë¦¬í•˜ì„¸ìš”.</p>
                </div>

                <!-- Editor Header -->
                <div class="p-4 border-b bg-gray-50 flex justify-between items-center shrink-0">
                    <div>
                        <div class="text-xs text-gray-500 font-bold mb-1" id="selected-path"></div>
                        <h2 class="text-xl font-bold text-gray-800" id="selected-title">-</h2>
                    </div>
                    <div class="flex items-center gap-3">
                        <label class="flex items-center cursor-pointer relative">
                            <input type="checkbox" id="toggle-active" class="sr-only toggle-checkbox" onchange="app.toggleActivation()">
                            <div class="toggle-label bg-gray-300 rounded-full w-10 h-6 relative">
                                <div class="toggle-dot bg-white w-5 h-5 rounded-full absolute top-0.5 left-0.5 shadow-sm"></div>
                            </div>
                            <span class="ml-2 text-sm font-bold text-gray-600" id="toggle-text">í•™ìƒ ë¹„ê³µê°œ</span>
                        </label>
                    </div>
                </div>

                <!-- Sub Tabs (Diagnostic / Formative) -->
                <div class="flex border-b border-gray-200 px-4 pt-2 bg-white shrink-0" id="sub-tabs">
                    <button onclick="app.setSubTab('diagnostic')" id="sub-btn-diagnostic" class="py-2 px-4 font-bold text-sm border-b-2 border-blue-500 text-blue-600">ì§„ë‹¨í‰ê°€</button>
                    <button onclick="app.setSubTab('formative')" id="sub-btn-formative" class="py-2 px-4 font-bold text-sm border-b-2 border-transparent text-gray-400 hover:text-gray-600">í˜•ì„±í‰ê°€</button>
                </div>

                <!-- Questions List -->
                <div class="flex-1 overflow-y-auto p-6 bg-gray-50 space-y-4">
                    <div id="q-list" class="space-y-3"></div>
                    
                    <!-- Add Form Area -->
                    <div class="mt-8 bg-white p-5 rounded-xl border-2 border-dashed border-gray-300">
                        <h3 class="font-bold text-gray-700 mb-4 flex items-center"><i class="fas fa-plus-circle text-blue-500 mr-2"></i> ìƒˆ ë¬¸ì œ ì¶”ê°€</h3>
                        <div class="space-y-3">
                            <div class="grid grid-cols-2 gap-3">
                                <select id="new-q-type" class="border p-2 rounded text-sm bg-gray-50">
                                    <option value="choice">ê°ê´€ì‹</option>
                                    <option value="ox">O/X</option>
                                    <option value="word">ë‹¨ë‹µí˜•</option>
                                    <option value="order">ìˆœì„œë‚˜ì—´</option>
                                </select>
                                <select id="new-q-subunit" class="border p-2 rounded text-sm bg-gray-50">
                                    <option value="">ì†Œë‹¨ì› (ì „ì²´)</option>
                                </select>
                            </div>
                            <input type="text" id="new-q-text" placeholder="ë¬¸ì œ ë‚´ìš© ì…ë ¥" class="w-full border p-2 rounded text-sm">
                            <input type="text" id="new-q-options" placeholder="ë³´ê¸° (ì½¤ë§ˆë¡œ êµ¬ë¶„, ê°ê´€ì‹/ìˆœì„œìš©)" class="w-full border p-2 rounded text-sm">
                            <input type="text" id="new-q-answer" placeholder="ì •ë‹µ" class="w-full border p-2 rounded text-sm font-bold text-blue-600">
                            <textarea id="new-q-exp" placeholder="í•´ì„¤ (ì„ íƒ)" class="w-full border p-2 rounded text-sm h-16 resize-none"></textarea>
                            <button onclick="app.addQuestion()" class="w-full bg-blue-600 text-white font-bold py-2 rounded hover:bg-blue-700 transition">ë“±ë¡</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB 2: Logs (Existing) -->
        <div id="tab-log" class="tab-content hidden h-full overflow-y-auto">
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-gray-800">ì œì¶œ í˜„í™© <span id="log-count" class="text-sm font-normal text-gray-500"></span></h2>
                    <div class="flex gap-2">
                        <select id="select-class-trigger" onchange="app.loadByClass(this.value)" class="border rounded px-3 py-2 text-sm font-bold">
                            <option value="">ë°˜ ì„ íƒ</option>
                            <option value="all">ì „ì²´ (ìµœê·¼ 50ê°œ)</option>
                            <option value="1">1ë°˜</option><option value="2">2ë°˜</option><option value="3">3ë°˜</option><option value="4">4ë°˜</option><option value="5">5ë°˜</option><option value="6">6ë°˜</option><option value="7">7ë°˜</option><option value="8">8ë°˜</option><option value="9">9ë°˜</option><option value="10">10ë°˜</option>
                        </select>
                        <button onclick="app.loadByClass(document.getElementById('select-class-trigger').value)" class="bg-gray-100 p-2 rounded"><i class="fas fa-sync-alt"></i></button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left whitespace-nowrap">
                        <thead class="bg-gray-50 text-gray-600 font-bold border-b">
                            <tr><th class="p-4">ì‹œê°„</th><th class="p-4">í•™ìƒ</th><th class="p-4">ì ìˆ˜</th><th class="p-4">ìƒíƒœ</th><th class="p-4">ê´€ë¦¬</th></tr>
                        </thead>
                        <tbody id="log-body" class="divide-y divide-gray-100"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- TAB 3: Question Bank (Revamped) -->
        <div id="tab-bank" class="tab-content hidden h-full overflow-hidden flex flex-col">
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 flex flex-col h-full overflow-hidden">
                 <!-- Filter Bar -->
                 <div class="p-4 border-b bg-gray-50 flex flex-wrap gap-3 items-center shrink-0">
                    <div class="flex items-center gap-2">
                        <i class="fas fa-filter text-gray-400"></i>
                        <select id="filter-big" onchange="app.filterBank('big')" class="border rounded px-2 py-1.5 text-sm w-32 font-bold text-gray-700"><option value="">ëŒ€ë‹¨ì› ì „ì²´</option></select>
                        <i class="fas fa-chevron-right text-gray-300 text-xs"></i>
                        <select id="filter-mid" onchange="app.filterBank('mid')" class="border rounded px-2 py-1.5 text-sm w-32 text-gray-700"><option value="">ì¤‘ë‹¨ì› ì „ì²´</option></select>
                        <i class="fas fa-chevron-right text-gray-300 text-xs"></i>
                        <select id="filter-small" onchange="app.filterBank('small')" class="border rounded px-2 py-1.5 text-sm w-32 text-gray-700"><option value="">ì†Œë‹¨ì› ì „ì²´</option></select>
                    </div>
                    <div class="h-6 w-px bg-gray-300 mx-2"></div>
                    <select id="filter-type" onchange="app.filterBank('type')" class="border rounded px-2 py-1.5 text-sm w-24 text-gray-700">
                        <option value="">ìœ í˜• ì „ì²´</option>
                        <option value="choice">ê°ê´€ì‹</option>
                        <option value="ox">O/X</option>
                        <option value="word">ë‹¨ë‹µí˜•</option>
                        <option value="order">ìˆœì„œ</option>
                    </select>
                    <div class="ml-auto text-xs text-gray-500">
                        ì´ <span id="bank-total-count" class="font-bold text-blue-600">0</span>ë¬¸ì œ
                    </div>
                 </div>

                 <!-- Table -->
                 <div class="flex-1 overflow-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-white font-bold text-gray-700 sticky top-0 shadow-sm z-10">
                            <tr>
                                <th class="p-3 w-16 text-center sortable" onclick="app.sortBank('id')">ID <i class="fas fa-sort sort-icon"></i></th>
                                <th class="p-3 w-20 text-center sortable" onclick="app.sortBank('category')">ë¶„ë¥˜ <i class="fas fa-sort sort-icon"></i></th>
                                <th class="p-3 w-40 sortable" onclick="app.sortBank('unit')">ë‹¨ì› ì •ë³´ <i class="fas fa-sort sort-icon"></i></th>
                                <th class="p-3 w-20 text-center sortable" onclick="app.sortBank('type')">ìœ í˜• <i class="fas fa-sort sort-icon"></i></th>
                                <th class="p-3">ë¬¸ì œ (í´ë¦­í•˜ì—¬ ìˆ˜ì •)</th>
                                <th class="p-3 w-32">ì •ë‹µ</th>
                                <th class="p-3 w-24 text-center sortable" onclick="app.sortBank('rate')">ì •ë‹µë¥  <i class="fas fa-sort sort-icon"></i></th>
                                <th class="p-3 w-16 text-center">ì‚­ì œ</th>
                            </tr>
                        </thead>
                        <tbody id="bank-body" class="divide-y divide-gray-100 bg-white"></tbody>
                    </table>
                 </div>
            </div>
        </div>

    </main>

    <!-- Edit Modal -->
    <div id="edit-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center">
        <div class="absolute inset-0 bg-black bg-opacity-50 backdrop-blur-sm" onclick="app.closeEditModal()"></div>
        <div class="bg-white rounded-xl shadow-2xl z-10 w-full max-w-2xl p-6 mx-4 relative flex flex-col max-h-[90vh]">
            <div class="flex justify-between items-center mb-4 border-b pb-3">
                <h3 class="font-bold text-lg text-gray-800"><i class="fas fa-edit text-blue-500 mr-2"></i>ë¬¸ì œ ìˆ˜ì •</h3>
                <button onclick="app.closeEditModal()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="overflow-y-auto flex-1 space-y-4 pr-2">
                <input type="hidden" id="edit-id">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">ë¶„ë¥˜</label>
                        <select id="edit-category" class="w-full border p-2 rounded text-sm bg-gray-50 font-bold">
                            <option value="diagnostic">ì§„ë‹¨í‰ê°€</option>
                            <option value="formative">í˜•ì„±í‰ê°€</option>
                            <option value="exam_prep">ì§€í•„í‰ê°€ ëŒ€ë¹„</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">ìœ í˜•</label>
                        <select id="edit-type" class="w-full border p-2 rounded text-sm bg-gray-50">
                            <option value="choice">ê°ê´€ì‹</option>
                            <option value="ox">O/X</option>
                            <option value="word">ë‹¨ë‹µí˜•</option>
                            <option value="order">ìˆœì„œë‚˜ì—´</option>
                        </select>
                    </div>
                </div>

                <!-- Unit Selectors for Edit -->
                <div class="bg-gray-50 p-3 rounded border border-gray-200">
                    <label class="block text-xs font-bold text-gray-500 mb-2">ë‹¨ì› ì´ë™</label>
                    <div class="grid grid-cols-2 gap-2">
                        <select id="edit-unit" onchange="app.updateEditSubUnits()" class="w-full border p-2 rounded text-sm"></select>
                        <select id="edit-subunit" class="w-full border p-2 rounded text-sm"></select>
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">ë¬¸ì œ ë‚´ìš©</label>
                    <input type="text" id="edit-question" class="w-full border p-2 rounded text-sm font-bold">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">ë³´ê¸° (ì½¤ë§ˆ êµ¬ë¶„)</label>
                    <input type="text" id="edit-options" class="w-full border p-2 rounded text-sm">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">ì •ë‹µ</label>
                    <input type="text" id="edit-answer" class="w-full border p-2 rounded text-sm font-bold text-blue-600 bg-blue-50">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">í•´ì„¤</label>
                    <textarea id="edit-explanation" class="w-full border p-2 rounded text-sm h-20 resize-none"></textarea>
                </div>
            </div>

            <div class="mt-6 pt-4 border-t flex justify-end gap-3">
                <button onclick="app.closeEditModal()" class="px-4 py-2 bg-white border border-gray-300 rounded text-gray-700 font-bold hover:bg-gray-50">ì·¨ì†Œ</button>
                <button onclick="app.saveEditQuestion()" class="px-6 py-2 bg-blue-600 text-white rounded font-bold hover:bg-blue-700 shadow-md">ìˆ˜ì • ì €ì¥</button>
            </div>
        </div>
    </div>

    <!-- Footer injected by AuthManager -->

    <script>
        window.AuthManager.init('teacher');

        const app = {
            treeData: [],
            questions: [],
            selectedNode: null,
            selectedCategory: 'diagnostic', 
            assessmentConfig: {},
            
            // Filters & Sort
            filters: { big: '', mid: '', small: '', type: '' },
            sort: { key: 'id', order: 'desc' },

            init: function() {
                this.loadTree();
                this.loadQuestions();
                this.loadConfig();
            },

            setTab: function(tab) {
                document.querySelectorAll('.tab-btn-base').forEach(b => b.classList.remove('tab-btn-active'));
                document.getElementById('btn-tab-'+tab).classList.add('tab-btn-active');
                document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
                document.getElementById('tab-'+tab).classList.remove('hidden');
                
                if(tab === 'bank') this.renderBank();
            },

            setSubTab: function(cat) {
                this.selectedCategory = cat;
                document.getElementById('sub-btn-diagnostic').className = cat==='diagnostic' ? "py-2 px-4 font-bold text-sm border-b-2 border-blue-500 text-blue-600" : "py-2 px-4 font-bold text-sm border-b-2 border-transparent text-gray-400 hover:text-gray-600";
                document.getElementById('sub-btn-formative').className = cat==='formative' ? "py-2 px-4 font-bold text-sm border-b-2 border-blue-500 text-blue-600" : "py-2 px-4 font-bold text-sm border-b-2 border-transparent text-gray-400 hover:text-gray-600";
                this.renderQuestions();
                this.updateToggleState();
            },

            // --- Data Loading ---
            loadTree: async function() {
                try {
                    const doc = await window.getCollection('curriculum').doc('tree').get();
                    this.treeData = (doc.exists && doc.data().tree) ? doc.data().tree : [];
                    this.renderTree();
                    this.populateFilters(); // Populate Big Unit Filter
                } catch(e) { console.error(e); }
            },

            loadQuestions: async function() {
                const snap = await window.getCollection('quiz_questions').get();
                this.questions = [];
                snap.forEach(doc => this.questions.push({id: parseInt(doc.id), ...doc.data()}));
                if(document.getElementById('tab-bank').classList.contains('hidden') === false) this.renderBank();
            },

            loadConfig: async function() {
                const doc = await window.getCollection('assessment_config').doc('status').get();
                this.assessmentConfig = (doc.exists) ? doc.data() : {};
            },

            // --- Tree Rendering ---
            renderTree: function() {
                const container = document.getElementById('tree-container');
                container.innerHTML = '';
                
                // 1. Exam Prep Node
                const examNode = document.createElement('div');
                examNode.className = 'tree-item exam-prep';
                examNode.innerHTML = '<i class="fas fa-file-contract mr-2"></i>ì§€í•„í‰ê°€ ëŒ€ë¹„ ì‹¤ì „';
                examNode.onclick = () => this.selectExamPrep(examNode);
                container.appendChild(examNode);

                // 2. Curriculum Tree
                this.treeData.forEach(big => {
                    const bigEl = document.createElement('div');
                    bigEl.className = 'tree-node level-0';
                    bigEl.innerHTML = `<div class="font-bold text-gray-800 py-1 select-none">${big.title}</div>`;
                    
                    if(big.children) {
                        big.children.forEach(mid => {
                            const midEl = document.createElement('div');
                            midEl.className = 'tree-node level-1';
                            const item = document.createElement('div');
                            item.className = 'tree-item';
                            item.innerHTML = `<i class="fas fa-folder text-yellow-400 mr-2"></i>${mid.title}`;
                            item.onclick = () => this.selectNode(mid, big.title, item);
                            midEl.appendChild(item);
                            bigEl.appendChild(midEl);
                        });
                    }
                    container.appendChild(bigEl);
                });
            },

            selectExamPrep: function(el) {
                this.resetSelection();
                el.classList.add('active');
                this.selectedNode = { id: 'exam_prep', title: 'ì§€í•„í‰ê°€ ëŒ€ë¹„ ì‹¤ì „', type: 'special' };
                this.renderEditor();
            },

            selectNode: function(node, parentTitle, el) {
                this.resetSelection();
                el.classList.add('active');
                this.selectedNode = { ...node, parentTitle };
                this.renderEditor();
            },

            resetSelection: function() {
                document.querySelectorAll('.tree-item').forEach(e => e.classList.remove('active'));
                document.getElementById('empty-state').classList.add('hidden');
            },

            // --- Editor Logic ---
            renderEditor: function() {
                const node = this.selectedNode;
                document.getElementById('selected-title').innerText = node.title;
                document.getElementById('selected-path').innerText = node.type === 'special' ? 'íŠ¹ë³„ í•™ìŠµ' : `${node.parentTitle} > ${node.title}`;
                
                // Show/Hide Sub Tabs
                const subTabs = document.getElementById('sub-tabs');
                if (node.id === 'exam_prep') {
                    subTabs.classList.add('hidden');
                    this.selectedCategory = 'exam_prep';
                } else {
                    subTabs.classList.remove('hidden');
                    this.setSubTab('diagnostic'); // Default
                }

                // Populate SubUnit Dropdown for Add Form
                const subSel = document.getElementById('new-q-subunit');
                subSel.innerHTML = '<option value="">ì†Œë‹¨ì› (ì „ì²´)</option>';
                if(node.children) {
                    node.children.forEach(small => {
                        const opt = document.createElement('option');
                        opt.value = small.id;
                        opt.innerText = small.title;
                        subSel.appendChild(opt);
                    });
                }

                this.renderQuestions();
                this.updateToggleState();
            },

            renderQuestions: function() {
                const list = document.getElementById('q-list');
                const filtered = this.questions.filter(q => 
                    q.unitId === this.selectedNode.id && 
                    q.category === this.selectedCategory
                );

                if(filtered.length === 0) {
                    list.innerHTML = '<div class="text-center py-10 text-gray-400 border-2 border-dashed border-gray-200 rounded-lg">ë“±ë¡ëœ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                } else {
                    list.innerHTML = filtered.map((q, idx) => `
                        <div class="bg-white p-4 rounded-lg border border-gray-200 hover:border-blue-300 transition relative group">
                            <div class="flex justify-between items-start mb-2">
                                <span class="bg-gray-100 text-gray-600 text-xs font-bold px-2 py-1 rounded">Q${idx+1} | ${q.type}</span>
                                <div class="flex gap-2">
                                    <button onclick="app.openEditModal(${q.id})" class="text-blue-400 hover:text-blue-600"><i class="fas fa-edit"></i></button>
                                    <button onclick="app.deleteQuestion('${q.id}')" class="text-gray-300 hover:text-red-500"><i class="fas fa-trash"></i></button>
                                </div>
                            </div>
                            <p class="font-bold text-gray-800 mb-2">${q.question}</p>
                            <div class="text-sm text-gray-500">
                                <span class="text-blue-600 font-bold mr-2">ì •ë‹µ: ${q.answer}</span>
                                ${q.options ? `<span class="text-xs text-gray-400">(${q.options.join(', ')})</span>` : ''}
                            </div>
                        </div>
                    `).join('');
                }
            },

            updateToggleState: function() {
                const key = `${this.selectedNode.id}_${this.selectedCategory}`;
                const isActive = this.assessmentConfig[key] === true;
                const checkbox = document.getElementById('toggle-active');
                const text = document.getElementById('toggle-text');
                
                checkbox.checked = isActive;
                text.innerText = isActive ? 'í•™ìƒ ê³µê°œ ì¤‘' : 'í•™ìƒ ë¹„ê³µê°œ';
                text.className = isActive ? 'ml-2 text-sm font-bold text-green-600' : 'ml-2 text-sm font-bold text-gray-400';
            },

            toggleActivation: async function() {
                if(!this.selectedNode) return;
                const key = `${this.selectedNode.id}_${this.selectedCategory}`;
                const checkbox = document.getElementById('toggle-active');
                const newState = checkbox.checked;
                
                // Optimistic UI
                this.assessmentConfig[key] = newState;
                this.updateToggleState();

                await window.getCollection('assessment_config').doc('status').set({
                    [key]: newState
                }, { merge: true });
            },

            addQuestion: async function() {
                if(!this.selectedNode) return;
                
                const type = document.getElementById('new-q-type').value;
                const text = document.getElementById('new-q-text').value;
                const ans = document.getElementById('new-q-answer').value;
                const opts = document.getElementById('new-q-options').value;
                const exp = document.getElementById('new-q-exp').value;
                const subUnitId = document.getElementById('new-q-subunit').value;

                if(!text || !ans) { alert("ë¬¸ì œì™€ ì •ë‹µì€ í•„ìˆ˜ì…ë‹ˆë‹¤."); return; }

                const newId = Date.now();
                const qData = {
                    id: newId,
                    unitId: this.selectedNode.id,
                    category: this.selectedCategory,
                    subUnitId: subUnitId || null,
                    type: type,
                    question: text,
                    answer: ans,
                    options: opts ? opts.split(',').map(s=>s.trim()) : [],
                    explanation: exp,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                await window.getCollection('quiz_questions').doc(String(newId)).set(qData);
                
                // Reset inputs
                document.getElementById('new-q-text').value = '';
                document.getElementById('new-q-options').value = '';
                document.getElementById('new-q-answer').value = '';
                document.getElementById('new-q-exp').value = '';
                
                this.questions.push(qData);
                this.renderQuestions();
                if(document.getElementById('tab-bank').classList.contains('hidden') === false) this.renderBank();
            },

            deleteQuestion: async function(id) {
                if(!confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
                await window.getCollection('quiz_questions').doc(String(id)).delete();
                this.questions = this.questions.filter(q => String(q.id) !== String(id));
                this.renderQuestions();
                if(document.getElementById('tab-bank').classList.contains('hidden') === false) this.renderBank();
            },

            // --- Question Bank Logic (Revamped) ---
            populateFilters: function() {
                // Populate Big Units
                const bigSel = document.getElementById('filter-big');
                bigSel.innerHTML = '<option value="">ëŒ€ë‹¨ì› ì „ì²´</option>';
                this.treeData.forEach(big => {
                    const opt = document.createElement('option');
                    opt.value = big.id;
                    opt.innerText = big.title;
                    bigSel.appendChild(opt);
                });
            },

            filterBank: function(level) {
                if(level === 'big') {
                    const bigId = document.getElementById('filter-big').value;
                    const midSel = document.getElementById('filter-mid');
                    const smallSel = document.getElementById('filter-small');
                    midSel.innerHTML = '<option value="">ì¤‘ë‹¨ì› ì „ì²´</option>';
                    smallSel.innerHTML = '<option value="">ì†Œë‹¨ì› ì „ì²´</option>';
                    this.filters.big = bigId;
                    this.filters.mid = '';
                    this.filters.small = '';

                    if(bigId) {
                        const big = this.treeData.find(b => b.id === bigId);
                        if(big && big.children) {
                            big.children.forEach(mid => {
                                const opt = document.createElement('option');
                                opt.value = mid.id;
                                opt.innerText = mid.title;
                                midSel.appendChild(opt);
                            });
                        }
                    }
                } else if(level === 'mid') {
                    const midId = document.getElementById('filter-mid').value;
                    const smallSel = document.getElementById('filter-small');
                    smallSel.innerHTML = '<option value="">ì†Œë‹¨ì› ì „ì²´</option>';
                    this.filters.mid = midId;
                    this.filters.small = '';
                    
                    if(midId) {
                        // Find Mid Node logic (search entire tree)
                        let midNode = null;
                        this.treeData.forEach(big => {
                            if(big.children) {
                                const found = big.children.find(m => m.id === midId);
                                if(found) midNode = found;
                            }
                        });
                        if(midNode && midNode.children) {
                            midNode.children.forEach(small => {
                                const opt = document.createElement('option');
                                opt.value = small.id;
                                opt.innerText = small.title;
                                smallSel.appendChild(opt);
                            });
                        }
                    }
                } else if(level === 'small') {
                    this.filters.small = document.getElementById('filter-small').value;
                } else if(level === 'type') {
                    this.filters.type = document.getElementById('filter-type').value;
                }

                this.renderBank();
            },

            sortBank: function(key) {
                if(this.sort.key === key) {
                    this.sort.order = this.sort.order === 'asc' ? 'desc' : 'asc';
                } else {
                    this.sort.key = key;
                    this.sort.order = 'asc';
                }
                this.renderBank();
            },

            renderBank: function() {
                const tbody = document.getElementById('bank-body');
                let filtered = this.questions.filter(q => {
                    // Filter Logic
                    if(this.filters.type && q.type !== this.filters.type) return false;
                    
                    // Unit Filters
                    // We need to resolve unit hierarchy for each question to filter properly
                    // Map questions unitId (Mid) to Tree
                    if(this.filters.mid && q.unitId !== this.filters.mid) return false;
                    if(this.filters.small && q.subUnitId !== this.filters.small) return false;
                    
                    if(this.filters.big) {
                         // Check if question's unitId belongs to selected Big Unit
                         const big = this.treeData.find(b => b.id === this.filters.big);
                         if(!big || !big.children || !big.children.find(m => m.id === q.unitId)) return false;
                    }
                    return true;
                });

                // Sort Logic
                filtered.sort((a, b) => {
                    let valA = a[this.sort.key];
                    let valB = b[this.sort.key];

                    // Special Sorts
                    if(this.sort.key === 'unit') {
                        // Sort by Unit ID logic or Name (Simplified to unitId)
                        valA = a.unitId; valB = b.unitId;
                    }
                    if(this.sort.key === 'rate') {
                        // Mock rate for now or 0
                        valA = a.correctRate || 0; valB = b.correctRate || 0;
                    }

                    if(valA < valB) return this.sort.order === 'asc' ? -1 : 1;
                    if(valA > valB) return this.sort.order === 'asc' ? 1 : -1;
                    return 0;
                });
                
                document.getElementById('bank-total-count').innerText = filtered.length;

                tbody.innerHTML = filtered.map(q => {
                    // Resolve Unit Names
                    let unitPath = 'ì§€í•„í‰ê°€ ëŒ€ë¹„';
                    if(q.category !== 'exam_prep') {
                        let bigTitle = '?', midTitle = '?', smallTitle = '-';
                        this.treeData.forEach(b => {
                            if(b.children) {
                                const m = b.children.find(m => m.id === q.unitId);
                                if(m) {
                                    bigTitle = b.title;
                                    midTitle = m.title;
                                    if(m.children && q.subUnitId) {
                                        const s = m.children.find(s => s.id === q.subUnitId);
                                        if(s) smallTitle = s.title;
                                    }
                                }
                            }
                        });
                        unitPath = `<div class="text-xs text-gray-500">${bigTitle} ></div><div class="font-bold text-gray-700">${midTitle}</div><div class="text-xs text-gray-400">${smallTitle}</div>`;
                    } else {
                        unitPath = '<span class="text-red-600 font-bold text-xs bg-red-50 px-2 py-1 rounded">ì§€í•„í‰ê°€ ì‹¤ì „</span>';
                    }

                    const typeMap = {choice:'ê°ê´€ì‹', ox:'O/X', word:'ë‹¨ë‹µí˜•', order:'ìˆœì„œ'};
                    const rate = q.correctRate ? `${q.correctRate}%` : '-';
                    const catMap = {diagnostic:'ì§„ë‹¨', formative:'í˜•ì„±', exam_prep:'ì§€í•„'};

                    return `
                    <tr class="border-b border-gray-50 last:border-0 hover:bg-gray-50 group cursor-pointer" onclick="app.openEditModal(${q.id})">
                        <td class="p-3 text-xs text-gray-500 text-center">${q.id}</td>
                        <td class="p-3 text-center"><span class="bg-gray-100 text-xs px-2 py-1 rounded text-gray-600">${catMap[q.category]||q.category}</span></td>
                        <td class="p-3 leading-tight">${unitPath}</td>
                        <td class="p-3 text-center"><span class="border border-gray-200 text-xs px-2 py-1 rounded text-gray-500">${typeMap[q.type]}</span></td>
                        <td class="p-3 font-bold text-gray-700 max-w-xs break-keep group-hover:text-blue-600">
                            ${q.question}
                            <i class="fas fa-edit text-xs text-gray-300 ml-2 opacity-0 group-hover:opacity-100"></i>
                        </td>
                        <td class="p-3 text-blue-600 font-bold truncate max-w-[100px]">${q.answer}</td>
                        <td class="p-3 text-center text-gray-500 font-mono">${rate}</td>
                        <td class="p-3 text-center" onclick="event.stopPropagation()">
                            <button onclick="app.deleteQuestion('${q.id}')" class="text-gray-300 hover:text-red-500 p-2"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `}).join('');
            },

            // --- Edit Modal Logic ---
            openEditModal: function(id) {
                const q = this.questions.find(x => x.id === id);
                if(!q) return;

                document.getElementById('edit-id').value = id;
                document.getElementById('edit-category').value = q.category;
                document.getElementById('edit-type').value = q.type;
                document.getElementById('edit-question').value = q.question;
                document.getElementById('edit-options').value = (q.options || []).join(', ');
                document.getElementById('edit-answer').value = q.answer;
                document.getElementById('edit-explanation').value = q.explanation || '';
                
                // Populate Unit Selector
                const unitSel = document.getElementById('edit-unit');
                unitSel.innerHTML = '<option value="">(ì„ íƒ ì•ˆí•¨ - ì§€í•„í‰ê°€)</option>';
                this.treeData.forEach(big => {
                     if(big.children) {
                         big.children.forEach(mid => {
                             const opt = document.createElement('option');
                             opt.value = mid.id;
                             opt.innerText = `${big.title} > ${mid.title}`;
                             unitSel.appendChild(opt);
                         });
                     }
                });
                unitSel.value = q.unitId || '';
                
                // Populate SubUnit
                this.updateEditSubUnits(q.subUnitId);

                document.getElementById('edit-modal').classList.remove('hidden');
                document.getElementById('edit-modal').classList.add('flex');
            },

            updateEditSubUnits: function(defaultVal = '') {
                const midId = document.getElementById('edit-unit').value;
                const subSel = document.getElementById('edit-subunit');
                subSel.innerHTML = '<option value="">(ì†Œë‹¨ì› ì—†ìŒ)</option>';
                
                if(midId) {
                    let midNode = null;
                    this.treeData.forEach(big => {
                        if(big.children) {
                            const found = big.children.find(m => m.id === midId);
                            if(found) midNode = found;
                        }
                    });
                    if(midNode && midNode.children) {
                        midNode.children.forEach(small => {
                            const opt = document.createElement('option');
                            opt.value = small.id;
                            opt.innerText = small.title;
                            subSel.appendChild(opt);
                        });
                    }
                }
                if(defaultVal) subSel.value = defaultVal;
            },

            saveEditQuestion: async function() {
                const id = document.getElementById('edit-id').value;
                const unitId = document.getElementById('edit-unit').value;
                
                const data = {
                    category: document.getElementById('edit-category').value,
                    type: document.getElementById('edit-type').value,
                    unitId: unitId || 'exam_prep',
                    subUnitId: document.getElementById('edit-subunit').value || null,
                    question: document.getElementById('edit-question').value,
                    options: document.getElementById('edit-options').value.split(',').map(s=>s.trim()),
                    answer: document.getElementById('edit-answer').value,
                    explanation: document.getElementById('edit-explanation').value,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                await window.getCollection('quiz_questions').doc(String(id)).update(data);
                
                // Update local data
                const idx = this.questions.findIndex(q => String(q.id) === String(id));
                if(idx > -1) this.questions[idx] = { ...this.questions[idx], ...data };
                
                this.closeEditModal();
                if(document.getElementById('tab-bank').classList.contains('hidden') === false) this.renderBank();
                else this.renderQuestions(); // If in editor tab
            },

            closeEditModal: function() {
                document.getElementById('edit-modal').classList.add('hidden');
                document.getElementById('edit-modal').classList.remove('flex');
            },

            // --- Log Tab (Existing) ---
            loadByClass: function(cls) {
                if(!cls) return;
                const tbody = document.getElementById('log-body');
                tbody.innerHTML = '<tr><td colspan="5" class="p-8 text-center">ë¡œë”© ì¤‘...</td></tr>';
                let q = window.getCollection('quiz_results').orderBy('timestamp', 'desc');
                if (cls !== 'all') q = q.where('class', '==', parseInt(cls));
                else q = q.limit(50);

                q.get().then(snap => {
                    let html = '';
                    snap.forEach(doc => {
                        const d = doc.data();
                        html += `<tr class="border-b hover:bg-blue-50"><td class="p-4 text-xs font-mono text-gray-500">${d.timeString||'-'}</td><td class="p-4 font-bold text-gray-700">${d.class}ë°˜ ${d.number}ë²ˆ ${d.name}</td><td class="p-4 font-bold text-blue-600">${d.score}ì </td><td class="p-4 text-xs">${d.status}</td><td class="p-4"><button onclick="app.deleteLog('${doc.id}')" class="text-gray-300 hover:text-red-500"><i class="fas fa-trash"></i></button></td></tr>`;
                    });
                    tbody.innerHTML = html || '<tr><td colspan="5" class="p-8 text-center text-gray-400">ë°ì´í„° ì—†ìŒ</td></tr>';
                    document.getElementById('log-count').innerText = `(${snap.size}ê±´)`;
                });
            },
            
            deleteLog: function(id) {
                if(confirm("ê¸°ë¡ ì‚­ì œ?")) window.getCollection('quiz_results').doc(id).delete().then(() => this.loadByClass(document.getElementById('select-class-trigger').value));
            }
        };

        document.addEventListener('auth-ready', () => app.init());
    </script>
</body>
</html>
