
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í€´ì¦ˆ ê´€ë¦¬ - Westory Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="../assets/js/firebase-config.js"></script>
    <link rel="stylesheet" href="../assets/css/style.css">
    <script src="../assets/js/auth-manager.js"></script>

    <style>
        .sort-icon { margin-left: 4px; font-size: 0.8em; color: #9ca3af; }
        .sort-active { color: #2563eb; }
        .tab-btn-base { padding: 12px 24px; font-weight: 700; font-size: 0.95rem; border-bottom: 3px solid transparent; color: #6b7280; transition: all 0.2s; }
        .tab-btn-base:hover { color: #374151; background-color: #f9fafb; }
        .tab-btn-active { border-bottom-color: #2563eb; color: #2563eb; }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header injected by AuthManager -->

    <main class="w-full max-w-7xl mx-auto px-6 py-8">
        <!-- Improved Tabs -->
        <div class="flex border-b border-gray-200 mb-6 bg-white rounded-t-lg px-2">
            <button onclick="app.setTab('log')" id="btn-tab-log" class="tab-btn-base tab-btn-active">ğŸ“Š ì œì¶œ í˜„í™©</button>
            <button onclick="app.setTab('bank')" id="btn-tab-bank" class="tab-btn-base">ğŸ—„ï¸ ë¬¸ì œ ì€í–‰</button>
            <button onclick="app.setTab('add')" id="btn-tab-add" class="tab-btn-base">âœï¸ ë¬¸ì œ ë“±ë¡</button>
        </div>

        <!-- 1. Submission Status Tab -->
        <div id="tab-log" class="tab-content">
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                    <h2 class="text-xl font-bold text-gray-800">ì œì¶œ í˜„í™© <span id="log-count" class="text-sm font-normal text-gray-500"></span></h2>
                    <div class="flex gap-2">
                        <select id="select-class-trigger" onchange="app.loadByClass(this.value)" class="border rounded px-3 py-2 text-sm font-bold bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">ë°˜ ì„ íƒ</option>
                            <option value="all">ì „ì²´ (ìµœê·¼ 50ê°œ)</option>
                            <option value="1">1ë°˜</option><option value="2">2ë°˜</option><option value="3">3ë°˜</option>
                            <option value="4">4ë°˜</option><option value="5">5ë°˜</option><option value="6">6ë°˜</option>
                            <option value="7">7ë°˜</option><option value="8">8ë°˜</option><option value="9">9ë°˜</option>
                            <option value="10">10ë°˜</option>
                        </select>
                        <button onclick="app.loadByClass(document.getElementById('select-class-trigger').value)" class="bg-gray-100 p-2 rounded hover:bg-gray-200 text-gray-600" title="ìƒˆë¡œê³ ì¹¨"><i class="fas fa-sync-alt"></i></button>
                        <button onclick="app.deleteSelectedLogs()" class="bg-white border border-red-200 text-red-600 px-3 py-2 rounded text-sm font-bold hover:bg-red-50 transition">ì„ íƒ ì‚­ì œ</button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left whitespace-nowrap">
                        <thead class="bg-gray-50 text-gray-600 font-bold border-b">
                            <tr>
                                <th class="p-4 w-10"><input type="checkbox" onchange="document.querySelectorAll('.log-checkbox').forEach(cb=>cb.checked=this.checked)"></th>
                                <th class="p-4">ì‹œê°„</th>
                                <th class="p-4">í•™ìƒ</th>
                                <th class="p-4">ì ìˆ˜</th>
                                <th class="p-4">ìƒíƒœ</th>
                                <th class="p-4 text-center">ê´€ë¦¬</th>
                            </tr>
                        </thead>
                        <tbody id="log-body" class="divide-y divide-gray-100">
                            <tr><td colspan="6" class="p-8 text-center text-gray-400">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ë ¤ë©´ ë°˜ì„ ì„ íƒí•˜ì„¸ìš”.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 2. Question Bank Tab -->
        <div id="tab-bank" class="tab-content hidden">
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-gray-800">ë¬¸ì œ ì€í–‰ <span id="total-q-count" class="text-sm font-normal text-gray-500"></span></h2>
                    <div class="flex gap-2">
                        <!-- Cascading Filter -->
                        <select id="bank-filter-major" onchange="app.handleMajorFilterChange()" class="border rounded px-3 py-2 text-sm bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 font-bold text-gray-700 min-w-[150px]">
                            <option value="all">ëŒ€ë‹¨ì› ì „ì²´</option>
                        </select>
                        <select id="bank-filter-middle" onchange="app.renderBank()" class="border rounded px-3 py-2 text-sm bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 min-w-[150px]">
                            <option value="all">ì¤‘ë‹¨ì› ì „ì²´</option>
                        </select>
                        <button onclick="app.deleteSelectedQuestions()" class="bg-white border border-red-200 text-red-600 px-3 py-2 rounded text-sm font-bold hover:bg-red-50 transition">ì„ íƒ ì‚­ì œ</button>
                    </div>
                </div>
                <div class="overflow-x-auto max-h-[700px]">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-gray-50 text-gray-600 font-bold sticky top-0 shadow-sm z-10">
                            <tr>
                                <th class="p-3 bg-gray-50 w-10"><input type="checkbox" onchange="document.querySelectorAll('.q-checkbox').forEach(cb=>cb.checked=this.checked)"></th>
                                <th class="p-3 bg-gray-50 w-20 cursor-pointer hover:bg-gray-100" onclick="app.sortBank('id')">ID <i id="sort-icon-id" class="fas fa-sort sort-icon"></i></th>
                                <th class="p-3 bg-gray-50 cursor-pointer hover:bg-gray-100" onclick="app.sortBank('unit')">ë‹¨ì› <i id="sort-icon-unit" class="fas fa-sort sort-icon"></i></th>
                                <th class="p-3 bg-gray-50 cursor-pointer hover:bg-gray-100" onclick="app.sortBank('question')">ë¬¸ì œ ë‚´ìš© <i id="sort-icon-question" class="fas fa-sort sort-icon"></i></th>
                                <th class="p-3 bg-gray-50 w-24 cursor-pointer hover:bg-gray-100" onclick="app.sortBank('type')">ìœ í˜• <i id="sort-icon-type" class="fas fa-sort sort-icon"></i></th>
                                <th class="p-3 bg-gray-50 w-20 text-center">ì •ë‹µ</th>
                                <th class="p-3 bg-gray-50 w-24 text-center cursor-pointer hover:bg-gray-100" onclick="app.sortBank('rate')">ì •ë‹µë¥  <i id="sort-icon-rate" class="fas fa-sort sort-icon"></i></th>
                            </tr>
                        </thead>
                        <tbody id="bank-body" class="divide-y divide-gray-100 bg-white"></tbody>
                    </table>
                </div>
                <div class="mt-4 text-xs text-gray-400 text-right">* ë¬¸ì œë¥¼ í´ë¦­í•˜ë©´ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
            </div>
        </div>

        <!-- 3. Add Question Tab -->
        <div id="tab-add" class="tab-content hidden">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <!-- Manual Add Form -->
                <div class="md:col-span-2 bg-white p-6 rounded-xl shadow-sm border border-gray-200 relative">
                    <input type="hidden" id="edit-q-id"> 
                    <div class="flex justify-between items-center mb-6 border-b pb-4">
                        <h3 class="font-bold text-lg text-gray-800" id="form-title">ğŸ“ ì§ì ‘ ë§Œë“¤ê¸°</h3>
                        <button onclick="app.clearForm()" class="text-xs text-gray-400 hover:text-gray-600"><i class="fas fa-undo mr-1"></i>ì´ˆê¸°í™”</button>
                    </div>
                    
                    <div class="space-y-4">
                        <!-- Cascading Unit Select -->
                        <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                            <label class="block text-xs font-bold text-gray-500 mb-2">ë‹¨ì› ì„ íƒ</label>
                            <div class="grid grid-cols-2 gap-4">
                                <select id="new-q-major" onchange="app.handleMajorAddChange()" class="w-full p-2 border rounded text-sm font-bold text-gray-700">
                                    <option value="">ëŒ€ë‹¨ì› ì„ íƒ</option>
                                </select>
                                <select id="new-q-middle" class="w-full p-2 border rounded text-sm">
                                    <option value="">ì¤‘ë‹¨ì› ì„ íƒ</option>
                                </select>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-gray-500 mb-1">ìœ í˜•</label>
                                <select id="new-q-type" class="w-full p-3 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                                    <option value="choice">ê°ê´€ì‹</option>
                                    <option value="ox">O/X</option>
                                    <option value="word">ë‹¨ë‹µí˜•</option>
                                    <option value="order">ìˆœì„œë‚˜ì—´</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 mb-1">ì´ë¯¸ì§€ (ì„ íƒ)</label>
                                <div class="flex items-center gap-2">
                                    <input type="file" id="new-q-image-file" accept="image/*" class="w-full p-2 border rounded-lg text-sm bg-gray-50 file:mr-4 file:py-1 file:px-2 file:rounded file:border-0 file:text-xs file:bg-blue-50 file:text-blue-700">
                                    <div id="image-preview-area" class="hidden flex items-center">
                                        <span class="text-xs text-blue-600 font-bold px-2 py-1 bg-blue-50 rounded"><i class="fas fa-check mr-1"></i>ë“±ë¡ë¨</span>
                                        <button onclick="app.removeImage()" class="text-gray-400 hover:text-red-500 ml-2" title="ì´ë¯¸ì§€ ì‚­ì œ"><i class="fas fa-times"></i></button>
                                    </div>
                                    <input type="hidden" id="current-image-data">
                                </div>
                            </div>
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">ë¬¸ì œ ë‚´ìš©</label>
                            <textarea id="new-q-text" class="w-full p-3 border rounded-lg text-sm h-32 focus:ring-2 focus:ring-blue-500 outline-none resize-none" placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">ë³´ê¸° (ì½¤ë§ˆ , ë¡œ êµ¬ë¶„ / ê°ê´€ì‹Â·ìˆœì„œë‚˜ì—´ ì „ìš©)</label>
                            <input type="text" id="new-q-options" class="w-full p-3 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none" placeholder="ì˜ˆ: ê¸°ì›ì „ 8000ë…„, ê¸°ì›ì „ 2333ë…„, ...">
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-gray-500 mb-1">ì •ë‹µ</label>
                                <input type="text" id="new-q-answer" class="w-full p-3 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none font-bold text-blue-600" placeholder="ì •ë‹µ ì…ë ¥">
                            </div>
                            <div class="col-span-1 md:col-span-2">
                                <label class="block text-xs font-bold text-gray-500 mb-1">í•´ì„¤ (ì„ íƒ)</label>
                                <textarea id="new-q-exp" class="w-full p-3 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none resize-none h-24" placeholder="í•´ì„¤ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                            </div>
                        </div>

                        <button onclick="app.saveCustomQuestion()" id="btn-save-q" class="w-full bg-blue-600 text-white font-bold py-4 rounded-lg hover:bg-blue-700 transition shadow-lg mt-4">
                            ë“±ë¡í•˜ê¸°
                        </button>
                    </div>
                </div>
                
                <!-- Excel Upload -->
                <div class="bg-green-50 p-6 rounded-xl border border-green-200 h-fit">
                    <div class="flex justify-between items-center mb-4 border-b border-green-200 pb-2">
                        <h3 class="font-bold text-lg text-green-800">ğŸ“— ì—‘ì…€ ëŒ€ëŸ‰ ì—…ë¡œë“œ</h3>
                        <button onclick="app.downloadTemplate()" class="text-xs bg-white text-green-700 border border-green-300 px-2 py-1 rounded hover:bg-green-50 shadow-sm transition"><i class="fas fa-download mr-1"></i>ì–‘ì‹ ë‹¤ìš´ë¡œë“œ</button>
                    </div>
                    <div class="mb-4 text-xs text-green-700 leading-relaxed">
                        <p class="mb-2"><strong>[í•„ìˆ˜ ì»¬ëŸ¼]</strong><br>unit, type, question, options, answer, explanation</p>
                        <p>ì—‘ì…€ íŒŒì¼(.xlsx)ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ ì„ íƒí•˜ì—¬ í•œ ë²ˆì— ë“±ë¡í•˜ì„¸ìš”.</p>
                    </div>
                    <input type="file" id="excel-file" accept=".xlsx" class="block w-full text-sm text-slate-500 mb-6 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-100 file:text-green-700 hover:file:bg-green-200 cursor-pointer"/>
                    <button onclick="app.uploadExcel()" class="w-full bg-green-600 text-white font-bold py-3 rounded-lg hover:bg-green-700 transition shadow-md">
                        ì—…ë¡œë“œ ì‹œì‘
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer injected by AuthManager -->

    <script>
        window.AuthManager.init('teacher');

        const app = {
            state: { questions: [], logs: [], sortField: 'id', sortOrder: 'asc', curriculum: [] },

            init: function() {
                this.loadCurriculumTree();
                this.loadQuestions();
            },

            loadCurriculumTree: async function() {
                try {
                    const doc = await window.getCollection('curriculum').doc('tree').get();
                    if(doc.exists && doc.data().tree) {
                        this.state.curriculum = doc.data().tree;
                        this.populateMajorSelects();
                    }
                } catch(e) { console.error("Tree load failed", e); }
            },

            populateMajorSelects: function() {
                const majors = this.state.curriculum;
                const options = majors.map(m => `<option value="${m.id}">${m.title}</option>`).join('');
                
                const filterMajor = document.getElementById('bank-filter-major');
                const addMajor = document.getElementById('new-q-major');
                
                filterMajor.innerHTML = `<option value="all">ëŒ€ë‹¨ì› ì „ì²´</option>` + options;
                addMajor.innerHTML = `<option value="">ëŒ€ë‹¨ì› ì„ íƒ</option>` + options;
            },

            // Cascading Logic for Filter
            handleMajorFilterChange: function() {
                const majorId = document.getElementById('bank-filter-major').value;
                const middleSel = document.getElementById('bank-filter-middle');
                middleSel.innerHTML = `<option value="all">ì¤‘ë‹¨ì› ì „ì²´</option>`;
                
                if(majorId !== 'all') {
                    const majorNode = this.state.curriculum.find(n => n.id === majorId);
                    if(majorNode && majorNode.children) {
                        middleSel.innerHTML += majorNode.children.map(c => `<option value="${c.title}">${c.title}</option>`).join('');
                    }
                }
                this.renderBank();
            },

            // Cascading Logic for Add Form
            handleMajorAddChange: function() {
                const majorId = document.getElementById('new-q-major').value;
                const middleSel = document.getElementById('new-q-middle');
                middleSel.innerHTML = `<option value="">ì¤‘ë‹¨ì› ì„ íƒ</option>`;

                if(majorId) {
                    const majorNode = this.state.curriculum.find(n => n.id === majorId);
                    if(majorNode && majorNode.children) {
                        middleSel.innerHTML += majorNode.children.map(c => `<option value="${c.title}">${c.title}</option>`).join('');
                    }
                }
            },

            setTab: function(tabName) {
                ['log', 'bank', 'add'].forEach(t => {
                    const btn = document.getElementById('btn-tab-' + t);
                    const div = document.getElementById('tab-' + t);
                    if (t === tabName) {
                        btn.classList.add('tab-btn-active');
                        div.classList.remove('hidden');
                    } else {
                        btn.classList.remove('tab-btn-active');
                        div.classList.add('hidden');
                    }
                });
                if (tabName === 'add' && !document.getElementById('edit-q-id').value) {
                    this.clearForm();
                }
            },

            loadByClass: function(cls) {
                if(!cls) return;
                const tbody = document.getElementById('log-body');
                tbody.innerHTML = '<tr><td colspan="6" class="p-8 text-center"><div class="loader-spinner mx-auto mb-2"></div>ë¡œë”© ì¤‘...</td></tr>';

                let q = window.getCollection('quiz_results').orderBy('timestamp', 'desc');
                if (cls !== 'all') q = q.where('class', '==', parseInt(cls) || cls);
                else q = q.limit(50);

                q.get().then(snap => {
                    let html = '';
                    snap.forEach(doc => {
                        const d = doc.data();
                        html += `
                        <tr class="hover:bg-blue-50 transition border-b border-gray-100 last:border-0">
                            <td class="p-4"><input type="checkbox" class="log-checkbox w-4 h-4" value="${doc.id}"></td>
                            <td class="p-4 text-xs text-gray-500 font-mono">${d.timeString}</td>
                            <td class="p-4 font-bold text-gray-700">${d.class}ë°˜ ${d.number}ë²ˆ ${d.name}</td>
                            <td class="p-4 font-bold text-blue-600">${d.score}ì </td>
                            <td class="p-4 text-xs"><span class="px-2 py-1 rounded ${d.status==='ì™„ë£Œ'?'bg-green-100 text-green-700':'bg-red-100 text-red-700'}">${d.status}</span></td>
                            <td class="p-4 text-center"><button onclick="app.deleteLog('${doc.id}')" class="text-gray-300 hover:text-red-500 transition"><i class="fas fa-trash"></i></button></td>
                        </tr>`;
                    });
                    tbody.innerHTML = html || '<tr><td colspan="6" class="p-8 text-center text-gray-400">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                    document.getElementById('log-count').innerText = `(${snap.size}ê±´)`;
                });
            },

            loadQuestions: function() {
                window.getCollection('quiz_questions').get().then(snap => {
                    this.state.questions = [];
                    snap.forEach(doc => this.state.questions.push({ ...doc.data(), id: parseInt(doc.id) }));
                    this.renderBank();
                });
            },

            sortBank: function(field) {
                if (this.state.sortField === field) {
                    this.state.sortOrder = this.state.sortOrder === 'asc' ? 'desc' : 'asc';
                } else {
                    this.state.sortField = field;
                    this.state.sortOrder = 'asc';
                }
                this.renderBank();
            },

            renderBank: function() {
                const majorId = document.getElementById('bank-filter-major').value;
                const middleVal = document.getElementById('bank-filter-middle').value;
                
                let list = this.state.questions;

                // 1. Filter by Major
                if (majorId !== 'all') {
                    const majorNode = this.state.curriculum.find(n => n.id === majorId);
                    if (majorNode) {
                        // Gather all middle/leaf unit names under this major
                        const validUnits = new Set();
                        const collectTitles = (node) => {
                             if(node.children) node.children.forEach(collectTitles);
                             validUnits.add(node.title);
                        };
                        collectTitles(majorNode);
                        
                        // Filter list
                        list = list.filter(q => validUnits.has(q.unit));
                    }
                }

                // 2. Filter by Middle (Exact Match)
                if (middleVal !== 'all') {
                     list = list.filter(q => q.unit === middleVal);
                }

                // Sorting
                const field = this.state.sortField;
                const order = this.state.sortOrder === 'asc' ? 1 : -1;
                list.sort((a, b) => {
                    let va = a[field], vb = b[field];
                    if (field === 'rate') {
                        va = a.stat_total ? (a.stat_correct / a.stat_total) : 0;
                        vb = b.stat_total ? (b.stat_correct / b.stat_total) : 0;
                    } else {
                        if (typeof va === 'string') va = va.toLowerCase();
                        if (typeof vb === 'string') vb = vb.toLowerCase();
                    }
                    if (va < vb) return -1 * order;
                    if (va > vb) return 1 * order;
                    return 0;
                });

                document.getElementById('total-q-count').innerText = `(${list.length}ë¬¸í•­)`;
                
                document.querySelectorAll('.sort-icon').forEach(el => { el.className = 'fas fa-sort sort-icon'; });
                const icon = document.getElementById('sort-icon-' + field);
                if(icon) icon.className = `fas fa-sort-${this.state.sortOrder === 'asc' ? 'up' : 'down'} sort-icon sort-active`;

                document.getElementById('bank-body').innerHTML = list.map(q => `
                    <tr class="hover:bg-blue-50 border-b border-gray-100 last:border-0 cursor-pointer group" onclick="app.editQuestion(${q.id})">
                        <td class="p-3" onclick="event.stopPropagation()"><input type="checkbox" class="q-checkbox w-4 h-4" value="${q.id}"></td>
                        <td class="p-3 text-xs font-bold text-gray-500 font-mono group-hover:text-blue-600">${q.id}</td>
                        <td class="p-3 text-xs text-gray-500">${q.unit || '-'}</td>
                        <td class="p-3 text-sm font-medium text-gray-800 truncate max-w-xs group-hover:text-blue-700">${q.question}</td>
                        <td class="p-3 text-xs"><span class="bg-gray-100 text-gray-600 px-2 py-1 rounded border">${q.type}</span></td>
                        <td class="p-3 text-xs font-bold text-center text-blue-600">${q.answer}</td>
                        <td class="p-3 text-xs text-gray-500 text-center font-mono">${q.stat_total ? Math.round((q.stat_correct/q.stat_total)*100)+'%' : '-'}</td>
                    </tr>
                `).join('');
            },

            downloadTemplate: function() {
                const wb = XLSX.utils.book_new();
                const ws_data = [ ['unit', 'type', 'question', 'options', 'answer', 'explanation'], ['I. ê³ ëŒ€', 'choice', 'ë‹¤ìŒ ì¤‘ ê³ ì¡°ì„ ì˜ ë²•ì´ ì•„ë‹Œ ê²ƒì€?', 'ì‚´ì¸ìëŠ” ì‚¬í˜•, ë„ë‘‘ì§ˆì€ ë…¸ë¹„, ìƒí•´ëŠ” ê³¡ì‹, ë„ë‘‘ì§ˆì€ ì‚¬í˜•', '4', 'ë„ë‘‘ì§ˆí•œ ìëŠ” ë…¸ë¹„ë¡œ ì‚¼ëŠ”ë‹¤.'] ];
                const ws = XLSX.utils.aoa_to_sheet(ws_data);
                XLSX.utils.book_append_sheet(wb, ws, "Template");
                XLSX.writeFile(wb, "question_template.xlsx");
            },

            editQuestion: function(id) {
                const q = this.state.questions.find(item => item.id === id);
                if (!q) return;

                document.getElementById('edit-q-id').value = q.id;
                // Note: Complex unit hierarchy mapping back to dropdowns is tricky without storing IDs.
                // We just set the middle unit select directly if possible, or leave blank if hierarchy mismatch.
                // For this version, we attempt to set values, but precise major/middle reconstruction from just 'unit' string (middle) is hard if names duplicate.
                // We'll set the 'middle' select value and hope for the best, or user re-selects.
                // Ideally, we store majorId and middleId in the question.
                
                // Fallback: Just set the Type/Text/etc. Unit might need re-selection.
                document.getElementById('new-q-type').value = q.type;
                document.getElementById('new-q-text').value = q.question;
                document.getElementById('new-q-options').value = (q.options || []).join(', ');
                document.getElementById('new-q-answer').value = q.answer;
                document.getElementById('new-q-exp').value = q.explanation || '';
                
                document.getElementById('current-image-data').value = q.image || '';
                document.getElementById('new-q-image-file').value = ''; 
                if (q.image) document.getElementById('image-preview-area').classList.remove('hidden');
                else document.getElementById('image-preview-area').classList.add('hidden');

                document.getElementById('form-title').innerHTML = `âœï¸ ë¬¸ì œ ìˆ˜ì • (ID: ${q.id})`;
                document.getElementById('btn-save-q').innerText = "ìˆ˜ì •ì‚¬í•­ ì €ì¥";
                document.getElementById('btn-save-q').classList.remove('bg-blue-600');
                document.getElementById('btn-save-q').classList.add('bg-indigo-600');
                
                this.setTab('add');
            },

            removeImage: function() {
                document.getElementById('current-image-data').value = '';
                document.getElementById('new-q-image-file').value = '';
                document.getElementById('image-preview-area').classList.add('hidden');
            },

            clearForm: function() {
                document.getElementById('edit-q-id').value = '';
                document.getElementById('form-title').innerHTML = 'ğŸ“ ì§ì ‘ ë§Œë“¤ê¸°';
                document.getElementById('new-q-text').value = '';
                document.getElementById('new-q-options').value = '';
                document.getElementById('new-q-answer').value = '';
                document.getElementById('new-q-exp').value = '';
                document.getElementById('new-q-major').value = '';
                document.getElementById('new-q-middle').innerHTML = '<option value="">ì¤‘ë‹¨ì› ì„ íƒ</option>';
                this.removeImage();
                document.getElementById('btn-save-q').innerText = "ë“±ë¡í•˜ê¸°";
                document.getElementById('btn-save-q').classList.add('bg-blue-600');
                document.getElementById('btn-save-q').classList.remove('bg-indigo-600');
            },

            readFileAsDataURL: function(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            },

            saveCustomQuestion: async function() {
                const editId = document.getElementById('edit-q-id').value;
                const isEdit = !!editId;
                let id = isEdit ? parseInt(editId) : 1;
                if (!isEdit && this.state.questions.length > 0) id = Math.max(...this.state.questions.map(q=>q.id)) + 1;

                let imageData = document.getElementById('current-image-data').value;
                const fileInput = document.getElementById('new-q-image-file');
                if (fileInput.files.length > 0) {
                    try { imageData = await this.readFileAsDataURL(fileInput.files[0]); } catch(e) { alert("ì´ë¯¸ì§€ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ"); return; }
                }
                
                // Use Middle Unit as the primary 'unit' field, or Major if middle is empty
                const middle = document.getElementById('new-q-middle').value;
                const majorSelect = document.getElementById('new-q-major');
                const majorText = majorSelect.options[majorSelect.selectedIndex]?.text;
                
                // If editing, preserve old unit if user didn't touch the dropdowns
                let finalUnit = middle || (majorText !== 'ëŒ€ë‹¨ì› ì„ íƒ' ? majorText : '');
                
                if(!finalUnit && isEdit) {
                     const oldQ = this.state.questions.find(q => q.id === id);
                     if(oldQ) finalUnit = oldQ.unit;
                }

                const data = {
                    id: id,
                    unit: finalUnit,
                    type: document.getElementById('new-q-type').value,
                    question: document.getElementById('new-q-text').value,
                    options: document.getElementById('new-q-options').value.split(',').map(s=>s.trim()).filter(s=>s),
                    answer: document.getElementById('new-q-answer').value,
                    explanation: document.getElementById('new-q-exp').value,
                    image: imageData || null
                };

                window.getCollection('quiz_questions').doc(String(id)).set(data).then(() => {
                    alert(isEdit ? 'ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    this.clearForm();
                    this.loadQuestions();
                    if(isEdit) this.setTab('bank'); 
                }).catch(err => alert("ì €ì¥ ì‹¤íŒ¨: " + err.message));
            },

            deleteSelectedLogs: function() {
                const checked = document.querySelectorAll('.log-checkbox:checked');
                if(!checked.length) return;
                if(!confirm(`${checked.length}ê°œì˜ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
                const batch = window.db.batch();
                checked.forEach(cb => batch.delete(window.getCollection('quiz_results').doc(cb.value)));
                batch.commit().then(() => this.loadByClass(document.getElementById('select-class-trigger').value));
            },
            
            deleteLog: function(id) {
                if(confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                    window.getCollection('quiz_results').doc(id).delete().then(() => this.loadByClass(document.getElementById('select-class-trigger').value));
                }
            },

            deleteSelectedQuestions: function() {
                const checked = document.querySelectorAll('.q-checkbox:checked');
                if(!checked.length) return;
                if(!confirm(`ì„ íƒí•œ ${checked.length}ê°œì˜ ë¬¸ì œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
                const batch = window.db.batch();
                checked.forEach(cb => batch.delete(window.getCollection('quiz_questions').doc(cb.value)));
                batch.commit().then(() => this.loadQuestions());
            }
        };

        document.addEventListener('auth-ready', () => app.init());
    </script>
</body>
</html>
