
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‹¨ì› ì„¤ì • - Westory Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Quill Editor -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="../assets/js/firebase-config.js"></script>
    <link rel="stylesheet" href="../assets/css/style.css">
    <script src="../assets/js/auth-manager.js"></script>

    <style>
        .tree-node { position: relative; padding-left: 20px; }
        .tree-line { position: absolute; top: 0; bottom: 0; left: 10px; border-left: 1px dashed #cbd5e1; }
        .tree-item { 
            display: flex; align-items: center; padding: 6px 10px; margin: 2px 0; 
            border-radius: 6px; cursor: pointer; transition: all 0.2s; border: 1px solid transparent; 
        }
        .tree-item:hover { background-color: #f1f5f9; }
        .tree-item.active { background-color: #eff6ff; border-color: #bfdbfe; color: #2563eb; font-weight: bold; }
        
        /* Level Styles */
        .level-0 .tree-item-title { font-weight: 800; font-size: 1.05rem; color: #1e293b; } /* Large */
        .level-1 .tree-item-title { font-weight: 600; font-size: 0.95rem; color: #475569; } /* Medium */
        .level-2 .tree-item-title { font-weight: 400; font-size: 0.9rem; color: #64748b; } /* Small */

        .btn-action { opacity: 0; transition: opacity 0.2s; }
        .tree-item:hover .btn-action { opacity: 1; }

        /* Quill Override */
        .ql-container { font-family: 'Noto Sans KR', sans-serif; font-size: 1rem; height: 500px; }
        .ql-editor strong { font-weight: bold; }
        
        /* Preview Styles */
        .cloze-input {
            border: none; border-bottom: 2px solid #374151; text-align: center;
            font-weight: bold; color: #2563eb; background: transparent;
            padding: 0 4px; width: 100px; display: inline-block;
        }
    </style>
</head>
<body class="bg-gray-50 h-screen flex flex-col">
    <!-- Header injected by AuthManager -->

    <main class="flex-1 w-full max-w-7xl mx-auto px-6 py-6 h-full overflow-hidden flex flex-col">
        
        <div class="flex justify-between items-center mb-4 shrink-0">
            <div>
                <h1 class="text-2xl font-bold text-gray-800"><i class="fas fa-sitemap text-blue-500 mr-2"></i>ë‹¨ì› ì„¤ì • ë° ìˆ˜ì—… ìë£Œ ê´€ë¦¬</h1>
                <p class="text-sm text-gray-500 mt-1">ëŒ€ë‹¨ì› > ì¤‘ë‹¨ì› > ì†Œë‹¨ì› êµ¬ì¡°ë¥¼ ì„¤ì •í•˜ê³ , ì†Œë‹¨ì›ì„ ì„ íƒí•˜ì—¬ í•™ìŠµ ìë£Œë¥¼ ë“±ë¡í•˜ì„¸ìš”.</p>
            </div>
        </div>

        <div class="flex gap-6 h-full overflow-hidden pb-4">
            
            <!-- Left: Tree Structure -->
            <div class="w-1/3 bg-white rounded-xl shadow-sm border border-gray-200 flex flex-col overflow-hidden">
                <div class="p-4 border-b bg-gray-50 font-bold text-gray-700 flex justify-between items-center">
                    <span>ğŸ“š ë‹¨ì› ëª©ì°¨</span>
                    <div class="flex gap-1">
                        <button onclick="app.addRootUnit()" class="text-xs bg-stone-800 text-white px-3 py-1.5 rounded hover:bg-stone-900 shadow-sm flex items-center transition" title="ëŒ€ë‹¨ì› ì¶”ê°€">
                            <i class="fas fa-plus mr-1.5"></i>ëŒ€ë‹¨ì› ì¶”ê°€
                        </button>
                        <button onclick="app.saveTree()" class="text-xs bg-blue-100 text-blue-700 px-3 py-1.5 rounded hover:bg-blue-200 transition font-bold">ì €ì¥</button>
                    </div>
                </div>
                <!-- Changed: Added overflow-x-auto for long titles -->
                <div class="flex-1 overflow-y-auto overflow-x-auto p-4" id="tree-container">
                    <div class="text-center text-gray-400 py-10">ë¡œë”© ì¤‘...</div>
                </div>
            </div>

            <!-- Right: Lesson Editor (Hidden until leaf selected) -->
            <div class="w-2/3 bg-white rounded-xl shadow-sm border border-gray-200 flex flex-col relative" id="editor-panel">
                <div id="empty-state" class="absolute inset-0 flex flex-col items-center justify-center text-gray-400 bg-white z-10 rounded-xl">
                    <i class="far fa-hand-point-left text-4xl mb-4"></i>
                    <p class="text-lg">ì™¼ìª½ ëª©ì°¨ì—ì„œ <strong>ì†Œë‹¨ì›</strong>ì„ ì„ íƒí•˜ë©´<br>ìë£Œë¥¼ í¸ì§‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                </div>

                <!-- Editor UI -->
                <div class="p-4 border-b flex justify-between items-center bg-gray-50 shrink-0">
                    <div class="flex items-center gap-2 overflow-hidden">
                        <span class="bg-blue-600 text-white text-xs px-2 py-1 rounded font-bold shrink-0">ì„ íƒë¨</span>
                        <span id="selected-unit-path" class="font-bold text-gray-700 truncate"></span>
                    </div>
                    <div class="flex gap-2">
                         <button onclick="app.previewLesson()" class="bg-white border border-gray-300 text-gray-700 px-4 py-2 rounded-lg font-bold hover:bg-gray-50 text-sm">
                            <i class="fas fa-eye mr-2"></i>ë¯¸ë¦¬ë³´ê¸°
                        </button>
                        <button onclick="app.saveLesson()" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-blue-700 shadow-md text-sm">
                            <i class="fas fa-save mr-2"></i>ì €ì¥í•˜ê¸°
                        </button>
                    </div>
                </div>

                <div class="flex-1 overflow-y-auto p-6 space-y-4">
                    <!-- Title Input -->
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">ìë£Œ ì œëª© (í•™ìƒì—ê²Œ í‘œì‹œë  ì œëª©)</label>
                        <input type="text" id="lesson-title" class="w-full text-lg font-bold border-b-2 border-gray-200 focus:border-blue-500 outline-none py-2 px-1 transition" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”">
                    </div>

                    <!-- Video Link -->
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">YouTube ì˜ìƒ ë§í¬ (ì„ íƒ)</label>
                        <div class="flex gap-2">
                            <input type="text" id="lesson-video" class="w-full border rounded-lg px-3 py-2 text-sm bg-gray-50 focus:bg-white transition" placeholder="https://youtu.be/...">
                        </div>
                    </div>

                    <!-- Content Editor -->
                    <div class="flex-1 flex flex-col h-full min-h-[500px]">
                        <label class="block text-xs font-bold text-gray-500 mb-1 flex justify-between">
                            <span>í•™ìŠµ ë‚´ìš© (í…ìŠ¤íŠ¸, ì´ë¯¸ì§€, ë¹ˆì¹¸)</span>
                            <span class="text-blue-600">ë¹ˆì¹¸ ë§Œë“œëŠ” ë²•: ì •ë‹µì„ ëŒ€ê´„í˜¸ [ì •ë‹µ] ìœ¼ë¡œ ê°ì‹¸ì„¸ìš”.</span>
                        </label>
                        <div id="quill-editor" class="bg-white"></div>
                    </div>
                </div>
            </div>
        </div>

    </main>
    
    <!-- (Existing Modal & Scripts...) -->
    <!-- Preview Modal -->
    <div id="preview-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center">
        <div class="absolute inset-0 bg-black bg-opacity-70 backdrop-blur-sm" onclick="app.closePreview()"></div>
        <div class="bg-white w-full max-w-4xl h-[85vh] rounded-2xl shadow-2xl z-10 flex flex-col overflow-hidden relative">
            <div class="p-4 border-b flex justify-between items-center bg-gray-50">
                <h3 class="font-bold text-lg"><i class="fas fa-mobile-alt mr-2"></i>í•™ìƒ í™”ë©´ ë¯¸ë¦¬ë³´ê¸°</h3>
                <button onclick="app.closePreview()" class="text-gray-500 hover:text-gray-800"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="flex-1 overflow-y-auto p-8 bg-gray-50">
                <div class="max-w-2xl mx-auto bg-white p-8 rounded-xl shadow-sm border border-gray-200 min-h-full">
                    <h1 id="preview-title" class="text-2xl font-bold mb-4 text-gray-900 border-b pb-4"></h1>
                    <div id="preview-video-area" class="mb-6 hidden">
                        <div class="relative pb-[56.25%] h-0 overflow-hidden rounded-xl bg-black">
                            <iframe id="preview-iframe" class="absolute top-0 left-0 w-full h-full" frameborder="0" allowfullscreen></iframe>
                        </div>
                    </div>
                    <div id="preview-content" class="prose max-w-none text-gray-800 leading-loose"></div>
                    <div class="mt-8 text-center">
                        <button class="bg-blue-600 text-white px-6 py-2 rounded-lg font-bold opacity-50 cursor-not-allowed">ì •ë‹µ í™•ì¸ (ì˜ˆì‹œ)</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer injected by AuthManager -->

    <script>
        window.AuthManager.init('teacher');

        const app = {
            treeData: [],
            selectedNodeId: null,
            expandedIds: new Set(),
            quill: null,

            init: function() {
                this.initQuill();
                this.loadTree();
            },

            initQuill: function() {
                this.quill = new Quill('#quill-editor', {
                    theme: 'snow',
                    modules: {
                        toolbar: [
                            [{ 'header': [1, 2, 3, false] }],
                            ['bold', 'italic', 'underline', 'strike'],
                            [{ 'color': [] }, { 'background': [] }],
                            [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                            ['link', 'image'],
                            ['clean']
                        ]
                    },
                    placeholder: 'ì—¬ê¸°ì— í•™ìŠµ ë‚´ìš©ì„ ì‘ì„±í•˜ì„¸ìš”. ì´ë¯¸ì§€ë¥¼ ë¶™ì—¬ë„£ê±°ë‚˜ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.'
                });
            },

            // --- Tree Management ---
            loadTree: async function() {
                try {
                    // Changed: Use dynamic collection for semester
                    const doc = await window.getCollection('curriculum').doc('tree').get();
                    if (doc.exists && doc.data().tree) {
                        this.treeData = doc.data().tree;
                    } else {
                        // Default Structure
                        this.treeData = [
                            { 
                                id: 'root-' + Date.now(), 
                                title: 'ìƒˆ ëŒ€ë‹¨ì›', 
                                children: [] 
                            }
                        ];
                    }
                    this.renderTree();
                } catch(e) {
                    console.error(e);
                    document.getElementById('tree-container').innerHTML = '<p class="text-red-500">ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨</p>';
                }
            },

            renderTree: function() {
                const container = document.getElementById('tree-container');
                container.innerHTML = '';
                
                const renderNode = (node, level, parentArr) => {
                    const el = document.createElement('div');
                    el.className = `tree-node level-${level}`;
                    
                    if (level > 0) {
                        const line = document.createElement('div');
                        line.className = 'tree-line';
                        el.appendChild(line);
                    }

                    const itemBox = document.createElement('div');
                    const isSelected = this.selectedNodeId === node.id;
                    itemBox.className = `tree-item ${isSelected ? 'active' : ''}`;
                    
                    const isExpanded = this.expandedIds.has(node.id);
                    const isLeaf = level >= 2;
                    let iconClass = 'fas fa-folder';
                    if (!isLeaf) iconClass = isExpanded ? 'fas fa-folder-open' : 'fas fa-folder';
                    else iconClass = 'fas fa-file-alt';

                    // Click Handler
                    itemBox.onclick = (e) => { 
                        e.stopPropagation(); 
                        if (!isLeaf) {
                            this.toggleExpand(node.id);
                        } else {
                            this.selectNode(node, level);
                        }
                    };

                    const caretIcon = !isLeaf 
                        ? `<i class="fas fa-caret-${isExpanded?'down':'right'} w-4 text-gray-400 mr-1 transition-transform"></i>` 
                        : `<span class="w-4 mr-1"></span>`;

                    const titleSpan = document.createElement('span');
                    // Changed: Added whitespace-nowrap to prevent line breaks
                    titleSpan.className = 'tree-item-title flex-1 ml-1 select-none whitespace-nowrap';
                    titleSpan.innerText = node.title;
                    
                    const actions = document.createElement('div');
                    actions.className = 'btn-action flex gap-1 ml-2';
                    
                    if (!isLeaf) {
                        const btnAdd = document.createElement('button');
                        btnAdd.className = 'text-green-600 hover:bg-green-100 p-1 rounded';
                        btnAdd.innerHTML = '<i class="fas fa-plus"></i>';
                        btnAdd.title = level === 0 ? 'ì¤‘ë‹¨ì› ì¶”ê°€' : 'ì†Œë‹¨ì› ì¶”ê°€';
                        btnAdd.onclick = (e) => { e.stopPropagation(); this.addChild(node); };
                        actions.appendChild(btnAdd);
                    }

                    const btnEdit = document.createElement('button');
                    btnEdit.className = 'text-blue-600 hover:bg-blue-100 p-1 rounded';
                    btnEdit.innerHTML = '<i class="fas fa-pen"></i>';
                    btnEdit.title = 'ì´ë¦„ ë³€ê²½';
                    btnEdit.onclick = (e) => { e.stopPropagation(); this.renameNode(node); };
                    actions.appendChild(btnEdit);

                    const btnDel = document.createElement('button');
                    btnDel.className = 'text-red-600 hover:bg-red-100 p-1 rounded';
                    btnDel.innerHTML = '<i class="fas fa-trash"></i>';
                    btnDel.title = 'ì‚­ì œ';
                    btnDel.onclick = (e) => { e.stopPropagation(); this.deleteNode(node, parentArr); };
                    actions.appendChild(btnDel);

                    itemBox.innerHTML = caretIcon + `<i class="${iconClass} text-gray-400 ${isSelected?'text-blue-500':''}"></i>`;
                    itemBox.appendChild(titleSpan);
                    itemBox.appendChild(actions);
                    el.appendChild(itemBox);

                    if (!isLeaf && isExpanded && node.children && node.children.length > 0) {
                        const childrenContainer = document.createElement('div');
                        node.children.forEach(child => {
                            childrenContainer.appendChild(renderNode(child, level + 1, node.children));
                        });
                        el.appendChild(childrenContainer);
                    }

                    return el;
                };

                this.treeData.forEach(rootNode => {
                    container.appendChild(renderNode(rootNode, 0, this.treeData));
                });
            },

            toggleExpand: function(id) {
                if(this.expandedIds.has(id)) this.expandedIds.delete(id);
                else this.expandedIds.add(id);
                this.renderTree();
            },

            selectNode: function(node, level) {
                this.selectedNodeId = node.id;
                this.renderTree(); 

                const panel = document.getElementById('empty-state');
                const pathDisplay = document.getElementById('selected-unit-path');

                if (level === 2) { 
                    panel.classList.add('hidden');
                    pathDisplay.innerText = node.title;
                    this.loadLessonContent(node.id, node.title);
                } else {
                    panel.classList.remove('hidden');
                }
            },

            addRootUnit: function() {
                const name = prompt("ìƒˆ ëŒ€ë‹¨ì› ì´ë¦„:");
                if(!name) return;
                const newId = 'u-'+Date.now();
                this.treeData.push({ id: newId, title: name, children: [] });
                this.expandedIds.add(newId);
                this.renderTree();
                this.saveTree(true); 
            },

            addChild: function(node) {
                const name = prompt("ìƒˆ í•˜ìœ„ ë‹¨ì› ì´ë¦„:");
                if(!name) return;
                if(!node.children) node.children = [];
                node.children.push({ id: 'u-'+Date.now(), title: name, children: [] });
                this.expandedIds.add(node.id); // Auto expand parent
                this.renderTree();
                this.saveTree(true);
            },

            renameNode: function(node) {
                const newName = prompt("ë‹¨ì› ì´ë¦„ ìˆ˜ì •:", node.title);
                if(newName) {
                    node.title = newName;
                    this.renderTree();
                    this.saveTree(true);
                    if(this.selectedNodeId === node.id) document.getElementById('selected-unit-path').innerText = newName;
                }
            },

            deleteNode: function(node, parentArr) {
                if(!confirm(`'${node.title}' ë° í•˜ìœ„ ë‚´ìš©ì„ ëª¨ë‘ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
                const idx = parentArr.indexOf(node);
                if(idx > -1) {
                    parentArr.splice(idx, 1);
                    if(this.selectedNodeId === node.id) {
                        this.selectedNodeId = null;
                        document.getElementById('empty-state').classList.remove('hidden');
                    }
                    this.renderTree();
                    this.saveTree(true);
                }
            },

            saveTree: async function(silent = false) {
                try {
                    // Changed: Use dynamic collection
                    await window.getCollection('curriculum').doc('tree').set({
                        tree: this.treeData,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    if(!silent) alert("êµ¬ì¡°ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
                } catch(e) {
                    alert("ì €ì¥ ì‹¤íŒ¨: " + e.message);
                }
            },

            loadLessonContent: async function(unitId, unitTitle) {
                document.getElementById('lesson-title').value = unitTitle; 
                document.getElementById('lesson-video').value = '';
                this.quill.setContents([]);

                try {
                    // Changed: Use dynamic collection
                    const snap = await window.getCollection('lessons').where('unitId', '==', unitId).limit(1).get();
                    if (!snap.empty) {
                        const data = snap.docs[0].data();
                        document.getElementById('lesson-title').value = data.title;
                        document.getElementById('lesson-video').value = data.videoUrl || '';
                        const raw = data.contentHtml || "";
                        this.quill.clipboard.dangerouslyPasteHTML(raw);
                    }
                } catch(e) {
                    console.error("Content load error", e);
                }
            },

            saveLesson: async function() {
                if(!this.selectedNodeId) return;

                const title = document.getElementById('lesson-title').value;
                const video = document.getElementById('lesson-video').value;
                const html = this.quill.root.innerHTML;

                const data = {
                    unitId: this.selectedNodeId,
                    title: title,
                    videoUrl: video,
                    contentHtml: html,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                try {
                    // Changed: Use dynamic collection
                    const lessonRef = window.getCollection('lessons');
                    const snap = await lessonRef.where('unitId', '==', this.selectedNodeId).limit(1).get();
                    if (snap.empty) {
                        await lessonRef.add(data);
                    } else {
                        await lessonRef.doc(snap.docs[0].id).update(data);
                    }
                    alert("ìˆ˜ì—… ìë£Œê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
                } catch(e) {
                    alert("ì €ì¥ ì‹¤íŒ¨: " + e.message);
                }
            },

            previewLesson: function() {
                const title = document.getElementById('lesson-title').value;
                const videoUrl = document.getElementById('lesson-video').value;
                let html = this.quill.root.innerHTML;

                html = html.replace(/\[(.*?)\]/g, (match, p1) => {
                    return `<input type="text" class="cloze-input" placeholder="ë¹ˆì¹¸" readonly value="(ì •ë‹µ: ${p1})">`;
                });

                document.getElementById('preview-title').innerText = title;
                document.getElementById('preview-content').innerHTML = html;

                const videoArea = document.getElementById('preview-video-area');
                if (videoUrl) {
                    const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
                    const match = videoUrl.match(regExp);
                    if (match && match[2].length === 11) {
                        document.getElementById('preview-iframe').src = `https://www.youtube.com/embed/${match[2]}`;
                        videoArea.classList.remove('hidden');
                    } else {
                        videoArea.classList.add('hidden');
                    }
                } else {
                    videoArea.classList.add('hidden');
                }

                document.getElementById('preview-modal').classList.remove('hidden');
                document.getElementById('preview-modal').classList.add('flex');
            },

            closePreview: function() {
                document.getElementById('preview-modal').classList.add('hidden');
                document.getElementById('preview-modal').classList.remove('flex');
                document.getElementById('preview-iframe').src = '';
            }
        };

        document.addEventListener('auth-ready', () => app.init());
    </script>
</body>
</html>
