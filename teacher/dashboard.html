<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>êµì‚¬ ëŒ€ì‹œë³´ë“œ - Westory Admin</title>
    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- FullCalendar -->
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="../assets/js/firebase-config.js"></script>
    <link rel="stylesheet" href="../assets/css/style.css">
    <script src="../assets/js/auth-manager.js"></script>

    <style>
        .fc-toolbar-title {
            font-size: 1.25em !important;
            font-weight: 700;
            color: #1f2937;
        }

        .fc-button {
            background-color: #2563eb !important;
            border-color: #2563eb !important;
            font-weight: 600 !important;
        }

        .fc-button:hover {
            background-color: #1d4ed8 !important;
            border-color: #1d4ed8 !important;
        }

        .fc-button-active {
            background-color: #1e40af !important;
            border-color: #1e40af !important;
        }

        .fc-daygrid-event {
            cursor: pointer;
            border-radius: 4px;
            padding: 2px 4px;
            font-size: 0.85rem;
            font-weight: 600;
            border: none;
        }

        /* Korean Calendar Colors */
        .fc-day-sun a {
            color: #ef4444 !important;
            text-decoration: none;
            font-weight: 700;
        }

        .fc-day-sat a {
            color: #3b82f6 !important;
            text-decoration: none;
            font-weight: 700;
        }

        .fc-day-holiday a {
            color: #ef4444 !important;
            font-weight: 700;
        }

        .holiday-text-event {
            background-color: transparent !important;
            border: none !important;
        }

        .holiday-text-event .fc-event-title {
            color: #ef4444;
            font-size: 0.75rem;
            font-weight: 800;
        }

        /* Modal Overlay */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 100;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* Mobile Optimization for Calendar */
        @media (max-width: 768px) {
            .fc-toolbar {
                flex-direction: column;
                gap: 0.5rem;
            }

            .fc-toolbar-title {
                font-size: 1rem !important;
            }

            .fc-button {
                padding: 0.25rem 0.6rem !important;
                font-size: 0.75rem !important;
            }

            .fc-header-toolbar {
                margin-bottom: 0.5rem !important;
            }

            .fc .fc-toolbar-chunk:first-child {
                display: flex;
                gap: 4px;
            }
        }

        /* Selected Date Cell Highlight */
        .fc-day-selected {
            background-color: #f3f4f6 !important;
            outline: 2px solid #3b82f6 !important;
            outline-offset: -2px !important;
        }

        /* Search Panel */
        #search-panel {
            position: absolute;
            top: 100%;
            right: 0;
            width: 300px;
            max-height: 400px;
            overflow-y: auto;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            z-index: 50;
            margin-top: 8px;
        }
    </style>
</head>

<body class="bg-gray-50 flex flex-col h-screen">
    <!-- Header injected by AuthManager -->

    <main class="flex-1 w-full max-w-7xl mx-auto px-4 py-4 md:px-6 md:py-6 h-full flex flex-col overflow-hidden">

        <div class="flex justify-between items-center mb-4 shrink-0">
            <div class="flex items-center gap-3">
                <h1 class="text-xl md:text-2xl font-bold text-gray-800">ëŒ€ì‹œë³´ë“œ</h1>
                <span id="dash-year-badge"
                    class="bg-blue-600 text-white font-bold px-3 py-1 rounded-full text-xs md:text-sm shadow-md min-w-[100px] text-center">
                    <i class="fas fa-spinner fa-spin"></i>
                </span>
            </div>
        </div>

        <!-- Search & Filter (Moved to Top Right of Calendar Area or Global Header) -->
        <!-- We will place it inside the calendar container header or keep it above -->
        </div>

        <!-- Main Content Area (Split Layout) -->
        <div class="flex flex-col md:flex-row h-[calc(100vh-140px)] gap-4">

            <!-- Left: Calendar (60%) -->
            <div class="w-full md:w-3/5 bg-white rounded-xl shadow-sm p-4 h-full flex flex-col">
                <div class="flex justify-between items-center mb-2">
                    <h2 class="text-lg font-bold text-gray-800"><i class="far fa-calendar-alt mr-2 text-blue-600"></i>í•™ì‚¬
                        ì¼ì •</h2>
                    <div class="flex items-center gap-2">
                        <button onclick="app.openSearch()"
                            class="bg-gray-50 border border-gray-200 text-gray-600 hover:text-blue-600 p-1.5 rounded-lg transition"
                            title="ê²€ìƒ‰">
                            <i class="fas fa-search"></i>
                        </button>
                        <select id="view-filter" onchange="app.refetchEvents()"
                            class="bg-gray-50 border border-gray-200 text-gray-700 text-sm rounded-lg p-1.5 outline-none">
                            <option value="all">ì „ì²´ ë³´ê¸°</option>
                            <option value="common">ê³µí†µ ì¼ì •</option>
                            <!-- Class options populated dynamically -->
                        </select>
                        <button onclick="app.openModal()"
                            class="bg-blue-600 text-white px-3 py-1.5 rounded-lg text-sm font-bold hover:bg-blue-700 shadow-sm transition">
                            <i class="fas fa-plus mr-1"></i> ì¶”ê°€
                        </button>
                        <div class="flex items-center gap-2 ml-2">
                            <button onclick="app.populate2026Holidays()"
                                class="bg-green-600 text-white px-2 py-1.5 rounded-md hover:bg-green-700 transition flex items-center gap-1 shadow-sm text-xs font-bold"
                                title="2026ë…„ ê³µíœ´ì¼ ìë™ ë“±ë¡">
                                <i class="fas fa-calendar-check"></i> ê³µíœ´ì¼
                            </button>
                            <button onclick="app.checkSchedule()"
                                class="bg-gray-600 text-white px-2 py-1.5 rounded-md hover:bg-gray-700 transition flex items-center gap-1 shadow-sm text-xs font-bold"
                                title="ë°ì´í„° í™•ì¸">
                                <i class="fas fa-database"></i> í™•ì¸
                            </button>
                        </div>
                    </div>
                    <!-- Search Panel (Hidden by default) -->
                    <div id="search-panel" class="hidden">
                        <div class="p-3 border-b border-gray-200">
                            <input type="text" id="search-input" placeholder="ì¼ì • ì œëª© ê²€ìƒ‰..."
                                class="w-full border border-gray-300 rounded-lg p-2 text-sm outline-none focus:ring-2 focus:ring-blue-500"
                                oninput="app.performSearch(this.value)">
                        </div>
                        <div id="search-results" class="p-3 text-sm text-gray-500">
                            ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”
                        </div>
                    </div>
                </div>
                <div id="calendar" class="flex-1"></div>
            </div>

            <!-- Right: Functions (40%) -->
            <div class="w-full md:w-2/5 flex flex-col gap-4 h-full">

                <!-- Right Top: Notice Board (50%) -->
                <div
                    class="h-1/2 bg-[#fffbeb] rounded-xl shadow-sm border border-yellow-200 p-4 flex flex-col relative overflow-hidden">
                    <div class="flex justify-between items-center mb-3 border-b border-yellow-200 pb-2">
                        <h3 class="text-lg font-extrabold text-amber-800 flex items-center">
                            <i class="fas fa-thumbtack mr-2 text-amber-600"></i>ì•Œë¦¼ì¥
                        </h3>
                        <button onclick="app.openNoticeModal()"
                            class="text-amber-700 hover:text-amber-900 bg-yellow-200 hover:bg-yellow-300 px-2 py-1 rounded text-xs font-bold transition">
                            <i class="fas fa-plus mr-1"></i>ì“°ê¸°
                        </button>
                    </div>
                    <div id="notice-list" class="flex-1 overflow-y-auto space-y-3 pr-2 custom-scroll">
                        <div class="text-center text-amber-800/50 py-10 font-bold text-sm">ë“±ë¡ëœ ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>
                    </div>
                </div>

                <!-- Right Bottom: Event Details (50%) -->
                <div class="h-1/2 bg-white rounded-xl shadow-sm border border-gray-200 p-4 flex flex-col">
                    <div class="flex justify-between items-center mb-3 border-b border-gray-100 pb-2">
                        <h3 class="text-lg font-bold text-gray-800 flex items-center">
                            <i class="fas fa-info-circle mr-2 text-blue-500"></i>ì¼ì • ìƒì„¸
                        </h3>
                        <span id="detail-date-display" class="text-sm font-bold text-gray-500">ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”</span>
                    </div>
                    <div id="detail-panel-content" class="flex-1 overflow-y-auto pr-2 custom-scroll">
                        <div class="flex flex-col items-center justify-center h-full text-gray-400">
                            <i class="far fa-calendar-check text-4xl mb-3 text-gray-200"></i>
                            <p class="text-sm">ë‹¬ë ¥ì—ì„œ ë‚ ì§œë‚˜ ì¼ì •ì„ í´ë¦­í•˜ë©´<br>ìƒì„¸ ë‚´ìš©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </main>

    <!-- Notice Add/Edit Modal -->
    <div id="notice-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center"
        onclick="app.attemptCloseNotice(event)">
        <div class="bg-[#fffbeb] rounded-xl shadow-2xl w-full max-w-lg p-8 m-4 border-t-8 border-amber-400 relative"
            onclick="event.stopPropagation()">
            <button onclick="app.attemptCloseNotice()"
                class="absolute top-4 right-4 text-amber-800 hover:text-amber-600">
                <i class="fas fa-times fa-lg"></i>
            </button>
            <h3 class="text-xl font-extrabold text-amber-900 mb-6"><i class="fas fa-pen-fancy mr-2"></i>ì•Œë¦¼ ì“°ê¸°</h3>

            <input type="hidden" id="notice-id">

            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-amber-800 mb-1">ì¹´í…Œê³ ë¦¬</label>
                    <select id="notice-category"
                        class="w-full bg-white border border-yellow-300 rounded p-2 text-sm font-bold text-gray-700 outline-none focus:ring-2 focus:ring-amber-300"
                        onchange="app.toggleDDayInput()">
                        <option value="normal">ğŸ“¢ ì¼ë°˜ ì•Œë¦¼</option>
                        <option value="exam">ğŸ”¥ ì •ê¸° ì‹œí—˜</option>
                        <option value="performance">âš¡ ìˆ˜í–‰í‰ê°€</option>
                        <option value="prep">ğŸ’ ìˆ˜ì—… ì¤€ë¹„ë¬¼</option>
                        <option value="dday">â³ D-Day ì„¤ì •</option>
                    </select>
                </div>

                <div id="dday-input-group" class="hidden">
                    <label class="block text-xs font-bold text-amber-800 mb-1">ëª©í‘œ ë‚ ì§œ</label>
                    <input type="date" id="notice-target-date"
                        class="w-full bg-white border border-yellow-300 rounded p-2 text-sm outline-none">
                </div>

                <div>
                    <label class="block text-xs font-bold text-amber-800 mb-1">ì•Œë¦¼ ë‚´ìš©</label>
                    <textarea id="notice-content" rows="5"
                        class="w-full bg-white border border-yellow-300 rounded p-3 text-sm resize-none outline-none focus:ring-2 focus:ring-amber-300 placeholder-amber-800/30"
                        placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
                </div>

                <div>
                    <label class="block text-xs font-bold text-amber-800 mb-2">ëŒ€ìƒ ì„ íƒ</label>
                    <div class="flex items-center gap-3">
                        <label class="inline-flex items-center gap-1 cursor-pointer">
                            <input type="radio" name="notice-target" value="common" id="notice-common-radio" checked
                                class="text-amber-600 focus:ring-amber-500" onchange="app.toggleNoticeClassSelect()">
                            <span class="text-sm font-bold text-amber-900">ì „ì²´ ê³µí†µ</span>
                        </label>
                        <label class="inline-flex items-center gap-1 cursor-pointer">
                            <input type="radio" name="notice-target" value="class" id="notice-class-radio"
                                class="text-amber-600 focus:ring-amber-500" onchange="app.toggleNoticeClassSelect()">
                            <span class="ml-2 text-sm font-bold text-gray-700">ë°˜ ì„ íƒ</span>
                        </label>
                    </div>
                    <div id="notice-class-select" class="flex gap-2 hidden">
                        <select id="notice-target-grade"
                            class="w-1/3 border border-gray-300 rounded-lg p-2.5 outline-none bg-white font-bold text-center">
                            <option value="1">1í•™ë…„</option>
                            <option value="2">2í•™ë…„</option>
                            <option value="3">3í•™ë…„</option>
                        </select>
                        <select id="notice-target-class-num"
                            class="w-2/3 border border-gray-300 rounded-lg p-2.5 outline-none bg-white font-bold">
                            <option value="1">1ë°˜</option>
                            <option value="2">2ë°˜</option>
                            <option value="3">3ë°˜</option>
                            <option value="4">4ë°˜</option>
                            <option value="5">5ë°˜</option>
                            <option value="6">6ë°˜</option>
                            <option value="7">7ë°˜</option>
                            <option value="8">8ë°˜</option>
                            <option value="9">9ë°˜</option>
                            <option value="10">10ë°˜</option>
                            <option value="11">11ë°˜</option>
                            <option value="12">12ë°˜</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="flex justify-end gap-2 mt-6">
                <button onclick="app.deleteNotice()" id="btn-delete-notice"
                    class="hidden px-3 py-2 text-red-600 hover:bg-red-50 rounded font-bold text-sm">ì‚­ì œ</button>
                <button onclick="app.saveNotice()"
                    class="px-5 py-2 bg-amber-500 text-white rounded-lg font-bold hover:bg-amber-600 shadow-md transition transform active:scale-95">ê²Œì‹œí•˜ê¸°</button>
            </div>
        </div>
    </div>

    <!-- Event Modal (Add/Edit) -->
    <div id="event-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center"
        onclick="app.attemptClose()">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 m-4" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-6">
                <h3 id="modal-title" class="text-xl font-bold text-gray-800"><i
                        class="fas fa-edit text-blue-500 mr-2"></i>ì¼ì • ë“±ë¡</h3>
                <button onclick="app.attemptClose()" class="text-gray-400 hover:text-gray-600 transition">
                    <i class="fas fa-times fa-lg"></i>
                </button>
            </div>

            <input type="hidden" id="event-id">

            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">ì¼ì • ì œëª©</label>
                    <input type="text" id="event-title"
                        class="w-full border border-gray-300 rounded-lg p-2.5 focus:ring-2 focus:ring-blue-500 outline-none"
                        placeholder="ì˜ˆ: ì—­ì‚¬ ìˆ˜í–‰í‰ê°€">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">ì‹œì‘ ë‚ ì§œ</label>
                        <input type="date" id="event-start"
                            class="w-full border border-gray-300 rounded-lg p-2.5 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">ì¢…ë£Œ ë‚ ì§œ (ì„ íƒ)</label>
                        <input type="date" id="event-end"
                            class="w-full border border-gray-300 rounded-lg p-2.5 outline-none" placeholder="ì—°ë„-ì›”-ì¼">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">ì¼ì • ì¢…ë¥˜</label>
                    <select id="event-type"
                        class="w-full border border-gray-300 rounded-lg p-2.5 outline-none font-bold">
                        <option value="exam" class="text-red-600">ğŸ”´ ì •ê¸° ì‹œí—˜</option>
                        <option value="performance" class="text-orange-500">âš¡ ìˆ˜í–‰í‰ê°€</option>
                        <option value="diagnosis" class="text-blue-600">ğŸ“ ì§„ë‹¨í‰ê°€</option>
                        <option value="formative" class="text-blue-600">ğŸ“˜ í˜•ì„±í‰ê°€</option>
                        <option value="event" class="text-green-600">ğŸ‰ í–‰ì‚¬</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">ëŒ€ìƒ ì„ íƒ</label>
                    <div class="flex items-center space-x-4 mb-2">
                        <label class="flex items-center cursor-pointer">
                            <input type="radio" name="targetType" value="common" checked
                                onchange="app.toggleTargetClass(false)" class="w-4 h-4 text-blue-600">
                            <span class="ml-2 text-sm font-bold text-gray-700">ì „ì²´ ê³µí†µ</span>
                        </label>
                        <label class="flex items-center cursor-pointer">
                            <input type="radio" name="targetType" value="class" onchange="app.toggleTargetClass(true)"
                                class="w-4 h-4 text-blue-600">
                            <span class="ml-2 text-sm font-bold text-gray-700">ë°˜ ì„ íƒ</span>
                        </label>
                    </div>
                    <div class="flex gap-2">
                        <select id="target-grade"
                            class="w-1/3 border border-gray-300 rounded-lg p-2.5 outline-none bg-gray-50 transition font-bold text-center"
                            disabled>
                            <option value="1">1í•™ë…„</option>
                            <option value="2">2í•™ë…„</option>
                            <option value="3">3í•™ë…„</option>
                        </select>
                        <select id="target-class-num"
                            class="w-2/3 border border-gray-300 rounded-lg p-2.5 outline-none bg-gray-50 transition font-bold"
                            disabled>
                            <option value="1">1ë°˜</option>
                            <option value="2">2ë°˜</option>
                            <option value="3">3ë°˜</option>
                            <option value="4">4ë°˜</option>
                            <option value="5">5ë°˜</option>
                            <option value="6">6ë°˜</option>
                            <option value="7">7ë°˜</option>
                            <option value="8">8ë°˜</option>
                            <option value="9">9ë°˜</option>
                            <option value="10">10ë°˜</option>
                            <option value="11">11ë°˜</option>
                            <option value="12">12ë°˜</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">ìƒì„¸ ë‚´ìš© (ì„ íƒ)</label>
                    <textarea id="event-desc" rows="3"
                        class="w-full border border-gray-300 rounded-lg p-2.5 outline-none resize-none"
                        placeholder="ì¼ì •ì— ëŒ€í•œ ìƒì„¸ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
                </div>
            </div>

            <div class="flex justify-end gap-2 mt-6 pt-4 border-t border-gray-100">
                <button type="button" id="btn-delete" onclick="app.deleteEvent()"
                    class="hidden px-4 py-2 bg-red-100 text-red-600 rounded-lg font-bold hover:bg-red-200 transition">ì‚­ì œ</button>
                <div class="flex-1"></div>
                <button type="button" onclick="app.attemptClose()"
                    class="px-5 py-2 bg-gray-100 text-gray-600 rounded-lg font-bold hover:bg-gray-200 transition">ì·¨ì†Œ</button>
                <button type="button" onclick="app.saveEvent()"
                    class="px-5 py-2 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 shadow-md transition transform active:scale-95">ì €ì¥</button>
            </div>
        </div>
    </div>

    <!-- Search Modal -->
    <div id="search-modal"
        class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-start justify-center pt-20">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6 m-4" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800"><i class="fas fa-search text-blue-500 mr-2"></i>ì¼ì • ê²€ìƒ‰</h3>
                <button onclick="app.closeSearch()" class="text-gray-400 hover:text-gray-600 transition">
                    <i class="fas fa-times fa-lg"></i>
                </button>
            </div>

            <div class="relative mb-4">
                <input type="text" id="search-input" onkeyup="if(event.key === 'Enter') app.executeSearch()"
                    class="w-full border-2 border-blue-100 rounded-xl p-3 pl-10 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 outline-none transition font-bold text-lg"
                    placeholder="ê²€ìƒ‰ì–´ ì…ë ¥ (ì˜ˆ: ì¤‘ê°„ê³ ì‚¬, ìˆ˜í–‰í‰ê°€)">
                <i class="fas fa-search absolute left-4 top-4 text-gray-400"></i>
                <button onclick="app.executeSearch()"
                    class="absolute right-2 top-2 bg-blue-600 text-white px-4 py-1.5 rounded-lg font-bold hover:bg-blue-700 transition">ê²€ìƒ‰</button>
            </div>

            <div id="search-results" class="h-64 overflow-y-auto custom-scroll space-y-2">
                <div class="text-center text-gray-400 py-10">ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ê³  ì—”í„°ë¥¼ ëˆ„ë¥´ì„¸ìš”.</div>
            </div>
        </div>
    </div>

    <!-- Footer injected by AuthManager -->

    <script>
        window.AuthManager.init('teacher');

        const app = {
            calendar: null,
            colorMap: {
                'exam': '#ef4444',       // Red
                'performance': '#f97316', // Orange
                'event': '#10b981',       // Green
                'diagnosis': '#3b82f6',   // Blue
                'formative': '#3b82f6'    // Blue
            },
            typeLabelMap: {
                'exam': 'ì •ê¸° ì‹œí—˜', 'performance': 'ìˆ˜í–‰í‰ê°€', 'event': 'í–‰ì‚¬', 'diagnosis': 'ì§„ë‹¨í‰ê°€', 'formative': 'í˜•ì„±í‰ê°€'
            },
            // Holidays loaded from Firestore (no hardcoding)
            holidays: {},

            init: function () {
                const cfg = window.currentConfig;
                if (cfg) document.getElementById('dash-year-badge').innerText = `${cfg.year}í•™ë…„ë„ ${cfg.semester}í•™ê¸°`;
                this.initCalendar();
                // this.initModal(); // Removed
                this.initSearch();
                this.initNotices();
                this.initClassFilter();
            },

            // Delete all holidays for the current semester path before populating
            resetHolidays: async function (path) {
                console.log(`[Holiday] Resetting holidays in ${path}...`);
                const snapshot = await window.db.collection(path).where('eventType', '==', 'holiday').get();

                // Also check for legacy 'targetType: common' + 'description: ëŒ€í•œë¯¼êµ­ ê³µíœ´ì¼' just in case
                const snapshot2 = await window.db.collection(path)
                    .where('description', '==', 'ëŒ€í•œë¯¼êµ­ ê³µíœ´ì¼').get();

                const batch = window.db.batch();
                let count = 0;

                const deleteDoc = (doc) => {
                    batch.delete(doc.ref);
                    count++;
                };

                snapshot.forEach(deleteDoc);
                snapshot2.forEach(deleteDoc);

                if (count > 0) {
                    await batch.commit();
                    console.log(`[Holiday] Deleted ${count} existing holiday records.`);
                }
            },

            // Populate 2026 Korea Holidays into Firestore
            populate2026Holidays: async function () {
                if (!confirm('ê¸°ì¡´ ê³µíœ´ì¼ ë°ì´í„°ë¥¼ ëª¨ë‘ ì‚­ì œí•˜ê³  2026ë…„ ê³µíœ´ì¼(ëŒ€ì²´ê³µíœ´ì¼ í¬í•¨)ì„ ë‹¤ì‹œ ë“±ë¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

                // Define 2026 Holidays strictly based on User Rule:
                // "If overlap with Sat/Sun or other holiday -> Next first non-holiday"
                // 2026 Holidays:
                // 1.1 (Thu) New Year
                // 2.16-18 (Mon-Wed) Seollal. No overlap.
                // 3.1 (Sun) Samil. Overlap Sun -> Sub: 3.2 (Mon).
                // 5.5 (Tue) Child.
                // 5.24 (Sun) Buddha. Overlap Sun -> Sub: 5.25 (Mon).
                // 6.6 (Sat) Memorial. Overlap Sat -> Sub: 6.8 (Mon) (Skip Sun).
                // 8.15 (Sat) Gwangbok. Overlap Sat -> Sub: 8.17 (Mon) (Skip Sun).
                // 9.24 (Thu) - 9.26 (Sat) Chuseok. 9.26 overlaps Sat. -> Sub: 9.28 (Mon) (Skip 9.27 Sun).
                // 10.3 (Sat) Gaecheon. Overlap Sat -> Sub: 10.5 (Mon) (Skip Sun).
                // 10.9 (Fri) Hangeul.
                // 12.25 (Fri) Xmas.

                const holidays = [
                    { title: "ì‹ ì •", start: "2026-01-01", eventType: "holiday" },
                    { title: "ì„¤ë‚  ì—°íœ´", start: "2026-02-16", eventType: "holiday" },
                    { title: "ì„¤ë‚ ", start: "2026-02-17", eventType: "holiday" },
                    { title: "ì„¤ë‚  ì—°íœ´", start: "2026-02-18", eventType: "holiday" },

                    { title: "ì‚¼ì¼ì ˆ", start: "2026-03-01", eventType: "holiday" },
                    { title: "ì‚¼ì¼ì ˆ ëŒ€ì²´ê³µíœ´ì¼", start: "2026-03-02", eventType: "holiday" }, // Sun -> Mon

                    { title: "ì–´ë¦°ì´ë‚ ", start: "2026-05-05", eventType: "holiday" },

                    { title: "ë¶€ì²˜ë‹˜ì˜¤ì‹ ë‚ ", start: "2026-05-24", eventType: "holiday" },
                    { title: "ë¶€ì²˜ë‹˜ì˜¤ì‹ ë‚  ëŒ€ì²´ê³µíœ´ì¼", start: "2026-05-25", eventType: "holiday" }, // Sun -> Mon

                    { title: "í˜„ì¶©ì¼", start: "2026-06-06", eventType: "holiday" },
                    { title: "í˜„ì¶©ì¼ ëŒ€ì²´ê³µíœ´ì¼", start: "2026-06-08", eventType: "holiday" }, // Sat -> Mon

                    { title: "ê´‘ë³µì ˆ", start: "2026-08-15", eventType: "holiday" },
                    { title: "ê´‘ë³µì ˆ ëŒ€ì²´ê³µíœ´ì¼", start: "2026-08-17", eventType: "holiday" }, // Sat -> Mon

                    { title: "ì¶”ì„ ì—°íœ´", start: "2026-09-24", eventType: "holiday" },
                    { title: "ì¶”ì„", start: "2026-09-25", eventType: "holiday" },
                    { title: "ì¶”ì„ ì—°íœ´", start: "2026-09-26", eventType: "holiday" }, // Sat
                    { title: "ì¶”ì„ ëŒ€ì²´ê³µíœ´ì¼", start: "2026-09-28", eventType: "holiday" }, // Sat -> Mon (Skip Sun 27)

                    { title: "ê°œì²œì ˆ", start: "2026-10-03", eventType: "holiday" },
                    { title: "ê°œì²œì ˆ ëŒ€ì²´ê³µíœ´ì¼", start: "2026-10-05", eventType: "holiday" }, // Sat -> Mon

                    { title: "í•œê¸€ë‚ ", start: "2026-10-09", eventType: "holiday" },
                    { title: "ì„±íƒ„ì ˆ", start: "2026-12-25", eventType: "holiday" }
                ];

                const path = this.getCollectionPath('calendar');
                if (!path) {
                    alert('Firestore ê²½ë¡œ ì˜¤ë¥˜');
                    return;
                }

                try {
                    // 1. Reset existing holidays
                    await this.resetHolidays(path);

                    // 2. Add new holidays
                    let count = 0;
                    const batch = window.db.batch();

                    for (const holiday of holidays) {
                        // Deterministic ID
                        const docId = `holiday_${holiday.start}_${holiday.title.replace(/\s+/g, '')}`;
                        const docRef = window.db.collection(path).doc(docId);

                        const data = {
                            ...holiday,
                            targetType: 'common',
                            targetClass: null,
                            description: 'ëŒ€í•œë¯¼êµ­ ê³µíœ´ì¼',
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        };
                        batch.set(docRef, data);
                        count++;
                    }
                    await batch.commit();
                    alert(`ì´ ${count}ê°œì˜ ê³µíœ´ì¼ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.\n(ê¸°ì¡´ ì¤‘ë³µ ë°ì´í„°ëŠ” ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.)`);
                    this.refetchEvents();
                } catch (e) {
                    alert('ê³µíœ´ì¼ ë“±ë¡ ì‹¤íŒ¨: ' + e.message);
                    console.error(e);
                }
            },

            // Dynamically populate class filter from Firestore users
            initClassFilter: async function () {
                try {
                    const snapshot = await window.db.collection('users')
                        .where('type', '==', 'student')
                        .get();
                    const classSet = new Set();
                    snapshot.forEach(doc => {
                        const d = doc.data();
                        if (d.grade && d.class) classSet.add(`${d.grade}-${d.class}`);
                    });
                    const sorted = Array.from(classSet).sort((a, b) => {
                        const [ga, ca] = a.split('-').map(Number);
                        const [gb, cb] = b.split('-').map(Number);
                        return ga - gb || ca - cb;
                    });
                    const sel = document.getElementById('view-filter');
                    const noticeClassSel = document.getElementById('notice-class-select');
                    sorted.forEach(cls => {
                        const opt = document.createElement('option');
                        opt.value = cls;
                        opt.textContent = `${cls}ë°˜`;
                        sel.appendChild(opt);
                    });
                } catch (e) { console.error('Class filter init error:', e); }
            },

            // --- Debug Tool ---
            checkSchedule: async function () {
                const cfg = window.currentConfig;
                if (!cfg) { alert("ì„¤ì • ë¡œë“œ ì‹¤íŒ¨"); return; }
                const path = `years/${cfg.year}/semesters/${cfg.semester}/calendar`;
                alert(`ë°ì´í„° í™•ì¸ ì¤‘: ${path}`);
                try {
                    const snapshot = await window.db.collection(path).get();
                    let count = 0;
                    let msg = "";
                    snapshot.forEach(doc => {
                        count++;
                        const d = doc.data();
                        if (count <= 5) msg += `${d.start}: ${d.title}\n`;
                    });
                    alert(`ì´ ${count}ê°œì˜ ì¼ì •ì´ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤.\n\n${msg}${count > 5 ? '...' : ''}`);
                    console.log("Check Complete", path, count);
                } catch (e) {
                    alert("ë°ì´í„° í™•ì¸ ì‹¤íŒ¨: " + e.message);
                }
            },

            // --- Search Functions ---
            selectedDateEl: null, // Track selected date cell

            initSearch: function () {
                // Initialize search event listeners if needed
                // Currently most logic is in HTML onclick attributes, but we can add global shortcuts here
            },

            openSearch: function () {
                document.getElementById('search-modal').classList.remove('hidden');
                document.getElementById('search-modal').classList.add('flex');
                document.getElementById('search-input').focus();
            },

            closeSearch: function () {
                document.getElementById('search-modal').classList.add('hidden');
                document.getElementById('search-modal').classList.remove('flex');
            },

            executeSearch: async function () {
                const query = document.getElementById('search-input').value.trim();
                const resultsEl = document.getElementById('search-results');
                if (!query) {
                    resultsEl.innerHTML = '<div class="text-center text-gray-400 py-10">ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</div>';
                    return;
                }
                resultsEl.innerHTML = '<div class="text-center text-gray-400 py-10"><i class="fas fa-spinner fa-spin mr-2"></i>ê²€ìƒ‰ ì¤‘...</div>';

                try {
                    const path = this.getCollectionPath('calendar');
                    const snapshot = await window.db.collection(path).get();
                    const results = [];
                    snapshot.forEach(doc => {
                        const d = doc.data();
                        const q = query.toLowerCase();
                        const titleMatch = d.title && d.title.toLowerCase().includes(q);
                        const descMatch = d.description && d.description.toLowerCase().includes(q);
                        if (titleMatch || descMatch) {
                            results.push({ id: doc.id, ...d });
                        }
                    });

                    if (results.length === 0) {
                        resultsEl.innerHTML = `<div class="text-center text-gray-400 py-10">
                            <i class="far fa-folder-open text-2xl mb-2"></i><br>
                            ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.
                        </div>`;
                    } else {
                        resultsEl.innerHTML = results.map(r => `
                            <div onclick="app.closeSearch(); app.showSearchResult('${r.id}', '${r.start}')" 
                                 class="p-3 border-b border-gray-100 hover:bg-blue-50 cursor-pointer transition">
                                <div class="font-bold text-sm text-gray-800">${r.title}</div>
                                <div class="text-xs text-gray-500">${r.start} ${r.end && r.start !== r.end ? '~ ' + r.end : ''}</div>
                                ${r.description ? `<div class="text-xs text-gray-400 mt-1 truncate">${r.description}</div>` : ''}
                            </div>
                        `).join('');
                    }
                } catch (e) {
                    console.error(e);
                    resultsEl.innerHTML = '<div class="text-center text-red-500 py-10">ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
                }
            },

            showSearchResult: function (id, dateStr) {
                // Navigate calendar to date
                if (this.calendar) this.calendar.gotoDate(dateStr);
                // Open modal with data (need to fetch if not in map, but usually map has it if loaded? 
                // Actually search queries ALL events from DB, so might not be in local eventsMap if not in current view range.
                // Best to just open modal with the data we have from search.
                // Wait, executeSearch fetched ALL docs in collection? Yes.
                // But we didn't store them in map.
                // Minimal data is enough to find it on calendar, but user expects to see details.
                // Let's just go to date for now, and maybe highlighting it? 
                // Or try to open modal if we can pass the full object. We have it in results.
                // I will update the onclick in map above to pass params.
                // Update: I can't easily pass full object in string interpolation safely without escaping.
                // I'll stick to gotoDate. User can see it on calendar.
            },

            //Helper function to get year/semester based collection path
            getCollectionPath: function (collectionName) {
                const cfg = window.currentConfig;
                if (!cfg || !cfg.year || !cfg.semester) {
                    console.error('Global config not loaded properly');
                    alert('ì‹œìŠ¤í…œ ì„¤ì •ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ì„¸ìš”.');
                    return null;
                }
                // EXCEPTION: calendar uses years/{year}/calendar (no semester) -> REMOVED to match Rules
                // if (collectionName === 'calendar') {
                //    return `years/${cfg.year}/calendar`;
                // }
                // All other collections use semesters path
                return `years/${cfg.year}/semesters/${cfg.semester}/${collectionName}`;
            },

            // --- Notice Board Logic ---
            initNotices: function () {
                this.fetchNotices();
            },

            fetchNotices: function () {
                const container = document.getElementById('notice-list');
                const path = this.getCollectionPath('notices');
                if (!path) return;

                window.db.collection(path).orderBy('createdAt', 'desc').onSnapshot(snapshot => {
                    if (snapshot.empty) {
                        container.innerHTML = '<div class="text-center text-amber-800/50 py-10 font-bold text-sm">ë“±ë¡ëœ ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                        return;
                    }

                    container.innerHTML = snapshot.docs.map(doc => {
                        const d = doc.data();
                        let icon = 'ğŸ“¢';
                        let dateInfo = '';

                        if (d.category === 'exam') icon = 'ğŸ”¥';
                        if (d.category === 'performance') icon = 'âš¡';
                        if (d.category === 'prep') icon = 'ğŸ’';
                        if (d.category === 'dday' && d.targetDate) {
                            icon = 'â³';
                            const today = new Date();
                            today.setHours(0, 0, 0, 0);
                            const target = new Date(d.targetDate);
                            target.setHours(0, 0, 0, 0);
                            const diff = Math.ceil((target - today) / (1000 * 60 * 60 * 24));
                            const dDayStr = diff > 0 ? `D-${diff}` : (diff === 0 ? 'D-Day' : `D+${Math.abs(diff)}`);
                            dateInfo = `<span class="ml-2 text-xs bg-red-500 text-white px-1.5 py-0.5 rounded-full font-bold animate-pulse">${dDayStr}</span>`;
                        }

                        // Parse new lines
                        const content = d.content.replace(/\n/g, '<br>');

                        return `
                            <div onclick="app.openNoticeModal('${doc.id}')" class="bg-white/80 p-3 rounded-lg border border-yellow-200 hover:bg-white transition cursor-pointer shadow-sm relative group">
                                <div class="flex justify-between items-start mb-1">
                                    <div class="flex items-center">
                                        <span class="text-lg mr-2">${icon}</span>
                                        ${dateInfo}
                                    </div>
                                    <span class="text-[10px] text-amber-800/60 font-mono">${new Date(d.createdAt.seconds * 1000).toLocaleDateString()}</span>
                                </div>
                                <div class="text-gray-800 text-sm font-bold leading-relaxed whitespace-pre-wrap">${content}</div>
                                <div class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition">
                                    <i class="fas fa-edit text-amber-600 hover:text-amber-800"></i>
                                </div>
                            </div>
                        `;
                    }).join('');
                });
            },

            openNoticeModal: function (id = null) {
                document.getElementById('notice-modal').classList.remove('hidden');
                document.getElementById('notice-modal').classList.add('flex');

                if (id) {
                    const path = this.getCollectionPath('notices');
                    if (!path) return;
                    window.db.collection(path).doc(id).get().then(doc => {
                        const d = doc.data();
                        document.getElementById('notice-id').value = id;
                        document.getElementById('notice-category').value = d.category;
                        document.getElementById('notice-content').value = d.content;
                        document.getElementById('notice-target-date').value = d.targetDate || '';
                        if (d.targetType === 'class') {
                            document.getElementById('notice-class-radio').checked = true;
                            if (d.targetClass) {
                                const parts = d.targetClass.split('-');
                                if (parts.length === 2) {
                                    document.getElementById('notice-target-grade').value = parts[0];
                                    document.getElementById('notice-target-class-num').value = parts[1];
                                }
                            }
                        } else {
                            document.getElementById('notice-common-radio').checked = true;
                        }
                        this.toggleNoticeClassSelect();
                        this.toggleDDayInput();
                        document.getElementById('btn-delete-notice').classList.remove('hidden');
                    });
                } else {
                    document.getElementById('notice-id').value = '';
                    document.getElementById('notice-category').value = 'normal';
                    document.getElementById('notice-content').value = '';
                    document.getElementById('notice-target-date').value = '';
                    document.getElementById('notice-common-radio').checked = true;
                    document.getElementById('notice-target-grade').value = '2';
                    document.getElementById('notice-target-class-num').value = '1';
                    this.toggleNoticeClassSelect();
                    this.toggleDDayInput();
                    document.getElementById('btn-delete-notice').classList.add('hidden');
                }
            },

            closeNoticeModal: function () {
                document.getElementById('notice-modal').classList.add('hidden');
                document.getElementById('notice-modal').classList.remove('flex');
            },

            attemptCloseNotice: function (e) {
                // If called from overlay click, e is the click event
                if (e && e.target && e.target.id !== 'notice-modal') return;
                const content = document.getElementById('notice-content').value.trim();
                if (content) {
                    if (!confirm('ì‘ì„± ì¤‘ì¸ ë‚´ìš©ì´ ìˆìŠµë‹ˆë‹¤. ì •ë§ë¡œ ë‹«ìœ¼ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
                }
                this.closeNoticeModal();
            },

            toggleNoticeClassSelect: function () {
                const isClass = document.getElementById('notice-class-radio').checked;
                const sel = document.getElementById('notice-class-select');
                if (isClass) sel.classList.remove('hidden');
                else sel.classList.add('hidden');
            },

            toggleDDayInput: function () {
                const cat = document.getElementById('notice-category').value;
                if (cat === 'dday') document.getElementById('dday-input-group').classList.remove('hidden');
                else document.getElementById('dday-input-group').classList.add('hidden');
            },

            saveNotice: async function () {
                const id = document.getElementById('notice-id').value;
                const content = document.getElementById('notice-content').value;
                if (!content) return alert("ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.");

                const isCommon = document.getElementById('notice-common-radio').checked;
                const data = {
                    category: document.getElementById('notice-category').value,
                    content: content,
                    targetDate: document.getElementById('notice-target-date').value,
                    targetType: isCommon ? 'common' : 'class',
                    targetClass: isCommon ? '' : `${document.getElementById('notice-target-grade').value}-${document.getElementById('notice-target-class-num').value}`,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                const path = this.getCollectionPath('notices');
                if (!path) return;

                try {
                    if (id) await window.db.collection(path).doc(id).update(data);
                    else {
                        data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                        await window.db.collection(path).add(data);
                    }
                    this.closeNoticeModal();
                } catch (e) { alert("ì €ì¥ ì‹¤íŒ¨: " + e.message); }
            },

            deleteNotice: async function () {
                const id = document.getElementById('notice-id').value;
                if (!confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
                const path = this.getCollectionPath('notices');
                if (!path) return;
                try {
                    await window.db.collection(path).doc(id).delete();
                    this.closeNoticeModal();
                } catch (e) { alert("ì‚­ì œ ì‹¤íŒ¨: " + e.message); }
            },

            // --- Detail Panel Logic ---
            showEventsOnPanel: function (dateStr, events) {
                const container = document.getElementById('detail-panel-content');
                const dateDisplay = document.getElementById('detail-date-display');

                // Format Date
                const dateObj = new Date(dateStr);
                const days = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
                dateDisplay.innerHTML = `<span class="inline-flex items-center bg-blue-50 border-2 border-blue-300 rounded-lg px-3 py-1"><span class="text-lg font-extrabold text-blue-800">${dateObj.getMonth() + 1}ì›” ${dateObj.getDate()}ì¼</span><span class="ml-1 text-sm font-bold text-blue-500">(${days[dateObj.getDay()]})</span></span>`;

                if (events.length === 0) {
                    container.innerHTML = `
                        <div class="flex flex-col items-center justify-center h-40 text-gray-400">
                            <i class="far fa-calendar-times text-3xl mb-2"></i>
                            <p class="text-sm">ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                            <button onclick="app.openModal(null, '${dateStr}')" class="mt-3 text-blue-600 hover:text-blue-800 font-bold text-xs underline">
                                ì´ ë‚ ì§œì— ì¼ì • ì¶”ê°€í•˜ê¸°
                            </button>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = events.map(ev => {
                    // Render holiday events with special styling
                    if (ev.classNames && ev.classNames.includes('holiday-text-event')) {
                        return `
                            <div class="group p-3 border-l-4 border-red-400 bg-red-50 mb-3 rounded-r-lg">
                                <div class="flex items-center gap-2">
                                    <span class="text-[10px] text-white px-1.5 py-0.5 rounded font-bold bg-red-500">ê³µíœ´ì¼</span>
                                    <h4 class="font-bold text-red-700 text-sm">${ev.title}</h4>
                                </div>
                            </div>
                        `;
                    }
                    // Use eventsMap to get full extendedProps if ev is a FullCalendar event object
                    const p = ev.extendedProps || this.eventsMap[ev.id];
                    if (!p) return '';

                    return `
                        <div onclick="app.openModal({id: '${ev.id}', extendedProps: { ...app.eventsMap['${ev.id}'] }})" 
                             class="group p-3 border-l-4 border-gray-200 hover:border-blue-500 bg-gray-50 hover:bg-white transition mb-3 rounded-r-lg cursor-pointer">
                            <div class="flex justify-between items-start">
                                <div>
                                    <div class="flex items-center gap-2 mb-1">
                                        <span class="text-[10px] text-white px-1.5 py-0.5 rounded font-bold" style="background-color: ${p.backgroundColor || this.colorMap[p.eventType] || '#999'}">${this.typeLabelMap[p.eventType] || 'ì¼ì •'}</span>
                                        <h4 class="font-bold text-gray-800 text-sm">${p.title}</h4>
                                    </div>
                                    <p class="text-xs text-gray-500">${p.start} ${p.end && p.start !== p.end ? '~ ' + p.end : ''}</p>
                                </div>
                                <i class="fas fa-chevron-right text-gray-300 group-hover:text-blue-500 text-xs mt-2"></i>
                            </div>
                            ${p.description ? `<p class="text-xs text-gray-600 mt-2 bg-gray-100 p-2 rounded">${p.description}</p>` : ''}
                        </div>
                    `;
                }).join('');

                // Add event button at bottom
                container.innerHTML += `
                    <div class="text-center mt-3">
                        <button onclick="app.openModal(null, '${dateStr}')" class="text-blue-600 hover:text-blue-800 font-bold text-xs underline">
                            <i class="fas fa-plus mr-1"></i>ì´ ë‚ ì§œì— ì¼ì • ì¶”ê°€í•˜ê¸°
                        </button>
                    </div>
                `;
            },

            // Need a way to look up full event props for editing
            eventsMap: {},

            initCalendar: function () {
                const calendarEl = document.getElementById('calendar');

                this.calendar = new FullCalendar.Calendar(calendarEl, {
                    initialView: 'dayGridMonth',
                    locale: 'ko',
                    headerToolbar: {
                        left: 'prev,next today',
                        center: 'title',
                        right: 'dayGridMonth,listMonth'
                    },
                    dayCellClassNames: (arg) => {
                        // Fix for "+1 day" error: Use local date string instead of UTC
                        // arg.date is a Date object. By default .toISOString() converts to UTC.
                        // We need the YYYY-MM-DD that matches the cell's visual date (Local).
                        const offset = arg.date.getTimezoneOffset() * 60000;
                        const localDate = new Date(arg.date.getTime() - offset);
                        const dateStr = localDate.toISOString().split('T')[0];

                        const evts = this.calendar ? this.calendar.getEvents() : [];
                        // Check if any holiday starts on this date
                        const isHoliday = evts.some(e => e.startStr === dateStr && e.extendedProps && e.extendedProps.eventType === 'holiday');
                        return isHoliday ? ['fc-day-holiday'] : [];
                    },
                    events: this.fetchEvents.bind(this),
                    dateClick: (info) => {
                        // Double Click Logic
                        const now = new Date().getTime();
                        if (this.lastDateClick && (now - this.lastDateClick < 300) && (this.lastDateClickStr === info.dateStr)) {
                            // Double Click Detected -> Open Add Modal
                            this.openModal(null, info.dateStr);
                            this.lastDateClick = 0;
                            return;
                        }
                        this.lastDateClick = now;
                        this.lastDateClickStr = info.dateStr;

                        // Single Click Logic (Show Details)
                        const allEvents = this.calendar.getEvents();
                        const dailyEvents = allEvents.filter(e => {
                            const start = new Date(e.startStr);
                            const end = e.end ? new Date(e.endStr) : new Date(start);
                            const target = new Date(info.dateStr);
                            if (!e.end) return e.startStr === info.dateStr;
                            return target >= start && target < end;
                        });

                        // Visual Feedback for Selection
                        if (this.selectedDateEl) this.selectedDateEl.classList.remove('fc-day-selected');
                        this.selectedDateEl = info.dayEl;
                        this.selectedDateEl.classList.add('fc-day-selected');

                        this.showEventsOnPanel(info.dateStr, dailyEvents);
                    },

                    eventClick: (info) => {
                        if (info.event.classNames.includes('holiday-text-event')) return;
                        // app.openModal(info.event); // Old behavior
                        // New behavior: Show details in panel
                        const startStr = info.event.startStr.split('T')[0];
                        this.showEventsOnPanel(startStr, [info.event]);
                    },
                    height: '100%',
                    contentHeight: '100%',
                    expandRows: true, // Auto expand rows to fill height
                    displayEventTime: false,
                    fixedWeekCount: false,
                    showNonCurrentDates: false,
                    windowResize: function (view) {
                        // Optional responsive handling
                    }
                });
                this.calendar.render();
            },

            fetchEvents: async function (info, successCallback, failureCallback) {
                console.log("[Calendar] fetchEvents CALLED!", info); // CRITICAL LOG
                const path = this.getCollectionPath('calendar');
                if (!path) {
                    failureCallback(new Error('Collection path not available'));
                    return;
                }

                try {
                    // Extract YYYY-MM-DD for simpler lex comparison
                    const startYMD = info.startStr.split('T')[0];
                    const endYMD = info.endStr.split('T')[0];
                    console.log(`[Calendar] 1. Fetch Request Range: ${startYMD} ~ ${endYMD}`);
                    console.log(`[Calendar] 2. Collection Path: ${path}`);

                    // Use Range Query to avoid fetching all 100+ events every time
                    const snapshot = await window.db.collection(path)
                        .where('start', '>=', startYMD)
                        .where('start', '<', endYMD) // endStr is exclusive
                        .get();

                    // const snapshot = await window.db.collection(path).get(); // Revert to all for debug if needed

                    console.log(`[Calendar] 3. Snapshot Size: ${snapshot.size}`);

                    if (snapshot.size > 0) {
                        snapshot.docs.forEach(d => console.log(' -> Found Event:', d.data()));
                    } else {
                        console.log(' -> No events found in this range.');
                    }

                    const events = [];
                    const filter = document.getElementById('view-filter').value;

                    this.eventsMap = {}; // Reset cache

                    snapshot.forEach(doc => {
                        const d = doc.data();
                        // Filter Logic
                        if (filter !== 'all') {
                            // If filter is specific class (e.g. '1-1'), show 'common' AND '1-1'
                            // Hide if targetType is 'class' AND targetClass != filter
                            if (d.targetType === 'class' && d.targetClass !== filter) return;
                        }

                        // Map for quick access
                        this.eventsMap[doc.id] = { id: doc.id, ...d };

                        // Holiday events get special styling
                        const isHoliday = d.eventType === 'holiday';
                        events.push({
                            id: doc.id,
                            title: d.title,
                            start: d.start,
                            end: d.end || d.start,
                            backgroundColor: isHoliday ? 'transparent' : (this.colorMap[d.eventType] || '#6b7280'),
                            borderColor: isHoliday ? 'transparent' : (this.colorMap[d.eventType] || '#6b7280'),
                            textColor: isHoliday ? '#ef4444' : undefined,
                            classNames: isHoliday ? ['holiday-text-event'] : [],
                            extendedProps: d
                        });
                    });
                    successCallback(events);
                } catch (e) { console.error(e); failureCallback(e); }
            },

            refetchEvents: function () { if (this.calendar) this.calendar.refetchEvents(); },

            initialFormState: null,

            openModal: function (eventObj = null, dateStr = null) {
                // If eventObj is passed from FullCalendar eventClick, it has extendedProps inside.
                // If passed from our manual map, it is just the object.
                // Standardize:
                let data = eventObj;
                if (eventObj && eventObj.extendedProps) data = { id: eventObj.id, ...eventObj.extendedProps };

                document.getElementById('event-modal').classList.remove('hidden');
                document.getElementById('event-modal').classList.add('flex');

                // Reset/Fill and Capture State
                if (data) {
                    document.getElementById('modal-title').innerText = "ì¼ì • ìˆ˜ì •";
                    document.getElementById('event-id').value = data.id;
                    document.getElementById('event-title').value = data.title;
                    document.getElementById('event-start').value = data.start;
                    document.getElementById('event-end').value = data.end || '';
                    document.getElementById('event-type').value = data.eventType;
                    document.getElementById('event-desc').value = data.description || '';
                    if (data.targetType === 'class') {
                        document.querySelector('input[name="targetType"][value="class"]').checked = true;
                        this.toggleTargetClass(true);
                        // Parse "2-1" -> grade=2, class=1
                        if (data.targetClass) {
                            const parts = data.targetClass.split('-');
                            if (parts.length === 2) {
                                document.getElementById('target-grade').value = parts[0];
                                document.getElementById('target-class-num').value = parts[1];
                            }
                        }
                    } else {
                        document.querySelector('input[name="targetType"][value="common"]').checked = true;
                        this.toggleTargetClass(false);
                    }
                    document.getElementById('btn-delete').classList.remove('hidden');
                } else {
                    document.getElementById('modal-title').innerText = "ì¼ì • ë“±ë¡";
                    // Reset fields
                    document.getElementById('event-id').value = '';
                    document.getElementById('event-title').value = '';
                    document.getElementById('event-start').value = dateStr || new Date().toISOString().split('T')[0];
                    document.getElementById('event-end').value = '';
                    document.getElementById('event-type').value = 'performance';
                    document.getElementById('event-desc').value = '';
                    document.querySelector('input[name="targetType"][value="common"]').checked = true;
                    this.toggleTargetClass(false);
                    document.getElementById('target-grade').value = '2'; // Default
                    document.getElementById('target-class-num').value = '1'; // Default
                    document.getElementById('btn-delete').classList.add('hidden');
                }

                this.captureFormState();
            },

            // Capture initial state for dirty checking
            captureFormState: function () {
                this.initialFormState = {
                    title: document.getElementById('event-title').value,
                    start: document.getElementById('event-start').value,
                    end: document.getElementById('event-end').value,
                    type: document.getElementById('event-type').value,
                    desc: document.getElementById('event-desc').value,
                    targetType: document.querySelector('input[name="targetType"]:checked').value,
                    targetGrade: document.getElementById('target-grade').value,
                    targetClassNum: document.getElementById('target-class-num').value
                };
            },

            isDirty: function () {
                if (!this.initialFormState) return false;
                const current = {
                    title: document.getElementById('event-title').value,
                    start: document.getElementById('event-start').value,
                    end: document.getElementById('event-end').value,
                    type: document.getElementById('event-type').value,
                    desc: document.getElementById('event-desc').value,
                    targetType: document.querySelector('input[name="targetType"]:checked').value,
                    targetGrade: document.getElementById('target-grade').value,
                    targetClassNum: document.getElementById('target-class-num').value
                };
                return JSON.stringify(this.initialFormState) !== JSON.stringify(current);
            },

            attemptClose: function () {
                if (this.isDirty()) {
                    if (!confirm("ì‘ì„± ì¤‘ì¸ ë‚´ìš©ì´ ìˆìŠµë‹ˆë‹¤. ì •ë§ ë‹«ìœ¼ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
                }
                this.closeModal();
            },

            closeModal: function () {
                document.getElementById('event-modal').classList.add('hidden');
                document.getElementById('event-modal').classList.remove('flex');
            },

            toggleTargetClass: function (enable) {
                const gradeSel = document.getElementById('target-grade');
                const classSel = document.getElementById('target-class-num');

                gradeSel.disabled = !enable;
                classSel.disabled = !enable;

                if (enable) {
                    gradeSel.classList.remove('bg-gray-50');
                    classSel.classList.remove('bg-gray-50');
                } else {
                    gradeSel.classList.add('bg-gray-50');
                    classSel.classList.add('bg-gray-50');
                }
            },

            saveEvent: async function () {
                const id = document.getElementById('event-id').value;
                const title = document.getElementById('event-title').value;
                const start = document.getElementById('event-start').value;
                if (!title || !start) { alert("ì œëª©ê³¼ ì‹œì‘ ë‚ ì§œëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤."); return; }

                // Check Year Mismatch Warning
                const cfg = window.currentConfig;
                if (cfg && cfg.year) {
                    const startYear = parseInt(start.split('-')[0]);
                    const currentYear = parseInt(cfg.year);
                    // Academic year 2026 roughly covers 2026-03 to 2027-02.
                    // But usually users expect the calendar year to match or be close. 
                    // Let's just warn if strict year mismatch for now, or maybe if it's way off.
                    // Actually, if the user is in 2026 Academic Year, and saves for 2028, that's definitely wrong.
                    if (startYear !== currentYear && startYear !== currentYear + 1) {
                        if (!confirm(`ì£¼ì˜: í˜„ì¬ ${currentYear}í•™ë…„ë„ ì¼ì • ê´€ë¦¬ ì¤‘ì…ë‹ˆë‹¤.\nì„ íƒí•˜ì‹  ë‚ ì§œëŠ” ${startYear}ë…„ì…ë‹ˆë‹¤. \n\në‹¤ë¥¸ í•™ë…„ë„ì— ì €ì¥ë˜ì–´ í˜„ì¬ ë‹¬ë ¥(2026í•™ë…„ë„)ì—ëŠ” ë³´ì´ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.\nê³„ì† ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                            return;
                        }
                    }
                }

                const isCommon = document.querySelector('input[name="targetType"]:checked').value === 'common';
                const targetType = isCommon ? 'common' : 'class';

                // Construct targetClass string (e.g., "2-1")
                let targetClass = null;
                if (!isCommon) {
                    const g = document.getElementById('target-grade').value;
                    const c = document.getElementById('target-class-num').value;
                    targetClass = `${g}-${c}`;
                }

                if (!isCommon && !targetClass) { alert("ë°˜ì„ ì„ íƒí•´ì£¼ì„¸ìš”."); return; }

                const data = {
                    title: title,
                    start: start,
                    end: document.getElementById('event-end').value || null,
                    eventType: document.getElementById('event-type').value,
                    targetType: targetType,
                    targetClass: targetClass,
                    description: document.getElementById('event-desc').value,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                const path = this.getCollectionPath('calendar');
                console.log('Attempting to save event to path:', path, 'Data:', data);

                if (!path) {
                    alert("ì €ì¥ ê²½ë¡œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (í•™ë…„ë„/í•™ê¸° ì„¤ì • í™•ì¸ í•„ìš”)");
                    return;
                }

                try {
                    let docRef;
                    if (id) {
                        await window.db.collection(path).doc(id).update(data);
                        console.log('[Calendar] Update Success:', id);
                    } else {
                        data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                        docRef = await window.db.collection(path).add(data);
                        console.log('[Calendar] Add Success. New ID:', docRef.id);
                    }
                    alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
                    this.initialFormState = null; // Reset dirty state on save
                    this.closeModal();
                    this.refetchEvents();
                } catch (e) {
                    console.error('[Calendar] Save FAILED. Error Object:', e);
                    console.error('[Calendar] Error Code:', e.code);
                    console.error('[Calendar] Error Message:', e.message);
                    alert("ì €ì¥ ì‹¤íŒ¨: " + e.message + " (See Console for details)");
                }
            },

            deleteEvent: async function () {
                const id = document.getElementById('event-id').value;
                if (!id) return;
                if (!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
                const path = this.getCollectionPath('calendar');
                if (!path) return;
                try {
                    await window.db.collection(path).doc(id).delete();
                    console.log('[Calendar] Delete Success:', id);
                    this.initialFormState = null; // Reset dirty state
                    this.closeModal();
                    this.refetchEvents();
                } catch (e) {
                    console.error('[Calendar] Delete Failed:', e);
                    alert("ì‚­ì œ ì‹¤íŒ¨: " + e.message);
                }
            }
        };

        document.addEventListener('auth-ready', () => app.init());
    </script>
</body>

</html>