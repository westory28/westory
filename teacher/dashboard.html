<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>êµì‚¬ ëŒ€ì‹œë³´ë“œ - Westory Admin</title>
    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- FullCalendar -->
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="../assets/js/firebase-config.js"></script>
    <link rel="stylesheet" href="../assets/css/style.css">
    <script src="../assets/js/auth-manager.js"></script>

    <style>
        .fc-toolbar-title {
            font-size: 1.25em !important;
            font-weight: 700;
            color: #1f2937;
        }

        .fc-button {
            background-color: #2563eb !important;
            border-color: #2563eb !important;
            font-weight: 600 !important;
        }

        .fc-button:hover {
            background-color: #1d4ed8 !important;
            border-color: #1d4ed8 !important;
        }

        .fc-button-active {
            background-color: #1e40af !important;
            border-color: #1e40af !important;
        }

        .fc-daygrid-event {
            cursor: pointer;
            border-radius: 4px;
            padding: 2px 4px;
            font-size: 0.85rem;
            font-weight: 600;
            border: none;
        }

        /* Korean Calendar Colors */
        .fc-day-sun a {
            color: #ef4444 !important;
            text-decoration: none;
            font-weight: 700;
        }

        .fc-day-sat a {
            color: #3b82f6 !important;
            text-decoration: none;
            font-weight: 700;
        }

        .fc-day-holiday a {
            color: #ef4444 !important;
            font-weight: 700;
        }

        .holiday-text-event {
            background-color: transparent !important;
            border: none !important;
        }

        .holiday-text-event .fc-event-title {
            color: #ef4444;
            font-size: 0.75rem;
            font-weight: 800;
        }

        /* Modal Overlay */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 100;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* Mobile Optimization for Calendar */
        @media (max-width: 768px) {
            .fc-toolbar {
                flex-direction: column;
                gap: 0.5rem;
            }

            .fc-toolbar-title {
                font-size: 1rem !important;
            }

            .fc-button {
                padding: 0.25rem 0.6rem !important;
                font-size: 0.75rem !important;
            }

            .fc-header-toolbar {
                margin-bottom: 0.5rem !important;
            }

            .fc .fc-toolbar-chunk:first-child {
                display: flex;
                gap: 4px;
            }
        }
    </style>
</head>

<body class="bg-gray-50 flex flex-col h-screen">
    <!-- Header injected by AuthManager -->

    <main class="flex-1 w-full max-w-7xl mx-auto px-4 py-4 md:px-6 md:py-6 h-full flex flex-col overflow-hidden">

        <div class="flex justify-between items-center mb-4 shrink-0">
            <h1 class="text-xl md:text-2xl font-bold text-gray-800 flex items-center">
                <i class="fas fa-calendar-alt text-blue-500 mr-2"></i>í•™ì‚¬ ì¼ì • ê´€ë¦¬
            </h1>
            <span id="dash-year-badge"
                class="bg-blue-600 text-white font-bold px-3 py-1 rounded-full text-xs md:text-sm shadow-md min-w-[100px] text-center">
                <i class="fas fa-spinner fa-spin"></i>
            </span>
        </div>

        <div class="flex flex-wrap items-center gap-2 w-full md:w-auto mb-4 shrink-0 justify-end">
            <!-- Search Button & Filter -->
            <div class="flex items-center gap-2">
                <button onclick="app.openSearch()"
                    class="bg-white border border-gray-200 text-gray-600 hover:text-blue-600 hover:border-blue-300 p-2 rounded-lg shadow-sm transition"
                    title="ì¼ì • ê²€ìƒ‰">
                    <i class="fas fa-search"></i>
                </button>
                <select id="view-filter" onchange="app.refetchEvents()"
                    class="bg-white border border-gray-200 text-gray-700 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2 shadow-sm outline-none">
                    <option value="all">ì „ì²´ ë³´ê¸°</option>
                    <option value="common">ì „ì²´ ê³µí†µ</option>
                    <option value="2-1">2-1ë°˜</option>
                    <option value="2-2">2-2ë°˜</option>
                    <option value="2-3">2-3ë°˜</option>
                    <option value="2-4">2-4ë°˜</option>
                    <option value="2-5">2-5ë°˜</option>
                    <option value="2-6">2-6ë°˜</option>
                    <option value="2-7">2-7ë°˜</option>
                    <option value="2-8">2-8ë°˜</option>
                    <option value="2-9">2-9ë°˜</option>
                    <option value="2-10">2-10ë°˜</option>
                    <option value="2-11">2-11ë°˜</option>
                    <option value="2-12">2-12ë°˜</option>
                </select>
            </div>
            <button onclick="app.openModal()"
                class="bg-blue-600 text-white px-3 py-2 rounded text-sm font-bold hover:bg-blue-700 shadow-sm ml-1 flex-1 md:flex-none whitespace-nowrap">
                <i class="fas fa-plus mr-1"></i> ì¼ì • ì¶”ê°€
            </button>
        </div>

        <div id="calendar" class="bg-white rounded-xl shadow-sm p-4 h-[calc(100vh-180px)]"></div>
    </main>

    <!-- Event Modal (Add/Edit) -->
    <div id="event-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 m-4" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-6">
                <h3 id="modal-title" class="text-xl font-bold text-gray-800"><i
                        class="fas fa-edit text-blue-500 mr-2"></i>ì¼ì • ë“±ë¡</h3>
                <button onclick="app.attemptClose()" class="text-gray-400 hover:text-gray-600 transition">
                    <i class="fas fa-times fa-lg"></i>
                </button>
            </div>

            <input type="hidden" id="event-id">

            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">ì¼ì • ì œëª©</label>
                    <input type="text" id="event-title"
                        class="w-full border border-gray-300 rounded-lg p-2.5 focus:ring-2 focus:ring-blue-500 outline-none"
                        placeholder="ì˜ˆ: ì—­ì‚¬ ìˆ˜í–‰í‰ê°€">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">ì‹œì‘ ë‚ ì§œ</label>
                        <input type="date" id="event-start"
                            class="w-full border border-gray-300 rounded-lg p-2.5 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">ì¢…ë£Œ ë‚ ì§œ (ì„ íƒ)</label>
                        <input type="date" id="event-end"
                            class="w-full border border-gray-300 rounded-lg p-2.5 outline-none" placeholder="ì—°ë„-ì›”-ì¼">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">ì¼ì • ì¢…ë¥˜</label>
                    <select id="event-type"
                        class="w-full border border-gray-300 rounded-lg p-2.5 outline-none font-bold">
                        <option value="exam" class="text-red-600">ğŸ”´ ì •ê¸° ì‹œí—˜ (Red)</option>
                        <option value="performance" class="text-orange-500">âš¡ ìˆ˜í–‰í‰ê°€ (Orange)</option>
                        <option value="diagnosis" class="text-blue-600">ğŸ“ ì§„ë‹¨í‰ê°€ (Blue)</option>
                        <option value="formative" class="text-blue-600">ğŸ“˜ í˜•ì„±í‰ê°€ (Blue)</option>
                        <option value="event" class="text-green-600">ğŸ‰ í–‰ì‚¬ (Green)</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">ëŒ€ìƒ ì„ íƒ</label>
                    <div class="flex items-center space-x-4 mb-2">
                        <label class="flex items-center cursor-pointer">
                            <input type="radio" name="targetType" value="common" checked
                                onchange="app.toggleTargetClass(false)" class="w-4 h-4 text-blue-600">
                            <span class="ml-2 text-sm font-bold text-gray-700">ì „ì²´ ê³µí†µ</span>
                        </label>
                        <label class="flex items-center cursor-pointer">
                            <input type="radio" name="targetType" value="class" onchange="app.toggleTargetClass(true)"
                                class="w-4 h-4 text-blue-600">
                            <span class="ml-2 text-sm font-bold text-gray-700">ë°˜ ì„ íƒ</span>
                        </label>
                    </div>
                    <select id="target-class"
                        class="w-full border border-gray-300 rounded-lg p-2.5 outline-none bg-gray-50 transition"
                        disabled>
                        <!-- Options populated by JS -->
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">ìƒì„¸ ë‚´ìš© (ì„ íƒ)</label>
                    <textarea id="event-desc" rows="3"
                        class="w-full border border-gray-300 rounded-lg p-2.5 outline-none resize-none"
                        placeholder="ì¼ì •ì— ëŒ€í•œ ìƒì„¸ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
                </div>
            </div>

            <div class="flex justify-end gap-2 mt-6 pt-4 border-t border-gray-100">
                <button type="button" id="btn-delete" onclick="app.deleteEvent()"
                    class="hidden px-4 py-2 bg-red-100 text-red-600 rounded-lg font-bold hover:bg-red-200 transition">ì‚­ì œ</button>
                <div class="flex-1"></div>
                <button type="button" onclick="app.attemptClose()"
                    class="px-5 py-2 bg-gray-100 text-gray-600 rounded-lg font-bold hover:bg-gray-200 transition">ì·¨ì†Œ</button>
                <button type="button" onclick="app.saveEvent()"
                    class="px-5 py-2 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 shadow-md transition transform active:scale-95">ì €ì¥</button>
            </div>
        </div>
    </div>

    <!-- Search Modal -->
    <div id="search-modal"
        class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-start justify-center pt-20">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6 m-4" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800"><i class="fas fa-search text-blue-500 mr-2"></i>ì¼ì • ê²€ìƒ‰</h3>
                <button onclick="app.closeSearch()" class="text-gray-400 hover:text-gray-600 transition">
                    <i class="fas fa-times fa-lg"></i>
                </button>
            </div>

            <div class="relative mb-4">
                <input type="text" id="search-input" onkeyup="if(event.key === 'Enter') app.executeSearch()"
                    class="w-full border-2 border-blue-100 rounded-xl p-3 pl-10 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 outline-none transition font-bold text-lg"
                    placeholder="ê²€ìƒ‰ì–´ ì…ë ¥ (ì˜ˆ: ì¤‘ê°„ê³ ì‚¬, ìˆ˜í–‰í‰ê°€)">
                <i class="fas fa-search absolute left-4 top-4 text-gray-400"></i>
                <button onclick="app.executeSearch()"
                    class="absolute right-2 top-2 bg-blue-600 text-white px-4 py-1.5 rounded-lg font-bold hover:bg-blue-700 transition">ê²€ìƒ‰</button>
            </div>

            <div id="search-results" class="h-64 overflow-y-auto custom-scroll space-y-2">
                <div class="text-center text-gray-400 py-10">ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ê³  ì—”í„°ë¥¼ ëˆ„ë¥´ì„¸ìš”.</div>
            </div>
        </div>
    </div>

    <!-- Footer injected by AuthManager -->

    <script>
        window.AuthManager.init('teacher');

        const app = {
            calendar: null,
            colorMap: {
                'exam': '#ef4444',       // Red
                'performance': '#f97316', // Orange
                'event': '#10b981',       // Green
                'diagnosis': '#3b82f6',   // Blue
                'formative': '#3b82f6'    // Blue
            },
            // Korean Public Holidays (2025-2026) Verified
            holidays: {
                // 2025
                '2025-01-01': 'ì‹ ì •',
                '2025-01-28': 'ì„¤ë‚ ', '2025-01-29': 'ì„¤ë‚ ', '2025-01-30': 'ì„¤ë‚ ',
                '2025-03-01': 'ì‚¼ì¼ì ˆ', '2025-03-03': 'ëŒ€ì²´ê³µíœ´ì¼',
                '2025-05-05': 'ì–´ë¦°ì´ë‚ /ì„ê°€íƒ„ì‹ ì¼', '2025-05-06': 'ëŒ€ì²´ê³µíœ´ì¼',
                '2025-06-06': 'í˜„ì¶©ì¼',
                '2025-08-15': 'ê´‘ë³µì ˆ',
                '2025-10-03': 'ê°œì²œì ˆ',
                '2025-10-05': 'ì¶”ì„', '2025-10-06': 'ì¶”ì„', '2025-10-07': 'ì¶”ì„', '2025-10-08': 'ëŒ€ì²´ê³µíœ´ì¼',
                '2025-10-09': 'í•œê¸€ë‚ ',
                '2025-12-25': 'ì„±íƒ„ì ˆ',

                // 2026
                '2026-01-01': 'ì‹ ì •',
                '2026-02-16': 'ì„¤ë‚ ', '2026-02-17': 'ì„¤ë‚ ', '2026-02-18': 'ì„¤ë‚ ',
                '2026-03-01': 'ì‚¼ì¼ì ˆ', '2026-03-02': 'ëŒ€ì²´ê³µíœ´ì¼',
                '2026-05-05': 'ì–´ë¦°ì´ë‚ ',
                '2026-05-24': 'ì„ê°€íƒ„ì‹ ì¼', '2026-05-25': 'ëŒ€ì²´ê³µíœ´ì¼',
                '2026-06-06': 'í˜„ì¶©ì¼',
                '2026-08-15': 'ê´‘ë³µì ˆ', '2026-08-17': 'ëŒ€ì²´ê³µíœ´ì¼',
                '2026-09-24': 'ì¶”ì„', '2026-09-25': 'ì¶”ì„', '2026-09-26': 'ì¶”ì„',
                '2026-10-03': 'ê°œì²œì ˆ', '2026-10-05': 'ëŒ€ì²´ê³µíœ´ì¼',
                '2026-10-09': 'í•œê¸€ë‚ ',
                '2026-12-25': 'ì„±íƒ„ì ˆ'
            },

            init: function () {
                const cfg = window.currentConfig;
                if (cfg) document.getElementById('dash-year-badge').innerText = `${cfg.year}í•™ë…„ë„ ${cfg.semester}í•™ê¸°`;
                this.initCalendar();
                this.initModal();
                this.initSearch();
            },

            initModal: function () {
                // Populate class dropdown
                const sel = document.getElementById('target-class');
                sel.innerHTML = Array.from({ length: 12 }, (_, i) => `<option value="2-${i + 1}">2-${i + 1}ë°˜</option>`).join('');

                // Overlay click
                document.getElementById('event-modal').addEventListener('click', (e) => {
                    if (e.target.id === 'event-modal') this.attemptClose();
                });
            },

            initSearch: function () {
                // Overlay click for search modal
                document.getElementById('search-modal').addEventListener('click', (e) => {
                    if (e.target.id === 'search-modal') this.closeSearch();
                });
            },

            openSearch: function () {
                const modal = document.getElementById('search-modal');
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                document.getElementById('search-input').value = '';
                document.getElementById('search-results').innerHTML = '<div class="text-center text-gray-400 py-10">ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ê³  ì—”í„°ë¥¼ ëˆ„ë¥´ì„¸ìš”.</div>';
                setTimeout(() => document.getElementById('search-input').focus(), 100);
            },

            closeSearch: function () {
                const modal = document.getElementById('search-modal');
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            },

            executeSearch: async function () {
                const keyword = document.getElementById('search-input').value.trim();
                if (!keyword) return;

                const resultsContainer = document.getElementById('search-results');
                resultsContainer.innerHTML = '<div class="text-center py-10"><i class="fas fa-spinner fa-spin text-blue-500 text-2xl"></i></div>';

                try {
                    // Fetch all events for the current year (Simple approach: fetch all and filter in memory, or range query)
                    // Assuming academic year is from March to next Feb. 
                    // To be safe and simple, let's fetch a wide range or relies on Firestore composite index if we want to filter by text (which Firestore doesn't support well).
                    // We will fetch based on date range of the current academic year.
                    const year = window.currentConfig?.year || new Date().getFullYear();
                    const startStr = `${year}-01-01`;
                    const endStr = `${parseInt(year) + 1}-12-31`; // Generous range

                    const snapshot = await window.db.collection('calendar_events')
                        .where('start', '>=', startStr)
                        .where('start', '<=', endStr)
                        .orderBy('start')
                        .get();

                    const matches = [];
                    snapshot.forEach(doc => {
                        const d = doc.data();
                        if (d.title.includes(keyword) || (d.description && d.description.includes(keyword))) {
                            matches.push({ id: doc.id, ...d });
                        }
                    });

                    if (matches.length === 0) {
                        resultsContainer.innerHTML = '<div class="text-center text-gray-500 py-10">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                        return;
                    }

                    resultsContainer.innerHTML = matches.map(ev => `
                        <div onclick="app.openSearchResult('${ev.id}')" class="p-3 border border-gray-100 rounded-lg hover:bg-blue-50 cursor-pointer transition flex items-center justify-between group">
                            <div>
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="text-xs font-bold text-white px-2 py-0.5 rounded" style="background-color: ${this.colorMap[ev.eventType]}">${ev.eventType}</span>
                                    <span class="font-bold text-gray-800">${ev.title}</span>
                                </div>
                                <div class="text-xs text-gray-500">
                                    <i class="far fa-calendar mr-1"></i>${ev.start} ${ev.end ? '~ ' + ev.end : ''}
                                    ${ev.targetType === 'class' ? `<span class="ml-2 bg-gray-100 px-1 rounded">${ev.targetClass}ë°˜</span>` : '<span class="ml-2 bg-gray-100 px-1 rounded">ì „ì²´</span>'}
                                </div>
                            </div>
                            <i class="fas fa-chevron-right text-gray-300 group-hover:text-blue-500"></i>
                        </div>
                    `).join('');

                } catch (e) {
                    console.error(e);
                    resultsContainer.innerHTML = '<div class="text-center text-red-500 py-10">ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
                }
            },

            openSearchResult: function (eventId) {
                // Find event in current calendar if possible, or fetch it. 
                // Since we have the ID, let's just fetch it to be sure or use the data we have.
                // Re-using openModal requires an event object structure similar to FullCalendar's info.event
                // But openModal mainly needs extendedProps. Let's fetch the doc to be robust.
                this.closeSearch();
                window.db.collection('calendar_events').doc(eventId).get().then(doc => {
                    if (doc.exists) {
                        const data = doc.data();
                        this.openModal({
                            id: doc.id,
                            extendedProps: data
                        });
                        // Optional: Move calendar to that date
                        this.calendar.gotoDate(data.start);
                    }
                });
            },

            initCalendar: function () {
                const calendarEl = document.getElementById('calendar');
                const holidayTextEvents = Object.keys(this.holidays).map(date => ({
                    title: this.holidays[date], start: date, allDay: true,
                    textColor: '#ef4444', backgroundColor: 'transparent', borderColor: 'transparent',
                    classNames: ['holiday-text-event']
                }));

                this.calendar = new FullCalendar.Calendar(calendarEl, {
                    initialView: 'dayGridMonth',
                    locale: 'ko',
                    headerToolbar: {
                        left: 'prev,next today',
                        center: 'title',
                        right: 'dayGridMonth,listMonth'
                    },
                    dayCellClassNames: (arg) => {
                        const year = arg.date.getFullYear();
                        const month = String(arg.date.getMonth() + 1).padStart(2, '0');
                        const day = String(arg.date.getDate()).padStart(2, '0');
                        if (this.holidays[`${year}-${month}-${day}`]) return ['fc-day-holiday'];
                        return [];
                    },
                    events: [...holidayTextEvents, this.fetchEvents.bind(this)],
                    dateClick: (info) => this.openModal(null, info.dateStr),
                    eventClick: (info) => {
                        if (info.event.classNames.includes('holiday-text-event')) return;
                        this.openModal(info.event);
                    },
                    height: '100%',
                    contentHeight: '100%',
                    expandRows: true, // Auto expand rows to fill height
                    displayEventTime: false,
                    fixedWeekCount: false,
                    showNonCurrentDates: false,
                    windowResize: function (view) {
                        // Optional responsive handling
                    }
                });
                this.calendar.render();
            },

            fetchEvents: async function (info, successCallback, failureCallback) {
                try {
                    const snapshot = await window.db.collection('calendar_events')
                        .where('start', '>=', info.startStr)
                        .where('start', '<', info.endStr)
                        .get();

                    const events = [];
                    const filter = document.getElementById('view-filter').value;

                    snapshot.forEach(doc => {
                        const d = doc.data();
                        if (filter !== 'all') {
                            if (filter === 'common') { if (d.targetType !== 'common') return; }
                            else { if (d.targetType === 'class' && d.targetClass !== filter) return; }
                        }
                        events.push({
                            id: doc.id,
                            title: d.title,
                            start: d.start,
                            end: d.end || d.start,
                            backgroundColor: this.colorMap[d.eventType] || '#6b7280',
                            borderColor: this.colorMap[d.eventType] || '#6b7280',
                            extendedProps: d
                        });
                    });
                    successCallback(events);
                } catch (e) { console.error(e); failureCallback(e); }
            },

            refetchEvents: function () { if (this.calendar) this.calendar.refetchEvents(); },

            initialFormState: null,

            openModal: function (eventObj = null, dateStr = null) {
                document.getElementById('event-modal').classList.remove('hidden');
                document.getElementById('event-modal').classList.add('flex');

                // Reset/Fill and Capture State
                if (eventObj) {
                    const p = eventObj.extendedProps;
                    document.getElementById('modal-title').innerText = "ì¼ì • ìˆ˜ì •";
                    document.getElementById('event-id').value = eventObj.id;
                    document.getElementById('event-title').value = p.title;
                    document.getElementById('event-start').value = p.start;
                    document.getElementById('event-end').value = p.end || '';
                    document.getElementById('event-type').value = p.eventType;
                    document.getElementById('event-desc').value = p.description || '';
                    if (p.targetType === 'class') {
                        document.querySelector('input[name="targetType"][value="class"]').checked = true;
                        this.toggleTargetClass(true);
                        document.getElementById('target-class').value = p.targetClass;
                    } else {
                        document.querySelector('input[name="targetType"][value="common"]').checked = true;
                        this.toggleTargetClass(false);
                    }
                    document.getElementById('btn-delete').classList.remove('hidden');
                } else {
                    document.getElementById('modal-title').innerText = "ì¼ì • ë“±ë¡";
                    // Reset fields
                    document.getElementById('event-id').value = '';
                    document.getElementById('event-title').value = '';
                    document.getElementById('event-start').value = dateStr || new Date().toISOString().split('T')[0];
                    document.getElementById('event-end').value = '';
                    document.getElementById('event-type').value = 'performance';
                    document.getElementById('event-desc').value = '';
                    document.querySelector('input[name="targetType"][value="common"]').checked = true;
                    this.toggleTargetClass(false);
                    document.getElementById('target-class').value = '2-1'; // Default
                    document.getElementById('btn-delete').classList.add('hidden');
                }

                this.captureFormState();
            },

            captureFormState: function () {
                this.initialFormState = {
                    title: document.getElementById('event-title').value,
                    start: document.getElementById('event-start').value,
                    end: document.getElementById('event-end').value,
                    type: document.getElementById('event-type').value,
                    desc: document.getElementById('event-desc').value,
                    targetType: document.querySelector('input[name="targetType"]:checked').value,
                    targetClass: document.getElementById('target-class').value
                };
            },

            isDirty: function () {
                if (!this.initialFormState) return false;
                const current = {
                    title: document.getElementById('event-title').value,
                    start: document.getElementById('event-start').value,
                    end: document.getElementById('event-end').value,
                    type: document.getElementById('event-type').value,
                    desc: document.getElementById('event-desc').value,
                    targetType: document.querySelector('input[name="targetType"]:checked').value,
                    targetClass: document.getElementById('target-class').value
                };
                return JSON.stringify(this.initialFormState) !== JSON.stringify(current);
            },

            attemptClose: function () {
                if (this.isDirty()) {
                    if (!confirm("ì‘ì„± ì¤‘ì¸ ë‚´ìš©ì´ ìˆìŠµë‹ˆë‹¤. ì •ë§ ë‹«ìœ¼ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
                }
                this.closeModal();
            },

            closeModal: function () {
                document.getElementById('event-modal').classList.add('hidden');
                document.getElementById('event-modal').classList.remove('flex');
            },

            toggleTargetClass: function (enable) {
                const sel = document.getElementById('target-class');
                sel.disabled = !enable;
                if (enable) sel.classList.remove('bg-gray-50'); else sel.classList.add('bg-gray-50');
            },

            saveEvent: async function () {
                const id = document.getElementById('event-id').value;
                const title = document.getElementById('event-title').value;
                const start = document.getElementById('event-start').value;
                if (!title || !start) { alert("ì œëª©ê³¼ ì‹œì‘ ë‚ ì§œëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤."); return; }

                const data = {
                    title: title,
                    start: start,
                    end: document.getElementById('event-end').value || null,
                    eventType: document.getElementById('event-type').value,
                    targetType: document.querySelector('input[name="targetType"]:checked').value,
                    targetClass: document.querySelector('input[name="targetType"]:checked').value === 'class' ? document.getElementById('target-class').value : null,
                    description: document.getElementById('event-desc').value,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                try {
                    if (id) await window.db.collection('calendar_events').doc(id).update(data);
                    else {
                        data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                        await window.db.collection('calendar_events').add(data);
                    }
                    this.initialFormState = null; // Reset dirty state on save
                    this.closeModal();
                    this.refetchEvents();
                } catch (e) { alert("ì €ì¥ ì‹¤íŒ¨: " + e.message); }
            },

            deleteEvent: async function () {
                const id = document.getElementById('event-id').value;
                if (!id) return;
                if (!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
                try {
                    await window.db.collection('calendar_events').doc(id).delete();
                    this.initialFormState = null; // Reset dirty state
                    this.closeModal();
                    this.refetchEvents();
                } catch (e) { alert("ì‚­ì œ ì‹¤íŒ¨: " + e.message); }
            }
        };

        document.addEventListener('auth-ready', () => app.init());
    </script>
</body>

</html>