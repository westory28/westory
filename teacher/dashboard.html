<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>êµì‚¬ ëŒ€ì‹œë³´ë“œ - Westory Admin</title>
    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- FullCalendar -->
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="../assets/js/firebase-config.js"></script>
    <link rel="stylesheet" href="../assets/css/style.css">
    <script src="../assets/js/auth-manager.js"></script>

    <style>
        .fc-toolbar-title {
            font-size: 1.25em !important;
            font-weight: 700;
            color: #1f2937;
        }

        .fc-button {
            background-color: #2563eb !important;
            border-color: #2563eb !important;
            font-weight: 600 !important;
        }

        .fc-button:hover {
            background-color: #1d4ed8 !important;
            border-color: #1d4ed8 !important;
        }

        .fc-button-active {
            background-color: #1e40af !important;
            border-color: #1e40af !important;
        }

        .fc-daygrid-event {
            cursor: pointer;
            border-radius: 4px;
            padding: 2px 4px;
            font-size: 0.85rem;
            font-weight: 600;
            border: none;
        }

        /* Korean Calendar Colors */
        .fc-day-sun a {
            color: #ef4444 !important;
            text-decoration: none;
            font-weight: 700;
        }

        .fc-day-sat a {
            color: #3b82f6 !important;
            text-decoration: none;
            font-weight: 700;
        }

        .fc-day-holiday a {
            color: #ef4444 !important;
            font-weight: 700;
        }

        .holiday-text-event {
            background-color: transparent !important;
            border: none !important;
        }

        .holiday-text-event .fc-event-title {
            color: #ef4444;
            font-size: 0.75rem;
            font-weight: 800;
        }

        /* Modal Overlay */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 100;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* Mobile Optimization for Calendar */
        @media (max-width: 768px) {
            .fc-toolbar {
                flex-direction: column;
                gap: 0.5rem;
            }

            .fc-toolbar-title {
                font-size: 1rem !important;
            }

            .fc-button {
                padding: 0.25rem 0.6rem !important;
                font-size: 0.75rem !important;
            }

            .fc-header-toolbar {
                margin-bottom: 0.5rem !important;
            }

            .fc .fc-toolbar-chunk:first-child {
                display: flex;
                gap: 4px;
            }
        }
    </style>
</head>

<body class="bg-gray-50 flex flex-col h-screen">
    <!-- Header injected by AuthManager -->

    <main class="flex-1 w-full max-w-7xl mx-auto px-4 py-4 md:px-6 md:py-6 h-full flex flex-col overflow-hidden">

        <div class="flex justify-between items-center mb-4 shrink-0">
            <h1 class="text-xl md:text-2xl font-bold text-gray-800 flex items-center">
                <i class="fas fa-calendar-alt text-blue-500 mr-2"></i>ëŒ€ì‹œë³´ë“œ
            </h1>
            <span id="dash-year-badge"
                class="bg-blue-600 text-white font-bold px-3 py-1 rounded-full text-xs md:text-sm shadow-md min-w-[100px] text-center">
                <i class="fas fa-spinner fa-spin"></i>
            </span>
        </div>

        <!-- Search & Filter (Moved to Top Right of Calendar Area or Global Header) -->
        <!-- We will place it inside the calendar container header or keep it above -->
        </div>

        <!-- Main Content Area (Split Layout) -->
        <div class="flex flex-col md:flex-row h-[calc(100vh-140px)] gap-4">

            <!-- Left: Calendar (60%) -->
            <div class="w-full md:w-3/5 bg-white rounded-xl shadow-sm p-4 h-full flex flex-col">
                <div class="flex justify-between items-center mb-2">
                    <h2 class="text-lg font-bold text-gray-800"><i class="far fa-calendar-alt mr-2 text-blue-600"></i>í•™ì‚¬
                        ì¼ì •</h2>
                    <div class="flex items-center gap-2">
                        <button onclick="app.openSearch()"
                            class="bg-gray-50 border border-gray-200 text-gray-600 hover:text-blue-600 p-1.5 rounded-lg transition"
                            title="ê²€ìƒ‰">
                            <i class="fas fa-search"></i>
                        </button>
                        <select id="view-filter" onchange="app.refetchEvents()"
                            class="bg-gray-50 border border-gray-200 text-gray-700 text-sm rounded-lg p-1.5 outline-none">
                            <option value="all">ì „ì²´ ë³´ê¸°</option>
                            <option value="common">ê³µí†µ ì¼ì •</option>
                            <!-- Class options populated dynamically -->
                        </select>
                        <button onclick="app.openModal()"
                            class="bg-blue-600 text-white px-3 py-1.5 rounded-lg text-sm font-bold hover:bg-blue-700 shadow-sm transition">
                            <i class="fas fa-plus mr-1"></i> ì¶”ê°€
                        </button>
                    </div>
                </div>
                <div id="calendar" class="flex-1"></div>
            </div>

            <!-- Right: Functions (40%) -->
            <div class="w-full md:w-2/5 flex flex-col gap-4 h-full">

                <!-- Right Top: Notice Board (50%) -->
                <div
                    class="h-1/2 bg-[#fffbeb] rounded-xl shadow-sm border border-yellow-200 p-4 flex flex-col relative overflow-hidden">
                    <div class="flex justify-between items-center mb-3 border-b border-yellow-200 pb-2">
                        <h3 class="text-lg font-extrabold text-amber-800 flex items-center">
                            <i class="fas fa-thumbtack mr-2 text-amber-600"></i>ì•Œë¦¼ì¥
                        </h3>
                        <button onclick="app.openNoticeModal()"
                            class="text-amber-700 hover:text-amber-900 bg-yellow-200 hover:bg-yellow-300 px-2 py-1 rounded text-xs font-bold transition">
                            <i class="fas fa-plus mr-1"></i>ì“°ê¸°
                        </button>
                    </div>
                    <div id="notice-list" class="flex-1 overflow-y-auto space-y-3 pr-2 custom-scroll">
                        <div class="text-center text-amber-800/50 py-10 font-bold text-sm">ë“±ë¡ëœ ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>
                    </div>
                </div>

                <!-- Right Bottom: Event Details (50%) -->
                <div class="h-1/2 bg-white rounded-xl shadow-sm border border-gray-200 p-4 flex flex-col">
                    <div class="flex justify-between items-center mb-3 border-b border-gray-100 pb-2">
                        <h3 class="text-lg font-bold text-gray-800 flex items-center">
                            <i class="fas fa-info-circle mr-2 text-blue-500"></i>ì¼ì • ìƒì„¸
                        </h3>
                        <span id="detail-date-display" class="text-sm font-bold text-gray-500">ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”</span>
                    </div>
                    <div id="detail-panel-content" class="flex-1 overflow-y-auto pr-2 custom-scroll">
                        <div class="flex flex-col items-center justify-center h-full text-gray-400">
                            <i class="far fa-calendar-check text-4xl mb-3 text-gray-200"></i>
                            <p class="text-sm">ë‹¬ë ¥ì—ì„œ ë‚ ì§œë‚˜ ì¼ì •ì„ í´ë¦­í•˜ë©´<br>ìƒì„¸ ë‚´ìš©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </main>

    <!-- Notice Add/Edit Modal -->
    <div id="notice-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-[#fffbeb] rounded-xl shadow-2xl w-full max-w-sm p-6 m-4 border-t-8 border-amber-400 relative"
            onclick="event.stopPropagation()">
            <button onclick="app.closeNoticeModal()" class="absolute top-4 right-4 text-amber-800 hover:text-amber-600">
                <i class="fas fa-times fa-lg"></i>
            </button>
            <h3 class="text-xl font-extrabold text-amber-900 mb-6"><i class="fas fa-pen-fancy mr-2"></i>ì•Œë¦¼ ì“°ê¸°</h3>

            <input type="hidden" id="notice-id">

            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-amber-800 mb-1">ì¹´í…Œê³ ë¦¬</label>
                    <select id="notice-category"
                        class="w-full bg-white border border-yellow-300 rounded p-2 text-sm font-bold text-gray-700 outline-none focus:ring-2 focus:ring-amber-300"
                        onchange="app.toggleDDayInput()">
                        <option value="normal">ğŸ“¢ ì¼ë°˜ ì•Œë¦¼</option>
                        <option value="exam">ğŸ”¥ ì •ê¸° ì‹œí—˜</option>
                        <option value="performance">âš¡ ìˆ˜í–‰í‰ê°€</option>
                        <option value="prep">ğŸ’ ìˆ˜ì—… ì¤€ë¹„ë¬¼</option>
                        <option value="dday">â³ D-Day ì„¤ì •</option>
                    </select>
                </div>

                <div id="dday-input-group" class="hidden">
                    <label class="block text-xs font-bold text-amber-800 mb-1">ëª©í‘œ ë‚ ì§œ</label>
                    <input type="date" id="notice-target-date"
                        class="w-full bg-white border border-yellow-300 rounded p-2 text-sm outline-none">
                </div>

                <div>
                    <label class="block text-xs font-bold text-amber-800 mb-1">ì•Œë¦¼ ë‚´ìš©</label>
                    <textarea id="notice-content" rows="4"
                        class="w-full bg-white border border-yellow-300 rounded p-3 text-sm resize-none outline-none focus:ring-2 focus:ring-amber-300 placeholder-amber-800/30"
                        placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
                </div>

                <div class="flex items-center gap-2">
                    <input type="checkbox" id="notice-common"
                        class="w-4 h-4 text-amber-600 rounded focus:ring-amber-500 border-gray-300">
                    <label for="notice-common" class="text-sm font-bold text-amber-900 cursor-pointer">í•™ê¸‰ ì „ì²´ ê³µí†µ
                        ì•Œë¦¼</label>
                </div>
            </div>

            <div class="flex justify-end gap-2 mt-6">
                <button onclick="app.deleteNotice()" id="btn-delete-notice"
                    class="hidden px-3 py-2 text-red-600 hover:bg-red-50 rounded font-bold text-sm">ì‚­ì œ</button>
                <button onclick="app.saveNotice()"
                    class="px-5 py-2 bg-amber-500 text-white rounded-lg font-bold hover:bg-amber-600 shadow-md transition transform active:scale-95">ê²Œì‹œí•˜ê¸°</button>
            </div>
        </div>
    </div>

    <!-- Event Modal (Add/Edit) -->
    <div id="event-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 m-4" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-6">
                <h3 id="modal-title" class="text-xl font-bold text-gray-800"><i
                        class="fas fa-edit text-blue-500 mr-2"></i>ì¼ì • ë“±ë¡</h3>
                <button onclick="app.attemptClose()" class="text-gray-400 hover:text-gray-600 transition">
                    <i class="fas fa-times fa-lg"></i>
                </button>
            </div>

            <input type="hidden" id="event-id">

            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">ì¼ì • ì œëª©</label>
                    <input type="text" id="event-title"
                        class="w-full border border-gray-300 rounded-lg p-2.5 focus:ring-2 focus:ring-blue-500 outline-none"
                        placeholder="ì˜ˆ: ì—­ì‚¬ ìˆ˜í–‰í‰ê°€">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">ì‹œì‘ ë‚ ì§œ</label>
                        <input type="date" id="event-start"
                            class="w-full border border-gray-300 rounded-lg p-2.5 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">ì¢…ë£Œ ë‚ ì§œ (ì„ íƒ)</label>
                        <input type="date" id="event-end"
                            class="w-full border border-gray-300 rounded-lg p-2.5 outline-none" placeholder="ì—°ë„-ì›”-ì¼">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">ì¼ì • ì¢…ë¥˜</label>
                    <select id="event-type"
                        class="w-full border border-gray-300 rounded-lg p-2.5 outline-none font-bold">
                        <option value="exam" class="text-red-600">ğŸ”´ ì •ê¸° ì‹œí—˜ (Red)</option>
                        <option value="performance" class="text-orange-500">âš¡ ìˆ˜í–‰í‰ê°€ (Orange)</option>
                        <option value="diagnosis" class="text-blue-600">ğŸ“ ì§„ë‹¨í‰ê°€ (Blue)</option>
                        <option value="formative" class="text-blue-600">ğŸ“˜ í˜•ì„±í‰ê°€ (Blue)</option>
                        <option value="event" class="text-green-600">ğŸ‰ í–‰ì‚¬ (Green)</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">ëŒ€ìƒ ì„ íƒ</label>
                    <div class="flex items-center space-x-4 mb-2">
                        <label class="flex items-center cursor-pointer">
                            <input type="radio" name="targetType" value="common" checked
                                onchange="app.toggleTargetClass(false)" class="w-4 h-4 text-blue-600">
                            <span class="ml-2 text-sm font-bold text-gray-700">ì „ì²´ ê³µí†µ</span>
                        </label>
                        <label class="flex items-center cursor-pointer">
                            <input type="radio" name="targetType" value="class" onchange="app.toggleTargetClass(true)"
                                class="w-4 h-4 text-blue-600">
                            <span class="ml-2 text-sm font-bold text-gray-700">ë°˜ ì„ íƒ</span>
                        </label>
                    </div>
                    <select id="target-class"
                        class="w-full border border-gray-300 rounded-lg p-2.5 outline-none bg-gray-50 transition"
                        disabled>
                        <!-- Options populated by JS -->
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">ìƒì„¸ ë‚´ìš© (ì„ íƒ)</label>
                    <textarea id="event-desc" rows="3"
                        class="w-full border border-gray-300 rounded-lg p-2.5 outline-none resize-none"
                        placeholder="ì¼ì •ì— ëŒ€í•œ ìƒì„¸ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
                </div>
            </div>

            <div class="flex justify-end gap-2 mt-6 pt-4 border-t border-gray-100">
                <button type="button" id="btn-delete" onclick="app.deleteEvent()"
                    class="hidden px-4 py-2 bg-red-100 text-red-600 rounded-lg font-bold hover:bg-red-200 transition">ì‚­ì œ</button>
                <div class="flex-1"></div>
                <button type="button" onclick="app.attemptClose()"
                    class="px-5 py-2 bg-gray-100 text-gray-600 rounded-lg font-bold hover:bg-gray-200 transition">ì·¨ì†Œ</button>
                <button type="button" onclick="app.saveEvent()"
                    class="px-5 py-2 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 shadow-md transition transform active:scale-95">ì €ì¥</button>
            </div>
        </div>
    </div>

    <!-- Search Modal -->
    <div id="search-modal"
        class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-start justify-center pt-20">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6 m-4" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800"><i class="fas fa-search text-blue-500 mr-2"></i>ì¼ì • ê²€ìƒ‰</h3>
                <button onclick="app.closeSearch()" class="text-gray-400 hover:text-gray-600 transition">
                    <i class="fas fa-times fa-lg"></i>
                </button>
            </div>

            <div class="relative mb-4">
                <input type="text" id="search-input" onkeyup="if(event.key === 'Enter') app.executeSearch()"
                    class="w-full border-2 border-blue-100 rounded-xl p-3 pl-10 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 outline-none transition font-bold text-lg"
                    placeholder="ê²€ìƒ‰ì–´ ì…ë ¥ (ì˜ˆ: ì¤‘ê°„ê³ ì‚¬, ìˆ˜í–‰í‰ê°€)">
                <i class="fas fa-search absolute left-4 top-4 text-gray-400"></i>
                <button onclick="app.executeSearch()"
                    class="absolute right-2 top-2 bg-blue-600 text-white px-4 py-1.5 rounded-lg font-bold hover:bg-blue-700 transition">ê²€ìƒ‰</button>
            </div>

            <div id="search-results" class="h-64 overflow-y-auto custom-scroll space-y-2">
                <div class="text-center text-gray-400 py-10">ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ê³  ì—”í„°ë¥¼ ëˆ„ë¥´ì„¸ìš”.</div>
            </div>
        </div>
    </div>

    <!-- Footer injected by AuthManager -->

    <script>
        window.AuthManager.init('teacher');

        const app = {
            calendar: null,
            colorMap: {
                'exam': '#ef4444',       // Red
                'performance': '#f97316', // Orange
                'event': '#10b981',       // Green
                'diagnosis': '#3b82f6',   // Blue
                'formative': '#3b82f6'    // Blue
            },
            typeLabelMap: {
                'exam': 'ì •ê¸° ì‹œí—˜', 'performance': 'ìˆ˜í–‰í‰ê°€', 'event': 'í–‰ì‚¬', 'diagnosis': 'ì§„ë‹¨í‰ê°€', 'formative': 'í˜•ì„±í‰ê°€'
            },
            // Korean Public Holidays (2025-2026) Verified
            holidays: {
                // 2025
                '2025-01-01': 'ì‹ ì •',
                '2025-01-28': 'ì„¤ë‚ ', '2025-01-29': 'ì„¤ë‚ ', '2025-01-30': 'ì„¤ë‚ ',
                '2025-03-01': 'ì‚¼ì¼ì ˆ', '2025-03-03': 'ëŒ€ì²´ê³µíœ´ì¼',
                '2025-05-05': 'ì–´ë¦°ì´ë‚ /ì„ê°€íƒ„ì‹ ì¼', '2025-05-06': 'ëŒ€ì²´ê³µíœ´ì¼',
                '2025-06-06': 'í˜„ì¶©ì¼',
                '2025-08-15': 'ê´‘ë³µì ˆ',
                '2025-10-03': 'ê°œì²œì ˆ',
                '2025-10-05': 'ì¶”ì„', '2025-10-06': 'ì¶”ì„', '2025-10-07': 'ì¶”ì„', '2025-10-08': 'ëŒ€ì²´ê³µíœ´ì¼',
                '2025-10-09': 'í•œê¸€ë‚ ',
                '2025-12-25': 'ì„±íƒ„ì ˆ',

                // 2026
                '2026-01-01': 'ì‹ ì •',
                '2026-02-16': 'ì„¤ë‚ ', '2026-02-17': 'ì„¤ë‚ ', '2026-02-18': 'ì„¤ë‚ ',
                '2026-03-01': 'ì‚¼ì¼ì ˆ', '2026-03-02': 'ëŒ€ì²´ê³µíœ´ì¼',
                '2026-05-05': 'ì–´ë¦°ì´ë‚ ',
                '2026-05-24': 'ì„ê°€íƒ„ì‹ ì¼', '2026-05-25': 'ëŒ€ì²´ê³µíœ´ì¼',
                '2026-06-06': 'í˜„ì¶©ì¼',
                '2026-08-15': 'ê´‘ë³µì ˆ', '2026-08-17': 'ëŒ€ì²´ê³µíœ´ì¼',
                '2026-09-24': 'ì¶”ì„', '2026-09-25': 'ì¶”ì„', '2026-09-26': 'ì¶”ì„',
                '2026-10-03': 'ê°œì²œì ˆ', '2026-10-05': 'ëŒ€ì²´ê³µíœ´ì¼',
                '2026-10-09': 'í•œê¸€ë‚ ',
                '2026-12-25': 'ì„±íƒ„ì ˆ'
            },

            init: function () {
                const cfg = window.currentConfig;
                if (cfg) document.getElementById('dash-year-badge').innerText = `${cfg.year}í•™ë…„ë„ ${cfg.semester}í•™ê¸°`;
                this.initCalendar();
                this.initModal();
                this.initSearch();
                this.initNotices();
                this.initClassFilter();
            },

            // Dynamically populate class filter from Firestore users
            initClassFilter: async function () {
                try {
                    const snapshot = await window.db.collection('users')
                        .where('type', '==', 'student')
                        .get();
                    const classSet = new Set();
                    snapshot.forEach(doc => {
                        const d = doc.data();
                        if (d.grade && d.class) classSet.add(`${d.grade}-${d.class}`);
                    });
                    const sorted = Array.from(classSet).sort((a, b) => {
                        const [ga, ca] = a.split('-').map(Number);
                        const [gb, cb] = b.split('-').map(Number);
                        return ga - gb || ca - cb;
                    });
                    const sel = document.getElementById('view-filter');
                    sorted.forEach(cls => {
                        const opt = document.createElement('option');
                        opt.value = cls;
                        opt.textContent = `${cls}ë°˜`;
                        sel.appendChild(opt);
                    });
                } catch (e) { console.error('Class filter init error:', e); }
            },

            //Helper function to get year/semester based collection path
            getCollectionPath: function (collectionName) {
                const cfg = window.currentConfig;
                if (!cfg || !cfg.year || !cfg.semester) {
                    console.error('Global config not loaded properly');
                    alert('ì‹œìŠ¤í…œ ì„¤ì •ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ì„¸ìš”.');
                    return null;
                }
                return `years/${cfg.year}/semesters/${cfg.semester}/${collectionName}`;
            },

            // --- Notice Board Logic ---
            initNotices: function () {
                this.fetchNotices();
            },

            fetchNotices: function () {
                const container = document.getElementById('notice-list');
                const path = this.getCollectionPath('notices');
                if (!path) return;

                window.db.collection(path).orderBy('createdAt', 'desc').onSnapshot(snapshot => {
                    if (snapshot.empty) {
                        container.innerHTML = '<div class="text-center text-amber-800/50 py-10 font-bold text-sm">ë“±ë¡ëœ ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                        return;
                    }

                    container.innerHTML = snapshot.docs.map(doc => {
                        const d = doc.data();
                        let icon = 'ğŸ“¢';
                        let dateInfo = '';

                        if (d.category === 'exam') icon = 'ğŸ”¥';
                        if (d.category === 'performance') icon = 'âš¡';
                        if (d.category === 'prep') icon = 'ğŸ’';
                        if (d.category === 'dday' && d.targetDate) {
                            icon = 'â³';
                            const today = new Date();
                            today.setHours(0, 0, 0, 0);
                            const target = new Date(d.targetDate);
                            target.setHours(0, 0, 0, 0);
                            const diff = Math.ceil((target - today) / (1000 * 60 * 60 * 24));
                            const dDayStr = diff > 0 ? `D-${diff}` : (diff === 0 ? 'D-Day' : `D+${Math.abs(diff)}`);
                            dateInfo = `<span class="ml-2 text-xs bg-red-500 text-white px-1.5 py-0.5 rounded-full font-bold animate-pulse">${dDayStr}</span>`;
                        }

                        // Parse new lines
                        const content = d.content.replace(/\n/g, '<br>');

                        return `
                            <div onclick="app.openNoticeModal('${doc.id}')" class="bg-white/80 p-3 rounded-lg border border-yellow-200 hover:bg-white transition cursor-pointer shadow-sm relative group">
                                <div class="flex justify-between items-start mb-1">
                                    <div class="flex items-center">
                                        <span class="text-lg mr-2">${icon}</span>
                                        ${dateInfo}
                                    </div>
                                    <span class="text-[10px] text-amber-800/60 font-mono">${new Date(d.createdAt.seconds * 1000).toLocaleDateString()}</span>
                                </div>
                                <div class="text-gray-800 text-sm font-bold leading-relaxed whitespace-pre-wrap">${content}</div>
                                <div class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition">
                                    <i class="fas fa-edit text-amber-600 hover:text-amber-800"></i>
                                </div>
                            </div>
                        `;
                    }).join('');
                });
            },

            openNoticeModal: function (id = null) {
                document.getElementById('notice-modal').classList.remove('hidden');
                document.getElementById('notice-modal').classList.add('flex');

                if (id) {
                    const path = this.getCollectionPath('notices');
                    if (!path) return;
                    window.db.collection(path).doc(id).get().then(doc => {
                        const d = doc.data();
                        document.getElementById('notice-id').value = id;
                        document.getElementById('notice-category').value = d.category;
                        document.getElementById('notice-content').value = d.content;
                        document.getElementById('notice-target-date').value = d.targetDate || '';
                        document.getElementById('notice-common').checked = (d.targetType === 'common');
                        this.toggleDDayInput();
                        document.getElementById('btn-delete-notice').classList.remove('hidden');
                    });
                } else {
                    document.getElementById('notice-id').value = '';
                    document.getElementById('notice-category').value = 'normal';
                    document.getElementById('notice-content').value = '';
                    document.getElementById('notice-target-date').value = '';
                    document.getElementById('notice-common').checked = true;
                    this.toggleDDayInput();
                    document.getElementById('btn-delete-notice').classList.add('hidden');
                }
            },

            closeNoticeModal: function () {
                document.getElementById('notice-modal').classList.add('hidden');
                document.getElementById('notice-modal').classList.remove('flex');
            },

            toggleDDayInput: function () {
                const cat = document.getElementById('notice-category').value;
                if (cat === 'dday') document.getElementById('dday-input-group').classList.remove('hidden');
                else document.getElementById('dday-input-group').classList.add('hidden');
            },

            saveNotice: async function () {
                const id = document.getElementById('notice-id').value;
                const content = document.getElementById('notice-content').value;
                if (!content) return alert("ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.");

                const data = {
                    category: document.getElementById('notice-category').value,
                    content: content,
                    targetDate: document.getElementById('notice-target-date').value,
                    targetType: document.getElementById('notice-common').checked ? 'common' : 'class', // Simple boolean for now
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                const path = this.getCollectionPath('notices');
                if (!path) return;

                try {
                    if (id) await window.db.collection(path).doc(id).update(data);
                    else {
                        data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                        await window.db.collection(path).add(data);
                    }
                    this.closeNoticeModal();
                } catch (e) { alert("ì €ì¥ ì‹¤íŒ¨: " + e.message); }
            },

            deleteNotice: async function () {
                const id = document.getElementById('notice-id').value;
                if (!confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
                const path = this.getCollectionPath('notices');
                if (!path) return;
                try {
                    await window.db.collection(path).doc(id).delete();
                    this.closeNoticeModal();
                } catch (e) { alert("ì‚­ì œ ì‹¤íŒ¨: " + e.message); }
            },

            // --- Detail Panel Logic ---
            showEventsOnPanel: function (dateStr, events) {
                const container = document.getElementById('detail-panel-content');
                const dateDisplay = document.getElementById('detail-date-display');

                // Format Date
                const dateObj = new Date(dateStr);
                const days = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
                dateDisplay.innerHTML = `<span class="inline-flex items-center bg-blue-50 border-2 border-blue-300 rounded-lg px-3 py-1"><span class="text-lg font-extrabold text-blue-800">${dateObj.getMonth() + 1}ì›” ${dateObj.getDate()}ì¼</span><span class="ml-1 text-sm font-bold text-blue-500">(${days[dateObj.getDay()]})</span></span>`;

                if (events.length === 0) {
                    container.innerHTML = `
                        <div class="flex flex-col items-center justify-center h-40 text-gray-400">
                            <i class="far fa-calendar-times text-3xl mb-2"></i>
                            <p class="text-sm">ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                            <button onclick="app.openModal(null, '${dateStr}')" class="mt-3 text-blue-600 hover:text-blue-800 font-bold text-xs underline">
                                ì´ ë‚ ì§œì— ì¼ì • ì¶”ê°€í•˜ê¸°
                            </button>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = events.map(ev => {
                    // Render holiday events with special styling
                    if (ev.classNames && ev.classNames.includes('holiday-text-event')) {
                        return `
                            <div class="group p-3 border-l-4 border-red-400 bg-red-50 mb-3 rounded-r-lg">
                                <div class="flex items-center gap-2">
                                    <span class="text-[10px] text-white px-1.5 py-0.5 rounded font-bold bg-red-500">ê³µíœ´ì¼</span>
                                    <h4 class="font-bold text-red-700 text-sm">${ev.title}</h4>
                                </div>
                            </div>
                        `;
                    }
                    // Use eventsMap to get full extendedProps if ev is a FullCalendar event object
                    const p = ev.extendedProps || this.eventsMap[ev.id];
                    if (!p) return '';

                    return `
                        <div onclick="app.openModal({id: '${ev.id}', extendedProps: { ...app.eventsMap['${ev.id}'] }})" 
                             class="group p-3 border-l-4 border-gray-200 hover:border-blue-500 bg-gray-50 hover:bg-white transition mb-3 rounded-r-lg cursor-pointer">
                            <div class="flex justify-between items-start">
                                <div>
                                    <div class="flex items-center gap-2 mb-1">
                                        <span class="text-[10px] text-white px-1.5 py-0.5 rounded font-bold" style="background-color: ${p.backgroundColor || this.colorMap[p.eventType] || '#999'}">${this.typeLabelMap[p.eventType] || 'ì¼ì •'}</span>
                                        <h4 class="font-bold text-gray-800 text-sm">${p.title}</h4>
                                    </div>
                                    <p class="text-xs text-gray-500">${p.start} ${p.end && p.start !== p.end ? '~ ' + p.end : ''}</p>
                                </div>
                                <i class="fas fa-chevron-right text-gray-300 group-hover:text-blue-500 text-xs mt-2"></i>
                            </div>
                            ${p.description ? `<p class="text-xs text-gray-600 mt-2 bg-gray-100 p-2 rounded">${p.description}</p>` : ''}
                        </div>
                    `;
                }).join('');
            },

            // Need a way to look up full event props for editing
            eventsMap: {},

            initCalendar: function () {
                const calendarEl = document.getElementById('calendar');
                const holidayTextEvents = Object.keys(this.holidays).map(date => ({
                    title: this.holidays[date], start: date, allDay: true,
                    textColor: '#ef4444', backgroundColor: 'transparent', borderColor: 'transparent',
                    classNames: ['holiday-text-event']
                }));

                this.calendar = new FullCalendar.Calendar(calendarEl, {
                    initialView: 'dayGridMonth',
                    locale: 'ko',
                    headerToolbar: {
                        left: 'prev,next today',
                        center: 'title',
                        right: 'dayGridMonth,listMonth'
                    },
                    dayCellClassNames: (arg) => {
                        const year = arg.date.getFullYear();
                        const month = String(arg.date.getMonth() + 1).padStart(2, '0');
                        const day = String(arg.date.getDate()).padStart(2, '0');
                        if (this.holidays[`${year}-${month}-${day}`]) return ['fc-day-holiday'];
                        return [];
                    },
                    events: [...holidayTextEvents, this.fetchEvents.bind(this)],
                    dateClick: (info) => {
                        // Find events for this date from the current view's cache or client side filter
                        // Better: Use getEvents() from calendar and filter
                        const allEvents = this.calendar.getEvents();
                        const dailyEvents = allEvents.filter(e => {
                            // Simple overlap check
                            const start = new Date(e.startStr);
                            const end = e.end ? new Date(e.endStr) : new Date(start);
                            const target = new Date(info.dateStr);
                            // Adjust for inclusive/exclusive handling if needed, but for day grid standard:
                            // If just start date
                            if (!e.end) return e.startStr === info.dateStr;
                            return target >= start && target < end;
                        }); // Include holidays too

                        this.showEventsOnPanel(info.dateStr, dailyEvents);
                    },
                    eventClick: (info) => {
                        if (info.event.classNames.includes('holiday-text-event')) return;
                        // app.openModal(info.event); // Old behavior
                        // New behavior: Show details in panel
                        const startStr = info.event.startStr.split('T')[0];
                        this.showEventsOnPanel(startStr, [info.event]);
                    },
                    height: '100%',
                    contentHeight: '100%',
                    expandRows: true, // Auto expand rows to fill height
                    displayEventTime: false,
                    fixedWeekCount: false,
                    showNonCurrentDates: false,
                    windowResize: function (view) {
                        // Optional responsive handling
                    }
                });
                this.calendar.render();
            },

            fetchEvents: async function (info, successCallback, failureCallback) {
                const path = this.getCollectionPath('calendar_events');
                if (!path) {
                    failureCallback(new Error('Collection path not available'));
                    return;
                }

                try {
                    const snapshot = await window.db.collection(path)
                        .where('start', '>=', info.startStr)
                        .where('start', '<', info.endStr)
                        .get();

                    const events = [];
                    const filter = document.getElementById('view-filter').value;

                    this.eventsMap = {}; // Reset cache

                    snapshot.forEach(doc => {
                        const d = doc.data();
                        if (filter !== 'all') {
                            if (filter === 'common') { if (d.targetType !== 'common') return; }
                            else { if (d.targetType === 'class' && d.targetClass !== filter) return; }
                        }

                        // Map for quick access
                        this.eventsMap[doc.id] = { id: doc.id, ...d };

                        events.push({
                            id: doc.id,
                            title: d.title,
                            start: d.start,
                            end: d.end || d.start,
                            backgroundColor: this.colorMap[d.eventType] || '#6b7280',
                            borderColor: this.colorMap[d.eventType] || '#6b7280',
                            extendedProps: d
                        });
                    });
                    successCallback(events);
                } catch (e) { console.error(e); failureCallback(e); }
            },

            refetchEvents: function () { if (this.calendar) this.calendar.refetchEvents(); },

            initialFormState: null,

            openModal: function (eventObj = null, dateStr = null) {
                // If eventObj is passed from FullCalendar eventClick, it has extendedProps inside.
                // If passed from our manual map, it is just the object.
                // Standardize:
                let data = eventObj;
                if (eventObj && eventObj.extendedProps) data = { id: eventObj.id, ...eventObj.extendedProps };

                document.getElementById('event-modal').classList.remove('hidden');
                document.getElementById('event-modal').classList.add('flex');

                // Reset/Fill and Capture State
                if (data) {
                    document.getElementById('modal-title').innerText = "ì¼ì • ìˆ˜ì •";
                    document.getElementById('event-id').value = data.id;
                    document.getElementById('event-title').value = data.title;
                    document.getElementById('event-start').value = data.start;
                    document.getElementById('event-end').value = data.end || '';
                    document.getElementById('event-type').value = data.eventType;
                    document.getElementById('event-desc').value = data.description || '';
                    if (data.targetType === 'class') {
                        document.querySelector('input[name="targetType"][value="class"]').checked = true;
                        this.toggleTargetClass(true);
                        document.getElementById('target-class').value = data.targetClass;
                    } else {
                        document.querySelector('input[name="targetType"][value="common"]').checked = true;
                        this.toggleTargetClass(false);
                    }
                    document.getElementById('btn-delete').classList.remove('hidden');
                } else {
                    document.getElementById('modal-title').innerText = "ì¼ì • ë“±ë¡";
                    // Reset fields
                    document.getElementById('event-id').value = '';
                    document.getElementById('event-title').value = '';
                    document.getElementById('event-start').value = dateStr || new Date().toISOString().split('T')[0];
                    document.getElementById('event-end').value = '';
                    document.getElementById('event-type').value = 'performance';
                    document.getElementById('event-desc').value = '';
                    document.querySelector('input[name="targetType"][value="common"]').checked = true;
                    this.toggleTargetClass(false);
                    document.getElementById('target-class').value = '2-1'; // Default
                    document.getElementById('btn-delete').classList.add('hidden');
                }

                this.captureFormState();
            },

            // ... (rest of modal logic: captureFormState, isDirty, attemptClose, closeModal, toggleTargetClass, saveEvent, deleteEvent)
            // Need to ensure these methods exist in the file after replacement.
            // Since I am replacing the mid-section, I must check start/end lines carefully.

            captureFormState: function () {
                this.initialFormState = {
                    title: document.getElementById('event-title').value,
                    start: document.getElementById('event-start').value,
                    end: document.getElementById('event-end').value,
                    type: document.getElementById('event-type').value,
                    desc: document.getElementById('event-desc').value,
                    targetType: document.querySelector('input[name="targetType"]:checked').value,
                    targetClass: document.getElementById('target-class').value
                };
            },

            isDirty: function () {
                if (!this.initialFormState) return false;
                const current = {
                    title: document.getElementById('event-title').value,
                    start: document.getElementById('event-start').value,
                    end: document.getElementById('event-end').value,
                    type: document.getElementById('event-type').value,
                    desc: document.getElementById('event-desc').value,
                    targetType: document.querySelector('input[name="targetType"]:checked').value,
                    targetClass: document.getElementById('target-class').value
                };
                return JSON.stringify(this.initialFormState) !== JSON.stringify(current);
            },

            attemptClose: function () {
                if (this.isDirty()) {
                    if (!confirm("ì‘ì„± ì¤‘ì¸ ë‚´ìš©ì´ ìˆìŠµë‹ˆë‹¤. ì •ë§ ë‹«ìœ¼ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
                }
                this.closeModal();
            },

            closeModal: function () {
                document.getElementById('event-modal').classList.add('hidden');
                document.getElementById('event-modal').classList.remove('flex');
            },

            toggleTargetClass: function (enable) {
                const sel = document.getElementById('target-class');
                sel.disabled = !enable;
                if (enable) sel.classList.remove('bg-gray-50'); else sel.classList.add('bg-gray-50');
            },

            saveEvent: async function () {
                const id = document.getElementById('event-id').value;
                const title = document.getElementById('event-title').value;
                const start = document.getElementById('event-start').value;
                if (!title || !start) { alert("ì œëª©ê³¼ ì‹œì‘ ë‚ ì§œëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤."); return; }

                const data = {
                    title: title,
                    start: start,
                    end: document.getElementById('event-end').value || null,
                    eventType: document.getElementById('event-type').value,
                    targetType: document.querySelector('input[name="targetType"]:checked').value,
                    targetClass: document.querySelector('input[name="targetType"]:checked').value === 'class' ? document.getElementById('target-class').value : null,
                    description: document.getElementById('event-desc').value,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                const path = this.getCollectionPath('calendar_events');
                if (!path) return;

                try {
                    if (id) await window.db.collection(path).doc(id).update(data);
                    else {
                        data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                        await window.db.collection(path).add(data);
                    }
                    this.initialFormState = null; // Reset dirty state on save
                    this.closeModal();
                    this.refetchEvents();
                } catch (e) { alert("ì €ì¥ ì‹¤íŒ¨: " + e.message); }
            },

            deleteEvent: async function () {
                const id = document.getElementById('event-id').value;
                if (!id) return;
                if (!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
                const path = this.getCollectionPath('calendar_events');
                if (!path) return;
                try {
                    await window.db.collection(path).doc(id).delete();
                    this.initialFormState = null; // Reset dirty state
                    this.closeModal();
                    this.refetchEvents();
                } catch (e) { alert("ì‚­ì œ ì‹¤íŒ¨: " + e.message); }
            }
        };

        document.addEventListener('auth-ready', () => app.init());
    </script>
</body>

</html>