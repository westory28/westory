<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>학생 관리 - Westory Admin</title>
    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="../assets/js/firebase-config.js"></script>
    <link rel="stylesheet" href="../assets/css/style.css">
    <script src="../assets/js/auth-manager.js"></script>
</head>
<body>
    <!-- Header injected by AuthManager -->

    <main class="max-w-7xl mx-auto px-4 py-8">
        
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
            <div class="p-6 border-b bg-gray-50 flex justify-between items-center flex-wrap gap-4">
                <h2 class="text-lg font-bold text-gray-800">
                    <i class="fas fa-users text-blue-500 mr-2"></i> 학생 명단 <span id="std-count" class="text-sm font-normal text-gray-500"></span>
                </h2>
                <div class="flex gap-2">
                    <input type="text" id="search-input" placeholder="이름 검색" class="border rounded px-3 py-2 text-sm">
                    <button onclick="app.filterList()" class="bg-blue-600 text-white px-4 py-2 rounded text-sm font-bold">검색</button>
                </div>
            </div>
            
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left">
                    <thead class="bg-gray-100 text-gray-600 font-bold uppercase text-xs">
                        <tr>
                            <th class="p-4 w-20 text-center">반</th>
                            <th class="p-4 w-20 text-center">번호</th>
                            <th class="p-4">이름</th>
                            <th class="p-4">이메일</th>
                            <th class="p-4 text-center w-32">관리</th>
                        </tr>
                    </thead>
                    <tbody id="std-list" class="divide-y divide-gray-100 bg-white">
                        <tr><td colspan="5" class="p-8 text-center text-gray-400">로딩 중...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

    </main>

    <!-- Edit Modal -->
    <div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="bg-white p-6 rounded-lg w-80 shadow-xl">
            <h3 class="font-bold mb-4">학생 정보 수정</h3>
            <input type="hidden" id="edit-id">
            <div class="space-y-3">
                <input type="number" id="edit-class" class="w-full border p-2 rounded" placeholder="반">
                <input type="number" id="edit-num" class="w-full border p-2 rounded" placeholder="번호">
                <input type="text" id="edit-name" class="w-full border p-2 rounded" placeholder="이름">
            </div>
            <div class="flex gap-2 mt-4">
                <button onclick="app.saveStudent()" class="flex-1 bg-blue-600 text-white py-2 rounded font-bold">저장</button>
                <button onclick="document.getElementById('edit-modal').classList.add('hidden')" class="flex-1 bg-gray-200 py-2 rounded">취소</button>
            </div>
        </div>
    </div>

    <script>
        window.AuthManager.init('teacher');

        const app = {
            students: [],
            
            init: function() {
                window.db.collection('users').orderBy('class').orderBy('number').get().then(snap => {
                    this.students = [];
                    snap.forEach(doc => this.students.push({ ...doc.data(), id: doc.id }));
                    this.render(this.students);
                });
            },

            render: function(list) {
                document.getElementById('std-count').innerText = `(${list.length}명)`;
                const tbody = document.getElementById('std-list');
                
                if(list.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="p-8 text-center">학생 데이터가 없습니다.</td></tr>';
                    return;
                }

                tbody.innerHTML = list.map(s => `
                    <tr class="hover:bg-blue-50 transition">
                        <td class="p-4 text-center font-bold text-gray-600">${s.class}</td>
                        <td class="p-4 text-center font-bold text-gray-600">${s.number}</td>
                        <td class="p-4 font-bold text-gray-800">${s.name}</td>
                        <td class="p-4 text-gray-500">${s.email}</td>
                        <td class="p-4 text-center">
                            <button onclick="app.openEdit('${s.id}')" class="text-blue-500 hover:text-blue-700 mr-2"><i class="fas fa-edit"></i></button>
                            <button onclick="app.deleteStudent('${s.id}')" class="text-red-400 hover:text-red-600"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `).join('');
            },

            filterList: function() {
                const q = document.getElementById('search-input').value.trim();
                const filtered = this.students.filter(s => s.name.includes(q) || String(s.class) === q);
                this.render(filtered);
            },

            openEdit: function(id) {
                const s = this.students.find(x => x.id === id);
                document.getElementById('edit-id').value = id;
                document.getElementById('edit-class').value = s.class;
                document.getElementById('edit-num').value = s.number;
                document.getElementById('edit-name').value = s.name;
                document.getElementById('edit-modal').classList.remove('hidden');
            },

            saveStudent: function() {
                const id = document.getElementById('edit-id').value;
                const updateData = {
                    class: parseInt(document.getElementById('edit-class').value),
                    number: parseInt(document.getElementById('edit-num').value),
                    name: document.getElementById('edit-name').value
                };
                window.db.collection('users').doc(id).update(updateData).then(() => {
                    document.getElementById('edit-modal').classList.add('hidden');
                    this.init(); // Reload
                });
            },

            deleteStudent: function(id) {
                if(confirm("정말 삭제하시겠습니까?")) {
                    window.db.collection('users').doc(id).delete().then(() => this.init());
                }
            }
        };

        document.addEventListener('auth-ready', () => app.init());
    </script>
</body>
</html>