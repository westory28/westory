<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í•™ìƒ ê´€ë¦¬ - Westory Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="../assets/js/firebase-config.js"></script>
    <link rel="stylesheet" href="../assets/css/style.css">
    <script src="../assets/js/auth-manager.js"></script>
    <style>
        .btn-bulk {
            transition: all 0.2s;
        }

        .btn-bulk:disabled {
            background-color: #f3f4f6;
            color: #9ca3af;
            border-color: #e5e7eb;
            cursor: not-allowed;
        }

        .btn-bulk:not(:disabled):hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        /* Solid colors when active */
        #btn-promote:not(:disabled) {
            background-color: #2563eb;
            color: white;
            border-color: #2563eb;
        }

        #btn-promote:not(:disabled):hover {
            background-color: #1d4ed8;
        }

        #btn-move:not(:disabled) {
            background-color: #16a34a;
            color: white;
            border-color: #16a34a;
        }

        #btn-move:not(:disabled):hover {
            background-color: #15803d;
        }

        #btn-delete:not(:disabled) {
            background-color: #dc2626;
            color: white;
            border-color: #dc2626;
        }

        #btn-delete:not(:disabled):hover {
            background-color: #b91c1c;
        }
    </style>
</head>

<body class="bg-gray-50">
    <!-- Header injected by AuthManager -->

    <main class="max-w-7xl mx-auto px-4 py-8">

        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
            <!-- Fixed Height Toolbar Container -->
            <div class="p-6 border-b bg-gray-50 flex justify-between items-center flex-wrap gap-4 min-h-[88px]">
                <div class="flex items-center gap-4">
                    <h2 class="text-lg font-bold text-gray-800">
                        <i class="fas fa-users text-blue-500 mr-2"></i> í•™ìƒ ëª…ë‹¨ <span id="std-count"
                            class="text-sm font-normal text-gray-500"></span>
                    </h2>
                    <!-- Bulk Actions Toolbar -->
                    <div id="bulk-toolbar" class="flex items-center gap-2 px-3 py-1">
                        <span class="text-xs font-bold text-blue-800 mr-2" id="selected-count-text">0ëª… ì„ íƒë¨</span>
                        <div class="h-4 w-px bg-gray-300 mx-1"></div>
                        <button id="btn-promote" onclick="app.promoteSelected()" disabled
                            class="btn-bulk text-xs px-3 py-1.5 rounded font-bold shadow-sm border" title="í•™ë…„ì„ 1ì”© ì˜¬ë¦½ë‹ˆë‹¤">
                            <i class="fas fa-level-up-alt mr-1"></i>ì¼ê´„ ì§„ê¸‰
                        </button>
                        <button id="btn-move" onclick="app.openMoveClassModal()" disabled
                            class="btn-bulk text-xs px-3 py-1.5 rounded font-bold shadow-sm border" title="ë°˜ì„ ë³€ê²½í•©ë‹ˆë‹¤">
                            <i class="fas fa-exchange-alt mr-1"></i>ë°˜ ì´ë™
                        </button>
                        <button id="btn-delete" onclick="app.deleteSelected()" disabled
                            class="btn-bulk text-xs px-3 py-1.5 rounded font-bold shadow-sm border">
                            <i class="fas fa-trash mr-1"></i>ì¼ê´„ ì‚­ì œ
                        </button>
                    </div>
                </div>
                <div class="flex gap-2">
                    <input type="text" id="search-input" placeholder="ì´ë¦„ ë˜ëŠ” ë°˜(ìˆ«ì) ê²€ìƒ‰"
                        class="border rounded px-3 py-2 text-sm w-64 focus:outline-none focus:border-blue-500">
                    <button onclick="app.filterList()"
                        class="bg-blue-600 text-white px-4 py-2 rounded text-sm font-bold hover:bg-blue-700">ê²€ìƒ‰</button>
                </div>
            </div>

            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left">
                    <thead class="bg-gray-100 text-gray-600 font-bold uppercase text-xs">
                        <tr>
                            <th class="p-4 w-10 text-center"><input type="checkbox" id="check-all"
                                    onclick="app.toggleSelectAll(this)"></th>
                            <th class="p-4 w-16 text-center">í•™ë…„</th>
                            <th class="p-4 w-16 text-center">ë°˜</th>
                            <th class="p-4 w-16 text-center">ë²ˆí˜¸</th>
                            <th class="p-4">ì´ë¦„ (í´ë¦­í•˜ì—¬ ê¸°ë¡ ì¡°íšŒ)</th>
                            <th class="p-4">ì´ë©”ì¼</th>
                            <th class="p-4 text-center w-32">ê´€ë¦¬</th>
                        </tr>
                    </thead>
                    <tbody id="std-list" class="divide-y divide-gray-100 bg-white">
                        <tr>
                            <td colspan="7" class="p-8 text-center text-gray-400">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

    </main>

    <!-- Student History Modal -->
    <div id="history-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center">
        <div class="bg-black bg-opacity-50 absolute inset-0"
            onclick="document.getElementById('history-modal').classList.add('hidden')"></div>
        <div class="bg-white rounded-lg shadow-xl z-10 w-full max-w-3xl p-6 mx-4 max-h-[85vh] flex flex-col">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <div>
                    <h3 class="font-bold text-lg text-gray-800" id="history-title">í•™ìŠµ ê¸°ë¡</h3>
                    <p class="text-xs text-gray-500">í•™ìƒì˜ ë¬¸ì œ í’€ì´ ë‚´ì—­ì„ ë‚ ì§œë³„ë¡œ í™•ì¸í•©ë‹ˆë‹¤.</p>
                </div>
                <button onclick="document.getElementById('history-modal').classList.add('hidden')"><i
                        class="fas fa-times text-gray-400 hover:text-gray-600 text-xl"></i></button>
            </div>
            <div id="history-content" class="overflow-y-auto flex-1 space-y-3 pr-2"></div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="edit-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center">
        <div class="bg-black bg-opacity-50 absolute inset-0"
            onclick="document.getElementById('edit-modal').classList.add('hidden')"></div>
        <div class="bg-white p-6 rounded-lg w-96 shadow-xl z-10">
            <h3 class="font-bold mb-4 text-lg border-b pb-2">í•™ìƒ ì •ë³´ ìˆ˜ì •</h3>
            <input type="hidden" id="edit-id">
            <div class="space-y-4">
                <div class="grid grid-cols-3 gap-2">
                    <div>
                        <label class="block text-xs text-gray-500 font-bold mb-1">í•™ë…„</label>
                        <input type="number" id="edit-grade" class="w-full border p-2 rounded text-sm text-center">
                    </div>
                    <div>
                        <label class="block text-xs text-gray-500 font-bold mb-1">ë°˜</label>
                        <input type="number" id="edit-class" class="w-full border p-2 rounded text-sm text-center">
                    </div>
                    <div>
                        <label class="block text-xs text-gray-500 font-bold mb-1">ë²ˆí˜¸</label>
                        <input type="number" id="edit-num" class="w-full border p-2 rounded text-sm text-center">
                    </div>
                </div>
                <div>
                    <label class="block text-xs text-gray-500 font-bold mb-1">ì´ë¦„</label>
                    <input type="text" id="edit-name" class="w-full border p-2 rounded text-sm font-bold">
                </div>
                <div>
                    <label class="block text-xs text-gray-500 font-bold mb-1">ì´ë©”ì¼ (ë¡œê·¸ì¸ ID)</label>
                    <input type="text" id="edit-email" class="w-full border p-2 rounded text-sm bg-gray-50">
                </div>
            </div>
            <div class="flex gap-2 mt-6">
                <button onclick="document.getElementById('edit-modal').classList.add('hidden')"
                    class="flex-1 bg-white border border-gray-300 text-gray-700 py-2 rounded font-bold hover:bg-gray-50">ì·¨ì†Œ</button>
                <button onclick="app.saveStudent()"
                    class="flex-1 bg-blue-600 text-white py-2 rounded font-bold hover:bg-blue-700 shadow-md">ì €ì¥</button>
            </div>
        </div>
    </div>

    <!-- Move Class Modal -->
    <div id="move-class-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center">
        <div class="bg-black bg-opacity-50 absolute inset-0"
            onclick="document.getElementById('move-class-modal').classList.add('hidden')"></div>
        <div class="bg-white p-6 rounded-lg w-80 shadow-xl z-10 text-center">
            <h3 class="font-bold text-lg mb-2">ë°˜ ì´ë™</h3>
            <p class="text-sm text-gray-500 mb-4">ì„ íƒí•œ í•™ìƒë“¤ì„ ì´ë™í•  ë°˜ì„ ì„ íƒí•˜ì„¸ìš”.</p>
            <select id="target-class-select" class="w-full border p-3 rounded mb-4 font-bold text-center">
                <option value="1">1ë°˜</option>
                <option value="2">2ë°˜</option>
                <option value="3">3ë°˜</option>
                <option value="4">4ë°˜</option>
                <option value="5">5ë°˜</option>
                <option value="6">6ë°˜</option>
                <option value="7">7ë°˜</option>
                <option value="8">8ë°˜</option>
                <option value="9">9ë°˜</option>
                <option value="10">10ë°˜</option>
                <option value="11">11ë°˜</option>
                <option value="12">12ë°˜</option>
            </select>
            <button onclick="app.moveSelected()"
                class="w-full bg-green-600 text-white font-bold py-2 rounded hover:bg-green-700">ì´ë™ í™•ì¸</button>
        </div>
    </div>

    <!-- Footer injected by AuthManager -->

    <script>
        window.AuthManager.init('teacher');

        const app = {
            students: [],
            selectedIds: new Set(),

            init: function () {
                window.getCollection('users').get().then(snap => {
                    this.students = [];
                    snap.forEach(doc => {
                        const d = doc.data();
                        this.students.push({
                            id: doc.id,
                            grade: parseInt(d.grade) || 2,
                            class: parseInt(d.class) || 0,
                            number: parseInt(d.number) || 0,
                            name: d.name || '',
                            email: d.email || ''
                        });
                    });
                    this.students.sort((a, b) => (a.grade - b.grade) || (a.class - b.class) || (a.number - b.number));
                    this.render(this.students);
                });
            },

            render: function (list) {
                document.getElementById('std-count').innerText = `(${list.length}ëª…)`;
                const tbody = document.getElementById('std-list');

                if (list.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="p-8 text-center text-gray-400">í•™ìƒ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                    return;
                }

                tbody.innerHTML = list.map(s => `
                    <tr class="hover:bg-blue-50 transition group border-b last:border-0">
                        <td class="p-4 text-center" data-label="ì„ íƒ">
                            <input type="checkbox" class="student-check w-4 h-4 text-blue-600 rounded focus:ring-blue-500" value="${s.id}" onclick="app.toggleSelect('${s.id}')" ${this.selectedIds.has(s.id) ? 'checked' : ''}>
                        </td>
                        <td class="p-4 text-center text-gray-500 text-xs" data-label="í•™ë…„">${s.grade}</td>
                        <td class="p-4 text-center font-bold text-gray-600" data-label="ë°˜">${s.class}</td>
                        <td class="p-4 text-center font-bold text-gray-600" data-label="ë²ˆí˜¸">${s.number}</td>
                        <td class="p-4" data-label="ì´ë¦„">
                            <span onclick="app.showHistory('${s.id}', '${s.name}', ${s.class}, ${s.number})" 
                                  class="font-bold text-gray-800 cursor-pointer hover:text-blue-600 hover:underline flex items-center justify-end md:justify-start">
                                ${s.name} <i class="fas fa-folder-open text-xs text-gray-300 group-hover:text-blue-400 ml-2"></i>
                            </span>
                        </td>
                        <td class="p-4 text-gray-500 text-xs font-mono" data-label="ì´ë©”ì¼">${s.email.split('@')[0]}</td>
                        <td class="p-4 text-center" data-label="ê´€ë¦¬">
                            <button onclick="app.openEdit('${s.id}')" class="text-blue-500 hover:text-blue-700 mr-3 p-1"><i class="fas fa-edit"></i> <span class="md:hidden">ìˆ˜ì •</span></button>
                            <button onclick="app.deleteStudent('${s.id}')" class="text-red-400 hover:text-red-600 p-1"><i class="fas fa-trash"></i> <span class="md:hidden">ì‚­ì œ</span></button>
                        </td>
                    </tr>
                `).join('');

                this.updateToolbar();
            },

            toggleSelectAll: function (el) {
                const visibleIds = Array.from(document.querySelectorAll('.student-check')).map(cb => cb.value);
                if (el.checked) visibleIds.forEach(id => this.selectedIds.add(id));
                else this.selectedIds.clear();
                this.render(this.students);
            },
            toggleSelect: function (id) {
                if (this.selectedIds.has(id)) this.selectedIds.delete(id);
                else this.selectedIds.add(id);
                this.updateToolbar();
            },
            updateToolbar: function () {
                const count = this.selectedIds.size;
                document.getElementById('selected-count-text').innerText = `${count}ëª… ì„ íƒë¨`;

                const btns = ['btn-promote', 'btn-move', 'btn-delete'];
                btns.forEach(id => {
                    document.getElementById(id).disabled = (count === 0);
                });
            },

            promoteSelected: async function () {
                if (!confirm(`ì„ íƒí•œ ${this.selectedIds.size}ëª…ì˜ í•™ë…„ì„ 1ì”© ì˜¬ë¦¬ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
                const batch = window.db.batch();
                this.selectedIds.forEach(id => {
                    const ref = window.getCollection('users').doc(id);
                    const currentGrade = this.students.find(s => s.id === id).grade || 2;
                    batch.update(ref, { grade: currentGrade + 1 });
                });
                await batch.commit();
                this.selectedIds.clear();
                this.init();
            },
            deleteSelected: async function () {
                if (!confirm(`ì„ íƒí•œ ${this.selectedIds.size}ëª…ì„ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ë³µêµ¬ ë¶ˆê°€)`)) return;
                const batch = window.db.batch();
                this.selectedIds.forEach(id => {
                    const ref = window.getCollection('users').doc(id);
                    batch.delete(ref);
                });
                await batch.commit();
                this.selectedIds.clear();
                this.init();
            },
            openMoveClassModal: function () {
                document.getElementById('move-class-modal').classList.remove('hidden');
                document.getElementById('move-class-modal').classList.add('flex');
            },
            moveSelected: async function () {
                const targetClass = parseInt(document.getElementById('target-class-select').value);
                if (!confirm(`ì„ íƒí•œ ${this.selectedIds.size}ëª…ì„ ${targetClass}ë°˜ìœ¼ë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

                const batch = window.db.batch();
                this.selectedIds.forEach(id => {
                    const ref = window.getCollection('users').doc(id);
                    batch.update(ref, { class: targetClass });
                });
                await batch.commit();

                document.getElementById('move-class-modal').classList.add('hidden');
                this.selectedIds.clear();
                this.init();
            },

            filterList: function () {
                const q = document.getElementById('search-input').value.trim();
                if (!q) { this.render(this.students); return; }
                const filtered = this.students.filter(s => s.name.includes(q) || String(s.class) === q);
                this.render(filtered);
            },

            showHistory: async function (uid, name, cls, num) {
                document.getElementById('history-title').innerText = `${name} (${cls}ë°˜ ${num}ë²ˆ) ë¬¸ì œ í’€ì´ ëª¨ìŒ`;
                const content = document.getElementById('history-content');
                content.innerHTML = '<div class="text-center p-10"><div class="loader-spinner mx-auto mb-2"></div><p>ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p></div>';
                document.getElementById('history-modal').classList.remove('hidden');

                try {
                    let snap = await window.getCollection('quiz_results')
                        .where('uid', '==', uid)
                        .orderBy('timestamp', 'desc')
                        .get();

                    if (snap.empty) {
                        content.innerHTML = '<div class="text-center p-20 text-gray-400 bg-gray-50 rounded-lg">í•´ë‹¹ í•™ê¸°ì˜ ë¬¸ì œ í’€ì´ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                        return;
                    }

                    let html = '';
                    const groups = {};
                    snap.forEach(doc => {
                        const d = doc.data();
                        const dateKey = d.timeString ? d.timeString.split(' ')[0] : 'Unknown';
                        if (!groups[dateKey]) groups[dateKey] = [];
                        groups[dateKey].push(d);
                    });

                    Object.keys(groups).forEach(date => {
                        html += `
                            <div class="border border-gray-200 rounded-lg overflow-hidden mb-4">
                                <div class="bg-gray-100 px-4 py-2 font-bold text-gray-700 flex justify-between items-center cursor-pointer hover:bg-gray-200" onclick="this.nextElementSibling.classList.toggle('hidden')">
                                    <span>ğŸ“… ${date} ì‘ì‹œ (${groups[date].length}ê±´)</span>
                                    <i class="fas fa-chevron-down text-gray-400"></i>
                                </div>
                                <div class="hidden bg-white p-4 space-y-4">
                                    ${groups[date].map(record => `
                                        <div>
                                            <div class="flex justify-between items-center text-sm mb-2 border-b pb-1">
                                                <span class="font-bold text-blue-600">${record.score}ì </span>
                                                <span class="text-gray-400 text-xs">${record.timeString.split(' ').slice(1).join(' ')}</span>
                                            </div>
                                            <div class="space-y-2">
                                                ${(record.details || []).map((q, idx) => `
                                                    <div class="flex items-start gap-2 text-sm ${q.correct ? 'text-green-700' : 'text-red-600'}">
                                                        <span class="font-mono font-bold w-6">Q${idx + 1}</span>
                                                        <span class="flex-1 truncate">${q.correct ? 'âœ… ì •ë‹µ' : `âŒ ì˜¤ë‹µ (ì œì¶œ: ${q.u})`}</span>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    });
                    content.innerHTML = html;

                } catch (e) {
                    console.error(e);
                    content.innerHTML = `<div class="text-center p-4 text-red-500">ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ${e.message}</div>`;
                }
            },

            openEdit: function (id) {
                const s = this.students.find(x => x.id === id);
                document.getElementById('edit-id').value = id;
                document.getElementById('edit-grade').value = s.grade;
                document.getElementById('edit-class').value = s.class;
                document.getElementById('edit-num').value = s.number;
                document.getElementById('edit-name').value = s.name;
                document.getElementById('edit-email').value = s.email;
                document.getElementById('edit-modal').classList.remove('hidden');
            },

            saveStudent: function () {
                const id = document.getElementById('edit-id').value;
                const updateData = {
                    grade: parseInt(document.getElementById('edit-grade').value),
                    class: parseInt(document.getElementById('edit-class').value),
                    number: parseInt(document.getElementById('edit-num').value),
                    name: document.getElementById('edit-name').value,
                    email: document.getElementById('edit-email').value
                };
                window.getCollection('users').doc(id).update(updateData).then(() => {
                    document.getElementById('edit-modal').classList.add('hidden');
                    this.init();
                });
            },

            deleteStudent: function (id) {
                if (confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ë³µêµ¬ ë¶ˆê°€)")) {
                    window.getCollection('users').doc(id).delete().then(() => this.init());
                }
            }
        };

        document.addEventListener('auth-ready', () => app.init());
    </script>
</body>

</html>