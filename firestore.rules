rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    function isTeacher() {
      return isSignedIn() && request.auth.token.email == "westoria28@gmail.com";
    }

    // Users
    match /users/{userId} {
      allow get: if isSignedIn() && (request.auth.uid == userId || isTeacher());
      allow list: if isTeacher();
      allow create: if isSignedIn();
      allow update, delete: if isSignedIn() && (request.auth.uid == userId || isTeacher());

      // Student personal academic records (sensitive)
      match /academic_records/{recordId} {
        allow read: if isSignedIn() && (request.auth.uid == userId || isTeacher());
        allow create, update: if isSignedIn()
          && request.auth.uid == userId
          && request.resource.data.keys().hasOnly(['scores', 'updatedAt'])
          && request.resource.data.scores is map
          && request.resource.data.scores.keys().size() <= 500;
        allow delete: if isSignedIn() && (request.auth.uid == userId || isTeacher());
      }
    }

    // Site settings
    match /site_settings/{docId} {
      allow read: if docId in ['terms', 'privacy', 'school_config', 'interface_config'] || isSignedIn();
      allow write: if isTeacher();

      match /items/{itemId} {
        allow read: if isSignedIn();
        allow write: if isTeacher();
      }
    }

    // Metadata
    match /metadata/{docId} {
      allow read, write: if isSignedIn();
    }

    // Legacy root collections (HTML-era compatibility)
    match /curriculum/{docId} {
      allow read: if isSignedIn();
      allow write: if isTeacher();
    }

    match /lessons/{docId} {
      allow read: if isSignedIn();
      allow write: if isTeacher();
    }

    match /quiz_questions/{docId} {
      allow read: if isSignedIn();
      allow write: if isTeacher();
    }

    match /assessment_config/{docId} {
      allow read: if isSignedIn();
      allow write: if isTeacher();
    }

    match /grading_plans/{docId} {
      allow read: if isSignedIn();
      allow write: if isTeacher();
    }

    match /exam_config/{docId} {
      allow read: if isSignedIn();
      allow write: if isTeacher();
    }

    match /quiz_results/{resultId} {
      allow read: if isSignedIn() && (resource.data.uid == request.auth.uid || isTeacher());
      allow create: if isSignedIn();
      allow update, delete: if isTeacher();
    }

    match /quiz_submissions/{docId} {
      allow read: if isSignedIn();
      allow write: if isTeacher();
    }

    // Semester-scoped collections
    match /years/{year}/semesters/{semester} {
      match /calendar/{docId} {
        allow read: if isSignedIn();
        allow write: if isTeacher();
      }

      match /notices/{docId} {
        allow read: if isSignedIn();
        allow write: if isTeacher();
      }

      match /curriculum/{docId} {
        allow read: if isSignedIn();
        allow write: if isTeacher();
      }

      match /lessons/{docId} {
        allow read: if isSignedIn();
        allow write: if isTeacher();
      }

      match /quiz_questions/{docId} {
        allow read: if isSignedIn();
        allow write: if isTeacher();
      }

      match /assessment_config/{docId} {
        allow read: if isSignedIn();
        allow write: if isTeacher();
      }

      match /grading_plans/{docId} {
        allow read: if isSignedIn();
        allow write: if isTeacher();
      }

      match /exam_config/{docId} {
        allow read: if isSignedIn();
        allow write: if isTeacher();
      }

      match /quiz_results/{resultId} {
        allow read: if isSignedIn() && (resource.data.uid == request.auth.uid || isTeacher());
        allow create: if isSignedIn();
        allow update, delete: if isTeacher();
      }

      match /quiz_submissions/{docId} {
        allow read: if isSignedIn();
        allow write: if isTeacher();
      }
    }
  }
}
