<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Westory - ì—­ì‚¬ í‰ê°€</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Firebase -->

    <!-- Config & Styles -->
    <link rel="stylesheet" href="../assets/css/style.css">
    <script type="module" src="../assets/js/firebase-config.js"></script>
    <script type="module" src="../assets/js/auth-manager.js"></script>

    <style>
        .exam-banner {
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
            color: white;
            border-radius: 16px;
            padding: 24px;
            position: relative;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .exam-banner:hover {
            transform: scale(1.01);
        }

        .exam-banner.disabled {
            background: #e5e7eb;
            color: #9ca3af;
            cursor: not-allowed;
            opacity: 1;
            transform: none;
            box-shadow: none;
            pointer-events: none;
        }

        .exam-banner.disabled .exam-deco {
            display: none;
        }

        .exam-deco {
            position: absolute;
            font-size: 8rem;
            opacity: 0.1;
            right: -20px;
            bottom: -20px;
            transform: rotate(-15deg);
        }



        /* Accordion Styles - Separated Cards */
        .acc-item {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            margin-bottom: 16px;
            /* Spacing between items */
            overflow: hidden;
            transition: box-shadow 0.2s;
        }

        .acc-item:hover {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }

        .acc-item:last-child {
            margin-bottom: 0;
        }

        .acc-header {
            padding: 20px;
            background-color: #fff;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s;
        }

        .acc-header:hover {
            background-color: #f8fafc;
        }

        .acc-header-title {
            font-weight: 800;
            font-size: 1.05rem;
            color: #1f2937;
        }

        .acc-icon {
            transition: transform 0.3s;
            color: #9ca3af;
        }

        .acc-body {
            display: none;
            background-color: #f8fafc;
            border-top: 1px solid #f1f5f9;
        }

        .acc-item.open .acc-body {
            display: block;
        }

        .acc-item.open .acc-icon {
            transform: rotate(180deg);
            color: #3b82f6;
        }

        .mid-unit-row {
            padding: 16px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #e2e8f0;
        }

        .mid-unit-row:last-child {
            border-bottom: none;
        }

        .mid-title {
            display: flex;
            align-items: center;
            font-weight: 600;
            color: #4b5563;
        }

        .mid-title i {
            color: #fbbf24;
            margin-right: 10px;
        }

        .btn-action {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 700;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            border: 1px solid transparent;
        }

        .btn-diag {
            color: #2563eb;
            background-color: #eff6ff;
            border-color: #dbeafe;
        }

        .btn-diag:hover {
            background-color: #2563eb;
            color: white;
            border-color: #2563eb;
        }

        .btn-form {
            color: #059669;
            background-color: #ecfdf5;
            border-color: #d1fae5;
        }

        .btn-form:hover {
            background-color: #059669;
            color: white;
            border-color: #059669;
        }

        .btn-disabled {
            color: #9ca3af;
            background-color: #f3f4f6;
            border-color: #e5e7eb;
            cursor: not-allowed;
        }
    </style>
</head>

<body class="bg-gray-50">
    <!-- Header injected by AuthManager -->

    <main class="container mx-auto px-4 py-8 max-w-4xl">

        <div id="greeting-area"
            class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 mb-8 flex items-center gap-3 hidden animate-[fadeIn_0.5s]">
            <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center text-xl">ğŸ”¥</div>
            <div>
                <div class="font-bold text-gray-800"><span id="user-name-display" class="text-blue-600">í•™ìƒ</span>ë‹˜, ì˜¤ëŠ˜ë„
                    í™”ì´íŒ…!</div>
                <div class="text-xs text-gray-400" id="semester-text">2025í•™ë…„ë„</div>
            </div>
        </div>

        <!-- 1. Exam Prep Banner (Default Disabled) -->
        <section class="mb-10">
            <h2 class="text-lg font-bold text-gray-800 mb-3 ml-1 flex items-center gap-2">
                <i class="fas fa-flag-checkered text-blue-600"></i> ì‹¤ì „ ëŒ€ë¹„
            </h2>
            <div id="exam-prep-card" class="exam-banner disabled shadow-lg group">
                <i class="fas fa-pen-fancy exam-deco text-white"></i>
                <div class="relative z-10">
                    <div id="banner-badge"
                        class="bg-gray-400 text-white text-[10px] font-bold px-2 py-1 rounded inline-block mb-2 shadow-sm">
                        ë¹„ê³µê°œ</div>
                    <h3 id="banner-title" class="text-2xl font-black mb-1">ì •ê¸° ì‹œí—˜ ëŒ€ë¹„ (ì¤€ë¹„ì¤‘)</h3>
                    <p id="banner-desc" class="text-gray-300 text-sm font-medium opacity-90">ì„ ìƒë‹˜ì´ í‰ê°€ë¥¼ í™œì„±í™”í•˜ë©´ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                    </p>
                </div>
                <div id="banner-icon"
                    class="hidden absolute right-6 top-1/2 transform -translate-y-1/2 bg-white/20 backdrop-blur-sm p-3 rounded-full text-white group-hover:bg-white group-hover:text-blue-600 transition">
                    <i class="fas fa-chevron-right text-xl"></i>
                </div>
            </div>
        </section>

        <!-- 2. Curriculum Tree List -->
        <section>
            <h2 class="text-lg font-bold text-gray-800 mb-4 ml-1 flex items-center gap-2">
                <i class="fas fa-layer-group text-amber-500"></i> ë‹¨ì›ë³„ í‰ê°€
            </h2>
            <div id="quiz-list-container" class="unit-list-container min-h-[100px]">
                <div class="py-20 text-center text-gray-400 bg-white rounded-xl border border-gray-200">
                    <div class="loader-spinner mx-auto mb-3"></div>
                    <p>í‰ê°€ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                </div>
            </div>
        </section>

    </main>

    <!-- Footer injected by AuthManager -->

    <script type="module">
        window.AuthManager.init('student');

        window.app = {
            config: {},
            tree: [],

            init: function () {
                document.addEventListener('auth-ready', (e) => {
                    const user = e.detail;
                    this.loadUserInfo(user.uid);
                    document.getElementById('semester-text').innerText = `${window.currentConfig.year}í•™ë…„ë„ ${window.currentConfig.semester}í•™ê¸°`;
                    this.loadData();
                });
            },

            loadUserInfo: async function (uid) {
                try {
                    const doc = await window.getCollection('users').doc(uid).get();
                    if (doc.exists) {
                        document.getElementById('user-name-display').innerText = doc.data().name || "í•™ìƒ";
                        document.getElementById('greeting-area').classList.remove('hidden');
                    }
                } catch (e) { }
            },

            loadData: async function () {
                try {
                    // Config Loading
                    try {
                        let settingsDoc = await window.getCollection('assessment_config').doc('settings').get();

                        // Fallback 2: Global (Legacy)
                        if (!settingsDoc.exists) {
                            settingsDoc = await window.db.collection('assessment_config').doc('settings').get();
                        }

                        if (settingsDoc.exists) {
                            this.config = settingsDoc.data();
                        } else {
                            // Try status doc (legacy)
                            let statusDoc = await window.getCollection('assessment_config').doc('status').get();
                            if (!statusDoc.exists) statusDoc = await window.db.collection('assessment_config').doc('status').get();

                            if (statusDoc.exists) {
                                const raw = statusDoc.data();
                                for (const key in raw) { this.config[key] = { active: raw[key] }; }
                            }
                        }
                    } catch (e) { console.warn("Config load warn", e); }

                    // Tree Loading
                    try {
                        let treeDoc = await window.getCollection('curriculum').doc('tree').get();

                        // Fallback 2: Global
                        if (!treeDoc.exists) {
                            treeDoc = await window.db.collection('curriculum').doc('tree').get();
                        }

                        this.tree = (treeDoc.exists && treeDoc.data().tree) ? treeDoc.data().tree : [];
                    } catch (e) { console.warn("Tree load warn", e); }

                    this.renderExamPrep();
                    this.renderList();
                } catch (e) {
                    console.error(e);
                    document.getElementById('quiz-list-container').innerHTML = '<div class="text-center text-red-400 p-10 font-bold bg-white rounded-xl border border-gray-200">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
                }
            },

            renderExamPrep: function () {
                const conf = this.config['exam_prep_exam_prep'] || {};
                const isActive = conf.active === true;
                const card = document.getElementById('exam-prep-card');

                if (isActive) {
                    card.classList.remove('disabled');
                    card.onclick = () => app.startQuiz('exam_prep', 'exam_prep', 'ì •ê¸° ì‹œí—˜ ëŒ€ë¹„ ì‹¤ì „');
                    document.getElementById('banner-badge').className = "bg-red-500 text-white text-[10px] font-bold px-2 py-1 rounded inline-block mb-2 shadow-sm";
                    document.getElementById('banner-badge').innerText = "FINAL CHECK";
                    document.getElementById('banner-title').innerText = "ì •ê¸° ì‹œí—˜ ëŒ€ë¹„ ì‹¤ì „ ë¬¸ì œ";
                    document.getElementById('banner-desc').innerText = "ì‹¤ì œ ì‹œí—˜ì²˜ëŸ¼ ë¬¸ì œë¥¼ í’€ì–´ë³´ê³  ì‹¤ë ¥ì„ ì ê²€í•˜ì„¸ìš”.";
                    document.getElementById('banner-desc').className = "text-blue-100 text-sm font-medium opacity-90";
                    document.getElementById('banner-icon').classList.remove('hidden');
                }
            },

            renderList: function () {
                const container = document.getElementById('quiz-list-container');
                if (this.tree.length === 0) {
                    container.innerHTML = '<div class="text-center py-10 text-gray-400 bg-white rounded-xl border border-gray-200">ë“±ë¡ëœ ë‹¨ì›ì´ ì—†ìŠµë‹ˆë‹¤.<br><span class="text-xs">ì„ ìƒë‹˜ì´ ì•„ì§ ë‹¨ì›ì„ ë“±ë¡í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</span></div>';
                    return;
                }

                let html = '';
                this.tree.forEach((big, idx) => {
                    html += `
                        <div class="acc-item" id="acc-${idx}">
                            <div class="acc-header" onclick="app.toggleAccordion('acc-${idx}')">
                                <span class="acc-header-title">${big.title}</span>
                                <i class="fas fa-chevron-down acc-icon"></i>
                            </div>
                            <div class="acc-body">
                    `;

                    if (big.children) {
                        big.children.forEach(mid => {
                            const diagConf = this.config[`${mid.id}_diagnostic`] || {};
                            const formConf = this.config[`${mid.id}_formative`] || {};
                            const isDiagActive = diagConf.active === true;
                            const isFormActive = formConf.active === true;

                            html += `
                                <div class="mid-unit-row">
                                    <div class="mid-title">
                                        <i class="fas fa-folder"></i>
                                        <span>${mid.title}</span>
                                    </div>
                                    <div class="flex gap-2">
                                        <button onclick="${isDiagActive ? `app.startQuiz('${mid.id}', 'diagnostic', '${mid.title}')` : ''}" 
                                            class="btn-action ${isDiagActive ? 'btn-diag' : 'btn-disabled'}">
                                            ${isDiagActive ? '<i class="fas fa-stethoscope"></i> ì§„ë‹¨í‰ê°€' : '<i class="fas fa-lock"></i> ì§„ë‹¨'}
                                        </button>
                                        <button onclick="${isFormActive ? `app.startQuiz('${mid.id}', 'formative', '${mid.title}')` : ''}" 
                                            class="btn-action ${isFormActive ? 'btn-form' : 'btn-disabled'}">
                                            ${isFormActive ? '<i class="fas fa-pencil-alt"></i> í˜•ì„±í‰ê°€' : '<i class="fas fa-lock"></i> í˜•ì„±'}
                                        </button>
                                    </div>
                                </div>
                            `;
                        });
                    }

                    html += `   </div>
                        </div>`;
                });
                container.innerHTML = html;
            },

            toggleAccordion: function (id) {
                document.getElementById(id).classList.toggle('open');
            },

            startQuiz: function (unitId, cat, title) {
                const url = `quiz-runner.html?unitId=${unitId}&category=${cat}&title=${encodeURIComponent(title)}`;
                window.location.href = url;
            }
        };

        app.init();
    </script>
    <script type="module" src="/assets/js/nav-optimizer.js"></script>
</body>

</html>