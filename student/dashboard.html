<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í•™ìƒ ëŒ€ì‹œë³´ë“œ - Westory</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- FullCalendar -->
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="../assets/js/firebase-config.js"></script>
    <link rel="stylesheet" href="../assets/css/style.css">
    <script src="../assets/js/auth-manager.js"></script>

    <style>
        .dashboard-container {
            max-width: 1280px;
            margin: 0 auto;
            padding: 24px 16px;
            width: 100%;
            display: flex;
            flex-direction: column;
            height: calc(100vh - 80px);
            /* Adjust for header/footer */
        }

        @media (min-width: 768px) {
            .dashboard-container {
                padding: 24px 40px;
            }
        }

        /* Calendar Styles from student/calendar.html */
        .fc-toolbar-title {
            font-size: 1.25em !important;
            font-weight: 700;
            color: #1f2937;
        }

        .fc-button {
            background-color: #2563eb !important;
            border-color: #2563eb !important;
            font-weight: 600 !important;
        }

        .fc-daygrid-event {
            cursor: pointer;
            border-radius: 4px;
            padding: 2px 4px;
            font-size: 0.8rem;
            font-weight: 600;
            border: none;
            transition: transform 0.1s;
        }

        .fc-daygrid-event:hover {
            transform: scale(1.02);
        }

        .fc-day-sun a {
            color: #ef4444 !important;
            text-decoration: none;
            font-weight: 700;
        }

        .fc-day-sat a {
            color: #3b82f6 !important;
            text-decoration: none;
            font-weight: 700;
        }

        .fc-day-holiday a {
            color: #ef4444 !important;
            font-weight: 700;
        }

        .holiday-text-event {
            background-color: transparent !important;
            border: none !important;
        }

        .holiday-text-event .fc-event-title {
            color: #ef4444;
            font-size: 0.75rem;
            font-weight: 800;
        }

        .fc-event-main {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 100;
            display: flex;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(2px);
        }

        @media (max-width: 768px) {
            .fc-toolbar {
                flex-direction: column;
                gap: 0.5rem;
            }

            .fc-toolbar-title {
                font-size: 1rem !important;
            }

            .fc-button {
                padding: 0.25rem 0.5rem !important;
                font-size: 0.75rem !important;
            }

            .fc-header-toolbar {
                margin-bottom: 0.5rem !important;
            }
        }
    </style>
</head>

<body class="bg-gray-50 flex flex-col h-screen overflow-hidden">
    <!-- Header injected by AuthManager -->

    <main class="dashboard-container">
        <div class="mb-6 flex flex-col md:flex-row justify-between items-start md:items-end gap-3 shrink-0">
            <div>
                <h1 class="text-2xl md:text-3xl font-extrabold text-gray-900 tracking-tight" id="welcome-text">í™˜ì˜í•©ë‹ˆë‹¤!
                </h1>
                <div class="flex items-center gap-2 mt-2">
                    <span
                        class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-bold bg-blue-100 text-blue-800"
                        id="semester-badge">
                        <i class="fas fa-spinner fa-spin mr-1"></i> ë¡œë”© ì¤‘
                    </span>
                </div>
            </div>

            <div class="flex items-center gap-4 text-xs font-bold text-gray-500">
                <div class="flex items-center"><span class="w-3 h-3 rounded-full bg-red-500 mr-1"></span>ì •ê¸° ì‹œí—˜</div>
                <div class="flex items-center"><span class="w-3 h-3 rounded-full bg-orange-500 mr-1"></span>ìˆ˜í–‰í‰ê°€</div>
                <div class="flex items-center"><span class="w-3 h-3 rounded-full bg-blue-500 mr-1"></span>ì§„ë‹¨/í˜•ì„±</div>
                <div class="flex items-center"><span class="w-3 h-3 rounded-full bg-green-500 mr-1"></span>í–‰ì‚¬</div>
            </div>
        </div>

        <div
            class="flex-1 bg-white rounded-xl shadow-lg border border-gray-100 p-4 md:p-6 overflow-hidden flex flex-col relative">
            <div id="calendar" class="h-full"></div>
        </div>
    </main>

    <!-- Detail Modal -->
    <div id="detail-modal" class="modal-overlay hidden" onclick="app.closeModal(event)">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 mx-4 relative transform transition-all scale-100"
            onclick="event.stopPropagation()">
            <div class="mb-4">
                <span id="detail-badge"
                    class="px-2 py-1 rounded text-xs font-bold text-white bg-gray-500 inline-block mb-2">TYPE</span>
                <h3 id="detail-title" class="text-xl font-bold text-gray-900 leading-tight">ì¼ì • ì œëª©</h3>
            </div>

            <div class="space-y-3 text-sm text-gray-600 bg-gray-50 p-4 rounded-xl border border-gray-100 mb-6">
                <div class="flex items-start gap-3">
                    <i class="fas fa-clock mt-1 text-blue-500"></i>
                    <div>
                        <p class="font-bold text-gray-800">ê¸°ê°„</p>
                        <!-- Footer injected by AuthManager -->

                        <script>
                            window.AuthManager.init('student');

                            const app = {
                                calendar: null,
                                userClassStr: null, // "2-1" etc.
                                colorMap: {
                                    'exam': '#ef4444',       // Red
                                    'performance': '#f97316', // Orange
                                    'event': '#10b981',       // Green
                                    'diagnosis': '#3b82f6',   // Blue
                                    'formative': '#3b82f6'    // Blue
                                },
                                typeLabelMap: {
                                    'exam': 'ì •ê¸° ì‹œí—˜', 'performance': 'ìˆ˜í–‰í‰ê°€', 'event': 'í–‰ì‚¬', 'diagnosis': 'ì§„ë‹¨í‰ê°€', 'formative': 'í˜•ì„±í‰ê°€'
                                },
                                holidays: {},

                                init: function () {
                                    document.addEventListener('auth-ready', async (e) => {
                                        const user = e.detail;
                                        document.getElementById('welcome-text').innerText = `${user.displayName || 'í•™ìƒ'}ë‹˜, í™˜ì˜í•©ë‹ˆë‹¤!`;

                                        const cfg = window.currentConfig;
                                        if (cfg) document.getElementById('semester-badge').innerText = `${cfg.year}í•™ë…„ë„ ${cfg.semester}í•™ê¸°`;

                                        await this.loadUserClass(user.uid);
                                        this.initCalendar();
                                        this.initNotices();
                                    });
                                },

                                loadUserClass: async function (uid) {
                                    try {
                                        const doc = await window.getCollection('users').doc(uid).get();
                                        if (doc.exists) {
                                            const d = doc.data();
                                            if (d.grade && d.class) {
                                                this.userClassStr = `${d.grade}-${d.class}`;
                                            }
                                        }
                                    } catch (e) { console.error(e); }
                                },

                                //Helper function to get year/semester based collection path
                                getCollectionPath: function (collectionName) {
                                    const cfg = window.currentConfig;
                                    if (!cfg || !cfg.year || !cfg.semester) {
                                        console.error('Global config not loaded properly');
                                        return null;
                                    }
                                    // EXCEPTION: calendar uses years/{year}/calendar (no semester)
                                    if (collectionName === 'calendar') {
                                        return `years/${cfg.year}/calendar`;
                                    }
                                    // All other collections use semesters path
                                    return `years/${cfg.year}/semesters/${cfg.semester}/${collectionName}`;
                                },

                                // --- Notice Board Logic (Read-Only) ---
                                initNotices: function () {
                                    const container = document.getElementById('notice-list');
                                    const path = this.getCollectionPath('notices');
                                    if (!path) return;

                                    window.db.collection(path).orderBy('createdAt', 'desc').onSnapshot(snapshot => {
                                        if (snapshot.empty) {
                                            container.innerHTML = '<div class="text-center text-amber-800/50 py-10 font-bold text-sm">ë“±ë¡ëœ ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                                            return;
                                        }

                                        const notices = [];
                                        snapshot.forEach(doc => {
                                            const d = doc.data();
                                            // Filter: Common OR User's Class
                                            if (d.targetType === 'common' || (this.userClassStr && d.targetType === 'class' && d.targetClass === this.userClassStr)) {
                                                notices.push({ id: doc.id, ...d });
                                            }
                                        });

                                        if (notices.length === 0) {
                                            container.innerHTML = '<div class="text-center text-amber-800/50 py-10 font-bold text-sm">ìš°ë¦¬ ë°˜ ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                                            return;
                                        }

                                        container.innerHTML = notices.map(d => {
                                            // Badge Style Logic
                                            let badge = '';
                                            if (d.category === 'normal') badge = '<span class="bg-red-500 text-white px-2 py-0.5 rounded text-xs font-bold">ğŸ“¢ ê³µì§€</span>';
                                            else if (d.category === 'exam') badge = '<span class="bg-blue-500 text-white px-2 py-0.5 rounded text-xs font-bold">ğŸ”¥ ì •ê¸°</span>';
                                            else if (d.category === 'performance') badge = '<span class="bg-green-500 text-white px-2 py-0.5 rounded text-xs font-bold">âš¡ ìˆ˜í–‰</span>';
                                            else if (d.category === 'prep') badge = '<span class="bg-yellow-500 text-white px-2 py-0.5 rounded text-xs font-bold">ğŸ’ ì¤€ë¹„</span>';
                                            else if (d.category === 'dday') {
                                                let dDayStr = 'D-Day';
                                                if (d.targetDate) {
                                                    const today = new Date();
                                                    today.setHours(0, 0, 0, 0);
                                                    const target = new Date(d.targetDate);
                                                    target.setHours(0, 0, 0, 0);
                                                    const diff = Math.ceil((target - today) / (1000 * 60 * 60 * 24));
                                                    dDayStr = diff > 0 ? `D-${diff}` : (diff === 0 ? 'D-Day' : `D+${Math.abs(diff)}`);
                                                }
                                                badge = `<span class="bg-purple-500 text-white px-2 py-0.5 rounded text-xs font-bold">â³ ${dDayStr}</span>`;
                                            } else {
                                                badge = '<span class="bg-gray-500 text-white px-2 py-0.5 rounded text-xs font-bold">ğŸ“¢ ì•Œë¦¼</span>';
                                            }

                                            // Parse new lines
                                            const content = d.content.replace(/\n/g, '<br>');

                                            // Mobile-optimized card
                                            return `
                            <div class="bg-white/80 p-3 rounded-lg border border-yellow-200 shadow-sm relative group mb-2">
                                <div class="flex justify-between items-center mb-2">
                                    ${badge}
                                    <span class="text-[10px] text-amber-800/60 font-mono">${new Date(d.createdAt.seconds * 1000).toLocaleDateString()}</span>
                                </div>
                                <div class="text-gray-800 text-sm font-bold leading-relaxed whitespace-pre-wrap">${content}</div>
                            </div>
                        `;
                                        }).join('');
                                    });
                                },

                                // --- Detail Panel Logic (Read-Only) ---
                                showEventsOnPanel: function (dateStr, events) {
                                    const container = document.getElementById('detail-panel-content');
                                    const dateDisplay = document.getElementById('detail-date-display');

                                    // Format Date
                                    const dateObj = new Date(dateStr);
                                    const days = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
                                    dateDisplay.innerHTML = `<span class="inline-flex items-center bg-blue-50 border-2 border-blue-300 rounded-lg px-3 py-1"><span class="text-lg font-extrabold text-blue-800">${dateObj.getMonth() + 1}ì›” ${dateObj.getDate()}ì¼</span><span class="ml-1 text-sm font-bold text-blue-500">(${days[dateObj.getDay()]})</span></span>`;

                                    if (events.length === 0) {
                                        container.innerHTML = `
                        <div class="flex flex-col items-center justify-center h-40 text-gray-400">
                            <i class="far fa-calendar-times text-3xl mb-2"></i>
                            <p class="text-sm">ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                        </div>
                    `;
                                        return;
                                    }

                                    container.innerHTML = events.map(ev => {
                                        // Render holiday events with special styling
                                        if (ev.classNames && ev.classNames.includes('holiday-text-event')) {
                                            return `
                        <div class="group p-3 border-l-4 border-red-400 bg-red-50 mb-3 rounded-r-lg">
                            <div class="flex items-center gap-2">
                                <span class="text-[10px] text-white px-1.5 py-0.5 rounded font-bold bg-red-500">ê³µíœ´ì¼</span>
                                <h4 class="font-bold text-red-700 text-sm">${ev.title}</h4>
                            </div>
                        </div>
                    `;
                                        }
                                        const p = ev.extendedProps || ev;
                                        return `
                        <div class="group p-3 border-l-4 border-gray-200 bg-gray-50 mb-3 rounded-r-lg">
                            <div class="flex justify-between items-start">
                                <div>
                                    <div class="flex items-center gap-2 mb-1">
                                        <span class="text-[10px] text-white px-1.5 py-0.5 rounded font-bold" style="background-color: ${p.backgroundColor || this.colorMap[p.eventType] || '#999'}">${this.typeLabelMap[p.eventType] || 'ì¼ì •'}</span>
                                        <h4 class="font-bold text-gray-800 text-sm">${p.title}</h4>
                                    </div>
                                    <p class="text-xs text-gray-500">${p.start} ${p.end && p.start !== p.end ? '~ ' + p.end : ''}</p>
                                </div>
                            </div>
                            ${p.description ? `<p class="text-xs text-gray-600 mt-2 bg-gray-100 p-2 rounded">${p.description}</p>` : ''}
                        </div>
                    `;
                                    }).join('');
                                },

                                initCalendar: function () {
                                    const calendarEl = document.getElementById('calendar');

                                    this.calendar = new FullCalendar.Calendar(calendarEl, {
                                        initialView: 'dayGridMonth',
                                        locale: 'ko',
                                        headerToolbar: {
                                            left: 'prev,next today',
                                            center: 'title',
                                            right: 'dayGridMonth,listMonth'
                                        },
                                        dayCellClassNames: (arg) => {
                                            const dateStr = arg.date.toISOString().split('T')[0];
                                            const evts = this.calendar ? this.calendar.getEvents() : [];
                                            const isHoliday = evts.some(e => e.startStr === dateStr && e.extendedProps && e.extendedProps.eventType === 'holiday');
                                            return isHoliday ? ['fc-day-holiday'] : [];
                                        },
                                        events: [this.fetchEvents.bind(this)],
                                        dateClick: (info) => {
                                            // Find events for this date
                                            const allEvents = this.calendar.getEvents();
                                            const dailyEvents = allEvents.filter(e => {
                                                const start = new Date(e.startStr);
                                                const end = e.end ? new Date(e.endStr) : new Date(start);
                                                const target = new Date(info.dateStr);
                                                if (!e.end) return e.startStr === info.dateStr;
                                                return target >= start && target < end;
                                            }); // Include holidays too

                                            this.showEventsOnPanel(info.dateStr, dailyEvents);
                                        },
                                        eventClick: (info) => {
                                            if (info.event.classNames.includes('holiday-text-event')) return;
                                            const startStr = info.event.startStr.split('T')[0];
                                            this.showEventsOnPanel(startStr, [info.event]);
                                        },
                                        height: '100%',
                                        contentHeight: '100%',
                                        expandRows: true,
                                        displayEventTime: false,
                                        fixedWeekCount: false,
                                        showNonCurrentDates: false,
                                    });
                                    this.calendar.render();
                                },

                                fetchEvents: async function (info, successCallback, failureCallback) {
                                    try {
                                        // Fetch logic same as before: generic fetch then client filter if needed,
                                        // or filtered query if possible. To be safe, we fetch range and filter in memory for class.
                                        const snapshot = await window.db.collection(this.getCollectionPath('calendar') || 'calendar')
                                            .where('start', '>=', info.startStr)
                                            .where('start', '<', info.endStr)
                                            .get();

                                        const events = [];
                                        snapshot.forEach(doc => {
                                            const d = doc.data();

                                            // Filter by Class (Common or My Class)
                                            if (d.targetType === 'class' && d.targetClass !== this.userClassStr) return;

                                            const isHoliday = d.eventType === 'holiday';
                                            events.push({
                                                id: doc.id,
                                                title: d.title,
                                                start: d.start,
                                                end: d.end || d.start,
                                                backgroundColor: isHoliday ? 'transparent' : (this.colorMap[d.eventType] || '#6b7280'),
                                                borderColor: isHoliday ? 'transparent' : (this.colorMap[d.eventType] || '#6b7280'),
                                                textColor: isHoliday ? '#ef4444' : undefined,
                                                classNames: isHoliday ? ['holiday-text-event'] : [],
                                                extendedProps: d
                                            });
                                        });
                                        successCallback(events);
                                    } catch (e) { console.error(e); failureCallback(e); }
                                }
                            };

                            app.init();
                        </script>
</body>

</html>