<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í•™ìƒ ëŒ€ì‹œë³´ë“œ - Westory</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- FullCalendar -->
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="../assets/js/firebase-config.js"></script>
    <link rel="stylesheet" href="../assets/css/style.css">
    <script src="../assets/js/auth-manager.js"></script>

    <style>
        .dashboard-container {
            max-width: 1280px;
            margin: 0 auto;
            padding: 24px 16px;
            width: 100%;
            display: flex;
            flex-direction: column;
            height: calc(100vh - 80px);
            /* Adjust for header/footer */
        }

        @media (min-width: 768px) {
            .dashboard-container {
                padding: 24px 40px;
            }
        }

        /* Calendar Styles from student/calendar.html */
        .fc-toolbar-title {
            font-size: 1.25em !important;
            font-weight: 700;
            color: #1f2937;
        }

        .fc-button {
            background-color: #2563eb !important;
            border-color: #2563eb !important;
            font-weight: 600 !important;
        }

        .fc-daygrid-event {
            cursor: pointer;
            border-radius: 4px;
            padding: 2px 4px;
            font-size: 0.8rem;
            font-weight: 600;
            border: none;
            transition: transform 0.1s;
        }

        .fc-daygrid-event:hover {
            transform: scale(1.02);
        }

        .fc-day-sun a {
            color: #ef4444 !important;
            text-decoration: none;
            font-weight: 700;
        }

        .fc-day-sat a {
            color: #3b82f6 !important;
            text-decoration: none;
            font-weight: 700;
        }

        .fc-day-holiday a {
            color: #ef4444 !important;
            font-weight: 700;
        }

        .holiday-text-event {
            background-color: transparent !important;
            border: none !important;
        }

        .holiday-text-event .fc-event-title {
            color: #ef4444;
            font-size: 0.75rem;
            font-weight: 800;
        }

        .fc-event-main {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 100;
            display: flex;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(2px);
        }

        @media (max-width: 768px) {
            .fc-toolbar {
                flex-direction: column;
                gap: 0.5rem;
            }

            .fc-toolbar-title {
                font-size: 1rem !important;
            }

            .fc-button {
                padding: 0.25rem 0.5rem !important;
                font-size: 0.75rem !important;
            }

            .fc-header-toolbar {
                margin-bottom: 0.5rem !important;
            }
        }

        /* Mobile: Separate containers clearly */
        @media (max-width: 1024px) {
            .dashboard-container {
                overflow: visible !important;
                height: auto !important;
            }

            .md\:h-\[calc\(100vh-140px\)\] {
                height: auto !important;
            }

            /* Each container gets explicit spacing and borders */
            .order-1,
            .order-2,
            .order-3 {
                min-height: 280px;
                margin-bottom: 8px;
                border-radius: 12px;
                overflow: hidden;
            }
        }

        /* Selected Date Cell Highlight */
        .fc-day-selected {
            background-color: #f3f4f6 !important;
            outline: 2px solid #3b82f6 !important;
            outline-offset: -2px !important;
        }
    </style>
</head>

<body class="bg-gray-50 flex flex-col">
    <!-- Header injected by AuthManager -->

    <main class="dashboard-container">
        <div class="mb-6 flex flex-col md:flex-row justify-between items-center gap-3 shrink-0">
            <div class="flex items-center gap-3">
                <h1 class="text-2xl md:text-3xl font-extrabold text-gray-900 tracking-tight" id="welcome-text"><i
                        class="fas fa-spinner fa-spin text-gray-300"></i></h1>
                <span id="semester-badge"
                    class="bg-blue-600 text-white font-bold px-3 py-1 rounded-full text-xs md:text-sm shadow-md shrink-0">
                    <i class="fas fa-spinner fa-spin"></i>
                </span>
            </div>


        </div>

        <!-- Main Content Area (Mobile: Flex-Col / Desktop: Grid) -->
        <div
            class="flex flex-col md:grid md:grid-cols-5 md:grid-rows-2 gap-4 h-auto md:h-[calc(100vh-140px)] min-h-[500px]">

            <!-- 1. Notice Board (Mobile: Order 1 / Desktop: Order 2, Right Top) -->
            <div
                class="order-1 md:order-2 md:col-span-2 md:row-span-1 bg-[#fffbeb] rounded-xl shadow-sm border border-yellow-200 p-4 flex flex-col relative overflow-hidden min-h-[300px] md:min-h-0">
                <div class="flex justify-between items-center mb-3 border-b border-yellow-200 pb-2">
                    <h3 class="text-lg font-extrabold text-amber-800 flex items-center">
                        <i class="fas fa-thumbtack mr-2 text-amber-600"></i>ì•Œë¦¼ì¥
                    </h3>
                </div>
                <div id="notice-list" class="flex-1 overflow-y-auto space-y-3 pr-2 custom-scroll">
                    <div class="text-center text-amber-800/50 py-10 font-bold text-sm">ë“±ë¡ëœ ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>
                </div>
            </div>

            <!-- 2. Calendar (Mobile: Order 2 / Desktop: Order 1, Left Full Height) -->
            <div
                class="order-2 md:order-1 md:col-span-3 md:row-span-2 bg-white rounded-xl shadow-sm p-4 flex flex-col min-h-[500px] md:min-h-0">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-2 gap-2">
                    <h2 class="text-lg font-bold text-gray-800 whitespace-nowrap"><i
                            class="far fa-calendar-alt mr-2 text-blue-600"></i>í•™ì‚¬ ì¼ì •</h2>

                    <button onclick="app.openSearch()"
                        class="bg-gray-50 border border-gray-200 text-gray-600 hover:text-blue-600 p-1.5 rounded-lg transition"
                        title="ì¼ì • ê²€ìƒ‰">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
                <div id="calendar" class="flex-1"></div>
            </div>

            <!-- 3. Event Details (Mobile: Order 3 / Desktop: Order 3, Right Bottom) -->
            <div
                class="order-3 md:order-3 md:col-span-2 md:row-span-1 bg-white rounded-xl shadow-sm border border-gray-200 p-4 flex flex-col min-h-[300px] md:min-h-0">
                <div class="flex justify-between items-center mb-3 border-b border-gray-100 pb-2">
                    <h3 class="text-lg font-bold text-gray-800 flex items-center">
                        <i class="fas fa-info-circle mr-2 text-blue-500"></i>ì¼ì • ìƒì„¸
                    </h3>
                    <span id="detail-date-display" class="text-sm font-bold text-gray-500">ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”</span>
                </div>
                <div id="detail-panel-content" class="flex-1 overflow-y-auto pr-2 custom-scroll">
                    <div class="flex flex-col items-center justify-center h-full text-gray-400">
                        <i class="far fa-calendar-check text-4xl mb-3 text-gray-200"></i>
                        <p class="text-sm">ë‹¬ë ¥ì—ì„œ ë‚ ì§œë‚˜ ì¼ì •ì„ í´ë¦­í•˜ë©´<br>ìƒì„¸ ë‚´ìš©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <!-- Detail Modal (Read-Only) -->
    <div id="detail-modal" class="modal-overlay hidden" onclick="app.closeDetailModal()">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 mx-4 relative transform transition-all scale-100"
            onclick="event.stopPropagation()">
            <div class="mb-4">
                <span id="detail-badge"
                    class="px-2 py-1 rounded text-xs font-bold text-white bg-gray-500 inline-block mb-2">TYPE</span>
                <h3 id="detail-title" class="text-xl font-bold text-gray-900 leading-tight">ì¼ì • ì œëª©</h3>
            </div>
            <div class="space-y-3 text-sm text-gray-600 bg-gray-50 p-4 rounded-xl border border-gray-100 mb-6">
                <div class="flex items-start gap-3">
                    <i class="fas fa-clock mt-1 text-blue-500"></i>
                    <div>
                        <p class="font-bold text-gray-800">ê¸°ê°„</p>
                        <p id="detail-date" class="text-gray-600">-</p>
                    </div>
                </div>
                <div class="flex items-start gap-3">
                    <i class="fas fa-align-left mt-1 text-green-500"></i>
                    <div>
                        <p class="font-bold text-gray-800">ì„¤ëª…</p>
                        <p id="detail-desc" class="text-gray-600">-</p>
                    </div>
                </div>
            </div>
            <button onclick="app.closeDetailModal()"
                class="w-full py-2.5 bg-gray-100 text-gray-700 rounded-xl font-bold hover:bg-gray-200 transition">ë‹«ê¸°</button>
        </div>
    </div>

    <!-- Search Modal -->
    <div id="search-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 items-start justify-center pt-20"
        onclick="app.closeSearch()">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6 m-4" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800"><i class="fas fa-search text-blue-500 mr-2"></i>ì¼ì • ê²€ìƒ‰</h3>
                <button onclick="app.closeSearch()" class="text-gray-400 hover:text-gray-600 transition">
                    <i class="fas fa-times fa-lg"></i>
                </button>
            </div>
            <div class="relative mb-4">
                <input type="text" id="modal-search-input" onkeyup="if(event.key === 'Enter') app.executeSearch()"
                    class="w-full border-2 border-blue-100 rounded-xl p-3 pl-10 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 outline-none transition font-bold text-lg"
                    placeholder="ê²€ìƒ‰ì–´ ì…ë ¥ (ì˜ˆ: ì •ê¸° ì‹œí—˜, ìˆ˜í–‰í‰ê°€ ë“±)">
                <i class="fas fa-search absolute left-4 top-4 text-gray-400"></i>
                <button onclick="app.executeSearch()"
                    class="absolute right-2 top-2 bg-blue-600 text-white px-4 py-1.5 rounded-lg font-bold hover:bg-blue-700 transition">ê²€ìƒ‰</button>
            </div>
            <div id="modal-search-results" class="h-64 overflow-y-auto custom-scroll space-y-2">
                <div class="text-center text-gray-400 py-10">ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ê³  ì—”í„°ë¥¼ ëˆ„ë¥´ì„¸ìš”.</div>
            </div>
        </div>
    </div>

    <!-- Footer injected by AuthManager -->

    <script>
        window.AuthManager.init('student');

        const app = {
            calendar: null,
            userClassStr: null, // "2-1" etc.
            colorMap: {
                'exam': '#ef4444',       // Red
                'performance': '#f97316', // Orange
                'event': '#10b981',       // Green
                'diagnosis': '#3b82f6',   // Blue
                'formative': '#3b82f6'    // Blue
            },
            typeLabelMap: {
                'exam': 'ì •ê¸° ì‹œí—˜', 'performance': 'ìˆ˜í–‰í‰ê°€', 'event': 'í–‰ì‚¬', 'diagnosis': 'ì§„ë‹¨í‰ê°€', 'formative': 'í˜•ì„±í‰ê°€'
            },
            holidays: {},

            init: function () {
                document.addEventListener('auth-ready', async (e) => {
                    const user = e.detail;
                    await this.loadUserClass(user.uid);
                    await this.updateWelcomeMessage(user); // Updated to support custom labels

                    const cfg = window.currentConfig;
                    if (cfg) document.getElementById('semester-badge').innerText = `${cfg.year}í•™ë…„ë„ ${cfg.semester}í•™ê¸°`;

                    this.initCalendar();
                    this.initNotices();
                });
            },

            loadUserClass: async function (uid) {
                try {
                    const doc = await window.getCollection('users').doc(uid).get();
                    if (doc.exists) {
                        const d = doc.data();
                        if (d.grade && d.class) {
                            this.userClassStr = `${d.grade}-${d.class}`;
                            this.userGrade = d.grade; // Store raw grade
                            this.userClass = d.class; // Store raw class
                        }
                    }
                } catch (e) { console.error(e); }
            },

            updateWelcomeMessage: async function (user) {
                let gradeLabel = this.userGrade ? this.userGrade + 'í•™ë…„' : '';
                let classLabel = this.userClass ? this.userClass + 'ë°˜' : '';

                try {
                    // Fetch school config for custom labels
                    const doc = await window.db.collection('site_settings').doc('school_config').get();
                    if (doc.exists) {
                        const data = doc.data();
                        if (data.grades) {
                            const gObj = data.grades.find(g => g.value === String(this.userGrade));
                            if (gObj) gradeLabel = gObj.label;
                        }
                        if (data.classes) {
                            const cObj = data.classes.find(c => c.value === String(this.userClass));
                            if (cObj) classLabel = cObj.label;
                        }
                    }
                } catch (e) { console.error("Config load error:", e); }

                if (this.userClassStr) {
                    document.getElementById('welcome-text').innerText = `${gradeLabel} ${classLabel}ì˜ ëŒ€ì‹œë³´ë“œ`;
                } else {
                    document.getElementById('welcome-text').innerText = `${user.displayName || 'í•™ìƒ'}ë‹˜ì˜ ëŒ€ì‹œë³´ë“œ`;
                }
            },

            getCollectionPath: function (collectionName) {
                const cfg = window.currentConfig;
                if (!cfg || !cfg.year || !cfg.semester) {
                    console.error('Global config not loaded properly');
                    return null;
                }
                // FIXED: Calendar also uses semester path to match Teacher's write path
                return `years/${cfg.year}/semesters/${cfg.semester}/${collectionName}`;
            },

            // --- Search Functions (Modal-Based, like Teacher) ---
            openSearch: function () {
                document.getElementById('modal-search-input').value = '';
                document.getElementById('modal-search-results').innerHTML = '<div class="text-center text-gray-400 py-10">ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ê³  ì—”í„°ë¥¼ ëˆ„ë¥´ì„¸ìš”.</div>';
                document.getElementById('search-modal').classList.remove('hidden');
                document.getElementById('search-modal').classList.add('flex');
                document.getElementById('modal-search-input').focus();
            },

            closeSearch: function () {
                document.getElementById('search-modal').classList.add('hidden');
                document.getElementById('search-modal').classList.remove('flex');
            },

            executeSearch: async function () {
                const query = document.getElementById('modal-search-input').value.trim();
                const resultsEl = document.getElementById('modal-search-results');
                if (!query) {
                    resultsEl.innerHTML = '<div class="text-center text-gray-400 py-10">ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</div>';
                    return;
                }
                resultsEl.innerHTML = '<div class="text-center text-gray-400 py-10"><i class="fas fa-spinner fa-spin mr-2"></i>ê²€ìƒ‰ ì¤‘...</div>';

                try {
                    const path = this.getCollectionPath('calendar');
                    if (!path) { resultsEl.innerHTML = '<div class="text-center text-red-500 py-10">ê²½ë¡œ ì˜¤ë¥˜</div>'; return; }
                    const snapshot = await window.db.collection(path).get();
                    const results = [];
                    const q = query.toLowerCase();

                    snapshot.forEach(doc => {
                        const d = doc.data();
                        // Student filter: common, holiday, or my class only
                        const isCommon = d.targetType === 'common';
                        const isHoliday = d.eventType === 'holiday';
                        const isMyClass = d.targetType === 'class' && d.targetClass === this.userClassStr;
                        if (!isCommon && !isHoliday && !isMyClass) return;

                        const titleMatch = d.title && d.title.toLowerCase().includes(q);
                        const descMatch = d.description && d.description.toLowerCase().includes(q);
                        if (titleMatch || descMatch) {
                            results.push({ id: doc.id, ...d });
                        }
                    });

                    if (results.length === 0) {
                        resultsEl.innerHTML = `<div class="text-center text-gray-400 py-10">
                            <i class="far fa-folder-open text-2xl mb-2"></i><br>
                            "${query}"ì´(ê°€) í¬í•¨ëœ ì œëª© ë˜ëŠ” ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.
                        </div>`;
                    } else {
                        resultsEl.innerHTML = results.map(r => {
                            const bgColor = this.colorMap[r.eventType] || '#6b7280';
                            const typeLabel = this.typeLabelMap[r.eventType] || 'ì¼ì •';
                            return `
                                <div onclick="app.closeSearch(); app.showSearchResult('${r.start}')" 
                                     class="p-3 border-b border-gray-100 hover:bg-blue-50 cursor-pointer rounded-lg transition">
                                    <div class="flex items-center gap-2 mb-1">
                                        <span class="text-[10px] text-white px-1.5 py-0.5 rounded font-bold" style="background-color:${bgColor}">${typeLabel}</span>
                                        <span class="font-bold text-sm text-gray-800">${r.title}</span>
                                    </div>
                                    <div class="text-xs text-gray-500">${r.start}${r.end && r.start !== r.end ? ' ~ ' + r.end : ''}</div>
                                    ${r.description ? `<div class="text-xs text-gray-400 mt-1 truncate">${r.description}</div>` : ''}
                                </div>
                            `;
                        }).join('');
                    }
                } catch (e) {
                    console.error('[Student Search] Error:', e);
                    resultsEl.innerHTML = '<div class="text-center text-red-500 py-10">ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
                }
            },

            showSearchResult: function (dateStr) {
                if (this.calendar) this.calendar.gotoDate(dateStr);
            },

            fetchEvents: async function (info, successCallback, failureCallback) {
                try {
                    const path = this.getCollectionPath('calendar');
                    if (!path) { console.error('[Student Calendar] No collection path'); return successCallback([]); }

                    // CRITICAL FIX: Extract YYYY-MM-DD from ISO string (matches Teacher's format)
                    const startYMD = info.startStr.split('T')[0];
                    const endYMD = info.endStr.split('T')[0];
                    console.log('[Student Calendar] fetchEvents called. Path:', path, 'Range:', startYMD, '~', endYMD);

                    const snapshot = await window.db.collection(path)
                        .where('start', '>=', startYMD)
                        .where('start', '<', endYMD)
                        .get();

                    console.log('[Student Calendar] Snapshot size:', snapshot.size);

                    const events = [];

                    snapshot.forEach(doc => {
                        const d = doc.data();

                        // Filter: Common OR Holiday OR My Class
                        const isCommon = d.targetType === 'common';
                        const isHoliday = d.eventType === 'holiday';
                        const isMyClass = d.targetType === 'class' && d.targetClass === this.userClassStr;

                        if (!isCommon && !isHoliday && !isMyClass) return;

                        events.push({
                            id: doc.id,
                            title: d.title,
                            start: d.start,
                            end: d.end || d.start,
                            backgroundColor: isHoliday ? 'transparent' : (this.colorMap[d.eventType] || '#6b7280'),
                            borderColor: isHoliday ? 'transparent' : (this.colorMap[d.eventType] || '#6b7280'),
                            textColor: isHoliday ? '#ef4444' : undefined,
                            classNames: isHoliday ? ['holiday-text-event'] : [],
                            extendedProps: d
                        });
                    });
                    console.log('[Student Calendar] Events after filter:', events.length);
                    successCallback(events);
                } catch (e) {
                    console.error('[Student Calendar] fetchEvents error:', e);
                    failureCallback(e);
                }
            },

            // --- Notice Board Logic (Read-Only) ---
            initNotices: function () {
                const container = document.getElementById('notice-list');
                const path = this.getCollectionPath('notices');
                if (!path) return;

                window.db.collection(path).orderBy('createdAt', 'desc').onSnapshot(snapshot => {
                    if (snapshot.empty) {
                        container.innerHTML = '<div class="text-center text-amber-800/50 py-10 font-bold text-sm">ë“±ë¡ëœ ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                        return;
                    }

                    const notices = [];
                    snapshot.forEach(doc => {
                        const d = doc.data();
                        if (d.targetType === 'common' || (this.userClassStr && d.targetType === 'class' && d.targetClass === this.userClassStr)) {
                            notices.push({ id: doc.id, ...d });
                        }
                    });

                    if (notices.length === 0) {
                        container.innerHTML = '<div class="text-center text-amber-800/50 py-10 font-bold text-sm">ìš°ë¦¬ ë°˜ ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                        return;
                    }

                    container.innerHTML = notices.map(d => {
                        let badge = '';
                        if (d.category === 'normal') badge = '<span class="bg-red-500 text-white px-2 py-0.5 rounded text-xs font-bold">ğŸ“¢ ê³µì§€</span>';
                        else if (d.category === 'exam') badge = '<span class="bg-blue-500 text-white px-2 py-0.5 rounded text-xs font-bold">ğŸ”¥ ì •ê¸°</span>';
                        else if (d.category === 'performance') badge = '<span class="bg-green-500 text-white px-2 py-0.5 rounded text-xs font-bold">âš¡ ìˆ˜í–‰</span>';
                        else if (d.category === 'prep') badge = '<span class="bg-yellow-500 text-white px-2 py-0.5 rounded text-xs font-bold">ğŸ’ ì¤€ë¹„</span>';
                        else if (d.category === 'dday') {
                            let dDayStr = 'D-Day';
                            if (d.targetDate) {
                                const today = new Date(); today.setHours(0, 0, 0, 0);
                                const target = new Date(d.targetDate); target.setHours(0, 0, 0, 0);
                                const diff = Math.ceil((target - today) / (1000 * 60 * 60 * 24));
                                dDayStr = diff > 0 ? 'D-' + diff : (diff === 0 ? 'D-Day' : 'D+' + Math.abs(diff));
                            }
                            badge = '<span class="bg-purple-500 text-white px-2 py-0.5 rounded text-xs font-bold">â³ ' + dDayStr + '</span>';
                        } else {
                            badge = '<span class="bg-gray-500 text-white px-2 py-0.5 rounded text-xs font-bold">ğŸ“¢ ì•Œë¦¼</span>';
                        }
                        const content = d.content.replace(/\n/g, '<br>');
                        return '<div class="bg-white/80 p-3 rounded-lg border border-yellow-200 shadow-sm relative group mb-2">' +
                            '<div class="flex justify-between items-center mb-2">' + badge +
                            '<span class="text-[10px] text-amber-800/60 font-mono">' + new Date(d.createdAt.seconds * 1000).toLocaleDateString() + '</span></div>' +
                            '<div class="text-gray-800 text-sm font-bold leading-relaxed whitespace-pre-wrap">' + content + '</div></div>';
                    }).join('');
                });
            },

            // --- Detail Panel Logic (Read-Only) ---
            showEventsOnPanel: function (dateStr, events) {
                const container = document.getElementById('detail-panel-content');
                const dateDisplay = document.getElementById('detail-date-display');
                const dateObj = new Date(dateStr);
                const days = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
                dateDisplay.innerHTML = '<span class="inline-flex items-center bg-blue-50 border-2 border-blue-300 rounded-lg px-3 py-1"><span class="text-lg font-extrabold text-blue-800">' + (dateObj.getMonth() + 1) + 'ì›” ' + dateObj.getDate() + 'ì¼</span><span class="ml-1 text-sm font-bold text-blue-500">(' + days[dateObj.getDay()] + ')</span></span>';

                if (events.length === 0) {
                    container.innerHTML = '<div class="flex flex-col items-center justify-center h-40 text-gray-400"><i class="far fa-calendar-times text-3xl mb-2"></i><p class="text-sm">ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</p></div>';
                    return;
                }

                container.innerHTML = events.map(ev => {
                    if (ev.classNames && ev.classNames.includes('holiday-text-event')) {
                        return '<div class="group p-3 border-l-4 border-red-400 bg-red-50 mb-3 rounded-r-lg"><div class="flex items-center gap-2"><span class="text-[10px] text-white px-1.5 py-0.5 rounded font-bold bg-red-500">ê³µíœ´ì¼</span><h4 class="font-bold text-red-700 text-sm">' + ev.title + '</h4></div></div>';
                    }
                    const p = ev.extendedProps || ev;
                    const bgColor = p.backgroundColor || this.colorMap[p.eventType] || '#999';
                    const typeLabel = this.typeLabelMap[p.eventType] || 'ì¼ì •';
                    // Escape values for onclick
                    const safeTitle = (p.title || '').replace(/'/g, "\\'");
                    const safeDesc = (p.description || '').replace(/'/g, "\\'").replace(/\n/g, '\\n');
                    const safeStart = p.start || '';
                    const safeEnd = p.end || '';
                    const safeType = p.eventType || '';
                    let html = '<div class="group p-3 border-l-4 border-gray-200 bg-gray-50 mb-3 rounded-r-lg cursor-pointer hover:bg-gray-100 transition" onclick="app.openDetailModal(\'' + safeType + '\', \'' + safeTitle + '\', \'' + safeStart + '\', \'' + safeEnd + '\', \'' + safeDesc + '\')">';
                    html += '<div class="flex justify-between items-start"><div>';
                    html += '<div class="flex items-center gap-2 mb-1">';
                    html += '<span class="text-[10px] text-white px-1.5 py-0.5 rounded font-bold" style="background-color:' + bgColor + '">' + typeLabel + '</span>';
                    html += '<h4 class="font-bold text-gray-800 text-sm">' + p.title + '</h4></div>';
                    html += '<p class="text-xs text-gray-500">' + p.start + (p.end && p.start !== p.end ? ' ~ ' + p.end : '') + '</p>';
                    html += '</div></div>';
                    if (p.description) html += '<p class="text-xs text-gray-600 mt-2 bg-gray-100 p-2 rounded">' + p.description + '</p>';
                    html += '</div>';
                    return html;
                }).join('');
            },

            openDetailModal: function (eventType, title, start, end, description) {
                const bgColor = this.colorMap[eventType] || '#6b7280';
                const typeLabel = this.typeLabelMap[eventType] || 'ì¼ì •';
                const badgeEl = document.getElementById('detail-badge');
                badgeEl.textContent = typeLabel;
                badgeEl.style.backgroundColor = bgColor;
                document.getElementById('detail-title').textContent = title;
                document.getElementById('detail-date').textContent = start + (end && start !== end ? ' ~ ' + end : '');
                const descEl = document.getElementById('detail-desc');
                descEl.textContent = description || 'ì„¤ëª… ì—†ìŒ';
                descEl.style.whiteSpace = 'pre-wrap';
                document.getElementById('detail-modal').classList.remove('hidden');
            },

            closeDetailModal: function () {
                document.getElementById('detail-modal').classList.add('hidden');
            },

            initCalendar: function () {
                const calendarEl = document.getElementById('calendar');
                this.calendar = new FullCalendar.Calendar(calendarEl, {
                    initialView: 'dayGridMonth',
                    locale: 'ko',
                    headerToolbar: {
                        left: 'prev,next today',
                        center: 'title',
                        right: 'dayGridMonth,listMonth'
                    },
                    dayCellClassNames: (arg) => {
                        const y = arg.date.getFullYear();
                        const m = String(arg.date.getMonth() + 1).padStart(2, '0');
                        const d = String(arg.date.getDate()).padStart(2, '0');
                        const dateStr = `${y}-${m}-${d}`;
                        const evts = this.calendar ? this.calendar.getEvents() : [];
                        const isHoliday = evts.some(e => e.startStr === dateStr && e.extendedProps && e.extendedProps.eventType === 'holiday');
                        return isHoliday ? ['fc-day-holiday'] : [];
                    },
                    events: this.fetchEvents.bind(this),
                    dateClick: (info) => {
                        const allEvents = this.calendar.getEvents();
                        const dailyEvents = allEvents.filter(e => {
                            const start = new Date(e.startStr);
                            const end = e.end ? new Date(e.endStr) : new Date(start);
                            const target = new Date(info.dateStr);
                            if (!e.end) return e.startStr === info.dateStr;
                            return target >= start && target < end;
                        });

                        // Visual feedback for selection
                        if (this.selectedDateEl) this.selectedDateEl.classList.remove('fc-day-selected');
                        this.selectedDateEl = info.dayEl;
                        this.selectedDateEl.classList.add('fc-day-selected');

                        this.showEventsOnPanel(info.dateStr, dailyEvents);
                    },
                    eventClick: (info) => {
                        if (info.event.classNames.includes('holiday-text-event')) return;
                        const p = info.event.extendedProps || {};
                        this.openDetailModal(
                            p.eventType || '',
                            info.event.title || '',
                            p.start || info.event.startStr.split('T')[0],
                            p.end || '',
                            p.description || ''
                        );
                    },
                    height: '100%',
                    contentHeight: '100%',
                    expandRows: true,
                    displayEventTime: false,
                    fixedWeekCount: false,
                    showNonCurrentDates: false,
                });
                this.calendar.render();
            }
        };

        app.init();
    </script>
</body>

</html>