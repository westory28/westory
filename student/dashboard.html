<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í•™ìƒ ëŒ€ì‹œë³´ë“œ - Westory</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- FullCalendar -->
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="../assets/js/firebase-config.js"></script>
    <link rel="stylesheet" href="../assets/css/style.css">
    <script src="../assets/js/auth-manager.js"></script>

    <style>
        .dashboard-container {
            max-width: 1280px;
            margin: 0 auto;
            padding: 24px 16px;
            width: 100%;
            display: flex;
            flex-direction: column;
            height: calc(100vh - 80px);
            /* Adjust for header/footer */
        }

        @media (min-width: 768px) {
            .dashboard-container {
                padding: 24px 40px;
            }
        }

        /* Calendar Styles from student/calendar.html */
        .fc-toolbar-title {
            font-size: 1.25em !important;
            font-weight: 700;
            color: #1f2937;
        }

        .fc-button {
            background-color: #2563eb !important;
            border-color: #2563eb !important;
            font-weight: 600 !important;
        }

        .fc-daygrid-event {
            cursor: pointer;
            border-radius: 4px;
            padding: 2px 4px;
            font-size: 0.8rem;
            font-weight: 600;
            border: none;
            transition: transform 0.1s;
        }

        .fc-daygrid-event:hover {
            transform: scale(1.02);
        }

        .fc-day-sun a {
            color: #ef4444 !important;
            text-decoration: none;
            font-weight: 700;
        }

        .fc-day-sat a {
            color: #3b82f6 !important;
            text-decoration: none;
            font-weight: 700;
        }

        .fc-day-holiday a {
            color: #ef4444 !important;
            font-weight: 700;
        }

        .holiday-text-event {
            background-color: transparent !important;
            border: none !important;
        }

        .holiday-text-event .fc-event-title {
            color: #ef4444;
            font-size: 0.75rem;
            font-weight: 800;
        }

        .fc-event-main {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 100;
            display: flex;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(2px);
        }

        @media (max-width: 768px) {
            .fc-toolbar {
                flex-direction: column;
                gap: 0.5rem;
            }

            .fc-toolbar-title {
                font-size: 1rem !important;
            }

            .fc-button {
                padding: 0.25rem 0.5rem !important;
                font-size: 0.75rem !important;
            }

            .fc-header-toolbar {
                margin-bottom: 0.5rem !important;
            }
        }
    </style>
</head>

<body class="bg-gray-50 flex flex-col h-screen">

    <main class="flex-1 w-full max-w-7xl mx-auto px-4 py-4 md:px-6 md:py-6 h-full flex flex-col overflow-hidden">

        <div class="flex justify-between items-center mb-4 shrink-0">
            <div class="flex items-center gap-3">
                <h1 class="text-xl md:text-2xl font-bold text-gray-800">ëŒ€ì‹œë³´ë“œ</h1>
                <span id="semester-badge"
                    class="bg-blue-600 text-white font-bold px-3 py-1 rounded-full text-xs md:text-sm shadow-md min-w-[100px] text-center">
                    <i class="fas fa-spinner fa-spin"></i>
                </span>
            </div>
            <div class="flex items-center gap-2 text-sm font-bold text-gray-600">
                <span id="user-class-badge" class="px-2 py-1 bg-gray-200 rounded text-xs hidden"></span>
            </div>
        </div>

        <!-- Main Content Area (Split Layout) -->
        <div class="flex flex-col md:flex-row h-[calc(100vh-140px)] gap-4">

            <!-- Left: Calendar (60%) -->
            <div class="w-full md:w-3/5 bg-white rounded-xl shadow-sm p-4 h-full flex flex-col">
                <div class="flex justify-between items-center mb-2">
                    <h2 class="text-lg font-bold text-gray-800"><i class="far fa-calendar-alt mr-2 text-blue-600"></i>í•™ì‚¬
                        ì¼ì •</h2>
                    <div class="flex items-center gap-2">
                        <button onclick="app.openSearch()"
                            class="bg-gray-50 border border-gray-200 text-gray-600 hover:text-blue-600 p-1.5 rounded-lg transition"
                            title="ê²€ìƒ‰">
                            <i class="fas fa-search"></i>
                        </button>
                        <!-- Filter is automatic for students (My Class + Common), so we don't need a select -->
                    </div>
                </div>
                <div id="calendar" class="flex-1"></div>
            </div>

            <!-- Right: Functions (40%) -->
            <div class="w-full md:w-2/5 flex flex-col gap-4 h-full">

                <!-- Right Top: Notice Board (50%) -->
                <div
                    class="h-1/2 bg-[#fffbeb] rounded-xl shadow-sm border border-yellow-200 p-4 flex flex-col relative overflow-hidden">
                    <div class="flex justify-between items-center mb-3 border-b border-yellow-200 pb-2">
                        <h3 class="text-lg font-extrabold text-amber-800 flex items-center">
                            <i class="fas fa-thumbtack mr-2 text-amber-600"></i>ì•Œë¦¼ì¥
                        </h3>
                        <!-- No Write Button -->
                    </div>
                    <div id="notice-list" class="flex-1 overflow-y-auto space-y-3 pr-2 custom-scroll">
                        <div class="text-center text-amber-800/50 py-10 font-bold text-sm">ë¡œë”© ì¤‘...</div>
                    </div>
                </div>

                <!-- Right Bottom: Event Details (50%) -->
                <div class="h-1/2 bg-white rounded-xl shadow-sm border border-gray-200 p-4 flex flex-col">
                    <div class="flex justify-between items-center mb-3 border-b border-gray-100 pb-2">
                        <h3 class="text-lg font-bold text-gray-800 flex items-center">
                            <i class="fas fa-info-circle mr-2 text-blue-500"></i>ì¼ì • ìƒì„¸
                        </h3>
                        <span id="detail-date-display" class="text-sm font-bold text-gray-500">ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”</span>
                    </div>
                    <div id="detail-panel-content" class="flex-1 overflow-y-auto pr-2 custom-scroll">
                        <div class="flex flex-col items-center justify-center h-full text-gray-400">
                            <i class="far fa-calendar-check text-4xl mb-3 text-gray-200"></i>
                            <p class="text-sm">ë‹¬ë ¥ì—ì„œ ë‚ ì§œë‚˜ ì¼ì •ì„ í´ë¦­í•˜ë©´<br>ìƒì„¸ ë‚´ìš©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </main>

    <!-- Notice Detail Modal (Read-Only) -->
    <div id="notice-detail-modal"
        class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center"
        onclick="app.closeNoticeDetail()">
        <div class="bg-[#fffbeb] rounded-xl shadow-2xl w-full max-w-lg p-8 m-4 border-t-8 border-amber-400 relative"
            onclick="event.stopPropagation()">
            <button onclick="app.closeNoticeDetail()"
                class="absolute top-4 right-4 text-amber-800 hover:text-amber-600">
                <i class="fas fa-times fa-lg"></i>
            </button>
            <h3 class="text-xl font-extrabold text-amber-900 mb-4 flex items-center">
                <span id="modal-notice-category-icon" class="mr-2"></span>
                <span id="modal-notice-title">ì•Œë¦¼ ìƒì„¸</span>
            </h3>

            <div
                class="mb-4 flex items-center justify-between text-xs font-bold text-amber-800/60 border-b border-yellow-200 pb-2">
                <span id="modal-notice-date"></span>
                <span id="modal-notice-target"></span>
            </div>

            <div id="modal-notice-content"
                class="text-gray-800 text-sm font-bold leading-relaxed whitespace-pre-wrap h-64 overflow-y-auto custom-scroll p-2">
            </div>
        </div>
    </div>

    <!-- Search Modal (Read-Only) -->
    <div id="search-modal"
        class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-start justify-center pt-20"
        onclick="app.closeSearch()">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6 m-4" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800"><i class="fas fa-search text-blue-500 mr-2"></i>ì¼ì • ê²€ìƒ‰</h3>
                <button onclick="app.closeSearch()" class="text-gray-400 hover:text-gray-600 transition">
                    <i class="fas fa-times fa-lg"></i>
                </button>
            </div>

            <div class="relative mb-4">
                <input type="text" id="modal-search-input" onkeyup="if(event.key === 'Enter') app.executeSearch()"
                    class="w-full border-2 border-blue-100 rounded-xl p-3 pl-10 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 outline-none transition font-bold text-lg"
                    placeholder="ê²€ìƒ‰ì–´ ì…ë ¥ (ì˜ˆ: ì¤‘ê°„ê³ ì‚¬, ìˆ˜í–‰í‰ê°€)">
                <i class="fas fa-search absolute left-4 top-4 text-gray-400"></i>
                <button onclick="app.executeSearch()"
                    class="absolute right-2 top-2 bg-blue-600 text-white px-4 py-1.5 rounded-lg font-bold hover:bg-blue-700 transition">ê²€ìƒ‰</button>
            </div>

            <div id="modal-search-results" class="h-64 overflow-y-auto custom-scroll space-y-2">
                <div class="text-center text-gray-400 py-10">ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ê³  ì—”í„°ë¥¼ ëˆ„ë¥´ì„¸ìš”.</div>
            </div>
        </div>
    </div>


    <script>
        window.AuthManager.init('student');

        window.app = {
            calendar: null,
            userClassStr: null, // "2-1" etc.
            colorMap: {
                'exam': '#ef4444',       // Red
                'performance': '#f97316', // Orange
                'event': '#10b981',       // Green
                'diagnosis': '#3b82f6',   // Blue
                'formative': '#3b82f6'    // Blue
            },
            typeLabelMap: {
                'exam': 'ì •ê¸° ì‹œí—˜', 'performance': 'ìˆ˜í–‰í‰ê°€', 'event': 'í–‰ì‚¬', 'diagnosis': 'ì§„ë‹¨í‰ê°€', 'formative': 'í˜•ì„±í‰ê°€'
            },
            initialized: false, // Add this flag

            init: function () {
                const runInit = async (user) => {
                    if (this.initialized) return;
                    this.initialized = true;

                    try {
                        // Load User Class Info
                        await this.loadUserClass(user.uid);

                        const cfg = window.currentConfig;
                        if (cfg) {
                            document.getElementById('semester-badge').innerText = `${cfg.year}í•™ë…„ë„ ${cfg.semester}í•™ê¸°`;
                        } else {
                            document.getElementById('semester-badge').innerText = 'ì„¤ì • ë¡œë“œ ì‹¤íŒ¨';
                        }

                        this.initCalendar();
                        this.initNotices();

                    } catch (err) {
                        console.error('Dashboard Init Error:', err);
                        alert('ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                    }
                };

                // Check if already ready
                if (window.AuthManager.currentUser) {
                    runInit(window.AuthManager.currentUser);
                } else {
                    document.addEventListener('auth-ready', (e) => runInit(e.detail));
                }
            },

            loadUserClass: async function (uid) {
                try {
                    const doc = await window.getCollection('users').doc(uid).get();
                    if (doc.exists) {
                        const d = doc.data();
                        if (d.grade && d.class) {
                            this.userClassStr = `${d.grade}-${d.class}`;
                            const badge = document.getElementById('user-class-badge');
                            badge.innerText = `${d.grade}í•™ë…„ ${d.class}ë°˜`;
                            badge.classList.remove('hidden');
                        }
                    }
                } catch (e) { console.error(e); }
            },

            //Helper function to get year/semester based collection path
            getCollectionPath: function (collectionName) {
                const cfg = window.currentConfig;
                if (!cfg || !cfg.year || !cfg.semester) return null;
                return `years/${cfg.year}/semesters/${cfg.semester}/${collectionName}`;
            },

            // --- Notice Board Logic (Read-Only) ---
            initNotices: function () {
                const container = document.getElementById('notice-list');
                const path = this.getCollectionPath('notices');
                if (!path) {
                    container.innerHTML = '<div class="text-center text-amber-800/50 py-10 font-bold text-sm">ì„¤ì • ì˜¤ë¥˜</div>';
                    return;
                }

                window.db.collection(path).orderBy('createdAt', 'desc').onSnapshot(snapshot => {
                    if (snapshot.empty) {
                        container.innerHTML = '<div class="text-center text-amber-800/50 py-10 font-bold text-sm">ë“±ë¡ëœ ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                        return;
                    }

                    const notices = [];
                    snapshot.forEach(doc => {
                        const d = doc.data();
                        // Filter: Common OR User's Class
                        const isCommon = d.targetType === 'common';
                        const isMyClass = d.targetType === 'class' && d.targetClass === this.userClassStr;

                        if (isCommon || isMyClass) {
                            notices.push({ id: doc.id, ...d });
                        }
                    });

                    if (notices.length === 0) {
                        container.innerHTML = '<div class="text-center text-amber-800/50 py-10 font-bold text-sm">ë“±ë¡ëœ ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                        return;
                    }

                    container.innerHTML = notices.map(d => {
                        let icon = 'ğŸ“¢';
                        let dateInfo = '';
                        let typeBadge = d.targetType === 'common' ? '<span class="text-[10px] bg-amber-500 text-white px-1 rounded mr-1">ê³µí†µ</span>' : '<span class="text-[10px] bg-blue-500 text-white px-1 rounded mr-1">í•™ê¸‰</span>';

                        if (d.category === 'exam') icon = 'ğŸ”¥';
                        if (d.category === 'performance') icon = 'âš¡';
                        if (d.category === 'prep') icon = 'ğŸ’';
                        if (d.category === 'dday' && d.targetDate) {
                            icon = 'â³';
                            const today = new Date();
                            today.setHours(0, 0, 0, 0);
                            const target = new Date(d.targetDate);
                            target.setHours(0, 0, 0, 0);
                            const diff = Math.ceil((target - today) / (1000 * 60 * 60 * 24));
                            const dDayStr = diff > 0 ? `D-${diff}` : (diff === 0 ? 'D-Day' : `D+${Math.abs(diff)}`);
                            dateInfo = `<span class="ml-2 text-xs bg-red-500 text-white px-1.5 py-0.5 rounded-full font-bold animate-pulse">${dDayStr}</span>`;
                        }

                        // Escape HTML in content for checking but render carefully
                        // const safeContent = d.content.replace(/</g, "&lt;").replace(/>/g, "&gt;");

                        return `
                            <div onclick="app.openNoticeDetail('${d.id}')" class="bg-white/80 p-3 rounded-lg border border-yellow-200 shadow-sm relative group mb-2 cursor-pointer hover:bg-yellow-50 transition">
                                <div class="flex justify-between items-start mb-1">
                                    <div class="flex items-center">
                                        <span class="text-lg mr-2">${icon}</span>
                                        ${typeBadge}
                                        ${dateInfo}
                                    </div>
                                    <span class="text-[10px] text-amber-800/60 font-mono">${new Date(d.createdAt.seconds * 1000).toLocaleDateString()}</span>
                                </div>
                                <div class="text-gray-800 text-sm font-bold leading-relaxed truncate">${d.content}</div>
                            </div>
                        `;
                    }).join('');

                    // Store notices for modal access
                    this.noticesMap = notices.reduce((acc, curr) => { acc[curr.id] = curr; return acc; }, {});
                });
            },

            openNoticeDetail: function (id) {
                const n = this.noticesMap[id];
                if (!n) return;

                let icon = 'ğŸ“¢';
                if (n.category === 'exam') icon = 'ğŸ”¥';
                if (n.category === 'performance') icon = 'âš¡';
                if (n.category === 'prep') icon = 'ğŸ’';
                if (n.category === 'dday') icon = 'â³';

                document.getElementById('modal-notice-category-icon').innerText = icon;
                document.getElementById('modal-notice-date').innerText = new Date(n.createdAt.seconds * 1000).toLocaleString();
                document.getElementById('modal-notice-target').innerText = n.targetType === 'common' ? 'ì „ì²´ ê³µí†µ' : `${n.targetClass}ë°˜`;
                document.getElementById('modal-notice-content').innerText = n.content; // Use innerText for safety

                document.getElementById('notice-detail-modal').classList.remove('hidden');
            },

            closeNoticeDetail: function () {
                document.getElementById('notice-detail-modal').classList.add('hidden');
            },


            // --- Detail Panel Logic (Read-Only) ---
            showEventsOnPanel: function (dateStr, events) {
                const container = document.getElementById('detail-panel-content');
                const dateDisplay = document.getElementById('detail-date-display');

                // Format Date
                const dateObj = new Date(dateStr);
                const days = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
                dateDisplay.innerHTML = `<span class="inline-flex items-center bg-blue-50 border-2 border-blue-300 rounded-lg px-3 py-1"><span class="text-lg font-extrabold text-blue-800">${dateObj.getMonth() + 1}ì›” ${dateObj.getDate()}ì¼</span><span class="ml-1 text-sm font-bold text-blue-500">(${days[dateObj.getDay()]})</span></span>`;

                if (events.length === 0) {
                    container.innerHTML = `
                        <div class="flex flex-col items-center justify-center h-40 text-gray-400">
                            <i class="far fa-calendar-times text-3xl mb-2"></i>
                            <p class="text-sm">ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = events.map(ev => {
                    // Render holiday events with special styling
                    if (ev.classNames && ev.classNames.includes('holiday-text-event')) {
                        return `
                        <div class="group p-3 border-l-4 border-red-400 bg-red-50 mb-3 rounded-r-lg">
                            <div class="flex items-center gap-2">
                                <span class="text-[10px] text-white px-1.5 py-0.5 rounded font-bold bg-red-500">ê³µíœ´ì¼</span>
                                <h4 class="font-bold text-red-700 text-sm">${ev.title}</h4>
                            </div>
                        </div>
                    `;
                    }
                    const p = ev.extendedProps || ev;
                    return `
                        <div class="group p-3 border-l-4 border-gray-200 bg-gray-50 mb-3 rounded-r-lg">
                            <div class="flex justify-between items-start">
                                <div>
                                    <div class="flex items-center gap-2 mb-1">
                                        <span class="text-[10px] text-white px-1.5 py-0.5 rounded font-bold" style="background-color: ${p.backgroundColor || this.colorMap[p.eventType] || '#999'}">${this.typeLabelMap[p.eventType] || 'ì¼ì •'}</span>
                                        <h4 class="font-bold text-gray-800 text-sm">${p.title}</h4>
                                    </div>
                                    <p class="text-xs text-gray-500">${p.start} ${p.end && p.start !== p.end ? '~ ' + p.end : ''}</p>
                                </div>
                            </div>
                            ${p.description ? `<p class="text-xs text-gray-600 mt-2 bg-gray-100 p-2 rounded">${p.description}</p>` : ''}
                        </div>
                    `;
                }).join('');
            },

            initCalendar: function () {
                const calendarEl = document.getElementById('calendar');

                this.calendar = new FullCalendar.Calendar(calendarEl, {
                    initialView: 'dayGridMonth',
                    locale: 'ko',
                    headerToolbar: {
                        left: 'prev,next today',
                        center: 'title',
                        right: 'dayGridMonth,listMonth'
                    },
                    dayCellClassNames: (arg) => {
                        // Fix for timezone offset issues in styling
                        const date = new Date(arg.date);
                        const localDate = new Date(date.getTime() - (date.getTimezoneOffset() * 60000));
                        const dateStr = localDate.toISOString().split('T')[0];

                        const evts = this.calendar ? this.calendar.getEvents() : [];
                        const isHoliday = evts.some(e => {
                            // Compare using startStr which is already YYYY-MM-DD
                            return e.startStr === dateStr && e.extendedProps && e.extendedProps.eventType === 'holiday';
                        });
                        return isHoliday ? ['fc-day-holiday'] : [];
                    },
                    events: [this.fetchEvents.bind(this)],
                    dateClick: (info) => {
                        // Find events for this date
                        const allEvents = this.calendar.getEvents();
                        const dailyEvents = allEvents.filter(e => {
                            // FullCalendar internal dates are UTC, but startStr/endStr are reliable for all-day events
                            // e.startStr is YYYY-MM-DD
                            if (e.allDay) {
                                const start = e.startStr;
                                const end = e.endStr || start; // Single day event has no endStr usually, or same day? FullCalendar logic varies.
                                // Actually, end is exclusive. 
                                // If start=2026-03-01, end=2026-03-02, it is 1 day.

                                if (!e.end) return start === info.dateStr;
                                return info.dateStr >= start && info.dateStr < e.endStr;
                            }
                            return false; // We mostly deal with all-day events
                        });

                        this.showEventsOnPanel(info.dateStr, dailyEvents);

                        // Highlight selected date
                        document.querySelectorAll('.fc-day-selected').forEach(el => el.classList.remove('fc-day-selected'));
                        info.dayEl.classList.add('fc-day-selected');
                    },
                    eventClick: (info) => {
                        const startStr = info.event.startStr.split('T')[0];

                        // Also highlight the date
                        // Difficult to get dayEl from eventClick directly without finding it.
                        // We will just show panel.

                        this.showEventsOnPanel(startStr, [info.event]);
                    },
                    height: '100%',
                    contentHeight: '100%',
                    expandRows: true, // Key for mobile to fill height
                    displayEventTime: false,
                    fixedWeekCount: false,
                    showNonCurrentDates: false,
                    windowResize: function (view) {
                        // Handle resize if needed
                    }
                });
                this.calendar.render();
            },

            fetchEvents: async function (info, successCallback, failureCallback) {
                try {
                    const path = this.getCollectionPath('calendar');
                    if (!path) { successCallback([]); return; }

                    const snapshot = await window.db.collection(path)
                        .where('start', '>=', info.startStr)
                        .where('start', '<', info.endStr)
                        .get();

                    const events = [];
                    snapshot.forEach(doc => {
                        const d = doc.data();

                        // Filter by Class (Common or My Class)
                        const isCommon = d.targetType === 'common';
                        const isMyClass = d.targetType === 'class' && d.targetClass === this.userClassStr;

                        if (!isCommon && !isMyClass) return;

                        const isHoliday = d.eventType === 'holiday';
                        events.push({
                            id: doc.id,
                            title: d.title,
                            start: d.start,
                            end: d.end || d.start,
                            backgroundColor: isHoliday ? 'transparent' : (this.colorMap[d.eventType] || '#6b7280'),
                            borderColor: isHoliday ? 'transparent' : (this.colorMap[d.eventType] || '#6b7280'),
                            textColor: isHoliday ? '#ef4444' : undefined,
                            classNames: isHoliday ? ['holiday-text-event'] : [],
                            extendedProps: d
                        });
                    });
                    successCallback(events);
                } catch (e) {
                    console.error("Fetch Events Error:", e);
                    failureCallback(e);
                }
            },

            // --- Search Functions (Read Only) ---
            openSearch: function () {
                document.getElementById('modal-search-input').value = '';
                document.getElementById('modal-search-results').innerHTML = '<div class="text-center text-gray-400 py-10">ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ê³  ì—”í„°ë¥¼ ëˆ„ë¥´ì„¸ìš”.</div>';
                document.getElementById('search-modal').classList.remove('hidden');
                document.getElementById('search-modal').classList.add('flex');
                document.getElementById('modal-search-input').focus();
            },

            closeSearch: function () {
                document.getElementById('search-modal').classList.add('hidden');
                document.getElementById('search-modal').classList.remove('flex');
            },

            executeSearch: async function () {
                const query = document.getElementById('modal-search-input').value.trim();
                const resultsEl = document.getElementById('modal-search-results');
                if (!query) {
                    resultsEl.innerHTML = '<div class="text-center text-gray-400 py-10">ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</div>';
                    return;
                }
                resultsEl.innerHTML = '<div class="text-center text-gray-400 py-10"><i class="fas fa-spinner fa-spin mr-2"></i>ê²€ìƒ‰ ì¤‘...</div>';

                try {
                    const path = this.getCollectionPath('calendar');
                    if (!path) {
                        resultsEl.innerHTML = '<div class="text-center text-red-500 py-10">ì„¤ì • ì˜¤ë¥˜ë¡œ ê²€ìƒ‰í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
                        return;
                    }
                    const snapshot = await window.db.collection(path).get();
                    const results = [];
                    snapshot.forEach(doc => {
                        const d = doc.data();

                        // Strict Filtering in Search too
                        const isCommon = d.targetType === 'common';
                        const isMyClass = d.targetType === 'class' && d.targetClass === this.userClassStr;
                        if (!isCommon && !isMyClass) return;

                        const q = query.toLowerCase();
                        const titleMatch = d.title && d.title.toLowerCase().includes(q);
                        const descMatch = d.description && d.description.toLowerCase().includes(q);
                        if (titleMatch || descMatch) {
                            results.push({ id: doc.id, ...d });
                        }
                    });

                    if (results.length === 0) {
                        resultsEl.innerHTML = `<div class="text-center text-gray-400 py-10">
                            <i class="far fa-folder-open text-2xl mb-2"></i><br>
                            í•´ë‹¹ í‚¤ì›Œë“œì— ë§ëŠ” ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.
                        </div>`;
                    } else {
                        resultsEl.innerHTML = results.map(r => `
                            <div onclick="app.closeSearch(); app.showSearchResult('${r.id}', '${r.start}')" 
                                 class="p-3 border-b border-gray-100 hover:bg-blue-50 cursor-pointer transition">
                                <div class="font-bold text-sm text-gray-800">${r.title}</div>
                                <div class="text-xs text-gray-500">${r.start} ${r.end && r.start !== r.end ? '~ ' + r.end : ''}</div>
                                ${r.description ? `<div class="text-xs text-gray-400 mt-1 truncate">${r.description}</div>` : ''}
                            </div>
                        `).join('');
                    }
                } catch (e) {
                    console.error(e);
                    resultsEl.innerHTML = '<div class="text-center text-red-500 py-10">ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
                }
            },

            showSearchResult: function (id, dateStr) {
                if (this.calendar) this.calendar.gotoDate(dateStr);
            },
        };

        // Expose to window for inline onclick handlers
        window.app = app;

        // Run Init Trigger
        app.init();
    </script>
</body>

</html>