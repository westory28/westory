
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Westory - ì—­ì‚¬ í€´ì¦ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    
    <!-- Config & Styles -->
    <link rel="stylesheet" href="../assets/css/style.css">
    <script src="../assets/js/firebase-config.js"></script>
    <script src="../assets/js/auth-manager.js"></script>
    
    <style>
        .quiz-card { background: white; border: 1px solid #e5e7eb; border-radius: 12px; padding: 20px; margin-bottom: 16px; transition: all 0.2s; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .quiz-card:hover { transform: translateY(-2px); box-shadow: 0 8px 16px -4px rgba(0,0,0,0.08); border-color: #bfdbfe; }
        .btn-start { padding: 8px 16px; border-radius: 8px; font-weight: bold; font-size: 0.9rem; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; }
        .btn-start.active { background-color: #eff6ff; color: #2563eb; border: 1px solid #bfdbfe; cursor: pointer; }
        .btn-start.active:hover { background-color: #2563eb; color: white; }
        .btn-start.disabled { background-color: #f3f4f6; color: #9ca3af; cursor: not-allowed; border: 1px solid #e5e7eb; }
        .badge { font-size: 0.75rem; font-weight: 800; padding: 2px 6px; border-radius: 4px; margin-right: 6px; }
        .exam-banner { background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%); color: white; border-radius: 16px; padding: 24px; position: relative; overflow: hidden; cursor: pointer; transition: transform 0.2s; }
        .exam-banner:hover { transform: scale(1.01); }
        .exam-banner.disabled { background: #e5e7eb; cursor: not-allowed; opacity: 0.8; }
        .exam-deco { position: absolute; font-size: 8rem; opacity: 0.1; right: -20px; bottom: -20px; transform: rotate(-15deg); }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header injected by AuthManager -->

    <main class="container mx-auto px-4 py-8 max-w-3xl">
        
        <div id="greeting-area" class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 mb-8 flex items-center gap-3 hidden animate-[fadeIn_0.5s]">
            <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center text-xl">ğŸ”¥</div>
            <div>
                <div class="font-bold text-gray-800"><span id="user-name-display" class="text-blue-600">í•™ìƒ</span>ë‹˜, ì˜¤ëŠ˜ë„ í™”ì´íŒ…!</div>
                <div class="text-xs text-gray-400" id="semester-text">2025í•™ë…„ë„</div>
            </div>
        </div>

        <!-- 1. Paper Exam Prep Banner -->
        <section class="mb-10">
            <h2 class="text-lg font-bold text-gray-800 mb-3 ml-1 flex items-center gap-2">
                <i class="fas fa-flag-checkered text-blue-600"></i> ì‹¤ì „ ëŒ€ë¹„
            </h2>
            <div id="exam-prep-card" class="exam-banner shadow-lg group" onclick="app.startQuiz('exam_prep', 'exam_prep', 'ì§€í•„í‰ê°€ ëŒ€ë¹„ ì‹¤ì „')">
                <i class="fas fa-pen-fancy exam-deco text-white"></i>
                <div class="relative z-10">
                    <div class="bg-red-500 text-white text-[10px] font-bold px-2 py-1 rounded inline-block mb-2 shadow-sm">FINAL CHECK</div>
                    <h3 class="text-2xl font-black mb-1">ì§€í•„í‰ê°€ ëŒ€ë¹„ ì‹¤ì „ ë¬¸ì œ</h3>
                    <p class="text-blue-100 text-sm font-medium opacity-90">ì‹¤ì œ ì‹œí—˜ì²˜ëŸ¼ ë¬¸ì œë¥¼ í’€ì–´ë³´ê³  ì‹¤ë ¥ì„ ì ê²€í•˜ì„¸ìš”.</p>
                </div>
                <div class="absolute right-6 top-1/2 transform -translate-y-1/2 bg-white/20 backdrop-blur-sm p-3 rounded-full text-white group-hover:bg-white group-hover:text-blue-600 transition">
                    <i class="fas fa-chevron-right text-xl"></i>
                </div>
            </div>
        </section>

        <!-- 2. Unit List -->
        <section>
            <h2 class="text-lg font-bold text-gray-800 mb-4 ml-1 flex items-center gap-2">
                <i class="fas fa-layer-group text-amber-500"></i> ë‹¨ì›ë³„ í•™ìŠµ
            </h2>
            <div id="quiz-list-container" class="space-y-4">
                <div class="py-20 text-center text-gray-400">
                    <div class="loader-spinner mx-auto mb-3"></div>
                    <p>í‰ê°€ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                </div>
            </div>
        </section>

    </main>

    <!-- Footer injected by AuthManager -->

    <script>
        window.AuthManager.init('student');

        const app = {
            config: {},
            tree: [],

            init: function() {
                document.addEventListener('auth-ready', (e) => {
                    const user = e.detail;
                    this.loadUserInfo(user.uid);
                    document.getElementById('semester-text').innerText = `${window.currentConfig.year}í•™ë…„ë„ ${window.currentConfig.semester}í•™ê¸°`;
                    this.loadData();
                });
            },

            loadUserInfo: async function(uid) {
                try {
                    const doc = await window.getCollection('users').doc(uid).get();
                    if(doc.exists) {
                        document.getElementById('user-name-display').innerText = doc.data().name || "í•™ìƒ";
                        document.getElementById('greeting-area').classList.remove('hidden');
                    }
                } catch(e) {}
            },

            loadData: async function() {
                try {
                    // Parallel Fetch
                    const [treeDoc, configDoc] = await Promise.all([
                        window.getCollection('curriculum').doc('tree').get(),
                        window.getCollection('assessment_config').doc('status').get()
                    ]);

                    this.tree = (treeDoc.exists && treeDoc.data().tree) ? treeDoc.data().tree : [];
                    this.config = (configDoc.exists) ? configDoc.data() : {};
                    
                    this.renderExamPrep();
                    this.renderList();
                } catch(e) {
                    console.error(e);
                    document.getElementById('quiz-list-container').innerHTML = '<div class="text-center text-red-400">ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨</div>';
                }
            },

            renderExamPrep: function() {
                const isActive = this.config['exam_prep_exam_prep'] === true;
                const card = document.getElementById('exam-prep-card');
                if(!isActive) {
                    card.classList.add('disabled', 'bg-gray-200');
                    card.classList.remove('exam-banner', 'cursor-pointer', 'shadow-lg');
                    card.style.background = '#e5e7eb';
                    card.onclick = null;
                    card.querySelector('h3').innerText += " (ì¤€ë¹„ì¤‘)";
                    card.querySelector('p').innerText = "ì„ ìƒë‹˜ì´ í‰ê°€ë¥¼ í™œì„±í™”í•˜ë©´ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.";
                    card.querySelector('i.fa-chevron-right').parentElement.style.display = 'none';
                }
            },

            renderList: function() {
                const container = document.getElementById('quiz-list-container');
                if(this.tree.length === 0) {
                    container.innerHTML = '<div class="text-center py-10 text-gray-400">ë“±ë¡ëœ ë‹¨ì›ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                    return;
                }

                let html = '';
                this.tree.forEach(big => {
                    if(big.children) {
                        big.children.forEach(mid => {
                            const diagKey = `${mid.id}_diagnostic`;
                            const formKey = `${mid.id}_formative`;
                            const isDiagActive = this.config[diagKey] === true;
                            const isFormActive = this.config[formKey] === true;

                            html += `
                                <div class="quiz-card group">
                                    <div class="mb-4">
                                        <div class="text-xs text-gray-400 font-bold mb-1">${big.title}</div>
                                        <h3 class="text-xl font-bold text-gray-800">${mid.title}</h3>
                                    </div>
                                    <div class="grid grid-cols-2 gap-3">
                                        <button onclick="${isDiagActive ? `app.startQuiz('${mid.id}', 'diagnostic', '${mid.title}')` : ''}" 
                                            class="btn-start ${isDiagActive ? 'active' : 'disabled'} h-12">
                                            ${isDiagActive ? '<i class="fas fa-stethoscope mr-2"></i>ì§„ë‹¨í‰ê°€' : '<span class="text-xs">Coming Soon</span>'}
                                        </button>
                                        <button onclick="${isFormActive ? `app.startQuiz('${mid.id}', 'formative', '${mid.title}')` : ''}" 
                                            class="btn-start ${isFormActive ? 'active' : 'disabled'} h-12">
                                            ${isFormActive ? '<i class="fas fa-pencil-alt mr-2"></i>í˜•ì„±í‰ê°€' : '<span class="text-xs">Coming Soon</span>'}
                                        </button>
                                    </div>
                                </div>
                            `;
                        });
                    }
                });
                container.innerHTML = html;
            },

            startQuiz: function(unitId, cat, title) {
                // Encode params
                const url = `quiz-runner.html?unitId=${unitId}&category=${cat}&title=${encodeURIComponent(title)}`;
                window.location.href = url;
            }
        };

        app.init();
    </script>
</body>
</html>
