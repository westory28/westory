
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Westory - ì—­ì‚¬ í‰ê°€</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    
    <!-- Config & Styles -->
    <link rel="stylesheet" href="../assets/css/style.css">
    <script src="../assets/js/firebase-config.js"></script>
    <script src="../assets/js/auth-manager.js"></script>
    
    <style>
        .exam-banner { background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%); color: white; border-radius: 16px; padding: 24px; position: relative; overflow: hidden; cursor: pointer; transition: transform 0.2s; }
        .exam-banner:hover { transform: scale(1.01); }
        .exam-banner.disabled { background: #e5e7eb; color: #9ca3af; cursor: not-allowed; opacity: 1; transform: none; box-shadow: none; pointer-events: none; }
        .exam-banner.disabled .exam-deco { display: none; }
        .exam-deco { position: absolute; font-size: 8rem; opacity: 0.1; right: -20px; bottom: -20px; transform: rotate(-15deg); }
        
        .unit-list-container { background: white; border-radius: 12px; border: 1px solid #e5e7eb; overflow: hidden; }
        .unit-item { padding: 16px; border-bottom: 1px solid #f3f4f6; display: flex; flex-direction: column; }
        .unit-item:last-child { border-bottom: none; }
        
        /* Hierarchy Styles */
        .level-0 { background-color: #f9fafb; font-weight: 800; color: #1f2937; padding-left: 20px; border-bottom: 2px solid #e5e7eb; }
        .level-1 { padding-left: 40px; border-left: 4px solid white; display: flex; justify-content: space-between; align-items: center; }
        .level-1:hover { background-color: #f8fafc; }
        .level-1 .title-area { display: flex; align-items: center; }
        .folder-icon { color: #fbbf24; margin-right: 10px; }

        .btn-action { padding: 6px 12px; border-radius: 6px; font-size: 0.85rem; font-weight: 700; transition: all 0.2s; display: inline-flex; align-items: center; gap: 6px; border: 1px solid transparent; }
        .btn-diag { color: #2563eb; background-color: #eff6ff; border-color: #dbeafe; }
        .btn-diag:hover { background-color: #2563eb; color: white; border-color: #2563eb; }
        .btn-form { color: #059669; background-color: #ecfdf5; border-color: #d1fae5; }
        .btn-form:hover { background-color: #059669; color: white; border-color: #059669; }
        .btn-disabled { color: #9ca3af; background-color: #f3f4f6; border-color: #e5e7eb; cursor: not-allowed; }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header injected by AuthManager -->

    <main class="container mx-auto px-4 py-8 max-w-4xl">
        
        <div id="greeting-area" class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 mb-8 flex items-center gap-3 hidden animate-[fadeIn_0.5s]">
            <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center text-xl">ğŸ”¥</div>
            <div>
                <div class="font-bold text-gray-800"><span id="user-name-display" class="text-blue-600">í•™ìƒ</span>ë‹˜, ì˜¤ëŠ˜ë„ í™”ì´íŒ…!</div>
                <div class="text-xs text-gray-400" id="semester-text">2025í•™ë…„ë„</div>
            </div>
        </div>

        <!-- 1. Exam Prep Banner (Default Disabled) -->
        <section class="mb-10">
            <h2 class="text-lg font-bold text-gray-800 mb-3 ml-1 flex items-center gap-2">
                <i class="fas fa-flag-checkered text-blue-600"></i> ì‹¤ì „ ëŒ€ë¹„
            </h2>
            <div id="exam-prep-card" class="exam-banner disabled shadow-lg group">
                <i class="fas fa-pen-fancy exam-deco text-white"></i>
                <div class="relative z-10">
                    <div id="banner-badge" class="bg-gray-400 text-white text-[10px] font-bold px-2 py-1 rounded inline-block mb-2 shadow-sm">ë¹„ê³µê°œ</div>
                    <h3 id="banner-title" class="text-2xl font-black mb-1">ì§€í•„í‰ê°€ ëŒ€ë¹„ (ì¤€ë¹„ì¤‘)</h3>
                    <p id="banner-desc" class="text-gray-300 text-sm font-medium opacity-90">ì„ ìƒë‹˜ì´ í‰ê°€ë¥¼ í™œì„±í™”í•˜ë©´ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                </div>
                <div id="banner-icon" class="hidden absolute right-6 top-1/2 transform -translate-y-1/2 bg-white/20 backdrop-blur-sm p-3 rounded-full text-white group-hover:bg-white group-hover:text-blue-600 transition">
                    <i class="fas fa-chevron-right text-xl"></i>
                </div>
            </div>
        </section>

        <!-- 2. Curriculum Tree List -->
        <section>
            <h2 class="text-lg font-bold text-gray-800 mb-4 ml-1 flex items-center gap-2">
                <i class="fas fa-layer-group text-amber-500"></i> ë‹¨ì›ë³„ í‰ê°€
            </h2>
            <div id="quiz-list-container" class="unit-list-container shadow-sm bg-white min-h-[100px]">
                <div class="py-20 text-center text-gray-400">
                    <div class="loader-spinner mx-auto mb-3"></div>
                    <p>í‰ê°€ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                </div>
            </div>
        </section>

    </main>

    <!-- Footer injected by AuthManager -->

    <script>
        window.AuthManager.init('student');

        const app = {
            config: {},
            tree: [],

            init: function() {
                document.addEventListener('auth-ready', (e) => {
                    const user = e.detail;
                    this.loadUserInfo(user.uid);
                    document.getElementById('semester-text').innerText = `${window.currentConfig.year}í•™ë…„ë„ ${window.currentConfig.semester}í•™ê¸°`;
                    this.loadData();
                });
            },

            loadUserInfo: async function(uid) {
                try {
                    const doc = await window.getCollection('users').doc(uid).get();
                    if(doc.exists) {
                        document.getElementById('user-name-display').innerText = doc.data().name || "í•™ìƒ";
                        document.getElementById('greeting-area').classList.remove('hidden');
                    }
                } catch(e) {}
            },

            loadData: async function() {
                try {
                    // Load Settings safely
                    try {
                        const settingsDoc = await window.getCollection('assessment_config').doc('settings').get();
                        if (settingsDoc.exists) {
                            this.config = settingsDoc.data();
                        } else {
                            // Try legacy status doc
                            const statusDoc = await window.getCollection('assessment_config').doc('status').get();
                            if (statusDoc.exists) {
                                const raw = statusDoc.data();
                                for(const key in raw) { this.config[key] = { active: raw[key] }; }
                            }
                        }
                    } catch (e) { console.warn("Config load warn", e); }

                    // Load Tree safely
                    try {
                        const treeDoc = await window.getCollection('curriculum').doc('tree').get();
                        this.tree = (treeDoc.exists && treeDoc.data().tree) ? treeDoc.data().tree : [];
                    } catch (e) { console.warn("Tree load warn", e); }
                    
                    this.renderExamPrep();
                    this.renderList();
                } catch(e) {
                    console.error(e);
                    document.getElementById('quiz-list-container').innerHTML = '<div class="text-center text-red-400 p-10 font-bold">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
                }
            },

            renderExamPrep: function() {
                const conf = this.config['exam_prep_exam_prep'] || {};
                const isActive = conf.active === true;
                const card = document.getElementById('exam-prep-card');
                
                if (isActive) {
                    card.classList.remove('disabled');
                    card.onclick = () => app.startQuiz('exam_prep', 'exam_prep', 'ì§€í•„í‰ê°€ ëŒ€ë¹„ ì‹¤ì „');
                    document.getElementById('banner-badge').className = "bg-red-500 text-white text-[10px] font-bold px-2 py-1 rounded inline-block mb-2 shadow-sm";
                    document.getElementById('banner-badge').innerText = "FINAL CHECK";
                    document.getElementById('banner-title').innerText = "ì§€í•„í‰ê°€ ëŒ€ë¹„ ì‹¤ì „ ë¬¸ì œ";
                    document.getElementById('banner-desc').innerText = "ì‹¤ì œ ì‹œí—˜ì²˜ëŸ¼ ë¬¸ì œë¥¼ í’€ì–´ë³´ê³  ì‹¤ë ¥ì„ ì ê²€í•˜ì„¸ìš”.";
                    document.getElementById('banner-desc').className = "text-blue-100 text-sm font-medium opacity-90";
                    document.getElementById('banner-icon').classList.remove('hidden');
                }
                // If not active, it stays in default disabled state (HTML default)
            },

            renderList: function() {
                const container = document.getElementById('quiz-list-container');
                if(this.tree.length === 0) {
                    container.innerHTML = '<div class="text-center py-10 text-gray-400">ë“±ë¡ëœ ë‹¨ì›ì´ ì—†ìŠµë‹ˆë‹¤.<br><span class="text-xs">ì„ ìƒë‹˜ì´ ì•„ì§ ë‹¨ì›ì„ ë“±ë¡í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</span></div>';
                    return;
                }

                let html = '';
                this.tree.forEach(big => {
                    // Level 0: Big Unit
                    html += `<div class="unit-item level-0">${big.title}</div>`;
                    if(big.children) {
                        big.children.forEach(mid => {
                            // Level 1: Mid Unit (with buttons)
                            const diagConf = this.config[`${mid.id}_diagnostic`] || {};
                            const formConf = this.config[`${mid.id}_formative`] || {};
                            const isDiagActive = diagConf.active === true;
                            const isFormActive = formConf.active === true;

                            html += `
                                <div class="unit-item level-1">
                                    <div class="title-area">
                                        <i class="fas fa-folder folder-icon"></i>
                                        <span class="font-bold text-gray-700">${mid.title}</span>
                                    </div>
                                    <div class="flex gap-2">
                                        <button onclick="${isDiagActive ? `app.startQuiz('${mid.id}', 'diagnostic', '${mid.title}')` : ''}" 
                                            class="btn-action ${isDiagActive ? 'btn-diag' : 'btn-disabled'}">
                                            ${isDiagActive ? '<i class="fas fa-stethoscope"></i> ì§„ë‹¨' : '<i class="fas fa-lock"></i> ì§„ë‹¨'}
                                        </button>
                                        <button onclick="${isFormActive ? `app.startQuiz('${mid.id}', 'formative', '${mid.title}')` : ''}" 
                                            class="btn-action ${isFormActive ? 'btn-form' : 'btn-disabled'}">
                                            ${isFormActive ? '<i class="fas fa-pencil-alt"></i> í˜•ì„±' : '<i class="fas fa-lock"></i> í˜•ì„±'}
                                        </button>
                                    </div>
                                </div>
                            `;
                        });
                    }
                });
                container.innerHTML = html;
            },

            startQuiz: function(unitId, cat, title) {
                const url = `quiz-runner.html?unitId=${unitId}&category=${cat}&title=${encodeURIComponent(title)}`;
                window.location.href = url;
            }
        };

        app.init();
    </script>
</body>
</html>
