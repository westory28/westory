
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Westory - ì—­ì‚¬ í‰ê°€</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    
    <!-- Config & Styles -->
    <link rel="stylesheet" href="../assets/css/style.css">
    <script src="../assets/js/firebase-config.js"></script>
    <script src="../assets/js/auth-manager.js"></script>
    
    <style>
        .exam-banner { background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%); color: white; border-radius: 16px; padding: 24px; position: relative; overflow: hidden; cursor: pointer; transition: transform 0.2s; }
        .exam-banner:hover { transform: scale(1.01); }
        .exam-banner.disabled { background: #e5e7eb; cursor: not-allowed; opacity: 0.8; }
        .exam-deco { position: absolute; font-size: 8rem; opacity: 0.1; right: -20px; bottom: -20px; transform: rotate(-15deg); }
        
        .unit-header { background: #f8fafc; padding: 16px 20px; border-bottom: 1px solid #e2e8f0; font-weight: 800; color: #1e293b; font-size: 1.1rem; }
        .unit-row { display: flex; justify-content: space-between; align-items: center; padding: 16px 20px; border-bottom: 1px solid #f1f5f9; background: white; transition: background 0.2s; }
        .unit-row:hover { background-color: #f8fafc; }
        .unit-title { font-weight: 600; color: #475569; display: flex; align-items: center; }
        .unit-title::before { content: ''; display: inline-block; width: 6px; height: 6px; background-color: #cbd5e1; border-radius: 50%; margin-right: 12px; }
        
        .btn-action { padding: 6px 12px; border-radius: 6px; font-size: 0.85rem; font-weight: 700; transition: all 0.2s; display: inline-flex; align-items: center; gap: 6px; border: 1px solid transparent; }
        .btn-diag { color: #2563eb; background-color: #eff6ff; border-color: #dbeafe; }
        .btn-diag:hover { background-color: #2563eb; color: white; border-color: #2563eb; }
        .btn-form { color: #059669; background-color: #ecfdf5; border-color: #d1fae5; }
        .btn-form:hover { background-color: #059669; color: white; border-color: #059669; }
        .btn-disabled { color: #9ca3af; background-color: #f3f4f6; border-color: #e5e7eb; cursor: not-allowed; }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header injected by AuthManager -->

    <main class="container mx-auto px-4 py-8 max-w-4xl">
        
        <div id="greeting-area" class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 mb-8 flex items-center gap-3 hidden animate-[fadeIn_0.5s]">
            <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center text-xl">ğŸ”¥</div>
            <div>
                <div class="font-bold text-gray-800"><span id="user-name-display" class="text-blue-600">í•™ìƒ</span>ë‹˜, ì˜¤ëŠ˜ë„ í™”ì´íŒ…!</div>
                <div class="text-xs text-gray-400" id="semester-text">2025í•™ë…„ë„</div>
            </div>
        </div>

        <!-- 1. Exam Prep Banner -->
        <section class="mb-10">
            <h2 class="text-lg font-bold text-gray-800 mb-3 ml-1 flex items-center gap-2">
                <i class="fas fa-flag-checkered text-blue-600"></i> ì‹¤ì „ ëŒ€ë¹„
            </h2>
            <div id="exam-prep-card" class="exam-banner shadow-lg group" onclick="app.startQuiz('exam_prep', 'exam_prep', 'ì§€í•„í‰ê°€ ëŒ€ë¹„ ì‹¤ì „')">
                <i class="fas fa-pen-fancy exam-deco text-white"></i>
                <div class="relative z-10">
                    <div class="bg-red-500 text-white text-[10px] font-bold px-2 py-1 rounded inline-block mb-2 shadow-sm">FINAL CHECK</div>
                    <h3 class="text-2xl font-black mb-1">ì§€í•„í‰ê°€ ëŒ€ë¹„ ì‹¤ì „ ë¬¸ì œ</h3>
                    <p class="text-blue-100 text-sm font-medium opacity-90">ì‹¤ì œ ì‹œí—˜ì²˜ëŸ¼ ë¬¸ì œë¥¼ í’€ì–´ë³´ê³  ì‹¤ë ¥ì„ ì ê²€í•˜ì„¸ìš”.</p>
                </div>
                <div class="absolute right-6 top-1/2 transform -translate-y-1/2 bg-white/20 backdrop-blur-sm p-3 rounded-full text-white group-hover:bg-white group-hover:text-blue-600 transition">
                    <i class="fas fa-chevron-right text-xl"></i>
                </div>
            </div>
        </section>

        <!-- 2. Curriculum Tree List -->
        <section>
            <h2 class="text-lg font-bold text-gray-800 mb-4 ml-1 flex items-center gap-2">
                <i class="fas fa-layer-group text-amber-500"></i> ë‹¨ì›ë³„ í‰ê°€
            </h2>
            <div id="quiz-list-container" class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                <div class="py-20 text-center text-gray-400">
                    <div class="loader-spinner mx-auto mb-3"></div>
                    <p>í‰ê°€ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                </div>
            </div>
        </section>

    </main>

    <!-- Footer injected by AuthManager -->

    <script>
        window.AuthManager.init('student');

        const app = {
            config: {},
            tree: [],

            init: function() {
                document.addEventListener('auth-ready', (e) => {
                    const user = e.detail;
                    this.loadUserInfo(user.uid);
                    document.getElementById('semester-text').innerText = `${window.currentConfig.year}í•™ë…„ë„ ${window.currentConfig.semester}í•™ê¸°`;
                    this.loadData();
                });
            },

            loadUserInfo: async function(uid) {
                try {
                    const doc = await window.getCollection('users').doc(uid).get();
                    if(doc.exists) {
                        document.getElementById('user-name-display').innerText = doc.data().name || "í•™ìƒ";
                        document.getElementById('greeting-area').classList.remove('hidden');
                    }
                } catch(e) {}
            },

            loadData: async function() {
                try {
                    // Fetch Tree & Settings from 'settings' doc
                    const [treeDoc, settingsDoc] = await Promise.all([
                        window.getCollection('curriculum').doc('tree').get(),
                        window.getCollection('assessment_config').doc('settings').get()
                    ]);

                    this.tree = (treeDoc.exists && treeDoc.data().tree) ? treeDoc.data().tree : [];
                    // Handle old format (status doc) vs new format (settings doc)
                    // If settings doc exists, use it. Else fallback or empty.
                    this.config = (settingsDoc.exists) ? settingsDoc.data() : {};
                    
                    // Legacy support check: if empty, try loading 'status' doc for basic activation
                    if(Object.keys(this.config).length === 0) {
                         const statusDoc = await window.getCollection('assessment_config').doc('status').get();
                         if(statusDoc.exists) {
                             const raw = statusDoc.data();
                             // Convert simple boolean to object format
                             for(const key in raw) { this.config[key] = { active: raw[key] }; }
                         }
                    }
                    
                    this.renderExamPrep();
                    this.renderList();
                } catch(e) {
                    console.error(e);
                    document.getElementById('quiz-list-container').innerHTML = '<div class="text-center text-red-400 p-10">ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨</div>';
                }
            },

            renderExamPrep: function() {
                const conf = this.config['exam_prep_exam_prep'] || {};
                const isActive = conf.active === true;
                const card = document.getElementById('exam-prep-card');
                if(!isActive) {
                    card.classList.add('disabled', 'bg-gray-200');
                    card.classList.remove('exam-banner', 'cursor-pointer', 'shadow-lg');
                    card.style.background = '#e5e7eb';
                    card.onclick = null;
                    card.querySelector('h3').innerText += " (ì¤€ë¹„ì¤‘)";
                    card.querySelector('p').innerText = "ì„ ìƒë‹˜ì´ í‰ê°€ë¥¼ í™œì„±í™”í•˜ë©´ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.";
                    card.querySelector('i.fa-chevron-right').parentElement.style.display = 'none';
                }
            },

            renderList: function() {
                const container = document.getElementById('quiz-list-container');
                if(this.tree.length === 0) {
                    container.innerHTML = '<div class="text-center py-10 text-gray-400">ë“±ë¡ëœ ë‹¨ì›ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                    return;
                }

                let html = '';
                this.tree.forEach(big => {
                    html += `<div class="unit-header">${big.title}</div>`;
                    if(big.children) {
                        big.children.forEach(mid => {
                            // Check Config for this unit
                            const diagConf = this.config[`${mid.id}_diagnostic`] || {};
                            const formConf = this.config[`${mid.id}_formative`] || {};
                            
                            const isDiagActive = diagConf.active === true;
                            const isFormActive = formConf.active === true;

                            html += `
                                <div class="unit-row">
                                    <div class="unit-title">${mid.title}</div>
                                    <div class="flex gap-2">
                                        <button onclick="${isDiagActive ? `app.startQuiz('${mid.id}', 'diagnostic', '${mid.title}')` : ''}" 
                                            class="btn-action ${isDiagActive ? 'btn-diag' : 'btn-disabled'}">
                                            ${isDiagActive ? '<i class="fas fa-stethoscope"></i> ì§„ë‹¨í‰ê°€' : '<i class="fas fa-lock"></i> ì§„ë‹¨'}
                                        </button>
                                        <button onclick="${isFormActive ? `app.startQuiz('${mid.id}', 'formative', '${mid.title}')` : ''}" 
                                            class="btn-action ${isFormActive ? 'btn-form' : 'btn-disabled'}">
                                            ${isFormActive ? '<i class="fas fa-pencil-alt"></i> í˜•ì„±í‰ê°€' : '<i class="fas fa-lock"></i> í˜•ì„±'}
                                        </button>
                                    </div>
                                </div>
                            `;
                        });
                    }
                });
                container.innerHTML = html;
            },

            startQuiz: function(unitId, cat, title) {
                const url = `quiz-runner.html?unitId=${unitId}&category=${cat}&title=${encodeURIComponent(title)}`;
                window.location.href = url;
            }
        };

        app.init();
    </script>
</body>
</html>
