<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>학사 일정 - Westory</title>
    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- FullCalendar -->
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <script src="../assets/js/firebase-config.js"></script>
    <link rel="stylesheet" href="../assets/css/style.css">
    <script src="../assets/js/auth-manager.js"></script>

    <style>
        .fc-toolbar-title {
            font-size: 1.25em !important;
            font-weight: 700;
            color: #1f2937;
        }

        .fc-button {
            background-color: #2563eb !important;
            border-color: #2563eb !important;
            font-weight: 600 !important;
        }

        .fc-daygrid-event {
            cursor: pointer;
            border-radius: 4px;
            padding: 2px 4px;
            font-size: 0.8rem;
            font-weight: 600;
            border: none;
            transition: transform 0.1s;
        }

        .fc-daygrid-event:hover {
            transform: scale(1.02);
        }

        /* Korean Calendar Colors */
        .fc-day-sun a {
            color: #ef4444 !important;
            text-decoration: none;
            font-weight: 700;
        }

        /* Red for Sunday */
        .fc-day-sat a {
            color: #3b82f6 !important;
            text-decoration: none;
            font-weight: 700;
        }

        /* Blue for Saturday */

        /* Holiday Styles */
        .fc-day-holiday a {
            color: #ef4444 !important;
            font-weight: 700;
        }

        /* Red date number */
        .holiday-text-event {
            background-color: transparent !important;
            border: none !important;
        }

        .holiday-text-event .fc-event-title {
            color: #ef4444;
            font-size: 0.75rem;
            font-weight: 800;
        }

        .fc-event-main {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 100;
            display: flex;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(2px);
        }

        /* Mobile Optimization for Calendar */
        @media (max-width: 768px) {
            .fc-toolbar {
                flex-direction: column;
                gap: 0.5rem;
            }

            .fc-toolbar-title {
                font-size: 1rem !important;
            }

            .fc-button {
                padding: 0.25rem 0.5rem !important;
                font-size: 0.75rem !important;
            }

            .fc-header-toolbar {
                margin-bottom: 0.5rem !important;
            }
        }
    </style>
</head>

<body class="bg-gray-50 flex flex-col h-screen">
    <!-- Header injected by AuthManager -->

    <main class="flex-1 w-full max-w-5xl mx-auto px-4 py-6 h-full flex flex-col overflow-hidden">

        <div class="mb-4 shrink-0">
            <h1 class="text-2xl font-bold text-gray-800"><i class="fas fa-calendar-check text-green-500 mr-2"></i>학사 일정
            </h1>
            <p class="text-sm text-gray-500 mt-1">우리 반의 주요 일정과 평가 계획을 확인하세요.</p>
        </div>

        <div
            class="flex-1 bg-white rounded-xl shadow-lg border border-gray-100 p-4 md:p-6 overflow-hidden flex flex-col relative">
            <div class="flex items-center gap-4 mb-4 text-xs font-bold text-gray-500 justify-end">
                <div class="flex items-center"><span class="w-3 h-3 rounded-full bg-red-500 mr-1"></span>정기 시험</div>
                <div class="flex items-center"><span class="w-3 h-3 rounded-full bg-orange-500 mr-1"></span>수행평가</div>
                <div class="flex items-center"><span class="w-3 h-3 rounded-full bg-blue-500 mr-1"></span>진단/형성</div>
                <div class="flex items-center"><span class="w-3 h-3 rounded-full bg-green-500 mr-1"></span>행사</div>
            </div>
            <div id="calendar" class="h-full"></div>
        </div>

    </main>

    <!-- Detail Modal -->
    <div id="detail-modal" class="modal-overlay hidden" onclick="app.closeModal(event)">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 mx-4 relative transform transition-all scale-100"
            onclick="event.stopPropagation()">
            <div class="mb-4">
                <span id="detail-badge"
                    class="px-2 py-1 rounded text-xs font-bold text-white bg-gray-500 inline-block mb-2">TYPE</span>
                <h3 id="detail-title" class="text-xl font-bold text-gray-900 leading-tight">일정 제목</h3>
            </div>

            <div class="space-y-3 text-sm text-gray-600 bg-gray-50 p-4 rounded-xl border border-gray-100 mb-6">
                <div class="flex items-start gap-3">
                    <i class="fas fa-clock mt-1 text-blue-500"></i>
                    <div>
                        <p class="font-bold text-gray-800">기간</p>
                        <p id="detail-date">-</p>
                    </div>
                </div>
                <div class="flex items-start gap-3">
                    <i class="fas fa-align-left mt-1 text-blue-500"></i>
                    <div>
                        <p class="font-bold text-gray-800">상세 내용</p>
                        <p id="detail-desc" class="whitespace-pre-wrap leading-relaxed">-</p>
                    </div>
                </div>
            </div>

            <button onclick="app.closeModal()"
                class="w-full bg-gray-800 text-white font-bold py-3 rounded-xl hover:bg-gray-900 transition">닫기</button>
        </div>
    </div>

    <!-- Footer injected by AuthManager -->

    <script>
        window.AuthManager.init('student');

        const app = {
            calendar: null,
            userClassStr: null,
            colorMap: {
                'exam': '#ef4444',       // Red
                'performance': '#f97316', // Orange
                'event': '#10b981',       // Green
                'diagnosis': '#3b82f6',   // Blue
                'formative': '#3b82f6'    // Blue
            },
            typeLabelMap: {
                'exam': '정기 시험', 'performance': '수행평가', 'event': '행사', 'diagnosis': '진단평가', 'formative': '형성평가'
            },

            // Korean Public Holidays (2025-2026) Verified with Exact Rules
            holidays: {
                // 2025
                '2025-01-01': '신정',
                '2025-01-28': '설날', '2025-01-29': '설날', '2025-01-30': '설날',
                '2025-03-01': '삼일절', '2025-03-03': '대체공휴일', // 3.1 Sat -> 3.3 Mon
                '2025-05-05': '어린이날/석가탄신일', '2025-05-06': '대체공휴일', // Overlap -> 5.6 Tue
                '2025-06-06': '현충일',
                '2025-08-15': '광복절',
                '2025-10-03': '개천절',
                '2025-10-05': '추석', '2025-10-06': '추석', '2025-10-07': '추석', '2025-10-08': '대체공휴일', // 10.5 Sun -> 10.8 Wed
                '2025-10-09': '한글날',
                '2025-12-25': '성탄절',

                // 2026
                '2026-01-01': '신정',
                '2026-02-16': '설날', '2026-02-17': '설날', '2026-02-18': '설날', // No Sun overlap
                '2026-03-01': '삼일절', '2026-03-02': '대체공휴일', // 3.1 Sun -> 3.2 Mon
                '2026-05-05': '어린이날',
                '2026-05-24': '석가탄신일', '2026-05-25': '대체공휴일', // 5.24 Sun -> 5.25 Mon
                '2026-06-06': '현충일', // Sat - No substitute for Memorial Day
                '2026-08-15': '광복절', '2026-08-17': '대체공휴일', // 8.15 Sat -> 8.17 Mon (National Holiday)
                '2026-09-24': '추석', '2026-09-25': '추석', '2026-09-26': '추석', // No Sun overlap -> No substitute
                '2026-10-03': '개천절', '2026-10-05': '대체공휴일', // 10.3 Sat -> 10.5 Mon (National Holiday)
                '2026-10-09': '한글날',
                '2026-12-25': '성탄절'
            },

            init: function () {
                document.addEventListener('auth-ready', async (e) => {
                    const user = e.detail;
                    await this.loadUserClass(user.uid);
                    this.initCalendar();
                });
            },

            loadUserClass: async function (uid) {
                try {
                    const doc = await window.getCollection('users').doc(uid).get();
                    if (doc.exists) {
                        const d = doc.data();
                        if (d.grade && d.class) {
                            this.userClassStr = `${d.grade}-${d.class}`;
                        }
                    }
                } catch (e) { console.error(e); }
            },

            initCalendar: function () {
                const calendarEl = document.getElementById('calendar');

                // Convert holiday list to text events
                const holidayTextEvents = Object.keys(this.holidays).map(date => ({
                    title: this.holidays[date],
                    start: date,
                    allDay: true,
                    classNames: ['holiday-text-event']
                }));

                this.calendar = new FullCalendar.Calendar(calendarEl, {
                    initialView: 'dayGridMonth',
                    locale: 'ko',
                    headerToolbar: {
                        left: 'prev,next today',
                        center: 'title',
                        right: 'dayGridMonth,listMonth'
                    },
                    dayCellClassNames: (arg) => {
                        // Use local time matching to avoid timezone shifts
                        const year = arg.date.getFullYear();
                        const month = String(arg.date.getMonth() + 1).padStart(2, '0');
                        const day = String(arg.date.getDate()).padStart(2, '0');
                        const dateStr = `${year}-${month}-${day}`;

                        if (this.holidays[dateStr]) return ['fc-day-holiday'];
                        return [];
                    },
                    events: [...holidayTextEvents, this.fetchEvents.bind(this)],
                    eventClick: (info) => {
                        if (info.event.classNames.includes('holiday-text-event')) return;
                        this.openModal(info.event);
                    },
                    height: '100%',
                    displayEventTime: false,
                    fixedWeekCount: false
                });
                this.calendar.render();
            },

            //Helper function to get year/semester based collection path
            getCollectionPath: function (collectionName) {
                const cfg = window.currentConfig;
                if (!cfg || !cfg.year || !cfg.semester) {
                    console.error('Global config not loaded properly');
                    return null;
                }
                return `${cfg.year}-${cfg.semester}/${collectionName}`;
            },

            fetchEvents: async function (info, successCallback, failureCallback) {
                const path = this.getCollectionPath('calendar_events');
                if (!path) {
                    failureCallback(new Error('Collection path not available'));
                    return;
                }
                try {
                    const snapshot = await window.db.collection(path)
                        .where('start', '>=', info.startStr)
                        .where('start', '<', info.endStr)
                        .get();

                    const events = [];
                    snapshot.forEach(doc => {
                        const d = doc.data();

                        let isVisible = false;
                        if (d.targetType === 'common') isVisible = true;
                        else if (d.targetType === 'class' && d.targetClass === this.userClassStr) isVisible = true;

                        if (isVisible) {
                            events.push({
                                title: d.title,
                                start: d.start,
                                end: d.end || d.start,
                                backgroundColor: this.colorMap[d.eventType] || '#6b7280',
                                borderColor: this.colorMap[d.eventType] || '#6b7280',
                                extendedProps: d
                            });
                        }
                    });
                    successCallback(events);
                } catch (e) {
                    console.error(e);
                    failureCallback(e);
                }
            },

            openModal: function (eventObj) {
                const p = eventObj.extendedProps;
                document.getElementById('detail-title').innerText = p.title;
                document.getElementById('detail-badge').innerText = this.typeLabelMap[p.eventType] || '일정';
                document.getElementById('detail-badge').style.backgroundColor = this.colorMap[p.eventType] || '#6b7280';

                let dateText = p.start;
                if (p.end && p.end !== p.start) dateText += ` ~ ${p.end}`;
                document.getElementById('detail-date').innerText = dateText;

                document.getElementById('detail-desc').innerText = p.description || '상세 내용이 없습니다.';

                const modal = document.getElementById('detail-modal');
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            },

            closeModal: function (e) {
                if (e && e.target.id !== 'detail-modal') return;
                const modal = document.getElementById('detail-modal');
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }
        };

        app.init();
    </script>
</body>

</html>