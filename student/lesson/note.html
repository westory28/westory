
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìˆ˜ì—… í™œë™ - Westory</title>
    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="../../assets/js/firebase-config.js"></script>
    <link rel="stylesheet" href="../../assets/css/style.css">
    <script src="../../assets/js/auth-manager.js"></script>

    <style>
        .note-container { max-width: 800px; margin: 0 auto; padding: 24px; }
        .cloze-input { border: none; border-bottom: 2px solid #374151; text-align: center; font-weight: bold; color: #2563eb; background: transparent; padding: 0 4px; width: 100px; transition: all 0.2s; }
        .cloze-input:focus { outline: none; border-bottom-color: #2563eb; background-color: #eff6ff; }
        .cloze-input.correct { border-bottom-color: #22c55e; color: #15803d; background-color: #dcfce7; pointer-events: none; }
        .cloze-input.wrong { border-bottom-color: #ef4444; color: #b91c1c; background-color: #fee2e2; }
        .youtube-container { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 24px; }
        .youtube-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        .note-section { background: white; padding: 32px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border: 1px solid #e5e7eb; line-height: 2.2; font-size: 1.05rem; }
        /* Quill Content Styles */
        .note-section h1, .note-section h2 { font-weight: bold; margin-top: 1em; margin-bottom: 0.5em; }
        .note-section h1 { font-size: 1.5em; }
        .note-section h2 { font-size: 1.25em; border-left: 4px solid #2563eb; padding-left: 10px; }
        .note-section p { margin-bottom: 0.5em; }
        .note-section img { max-width: 100%; border-radius: 8px; margin: 10px 0; }
        .loader-spinner { border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <!-- Header injected by AuthManager -->

    <main class="note-container">
        
        <!-- Loading / Empty State -->
        <div id="loading-state" class="text-center py-32">
            <div class="loader-spinner mx-auto mb-4" id="loader"></div>
            <p class="text-gray-500 font-medium text-lg" id="status-msg">ìˆ˜ì—… ìë£Œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>
        </div>

        <!-- Content Area -->
        <div id="content-area" class="hidden animate-[fadeIn_0.5s_ease-out]">
            <!-- Title -->
            <div class="mb-6 border-b pb-4 border-gray-200">
                <span class="text-sm font-bold text-blue-600 bg-blue-50 px-2 py-1 rounded mb-2 inline-block">í•™ìŠµ ìë£Œ</span>
                <h1 class="text-2xl font-bold text-gray-900 leading-tight" id="lesson-title"></h1>
            </div>

            <!-- Video -->
            <div id="video-wrapper" class="youtube-container hidden">
                <iframe id="video-frame" frameborder="0" allowfullscreen></iframe>
            </div>

            <!-- Note Content -->
            <div id="lesson-body" class="note-section text-gray-800"></div>

            <!-- Action Buttons -->
            <div class="mt-8 flex justify-end gap-3 sticky bottom-6 z-10">
                <button onclick="resetInputs()" class="px-6 py-3 bg-white border border-gray-300 text-gray-700 font-bold rounded-lg shadow-sm hover:bg-gray-50 transition"><i class="fas fa-undo mr-2"></i>ì´ˆê¸°í™”</button>
                <button onclick="checkAnswers()" class="px-6 py-3 bg-blue-600 text-white font-bold rounded-lg shadow-lg hover:bg-blue-700 transition transform active:scale-95"><i class="fas fa-check mr-2"></i>ì •ë‹µ í™•ì¸</button>
            </div>
        </div>

    </main>

    <!-- Footer injected by AuthManager -->

    <script>
        window.AuthManager.init('student');

        document.addEventListener('auth-ready', async () => {
            const params = new URLSearchParams(window.location.search);
            const unitId = params.get('id');
            const titleParam = params.get('title');

            if(!unitId) {
                showStatus("ì„ íƒëœ ë‹¨ì›ì´ ì—†ìŠµë‹ˆë‹¤.<br>ëª©ë¡ì—ì„œ ë‹¨ì›ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
                return;
            }

            try {
                // Fetch from current semester's lessons
                const snap = await window.getCollection('lessons').where('unitId', '==', unitId).limit(1).get();
                
                if(snap.empty) {
                    showStatus("ì•„ì§ ë“±ë¡ëœ ìˆ˜ì—… ìë£Œê°€ ì—†ìŠµë‹ˆë‹¤.<br>ì„ ìƒë‹˜ê»˜ ë¬¸ì˜í•´ì£¼ì„¸ìš”. ğŸ™‡â€â™‚ï¸");
                    return;
                }

                const data = snap.docs[0].data();
                renderLesson(data, titleParam);
            } catch(e) {
                console.error(e);
                showStatus("ìë£Œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
        });

        function showStatus(msg) {
            document.getElementById('loader').classList.add('hidden');
            document.getElementById('status-msg').innerHTML = msg;
        }

        function renderLesson(data, fallbackTitle) {
            document.getElementById('loading-state').classList.add('hidden');
            document.getElementById('content-area').classList.remove('hidden');

            // Title
            document.getElementById('lesson-title').innerText = data.title || fallbackTitle || 'ì œëª© ì—†ìŒ';
            
            // Video
            if(data.videoUrl) {
                const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
                const match = data.videoUrl.match(regExp);
                if (match && match[2].length === 11) {
                    document.getElementById('video-frame').src = `https://www.youtube.com/embed/${match[2]}`;
                    document.getElementById('video-wrapper').classList.remove('hidden');
                }
            }

            // HTML Content & Cloze Conversion
            let html = data.contentHtml || '';
            // Replace [answer] with input fields
            html = html.replace(/\[(.*?)\]/g, (match, p1) => {
                // p1 is the answer text inside brackets
                return `<input type="text" class="cloze-input" data-answer="${p1}" placeholder="ë¹ˆì¹¸" autocomplete="off">`;
            });
            
            document.getElementById('lesson-body').innerHTML = html;
        }

        function checkAnswers() {
            const inputs = document.querySelectorAll('.cloze-input');
            if(inputs.length === 0) {
                alert("ì±„ì í•  ë¹ˆì¹¸ì´ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }

            let correctCount = 0;
            inputs.forEach(input => {
                const userAnswer = input.value.trim().replace(/\s+/g, '');
                const correctAnswer = input.dataset.answer.replace(/\s+/g, '');
                
                if (userAnswer === correctAnswer) {
                    input.classList.add('correct');
                    input.classList.remove('wrong');
                    correctCount++;
                } else {
                    input.classList.add('wrong');
                    input.classList.remove('correct');
                }
            });

            if (correctCount === inputs.length) {
                alert("ğŸ‰ í›Œë¥­í•©ë‹ˆë‹¤! ëª¨ë“  ë¹ˆì¹¸ì„ ì™„ë²½í•˜ê²Œ ì±„ì› ìŠµë‹ˆë‹¤.");
            }
        }

        function resetInputs() {
            if(!confirm("ì…ë ¥í•œ ë‚´ìš©ì„ ëª¨ë‘ ì§€ìš°ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            const inputs = document.querySelectorAll('.cloze-input');
            inputs.forEach(input => {
                input.value = '';
                input.classList.remove('correct', 'wrong');
            });
        }
    </script>
</body>
</html>
