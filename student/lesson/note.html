
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìˆ˜ì—… í™œë™ - Westory</title>
    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="../../assets/js/firebase-config.js"></script>
    <link rel="stylesheet" href="../../assets/css/style.css">
    <script src="../../assets/js/auth-manager.js"></script>

    <style>
        body { height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        main { flex: 1; display: flex; overflow: hidden; height: 100%; }
        
        /* Sidebar */
        .lesson-sidebar { width: 300px; background: white; border-right: 1px solid #e5e7eb; display: flex; flex-direction: column; height: 100%; transition: transform 0.3s; z-index: 40; }
        .sidebar-header { padding: 16px; border-bottom: 1px solid #f3f4f6; font-weight: 800; color: #1f2937; display: flex; justify-content: space-between; align-items: center; }
        .sidebar-content { flex: 1; overflow-y: auto; padding: 12px; }
        
        /* Tree Items */
        .tree-group { margin-bottom: 12px; }
        .tree-header { font-size: 0.95rem; font-weight: 700; color: #374151; padding: 8px 12px; cursor: pointer; display: flex; align-items: center; border-radius: 6px; transition: background 0.2s; }
        .tree-header:hover { background-color: #f3f4f6; }
        .tree-header i { margin-right: 8px; font-size: 0.8em; color: #9ca3af; transition: transform 0.2s; }
        .tree-group.open .tree-header i { transform: rotate(90deg); color: #3b82f6; }
        .tree-children { display: none; padding-left: 12px; margin-top: 4px; }
        .tree-group.open .tree-children { display: block; }
        
        .lesson-item { display: flex; align-items: center; padding: 8px 12px; font-size: 0.9rem; color: #6b7280; border-radius: 6px; cursor: pointer; transition: all 0.2s; text-decoration: none; margin-bottom: 2px; }
        .lesson-item:hover { background-color: #eff6ff; color: #2563eb; }
        .lesson-item.active { background-color: #2563eb; color: white; font-weight: 700; }
        .lesson-item i { margin-right: 8px; font-size: 1rem; }

        /* Main Content */
        .content-container { flex: 1; overflow-y: auto; padding: 32px; background-color: #f9fafb; position: relative; }
        .note-wrapper { max-width: 800px; margin: 0 auto; }

        .cloze-input { border: none; border-bottom: 2px solid #374151; text-align: center; font-weight: bold; color: #2563eb; background: transparent; padding: 0 4px; width: 100px; transition: all 0.2s; }
        .cloze-input:focus { outline: none; border-bottom-color: #2563eb; background-color: #eff6ff; }
        .cloze-input.correct { border-bottom-color: #22c55e; color: #15803d; background-color: #dcfce7; pointer-events: none; }
        .cloze-input.wrong { border-bottom-color: #ef4444; color: #b91c1c; background-color: #fee2e2; }
        .youtube-container { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 24px; }
        .youtube-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        .note-section { background: white; padding: 40px; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border: 1px solid #e5e7eb; line-height: 2.2; font-size: 1.05rem; }
        
        /* Quill Content Styles */
        .note-section h1, .note-section h2 { font-weight: bold; margin-top: 1em; margin-bottom: 0.5em; }
        .note-section h1 { font-size: 1.5em; }
        .note-section h2 { font-size: 1.25em; border-left: 4px solid #2563eb; padding-left: 10px; }
        .note-section p { margin-bottom: 0.5em; }
        .note-section img { max-width: 100%; border-radius: 8px; margin: 10px 0; }
        
        /* Mobile Toggle */
        .sidebar-toggle { display: none; position: absolute; bottom: 20px; left: 20px; z-index: 50; background: #1f2937; color: white; width: 50px; height: 50px; border-radius: 50%; align-items: center; justify-content: center; box-shadow: 0 4px 6px rgba(0,0,0,0.2); cursor: pointer; }
        
        @media (max-width: 768px) {
            .lesson-sidebar { position: fixed; left: 0; top: 64px; bottom: 0; transform: translateX(-100%); width: 80%; max-width: 320px; }
            .lesson-sidebar.show { transform: translateX(0); }
            .sidebar-toggle { display: flex; }
            .content-container { padding: 20px; }
            .note-section { padding: 20px; }
        }
        
        .overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 30; }
        .overlay.show { display: block; }
    </style>
</head>
<body>
    <!-- Header injected by AuthManager -->

    <main>
        <!-- Mobile Overlay -->
        <div id="sidebar-overlay" class="overlay" onclick="toggleSidebar()"></div>

        <!-- Sidebar -->
        <aside id="lesson-sidebar" class="lesson-sidebar">
            <div class="sidebar-header">
                <span>ğŸ“‘ ìˆ˜ì—… ëª©ì°¨</span>
                <button onclick="toggleSidebar()" class="md:hidden text-gray-400"><i class="fas fa-times"></i></button>
            </div>
            <div id="tree-root" class="sidebar-content">
                <div class="text-center text-gray-400 py-10 text-sm">ëª©ì°¨ ë¡œë”© ì¤‘...</div>
            </div>
        </aside>

        <!-- Content -->
        <div class="content-container">
            <button class="sidebar-toggle" onclick="toggleSidebar()"><i class="fas fa-list"></i></button>
            
            <div class="note-wrapper">
                <!-- Loading / Empty State -->
                <div id="loading-state" class="text-center py-32">
                    <div class="text-6xl mb-4">ğŸ‘ˆ</div>
                    <h2 class="text-xl font-bold text-gray-700">í•™ìŠµí•  ë‹¨ì›ì„ ì„ íƒí•˜ì„¸ìš”</h2>
                    <p class="text-gray-500 mt-2">ì™¼ìª½ ëª©ë¡ì—ì„œ ìˆ˜ì—… ìë£Œë¥¼ í´ë¦­í•˜ë©´ ë‚´ìš©ì´ í‘œì‹œë©ë‹ˆë‹¤.</p>
                </div>

                <!-- Actual Content -->
                <div id="content-area" class="hidden animate-[fadeIn_0.3s_ease-out]">
                    <!-- Title -->
                    <div class="mb-6">
                        <span class="text-xs font-bold text-blue-600 bg-blue-50 px-2 py-1 rounded mb-2 inline-block">í•™ìŠµ ìë£Œ</span>
                        <h1 class="text-3xl font-extrabold text-gray-900 leading-tight" id="lesson-title"></h1>
                    </div>

                    <!-- Video -->
                    <div id="video-wrapper" class="youtube-container hidden">
                        <iframe id="video-frame" frameborder="0" allowfullscreen></iframe>
                    </div>

                    <!-- Note Content -->
                    <div id="lesson-body" class="note-section text-gray-800"></div>

                    <!-- Action Buttons -->
                    <div class="mt-8 flex justify-center gap-4 pb-10">
                        <button onclick="resetInputs()" class="px-6 py-3 bg-white border-2 border-gray-200 text-gray-600 font-bold rounded-xl shadow-sm hover:bg-gray-50 transition"><i class="fas fa-undo mr-2"></i>ë‹¤ì‹œ í’€ê¸°</button>
                        <button onclick="checkAnswers()" class="px-8 py-3 bg-blue-600 text-white font-bold rounded-xl shadow-lg hover:bg-blue-700 transition transform active:scale-95"><i class="fas fa-check mr-2"></i>ì •ë‹µ í™•ì¸</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer injected by AuthManager -->

    <script>
        window.AuthManager.init('student');

        let currentLessonId = null;

        document.addEventListener('auth-ready', async () => {
            await loadTree();
            
            // Check URL Params for deep linking
            const params = new URLSearchParams(window.location.search);
            const unitId = params.get('id');
            const titleParam = params.get('title');

            if(unitId) {
                loadLessonContent(unitId, titleParam);
            }
        });

        function toggleSidebar() {
            document.getElementById('lesson-sidebar').classList.toggle('show');
            document.getElementById('sidebar-overlay').classList.toggle('show');
        }

        async function loadTree() {
            const treeContainer = document.getElementById('tree-root');
            try {
                const doc = await window.getCollection('curriculum').doc('tree').get();
                if (!doc.exists || !doc.data().tree) {
                    treeContainer.innerHTML = '<div class="p-4 text-center text-gray-400 text-sm">ë“±ë¡ëœ ëª©ì°¨ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                    return;
                }

                const tree = doc.data().tree;
                let html = '';

                tree.forEach((big, idx) => {
                    // Default open if it's the first one or if user hasn't selected anything
                    const isOpen = idx === 0 ? 'open' : '';
                    
                    html += `
                        <div class="tree-group ${isOpen}">
                            <div class="tree-header" onclick="this.parentElement.classList.toggle('open')">
                                <i class="fas fa-chevron-right"></i>
                                <span>${big.title}</span>
                            </div>
                            <div class="tree-children">
                                ${(big.children || []).map(mid => `
                                    <div class="mb-2">
                                        <div class="text-xs font-bold text-gray-400 px-3 py-1">${mid.title}</div>
                                        ${(mid.children || []).map(small => `
                                            <div class="lesson-item" id="item-${small.id}" onclick="onSelectLesson('${small.id}', '${small.title}')">
                                                <i class="far fa-file-alt"></i>
                                                <span class="truncate">${small.title}</span>
                                            </div>
                                        `).join('')}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                });
                treeContainer.innerHTML = html;
            } catch (e) {
                console.error(e);
                treeContainer.innerHTML = '<div class="p-4 text-red-500 text-sm">ëª©ì°¨ ë¡œë“œ ì‹¤íŒ¨</div>';
            }
        }

        window.onSelectLesson = function(id, title) {
            // Update URL without reload
            const newUrl = `${window.location.pathname}?id=${id}&title=${encodeURIComponent(title)}`;
            window.history.pushState({path: newUrl}, '', newUrl);
            
            // Close sidebar on mobile
            if(window.innerWidth < 768) toggleSidebar();

            loadLessonContent(id, title);
        };

        async function loadLessonContent(unitId, fallbackTitle) {
            // Update Active State in Sidebar
            document.querySelectorAll('.lesson-item').forEach(el => el.classList.remove('active'));
            const activeItem = document.getElementById(`item-${unitId}`);
            if(activeItem) activeItem.classList.add('active');

            // Show Loading
            document.getElementById('loading-state').classList.add('hidden');
            document.getElementById('content-area').classList.add('hidden');
            
            // Re-use loading spinner from previous layout if needed, or simple opacity
            // Ideally create a local spinner, but for now just clear content
            
            try {
                const snap = await window.getCollection('lessons').where('unitId', '==', unitId).limit(1).get();
                if(snap.empty) {
                    document.getElementById('loading-state').classList.remove('hidden');
                    document.getElementById('loading-state').innerHTML = `<div class="text-6xl mb-4">ğŸ“­</div><h2 class="text-xl font-bold">ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤</h2><p class="text-gray-500">ì„ ìƒë‹˜ì´ ì•„ì§ ìë£Œë¥¼ ë“±ë¡í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>`;
                    return;
                }

                const data = snap.docs[0].data();
                renderLesson(data, fallbackTitle);
            } catch(e) {
                console.error(e);
                alert("ìë£Œ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
        }

        function renderLesson(data, fallbackTitle) {
            document.getElementById('loading-state').classList.add('hidden');
            document.getElementById('content-area').classList.remove('hidden');

            document.getElementById('lesson-title').innerText = data.title || fallbackTitle || 'ì œëª© ì—†ìŒ';
            
            if(data.videoUrl) {
                const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
                const match = data.videoUrl.match(regExp);
                if (match && match[2].length === 11) {
                    document.getElementById('video-frame').src = `https://www.youtube.com/embed/${match[2]}`;
                    document.getElementById('video-wrapper').classList.remove('hidden');
                } else {
                    document.getElementById('video-wrapper').classList.add('hidden');
                }
            } else {
                document.getElementById('video-wrapper').classList.add('hidden');
            }

            let html = data.contentHtml || '';
            html = html.replace(/\[(.*?)\]/g, (match, p1) => {
                return `<input type="text" class="cloze-input" data-answer="${p1}" placeholder="ë¹ˆì¹¸" autocomplete="off">`;
            });
            
            document.getElementById('lesson-body').innerHTML = html;
            
            // Scroll to top
            document.querySelector('.content-container').scrollTop = 0;
        }

        window.checkAnswers = function() {
            const inputs = document.querySelectorAll('.cloze-input');
            if(inputs.length === 0) { alert("ì±„ì í•  ë¹ˆì¹¸ì´ ì—†ìŠµë‹ˆë‹¤."); return; }

            let correctCount = 0;
            inputs.forEach(input => {
                const userAnswer = input.value.trim().replace(/\s+/g, '');
                const correctAnswer = input.dataset.answer.replace(/\s+/g, '');
                if (userAnswer === correctAnswer) {
                    input.classList.add('correct'); input.classList.remove('wrong'); correctCount++;
                } else {
                    input.classList.add('wrong'); input.classList.remove('correct');
                }
            });

            if (correctCount === inputs.length) alert("ğŸ‰ í›Œë¥­í•©ë‹ˆë‹¤! ëª¨ë“  ë¹ˆì¹¸ì„ ì™„ë²½í•˜ê²Œ ì±„ì› ìŠµë‹ˆë‹¤.");
        };

        window.resetInputs = function() {
            if(!confirm("ì…ë ¥í•œ ë‚´ìš©ì„ ëª¨ë‘ ì§€ìš°ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            const inputs = document.querySelectorAll('.cloze-input');
            inputs.forEach(input => { input.value = ''; input.classList.remove('correct', 'wrong'); });
        };
    </script>
</body>
</html>
