<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í‰ê°€ ì‘ì‹œ - Westory</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <!-- Config & Styles -->
    <link rel="stylesheet" href="../assets/css/style.css">
    <script src="../assets/js/firebase-config.js"></script>
    <script src="../assets/js/auth-manager.js"></script>

    <style>
        .quiz-option {
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
        }

        .quiz-option:hover {
            border-color: #93c5fd;
            background-color: #f0f9ff;
        }

        .quiz-option.selected {
            border-color: #2563eb;
            background-color: #eff6ff;
            color: #1e40af;
            font-weight: bold;
        }

        .opt-num {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            font-size: 0.8rem;
            font-weight: bold;
            color: #64748b;
        }

        .quiz-option.selected .opt-num {
            background: #2563eb;
            color: white;
        }

        .timer-progress {
            transition: width 1s linear;
        }

        .timer-urgent {
            background-color: #ef4444;
        }
    </style>
</head>

<body class="bg-gray-50 text-gray-800">
    <div id="loading-overlay" class="fixed inset-0 bg-white z-50 flex flex-col items-center justify-center">
        <div class="loader-spinner"></div>
        <p class="mt-4 text-gray-500 font-bold" id="loading-msg">ë§ì¶¤í˜• ì‹œí—˜ í™˜ê²½ êµ¬ì„± ì¤‘...</p>
    </div>

    <!-- Main Container -->
    <main class="max-w-2xl mx-auto px-4 py-8 min-h-screen flex flex-col">

        <!-- View: Intro / Ready -->
        <section id="view-intro" class="flex-1 flex flex-col items-center justify-center text-center hidden">
            <div class="bg-white p-8 rounded-2xl shadow-lg border border-gray-100 w-full">
                <div
                    class="w-16 h-16 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-3xl mx-auto mb-6">
                    <i class="fas fa-file-signature"></i>
                </div>
                <h1 class="text-2xl font-bold text-gray-900 mb-2" id="intro-title">ë‹¨ì›ëª…</h1>
                <p class="text-gray-500 mb-6 font-medium bg-gray-50 inline-block px-4 py-1 rounded-full text-sm"
                    id="intro-subtitle">ì§„ë‹¨í‰ê°€</p>

                <div class="space-y-4 mb-8 text-left bg-blue-50 p-5 rounded-xl border border-blue-100 text-sm">
                    <div class="flex justify-between border-b border-blue-200 pb-2">
                        <span class="text-gray-600">ì œí•œ ì‹œê°„</span>
                        <span class="font-bold text-blue-800" id="info-time">60ì´ˆ</span>
                    </div>
                    <div class="flex justify-between border-b border-blue-200 pb-2">
                        <span class="text-gray-600">ì¶œì œ ë¬¸í•­ ìˆ˜</span>
                        <span class="font-bold text-blue-800" id="info-count">- ë¬¸í•­</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">ë‚˜ì˜ ê¸°ë¡</span>
                        <span class="font-bold text-gray-800" id="info-history">-íšŒ ì‘ì‹œ</span>
                    </div>
                </div>

                <div id="start-btn-area">
                    <button onclick="app.startQuiz()"
                        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl shadow-md transition transform active:scale-95 text-lg">
                        í‰ê°€ ì‹œì‘í•˜ê¸°
                    </button>
                    <p class="mt-4 text-xs text-gray-400">ì •ê¸° ì‹œí—˜ ëŒ€ë¹„ëŠ” ë‹¨ì›ë³„ë¡œ ê³ ë¥´ê²Œ ì¶œì œë©ë‹ˆë‹¤.</p>
                </div>
                <div id="blocked-msg"
                    class="hidden text-red-500 font-bold p-4 bg-red-50 rounded-xl border border-red-100">
                    <i class="fas fa-ban mr-2"></i><span id="blocked-reason"></span>
                </div>
            </div>
        </section>

        <!-- View: Quiz -->
        <section id="view-quiz" class="hidden flex-col h-full">
            <div class="flex justify-between items-center mb-6">
                <div class="font-bold text-gray-500"><span id="q-current">1</span> / <span id="q-total">10</span></div>
                <div class="flex items-center gap-2 bg-white px-3 py-1 rounded-full shadow-sm border border-gray-200">
                    <i class="fas fa-stopwatch text-red-500"></i>
                    <span class="font-mono font-bold text-lg text-gray-700 w-12 text-center"
                        id="timer-display">00:00</span>
                </div>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2 mb-8 overflow-hidden">
                <div id="timer-bar" class="bg-blue-500 h-2 rounded-full timer-progress" style="width: 100%"></div>
            </div>
            <div class="bg-white p-6 md:p-8 rounded-2xl shadow-sm border border-gray-200 flex-1 flex flex-col">
                <div id="q-image-area" class="mb-4 hidden text-center">
                    <img id="q-image" class="max-h-48 mx-auto rounded-lg border border-gray-100 cursor-zoom-in"
                        onclick="window.open(this.src)">
                </div>
                <h2 class="text-xl md:text-2xl font-bold text-gray-800 mb-8 leading-snug break-keep" id="q-text"></h2>
                <div id="q-options-area" class="space-y-3 flex-1"></div>
                <div class="mt-8 pt-4 border-t border-gray-100 flex justify-end">
                    <button id="btn-next" onclick="app.nextQuestion()"
                        class="bg-gray-800 text-white px-8 py-3 rounded-xl font-bold hover:bg-gray-900 transition shadow-lg">ë‹¤ìŒ
                        ë¬¸ì œ <i class="fas fa-arrow-right ml-2"></i></button>
                </div>
            </div>
        </section>

        <!-- View: Result -->
        <section id="view-result" class="hidden text-center">
            <div class="bg-white p-8 rounded-2xl shadow-xl border-t-8 border-blue-500 max-w-md mx-auto">
                <h2 class="text-3xl font-black text-gray-800 mb-2">í‰ê°€ ì¢…ë£Œ</h2>
                <p class="text-gray-500 mb-8">ìˆ˜ê³ í•˜ì…¨ìŠµë‹ˆë‹¤! ê²°ê³¼ë¥¼ í™•ì¸í•˜ì„¸ìš”.</p>
                <div class="relative w-48 h-48 mx-auto mb-6">
                    <canvas id="resultChart"></canvas>
                    <div class="absolute inset-0 flex flex-col items-center justify-center">
                        <span class="text-5xl font-black text-blue-600" id="res-score">0</span>
                        <span class="text-sm text-gray-400 font-bold">ì </span>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-3 mb-6">
                    <button onclick="document.getElementById('review-area').classList.toggle('hidden')"
                        class="bg-white border-2 border-gray-200 text-gray-700 font-bold py-3 rounded-xl hover:bg-gray-50">ì˜¤ë‹µ
                        ë…¸íŠ¸</button>
                    <button onclick="location.href='quiz.html'"
                        class="bg-gray-800 text-white font-bold py-3 rounded-xl hover:bg-gray-900 shadow-md">ëª©ë¡ìœ¼ë¡œ</button>
                </div>
                <button onclick="location.href='history.html'"
                    class="text-gray-400 text-sm hover:text-gray-600 underline">ë‚´ ê¸°ë¡ì¥ ë³´ê¸°</button>
            </div>
            <div id="review-area"
                class="hidden mt-6 bg-white p-6 rounded-2xl shadow-lg text-left border border-red-100">
                <h3 class="font-bold text-lg text-red-500 mb-4 border-b pb-2"><i class="fas fa-check-circle mr-2"></i>í‹€ë¦°
                    ë¬¸ì œ í™•ì¸</h3>
                <div id="review-list" class="space-y-6"></div>
            </div>
        </section>
    </main>

    <!-- Footer injected by AuthManager -->

    <script>
        window.AuthManager.init('student');

        const app = {
            params: {},
            config: {},
            allQuestions: [],
            selectedQuestions: [],
            currentIndex: 0,
            answers: {},
            timer: null,
            timeLeft: 60,
            timeLimitTotal: 60,
            user: null,

            init: function () {
                const p = new URLSearchParams(window.location.search);
                this.params = { unitId: p.get('unitId'), category: p.get('category'), title: decodeURIComponent(p.get('title') || '') };
                document.getElementById('intro-title').innerText = this.params.title;
                document.getElementById('intro-subtitle').innerText = this.params.category === 'diagnostic' ? 'ì§„ë‹¨í‰ê°€' : (this.params.category === 'formative' ? 'í˜•ì„±í‰ê°€' : 'ì‹¤ì „ ëª¨ì˜ê³ ì‚¬');
                document.addEventListener('auth-ready', (e) => { this.user = e.detail; this.checkPreconditions(); });
            },

            checkPreconditions: async function () {
                try {
                    const settingsDoc = await window.getCollection('assessment_config').doc('settings').get();
                    const key = `${this.params.unitId}_${this.params.category}`;
                    const allSettings = settingsDoc.exists ? settingsDoc.data() : {};
                    this.config = allSettings[key] || { active: true, timeLimit: 60, allowRetake: true, cooldown: 0, questionCount: 10 };

                    if (!this.config.active && this.params.unitId !== 'exam_prep') throw new Error("í˜„ì¬ ë¹„í™œì„±í™”ëœ í‰ê°€ì…ë‹ˆë‹¤.");

                    let qQuery = window.getCollection('quiz_questions');
                    if (this.params.unitId === 'exam_prep') {
                        qQuery = qQuery.where('category', '==', 'exam_prep');
                    } else {
                        qQuery = qQuery.where('unitId', '==', this.params.unitId).where('category', '==', this.params.category);
                    }
                    const qSnap = await qQuery.get();
                    this.allQuestions = [];
                    qSnap.forEach(d => this.allQuestions.push({ id: parseInt(d.id), ...d.data() }));
                    if (this.allQuestions.length === 0) throw new Error("ë“±ë¡ëœ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.");

                    const histSnap = await window.getCollection('quiz_results')
                        .where('uid', '==', this.user.uid)
                        .where('unitId', '==', this.params.unitId)
                        .where('category', '==', this.params.category)
                        .orderBy('timestamp', 'desc').get();

                    // Collect solved question IDs
                    const solvedIds = new Set();
                    histSnap.forEach(doc => {
                        const d = doc.data();
                        if (d.details) d.details.forEach(log => solvedIds.add(parseInt(log.id)));
                    });

                    this.timeLimitTotal = this.config.timeLimit || 60;
                    document.getElementById('info-time').innerText = this.timeLimitTotal + "ì´ˆ";
                    document.getElementById('info-count').innerText = (this.config.questionCount || 10) + "ë¬¸í•­";
                    document.getElementById('info-history').innerText = (!histSnap.empty ? histSnap.size + "íšŒ ì‘ì‹œ" : "ì²« ì‘ì‹œ");

                    if (!this.config.allowRetake && !histSnap.empty && this.params.unitId !== 'exam_prep') {
                        this.blockStart("ì¬ì‘ì‹œê°€ í—ˆìš©ë˜ì§€ ì•ŠëŠ” í‰ê°€ì…ë‹ˆë‹¤."); return;
                    }

                    if (this.config.cooldown > 0 && !histSnap.empty) {
                        const lastAttempt = histSnap.docs[0].data().timestamp.toDate();
                        const diffMins = (new Date() - lastAttempt) / 1000 / 60;
                        if (diffMins < this.config.cooldown) {
                            const remain = Math.ceil(this.config.cooldown - diffMins);
                            this.blockStart(`ì¬ì‘ì‹œ ëŒ€ê¸° ì‹œê°„: ${remain}ë¶„ ë‚¨ìŒ`); return;
                        }
                    }

                    // Smart Question Selection
                    this.selectSmartQuestions(solvedIds);

                    document.getElementById('loading-overlay').classList.add('hidden');
                    document.getElementById('view-intro').classList.remove('hidden');
                    document.getElementById('view-intro').classList.add('flex');
                } catch (e) {
                    document.getElementById('loading-msg').innerText = "ì˜¤ë¥˜: " + e.message;
                    document.getElementById('loading-msg').classList.add('text-red-500');
                }
            },

            selectSmartQuestions: function (solvedIds) {
                const targetCount = this.config.questionCount || 10;

                // 1. Filter out previously solved questions
                let pool = this.allQuestions.filter(q => !solvedIds.has(q.id));

                // 2. If pool is insufficient, reset exclusion logic (or add some back)
                if (pool.length < targetCount) {
                    pool = [...this.allQuestions]; // Fallback to full bank if new questions are exhausted
                }

                if (this.params.unitId === 'exam_prep') {
                    // BALANCED DISTRIBUTION LOGIC
                    this.selectedQuestions = this.pickBalancedQuestions(pool, targetCount);
                } else {
                    // NORMAL RANDOM LOGIC
                    this.selectedQuestions = pool.sort(() => 0.5 - Math.random()).slice(0, targetCount);
                }

                document.getElementById('q-total').innerText = this.selectedQuestions.length;
            },

            pickBalancedQuestions: function (pool, targetCount) {
                // Group by refBig then refMid
                const groups = {};
                pool.forEach(q => {
                    const bigKey = q.refBig || 'unknown_big';
                    const midKey = q.refMid || 'unknown_mid';
                    const key = `${bigKey}_${midKey}`;
                    if (!groups[key]) groups[key] = [];
                    groups[key].push(q);
                });

                const groupKeys = Object.keys(groups);
                const result = [];
                const localGroups = JSON.parse(JSON.stringify(groups)); // Deep copy to avoid mutations

                // Round-Robin Selection
                let safety = 0;
                while (result.length < targetCount && groupKeys.some(k => localGroups[k].length > 0) && safety < 1000) {
                    groupKeys.forEach(k => {
                        if (result.length < targetCount && localGroups[k].length > 0) {
                            const idx = Math.floor(Math.random() * localGroups[k].length);
                            result.push(localGroups[k].splice(idx, 1)[0]);
                        }
                    });
                    safety++;
                }
                return result.sort(() => 0.5 - Math.random());
            },

            blockStart: function (reason) {
                document.getElementById('start-btn-area').classList.add('hidden');
                document.getElementById('blocked-msg').classList.remove('hidden');
                document.getElementById('blocked-reason').innerText = reason;
                document.getElementById('loading-overlay').classList.add('hidden');
                document.getElementById('view-intro').classList.remove('hidden');
                document.getElementById('view-intro').classList.add('flex');
            },

            startQuiz: function () {
                this.currentIndex = 0;
                this.answers = {};
                this.timeLeft = this.timeLimitTotal;
                document.getElementById('view-intro').classList.remove('flex');
                document.getElementById('view-intro').classList.add('hidden');
                document.getElementById('view-quiz').classList.remove('hidden');
                document.getElementById('view-quiz').classList.add('flex');
                this.renderQuestion();
                this.startTimer();
            },

            startTimer: function () {
                const display = document.getElementById('timer-display');
                const bar = document.getElementById('timer-bar');
                this.timer = setInterval(() => {
                    this.timeLeft--;
                    const m = Math.floor(this.timeLeft / 60);
                    const s = this.timeLeft % 60;
                    display.innerText = `${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
                    const pct = (this.timeLeft / this.timeLimitTotal) * 100;
                    bar.style.width = pct + "%";
                    if (pct < 20) bar.classList.add('timer-urgent');
                    if (this.timeLeft <= 0) { clearInterval(this.timer); alert("ì‹œê°„ ì¢…ë£Œ!"); this.finishQuiz(true); }
                }, 1000);
            },

            renderQuestion: function () {
                const q = this.selectedQuestions[this.currentIndex];
                document.getElementById('q-current').innerText = this.currentIndex + 1;
                const imgArea = document.getElementById('q-image-area');
                if (q.image) { document.getElementById('q-image').src = q.image; imgArea.classList.remove('hidden'); } else { imgArea.classList.add('hidden'); }
                document.getElementById('q-text').innerHTML = q.question;
                const container = document.getElementById('q-options-area');
                container.innerHTML = '';
                if (q.type === 'choice') {
                    q.options.forEach((opt, i) => {
                        const div = document.createElement('div');
                        div.className = `quiz-option ${this.answers[q.id] === opt ? 'selected' : ''}`;
                        div.innerHTML = `<div class="opt-num">${i + 1}</div><div class="font-medium">${opt}</div>`;
                        div.onclick = () => this.selectAnswer(q.id, opt);
                        container.appendChild(div);
                    });
                } else if (q.type === 'ox') {
                    ['O', 'X'].forEach(opt => {
                        const div = document.createElement('div');
                        div.className = `quiz-option justify-center text-xl font-bold ${this.answers[q.id] === opt ? 'selected' : ''}`;
                        div.innerHTML = opt;
                        div.onclick = () => this.selectAnswer(q.id, opt);
                        container.appendChild(div);
                    });
                } else {
                    const input = document.createElement('input');
                    input.type = "text";
                    input.className = "w-full border-b-2 border-gray-300 p-3 text-lg focus:border-blue-500 outline-none text-center bg-transparent";
                    input.placeholder = "ì •ë‹µì„ ì…ë ¥í•˜ì„¸ìš”";
                    input.value = this.answers[q.id] || '';
                    input.oninput = (e) => this.answers[q.id] = e.target.value;
                    container.appendChild(input);
                }
                const btn = document.getElementById('btn-next');
                btn.innerHTML = (this.currentIndex === this.selectedQuestions.length - 1) ? 'ì œì¶œ í•˜ê¸° <i class="fas fa-check ml-2"></i>' : 'ë‹¤ìŒ ë¬¸ì œ <i class="fas fa-arrow-right ml-2"></i>';
            },

            selectAnswer: function (qid, val) { this.answers[qid] = val; this.renderQuestion(); },

            nextQuestion: function () {
                const q = this.selectedQuestions[this.currentIndex];
                if (!this.answers[q.id] && !confirm("ë„˜ì–´ê°€ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
                if (this.currentIndex < this.selectedQuestions.length - 1) { this.currentIndex++; this.renderQuestion(); } else { this.finishQuiz(); }
            },

            finishQuiz: async function (isTimeOut = false) {
                clearInterval(this.timer);
                let correctCnt = 0;
                const details = [], detailLogs = [];
                this.selectedQuestions.forEach(q => {
                    const userAns = (this.answers[q.id] || "").toString().replace(/\s+/g, '').trim();
                    const realAns = q.answer.toString().replace(/\s+/g, '').trim();
                    const isCorrect = (userAns === realAns);
                    if (isCorrect) correctCnt++;
                    details.push({ q: q.question, u: userAns, a: q.answer, correct: isCorrect, exp: q.explanation });
                    detailLogs.push({ id: q.id, correct: isCorrect, u: userAns });
                });
                const score = Math.round((correctCnt / this.selectedQuestions.length) * 100);
                try {
                    const userData = await window.getCollection('users').doc(this.user.uid).get();
                    const profile = userData.data() || {};
                    await window.getCollection('quiz_results').add({
                        uid: this.user.uid, name: profile.name || 'Unknown', class: profile.class || 0, number: profile.number || 0,
                        unitId: this.params.unitId, category: this.params.category, score: score, details: detailLogs,
                        status: isTimeOut ? 'ì‹œê°„ì´ˆê³¼' : 'ì™„ë£Œ', timestamp: firebase.firestore.FieldValue.serverTimestamp(), timeString: new Date().toLocaleString()
                    });
                } catch (e) { console.error(e); }
                this.renderResult(score, details);
            },

            renderResult: function (score, details) {
                document.getElementById('view-quiz').classList.add('hidden');
                document.getElementById('view-result').classList.remove('hidden');
                document.getElementById('res-score').innerText = score;
                new Chart(document.getElementById('resultChart'), { type: 'doughnut', data: { labels: ['ì •ë‹µ', 'ì˜¤ë‹µ'], datasets: [{ data: [score, 100 - score], backgroundColor: ['#2563eb', '#f3f4f6'], borderWidth: 0 }] }, options: { cutout: '85%', plugins: { legend: { display: false } } } });
                const list = document.getElementById('review-list');
                list.innerHTML = details.filter(d => !d.correct).length === 0 ? '<div class="text-center py-4 text-green-600 font-bold">ğŸ‰ ì™„ë²½í•©ë‹ˆë‹¤!</div>' : details.map((d, i) => `
                        <div class="${d.correct ? 'hidden' : 'block'} border-b pb-4 last:border-0">
                            <div class="flex gap-2 items-start mb-2"><span class="bg-red-100 text-red-600 text-xs font-bold px-2 py-1 rounded">Q${i + 1}</span><div class="font-bold text-gray-800">${d.q}</div></div>
                            <div class="flex gap-4 text-sm ml-8 mb-2"><span class="text-red-500 line-through">${d.u || '(ë¯¸ì…ë ¥)'}</span><span class="text-blue-600 font-bold"><i class="fas fa-arrow-right mr-1"></i>${d.a}</span></div>
                            <div class="ml-8 bg-gray-50 p-3 rounded text-xs text-gray-600">${d.exp || 'í•´ì„¤ ì—†ìŒ'}</div>
                        </div>`).join('');
            }
        };
        app.init();
    </script>
</body>

</html>